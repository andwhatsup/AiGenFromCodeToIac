{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_version = \">= 1.3.0\"\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"6.27.0\"\n    }\n    random = {\n      source  = \"hashicorp/random\"\n      version = \"3.7.2\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy resources in.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"lambda_function_name\" {\n  description = \"Name for the Lambda function.\"\n  type        = string\n  default     = \"iterator-lambda\"\n}\n\nvariable \"lambda_handler\" {\n  description = \"Lambda handler name (for Go, usually the binary name).\"\n  type        = string\n  default     = \"main\"\n}\n\nvariable \"lambda_runtime\" {\n  description = \"Lambda runtime.\"\n  type        = string\n  default     = \"go1.x\"\n}\n\nvariable \"lambda_role_name\" {\n  description = \"IAM role name for Lambda.\"\n  type        = string\n  default     = \"iterator-lambda-role\"\n}\n\nvariable \"lambda_s3_bucket\" {\n  description = \"S3 bucket for Lambda deployment package.\"\n  type        = string\n}\n\nvariable \"lambda_s3_key\" {\n  description = \"S3 key for Lambda deployment package.\"\n  type        = string\n}\n"
    },
    {
      "name": "lambda.tf",
      "content": "resource \"aws_iam_role\" \"lambda_exec\" {\n  name               = var.lambda_role_name\n  assume_role_policy = file(\"${path.module}/assume_role_policy.json\")\n}\n\nresource \"aws_iam_role_policy\" \"lambda_policy\" {\n  name   = \"lambda-basic-execution\"\n  role   = aws_iam_role.lambda_exec.id\n  policy = data.aws_iam_policy_document.lambda_policy.json\n}\n\ndata \"aws_iam_policy_document\" \"lambda_policy\" {\n  statement {\n    actions = [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ]\n    resources = [\"arn:aws:logs:*:*:*\"]\n  }\n}\n\nresource \"aws_lambda_function\" \"iterator\" {\n  function_name = var.lambda_function_name\n  s3_bucket     = var.lambda_s3_bucket\n  s3_key        = var.lambda_s3_key\n  handler       = var.lambda_handler\n  runtime       = var.lambda_runtime\n  role          = aws_iam_role.lambda_exec.arn\n  environment {\n    variables = {\n      REGION = var.aws_region\n      LAMBDA = var.lambda_function_name\n    }\n  }\n}\n"
    },
    {
      "name": "stepfunctions.tf",
      "content": "resource \"aws_sfn_state_machine\" \"iterator\" {\n  name     = \"iterator-state-machine\"\n  role_arn = aws_iam_role.lambda_exec.arn\n  definition = templatefile(\"${path.module}/step_function_definition.json\", {\n    iterator_arn = aws_lambda_function.iterator.arn\n  })\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"lambda_function_name\" {\n  description = \"Name of the Lambda function.\"\n  value       = aws_lambda_function.iterator.function_name\n}\n\noutput \"lambda_function_arn\" {\n  description = \"ARN of the Lambda function.\"\n  value       = aws_lambda_function.iterator.arn\n}\n\noutput \"step_function_arn\" {\n  description = \"ARN of the Step Functions state machine.\"\n  value       = aws_sfn_state_machine.iterator.arn\n}\n"
    },
    {
      "name": "cloudwatch.tf",
      "content": "resource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${var.lambda_function_name}\"\n  retention_in_days = 14\n}\n\nresource \"aws_cloudwatch_log_group\" \"stepfunctions\" {\n  name              = \"/aws/vendedlogs/states/iterator-state-machine\"\n  retention_in_days = 14\n}\n"
    },
    {
      "name": "step_function_definition.json",
      "content": "{\n  \"Comment\": \"Invoke Lambda every 10 seconds\",\n  \"StartAt\": \"ConfigureCount\",\n  \"States\": {\n    \"ConfigureCount\": {\n      \"Type\": \"Pass\",\n      \"Result\": {\n        \"index\": 0,\n        \"count\": 6\n      },\n      \"ResultPath\": \"$.iterator\",\n      \"Next\": \"Iterator\"\n    },\n    \"Iterator\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"${iterator_arn }\",\n      \"ResultPath\": \"$.iterator\",\n      \"Next\": \"IsCountReached\"\n    },\n    \"IsCountReached\": {\n      \"Type\": \"Choice\",\n      \"Choices\": [\n        {\n          \"Variable\": \"$.iterator.continue\",\n          \"BooleanEquals\": true,\n          \"Next\": \"Wait\"\n        }\n      ],\n      \"Default\": \"Done\"\n    },\n    \"Wait\": {\n      \"Type\": \"Wait\",\n      \"Seconds\": 10,\n      \"Next\": \"Iterator\"\n    },\n    \"Done\": {\n      \"Type\": \"Pass\",\n      \"End\": true\n    }\n  }\n}\n"
    },
    {
      "name": "assume_role_policy.json",
      "content": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": { \"Service\": \"lambda.amazonaws.com\"},\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n"
    }
  ]
}