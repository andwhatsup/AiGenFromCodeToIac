{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_version = \">= 1.3.0\"\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.0\"\n    }\n    kubernetes = {\n      source  = \"hashicorp/kubernetes\"\n      version = \">= 2.20\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}\n\nprovider \"kubernetes\" {\n  host                   = aws_eks_cluster.eks.endpoint\n  cluster_ca_certificate = base64decode(aws_eks_cluster.eks.certificate_authority[0].data)\n  token                  = data.aws_eks_cluster_auth.eks.token\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy resources in.\"\n  type        = string\n  default     = \"us-west-2\"\n}\n\nvariable \"vpc_cidr\" {\n  description = \"CIDR block for the VPC.\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"public_subnet_cidrs\" {\n  description = \"List of public subnet CIDR blocks.\"\n  type        = list(string)\n  default     = [\"10.0.1.0/24\", \"10.0.2.0/24\"]\n}\n\nvariable \"private_subnet_cidrs\" {\n  description = \"List of private subnet CIDR blocks.\"\n  type        = list(string)\n  default     = [\"10.0.101.0/24\", \"10.0.102.0/24\"]\n}\n\nvariable \"eks_cluster_name\" {\n  description = \"Name for the EKS cluster.\"\n  type        = string\n  default     = \"energi-eks-cluster\"\n}\n\nvariable \"node_instance_type\" {\n  description = \"EC2 instance type for EKS worker nodes.\"\n  type        = string\n  default     = \"t3.large\"\n}\n\nvariable \"desired_capacity\" {\n  description = \"Desired number of worker nodes.\"\n  type        = number\n  default     = 2\n}\n\nvariable \"max_capacity\" {\n  description = \"Maximum number of worker nodes.\"\n  type        = number\n  default     = 3\n}\n\nvariable \"min_capacity\" {\n  description = \"Minimum number of worker nodes.\"\n  type        = number\n  default     = 1\n}\n\nvariable \"docker_image\" {\n  description = \"Energi Node Docker image (from Docker Hub).\"\n  type        = string\n  default     = \"energi/energi:latest\"\n}\n\nvariable \"ebs_volume_size\" {\n  description = \"Size of EBS volume for blockchain data (in GiB).\"\n  type        = number\n  default     = 100\n}\n"
    },
    {
      "name": "vpc.tf",
      "content": "resource \"aws_vpc\" \"main\" {\n  cidr_block           = var.vpc_cidr\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n  tags = {\n    Name = \"energi-vpc\"\n  }\n}\n\nresource \"aws_internet_gateway\" \"main\" {\n  vpc_id = aws_vpc.main.id\n  tags = {\n    Name = \"energi-igw\"\n  }\n}\n\nresource \"aws_subnet\" \"public\" {\n  count                   = length(var.public_subnet_cidrs)\n  vpc_id                  = aws_vpc.main.id\n  cidr_block              = var.public_subnet_cidrs[count.index]\n  map_public_ip_on_launch = true\n  availability_zone       = data.aws_availability_zones.available.names[count.index]\n  tags = {\n    Name = \"energi-public-subnet-${count.index + 1}\"\n  }\n}\n\nresource \"aws_subnet\" \"private\" {\n  count             = length(var.private_subnet_cidrs)\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = var.private_subnet_cidrs[count.index]\n  availability_zone = data.aws_availability_zones.available.names[count.index]\n  tags = {\n    Name = \"energi-private-subnet-${count.index + 1}\"\n  }\n}\n\nresource \"aws_nat_gateway\" \"main\" {\n  allocation_id = aws_eip.nat.id\n  subnet_id     = aws_subnet.public[0].id\n  tags = {\n    Name = \"energi-nat-gw\"\n  }\n  depends_on = [aws_internet_gateway.main]\n}\n\nresource \"aws_eip\" \"nat\" {\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.main.id\n  tags = {\n    Name = \"energi-public-rt\"\n  }\n}\n\nresource \"aws_route\" \"public_internet_access\" {\n  route_table_id         = aws_route_table.public.id\n  destination_cidr_block = \"0.0.0.0/0\"\n  gateway_id             = aws_internet_gateway.main.id\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  count          = length(var.public_subnet_cidrs)\n  subnet_id      = aws_subnet.public[count.index].id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_route_table\" \"private\" {\n  vpc_id = aws_vpc.main.id\n  tags = {\n    Name = \"energi-private-rt\"\n  }\n}\n\nresource \"aws_route\" \"private_nat_gateway\" {\n  route_table_id         = aws_route_table.private.id\n  destination_cidr_block = \"0.0.0.0/0\"\n  nat_gateway_id         = aws_nat_gateway.main.id\n}\n\nresource \"aws_route_table_association\" \"private\" {\n  count          = length(var.private_subnet_cidrs)\n  subnet_id      = aws_subnet.private[count.index].id\n  route_table_id = aws_route_table.private.id\n}\n"
    },
    {
      "name": "eks.tf",
      "content": "resource \"aws_iam_role\" \"eks_cluster\" {\n  name = \"energi-eks-cluster-role\"\n  assume_role_policy = data.aws_iam_policy_document.eks_assume_role_policy.json\n}\n\ndata \"aws_iam_policy_document\" \"eks_assume_role_policy\" {\n  statement {\n    actions = [\"sts:AssumeRole\"]\n    principals {\n      type        = \"Service\"\n      identifiers = [\"eks.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eks_cluster_AmazonEKSClusterPolicy\" {\n  role       = aws_iam_role.eks_cluster.name\n  policy_arn = \"arn:aws:iam::aws:policy/AmazonEKSClusterPolicy\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eks_cluster_AmazonEKSServicePolicy\" {\n  role       = aws_iam_role.eks_cluster.name\n  policy_arn = \"arn:aws:iam::aws:policy/AmazonEKSServicePolicy\"\n}\n\nresource \"aws_eks_cluster\" \"eks\" {\n  name     = var.eks_cluster_name\n  role_arn = aws_iam_role.eks_cluster.arn\n\n  vpc_config {\n    subnet_ids = concat(\n      aws_subnet.public[*].id,\n      aws_subnet.private[*].id\n    )\n    endpoint_public_access = true\n    endpoint_private_access = true\n  }\n\n  depends_on = [aws_iam_role_policy_attachment.eks_cluster_AmazonEKSClusterPolicy]\n}\n\ndata \"aws_eks_cluster\" \"eks\" {\n  name = aws_eks_cluster.eks.name\n}\n\ndata \"aws_eks_cluster_auth\" \"eks\" {\n  name = aws_eks_cluster.eks.name\n}\n\nresource \"aws_iam_role\" \"eks_node_group\" {\n  name = \"energi-eks-node-group-role\"\n  assume_role_policy = data.aws_iam_policy_document.eks_node_assume_role_policy.json\n}\n\ndata \"aws_iam_policy_document\" \"eks_node_assume_role_policy\" {\n  statement {\n    actions = [\"sts:AssumeRole\"]\n    principals {\n      type        = \"Service\"\n      identifiers = [\"ec2.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eks_node_AmazonEKSWorkerNodePolicy\" {\n  role       = aws_iam_role.eks_node_group.name\n  policy_arn = \"arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eks_node_AmazonEC2ContainerRegistryReadOnly\" {\n  role       = aws_iam_role.eks_node_group.name\n  policy_arn = \"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eks_node_AmazonEKS_CNI_Policy\" {\n  role       = aws_iam_role.eks_node_group.name\n  policy_arn = \"arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy\"\n}\n\nresource \"aws_eks_node_group\" \"default\" {\n  cluster_name    = aws_eks_cluster.eks.name\n  node_group_name = \"energi-node-group\"\n  node_role_arn   = aws_iam_role.eks_node_group.arn\n  subnet_ids      = aws_subnet.private[*].id\n\n  scaling_config {\n    desired_size = var.desired_capacity\n    max_size     = var.max_capacity\n    min_size     = var.min_capacity\n  }\n\n  instance_types = [var.node_instance_type]\n  disk_size      = 100\n\n  remote_access {\n    ec2_ssh_key = null\n  }\n\n  depends_on = [\n    aws_iam_role_policy_attachment.eks_node_AmazonEKSWorkerNodePolicy,\n    aws_iam_role_policy_attachment.eks_node_AmazonEC2ContainerRegistryReadOnly,\n    aws_iam_role_policy_attachment.eks_node_AmazonEKS_CNI_Policy\n  ]\n}\n"
    },
    {
      "name": "k8s_energi_node.yaml",
      "content": "---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: energi-node-pvc\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 100Gi\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: energi-node\nspec:\n  serviceName: \"energi-node\"\n  replicas: 1\n  selector:\n    matchLabels:\n      app: energi-node\n  template:\n    metadata:\n      labels:\n        app: energi-node\n    spec:\n      containers:\n      - name: energi-node\n        image: energi/energi:latest\n        ports:\n        - containerPort: 10200\n        volumeMounts:\n        - name: energi-node-storage\n          mountPath: /root/.energicore\n      volumes:\n      - name: energi-node-storage\n        persistentVolumeClaim:\n          claimName: energi-node-pvc\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"eks_cluster_name\" {\n  description = \"EKS cluster name\"\n  value       = aws_eks_cluster.eks.name\n}\n\noutput \"eks_cluster_endpoint\" {\n  description = \"EKS cluster endpoint\"\n  value       = aws_eks_cluster.eks.endpoint\n}\n\noutput \"eks_cluster_ca\" {\n  description = \"EKS cluster CA certificate\"\n  value       = aws_eks_cluster.eks.certificate_authority[0].data\n}\n\noutput \"node_group_role_arn\" {\n  description = \"EKS node group IAM role ARN\"\n  value       = aws_iam_role.eks_node_group.arn\n}\n\noutput \"vpc_id\" {\n  description = \"VPC ID\"\n  value       = aws_vpc.main.id\n}\n"
    },
    {
      "name": "data_sources.tf",
      "content": "data \"aws_availability_zones\" \"available\" {}\n"
    },
    {
      "name": "README.md",
      "content": "# Energi Node on AWS EKS with Persistent Storage\n\nThis Terraform configuration provisions an AWS EKS cluster with a VPC, subnets, IAM roles, and a Kubernetes StatefulSet for running an Energi blockchain node with persistent storage.\n\n## Key Components\n- **VPC** with public/private subnets, NAT gateway, and routing\n- **EKS Cluster** and managed node group\n- **IAM roles** for EKS and worker nodes\n- **Kubernetes StatefulSet** for Energi Node (YAML manifest)\n- **PersistentVolumeClaim** for blockchain data\n\n## Usage\n1. Initialize Terraform:\n   ```sh\n   terraform init\n   ```\n2. Review and apply the plan:\n   ```sh\n   terraform apply\n   ```\n3. Deploy the Energi Node to EKS:\n   ```sh\n   aws eks --region <region> update-kubeconfig --name <cluster_name>\n   kubectl apply -f k8s_energi_node.yaml\n   ```\n\n## Notes\n- The Energi Node image is pulled from Docker Hub. For production, consider mirroring to Amazon ECR.\n- Persistent storage is provided by EBS via Kubernetes PVC.\n- Adjust variables in `variables.tf` as needed for your environment.\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region = \"us-west-2\"\nvpc_cidr = \"10.0.0.0/16\"\npublic_subnet_cidrs = [\"10.0.1.0/24\", \"10.0.2.0/24\"]\nprivate_subnet_cidrs = [\"10.0.101.0/24\", \"10.0.102.0/24\"]\neks_cluster_name = \"energi-eks-cluster\"\nnode_instance_type = \"t3.large\"\ndesired_capacity = 2\nmax_capacity = 3\nmin_capacity = 1\ndocker_image = \"energi/energi:latest\"\nebs_volume_size = 100\n"
    }
  ]
}