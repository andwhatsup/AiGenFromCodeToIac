{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.27.0\"\n    }\n  }\n  required_version = \">= 1.3.0\"\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy resources in.\"\n  type        = string\n}\n\nvariable \"lambda_function_name\" {\n  description = \"Name for the Lambda function.\"\n  type        = string\n  default     = \"ssm-backup-lambda\"\n}\n\nvariable \"s3_bucket_name\" {\n  description = \"Name for the S3 bucket to store backups.\"\n  type        = string\n}\n\nvariable \"kms_key_alias\" {\n  description = \"Alias for the KMS key used for S3 encryption.\"\n  type        = string\n  default     = \"alias/ssm-backup-kms-key\"\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"lambda_function_name\" {\n  description = \"Name of the Lambda function.\"\n  value       = aws_lambda_function.ssm_backup.function_name\n}\n\noutput \"s3_bucket_name\" {\n  description = \"Name of the S3 bucket used for backups.\"\n  value       = aws_s3_bucket.ssm_backup.id\n}\n\noutput \"kms_key_arn\" {\n  description = \"ARN of the KMS key used for S3 encryption.\"\n  value       = aws_kms_key.ssm_backup.arn\n}\n"
    },
    {
      "name": "lambda.tf",
      "content": "resource \"aws_iam_role\" \"lambda_exec\" {\n  name = \"ssm-backup-lambda-exec-role\"\n  assume_role_policy = data.aws_iam_policy_document.lambda_assume_role_policy.json\n}\n\ndata \"aws_iam_policy_document\" \"lambda_assume_role_policy\" {\n  statement {\n    actions = [\"sts:AssumeRole\"]\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role_policy\" \"lambda_policy\" {\n  name   = \"ssm-backup-lambda-policy\"\n  role   = aws_iam_role.lambda_exec.id\n  policy = data.aws_iam_policy_document.lambda_policy.json\n}\n\ndata \"aws_iam_policy_document\" \"lambda_policy\" {\n  statement {\n    actions = [\n      \"ssm:DescribeParameters\",\n      \"ssm:GetParameters\",\n      \"ssm:GetParameter\",\n      \"ssm:GetParametersByPath\"\n    ]\n    resources = [\"*\"]\n  }\n  statement {\n    actions = [\n      \"s3:PutObject\"\n    ]\n    resources = [\"${aws_s3_bucket.ssm_backup.arn}/*\"]\n  }\n  statement {\n    actions = [\n      \"kms:Encrypt\",\n      \"kms:Decrypt\",\n      \"kms:GenerateDataKey\"\n    ]\n    resources = [aws_kms_key.ssm_backup.arn]\n  }\n  statement {\n    actions = [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ]\n    resources = [\"arn:aws:logs:*:*:*\"]\n  }\n}\n\nresource \"aws_lambda_function\" \"ssm_backup\" {\n  function_name = var.lambda_function_name\n  role          = aws_iam_role.lambda_exec.arn\n  handler       = \"ssm_backup.lambda_handler\"\n  runtime       = \"python3.11\"\n  filename      = \"../function.zip\"\n  source_code_hash = filebase64sha256(\"../function.zip\")\n  environment {\n    variables = {\n      S3_BUCKET   = aws_s3_bucket.ssm_backup.id\n      KMS_KEY_ARN = aws_kms_key.ssm_backup.arn\n    }\n  }\n  timeout = 300\n}\n\nresource \"aws_cloudwatch_log_group\" \"lambda_log\" {\n  name              = \"/aws/lambda/${aws_lambda_function.ssm_backup.function_name}\"\n  retention_in_days = 14\n}\n"
    },
    {
      "name": "storage.tf",
      "content": "resource \"aws_s3_bucket\" \"ssm_backup\" {\n  bucket = var.s3_bucket_name\n\n  server_side_encryption_configuration {\n    rule {\n      apply_server_side_encryption_by_default {\n        kms_master_key_id = aws_kms_key.ssm_backup.arn\n        sse_algorithm     = \"aws:kms\"\n      }\n    }\n  }\n\n  force_destroy = true\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"ssm_backup\" {\n  bucket = aws_s3_bucket.ssm_backup.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n"
    },
    {
      "name": "kms.tf",
      "content": "resource \"aws_kms_key\" \"ssm_backup\" {\n  description             = \"KMS key for SSM backup S3 bucket encryption\"\n  deletion_window_in_days = 7\n  enable_key_rotation     = true\n}\n\nresource \"aws_kms_alias\" \"ssm_backup\" {\n  name          = var.kms_key_alias\n  target_key_id = aws_kms_key.ssm_backup.key_id\n}\n"
    },
    {
      "name": "ssm.tf",
      "content": "# No explicit SSM Parameter Store resources are created, as the Lambda function interacts with existing parameters.\n# If you want to create example parameters, uncomment and customize below:\n# resource \"aws_ssm_parameter\" \"example\" {\n#   name  = \"/example/parameter\"\n#   type  = \"SecureString\"\n#   value = \"example-value\"\n# }\n"
    }
  ]
}