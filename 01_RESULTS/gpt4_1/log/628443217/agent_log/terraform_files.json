{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 4.0\"\n    }\n  }\n  required_version = \">= 1.4.5\"\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy resources in.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"vpc_cidr\" {\n  description = \"CIDR block for the VPC.\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"public_subnet_cidr\" {\n  description = \"CIDR block for the public subnet.\"\n  type        = string\n  default     = \"10.0.1.0/24\"\n}\n\nvariable \"instance_type\" {\n  description = \"EC2 instance type.\"\n  type        = string\n  default     = \"t3.micro\"\n}\n\nvariable \"key_name\" {\n  description = \"Name of the SSH key pair to use for EC2 instance.\"\n  type        = string\n}\n\nvariable \"allowed_ssh_cidr\" {\n  description = \"CIDR block allowed to access EC2 via SSH.\"\n  type        = string\n  default     = \"0.0.0.0/0\"\n}\n"
    },
    {
      "name": "vpc.tf",
      "content": "resource \"aws_vpc\" \"main\" {\n  cidr_block           = var.vpc_cidr\n  enable_dns_support   = true\n  enable_dns_hostnames = true\n  tags = {\n    Name = \"main-vpc\"\n  }\n}\n\nresource \"aws_internet_gateway\" \"main\" {\n  vpc_id = aws_vpc.main.id\n  tags = {\n    Name = \"main-igw\"\n  }\n}\n\nresource \"aws_subnet\" \"public\" {\n  vpc_id                  = aws_vpc.main.id\n  cidr_block              = var.public_subnet_cidr\n  map_public_ip_on_launch = true\n  availability_zone       = data.aws_availability_zones.available.names[0]\n  tags = {\n    Name = \"main-public-subnet\"\n  }\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.main.id\n  tags = {\n    Name = \"main-public-rt\"\n  }\n}\n\nresource \"aws_route\" \"public_internet_access\" {\n  route_table_id         = aws_route_table.public.id\n  destination_cidr_block = \"0.0.0.0/0\"\n  gateway_id             = aws_internet_gateway.main.id\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  subnet_id      = aws_subnet.public.id\n  route_table_id = aws_route_table.public.id\n}\n\ndata \"aws_availability_zones\" \"available\" {}\n"
    },
    {
      "name": "security.tf",
      "content": "resource \"aws_security_group\" \"web\" {\n  name        = \"web-sg\"\n  description = \"Allow HTTP and SSH\"\n  vpc_id      = aws_vpc.main.id\n\n  ingress {\n    description = \"Allow HTTP\"\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  ingress {\n    description = \"Allow SSH\"\n    from_port   = 22\n    to_port     = 22\n    protocol    = \"tcp\"\n    cidr_blocks = [var.allowed_ssh_cidr]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = {\n    Name = \"web-sg\"\n  }\n}\n"
    },
    {
      "name": "ec2.tf",
      "content": "resource \"aws_key_pair\" \"main\" {\n  key_name   = var.key_name\n  public_key = file(\"../source/.security/my-net-keypair.id_rsa.pub\")\n}\n\nresource \"aws_instance\" \"web\" {\n  ami                    = data.aws_ami.amazon_linux.id\n  instance_type          = var.instance_type\n  subnet_id              = aws_subnet.public.id\n  vpc_security_group_ids = [aws_security_group.web.id]\n  key_name               = aws_key_pair.main.key_name\n\n  user_data = file(\"../source/nginx-php-inst.sh\")\n\n  tags = {\n    Name = \"nginx-php-ec2\"\n  }\n}\n\ndata \"aws_ami\" \"amazon_linux\" {\n  most_recent = true\n  owners      = [\"amazon\"]\n  filter {\n    name   = \"name\"\n    values = [\"amzn2-ami-hvm-*-x86_64-gp2\"]\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"ec2_public_ip\" {\n  description = \"The public IP address of the EC2 instance.\"\n  value       = aws_instance.web.public_ip\n}\n\noutput \"ec2_public_dns\" {\n  description = \"The public DNS of the EC2 instance.\"\n  value       = aws_instance.web.public_dns\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region      = \"us-east-1\"\nkey_name        = \"my-net-keypair\"\nallowed_ssh_cidr = \"0.0.0.0/0\"\n"
    },
    {
      "name": "README.md",
      "content": "# AWS EC2 Nginx + PHP-FPM Terraform Deployment\n\nThis Terraform configuration provisions a secure, single EC2 instance running nginx and PHP-FPM (PHP 8.2) on Amazon Linux, with networking and security best practices.\n\n## Files\n- `provider.tf`: AWS provider configuration\n- `variables.tf`: Input variables\n- `vpc.tf`: VPC, subnet, IGW, and routing\n- `security.tf`: Security group for HTTP/SSH\n- `ec2.tf`: EC2 instance, key pair, and user data\n- `outputs.tf`: Useful outputs\n- `terraform.tfvars.example`: Example variable values\n\n## Usage\n1. Copy your SSH public key to `source/.security/my-net-keypair.id_rsa.pub`.\n2. Edit `terraform.tfvars` as needed (see `terraform.tfvars.example`).\n3. Run:\n   ```sh\n   terraform init\n   terraform apply -var-file=\"terraform.tfvars\"\n   ```\n4. Access your instance via SSH and HTTP.\n\n## Security\n- Only port 80 (HTTP) and 22 (SSH) are open.\n- Restrict `allowed_ssh_cidr` for production.\n"
    }
  ]
}