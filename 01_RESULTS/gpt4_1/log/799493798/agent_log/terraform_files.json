{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.0\"\n    }\n  }\n  required_version = \">= 1.3.0\"\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy resources in.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"lambda_function_name\" {\n  description = \"Name for the Lambda function.\"\n  type        = string\n  default     = \"my_lambda_function\"\n}\n\nvariable \"s3_bucket_name\" {\n  description = \"Name for the S3 bucket.\"\n  type        = string\n}\n\nvariable \"lambda_handler\" {\n  description = \"Handler for the Lambda function.\"\n  type        = string\n  default     = \"lambda_function.lambda_handler\"\n}\n\nvariable \"lambda_runtime\" {\n  description = \"Runtime for the Lambda function.\"\n  type        = string\n  default     = \"python3.12\"\n}\n\nvariable \"lambda_source_path\" {\n  description = \"Path to the Lambda deployment package (zip file).\"\n  type        = string\n  default     = \"./lambda_function_payload.zip\"\n}\n"
    },
    {
      "name": "main.tf",
      "content": "resource \"aws_s3_bucket\" \"lambda_bucket\" {\n  bucket = var.s3_bucket_name\n  force_destroy = true\n\n  tags = {\n    Name = var.s3_bucket_name\n    ManagedBy = \"Terraform\"\n  }\n}\n\nresource \"aws_iam_role\" \"lambda_exec_role\" {\n  name = \"lambda_exec_role_${var.lambda_function_name}\"\n  assume_role_policy = data.aws_iam_policy_document.lambda_assume_role_policy.json\n}\n\ndata \"aws_iam_policy_document\" \"lambda_assume_role_policy\" {\n  statement {\n    actions = [\"sts:AssumeRole\"]\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role_policy\" \"lambda_s3_policy\" {\n  name = \"lambda_s3_policy_${var.lambda_function_name}\"\n  role = aws_iam_role.lambda_exec_role.id\n  policy = data.aws_iam_policy_document.lambda_s3_policy.json\n}\n\ndata \"aws_iam_policy_document\" \"lambda_s3_policy\" {\n  statement {\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:ListBucket\"\n    ]\n    resources = [\n      aws_s3_bucket.lambda_bucket.arn,\n      \"${aws_s3_bucket.lambda_bucket.arn}/*\"\n    ]\n  }\n  statement {\n    actions = [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ]\n    resources = [\"arn:aws:logs:*:*:*\"]\n  }\n}\n\nresource \"aws_lambda_function\" \"main\" {\n  function_name = var.lambda_function_name\n  handler       = var.lambda_handler\n  runtime       = var.lambda_runtime\n  role          = aws_iam_role.lambda_exec_role.arn\n  filename      = var.lambda_source_path\n  source_code_hash = filebase64sha256(var.lambda_source_path)\n\n  environment {\n    variables = {\n      BUCKET_NAME = aws_s3_bucket.lambda_bucket.bucket\n    }\n  }\n\n  depends_on = [aws_iam_role_policy.lambda_s3_policy]\n}\n\nresource \"aws_api_gateway_rest_api\" \"lambda_api\" {\n  name        = \"lambda-api-${var.lambda_function_name}\"\n  description = \"API Gateway for Lambda integration\"\n}\n\nresource \"aws_api_gateway_resource\" \"proxy\" {\n  rest_api_id = aws_api_gateway_rest_api.lambda_api.id\n  parent_id   = aws_api_gateway_rest_api.lambda_api.root_resource_id\n  path_part   = \"{proxy+}\"\n}\n\nresource \"aws_api_gateway_method\" \"proxy_method\" {\n  rest_api_id   = aws_api_gateway_rest_api.lambda_api.id\n  resource_id   = aws_api_gateway_resource.proxy.id\n  http_method   = \"ANY\"\n  authorization = \"NONE\"\n}\n\nresource \"aws_api_gateway_integration\" \"lambda_integration\" {\n  rest_api_id = aws_api_gateway_rest_api.lambda_api.id\n  resource_id = aws_api_gateway_resource.proxy.id\n  http_method = aws_api_gateway_method.proxy_method.http_method\n  integration_http_method = \"POST\"\n  type                    = \"AWS_PROXY\"\n  uri                     = aws_lambda_function.main.invoke_arn\n}\n\nresource \"aws_lambda_permission\" \"apigw\" {\n  statement_id  = \"AllowAPIGatewayInvoke\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.main.function_name\n  principal     = \"apigateway.amazonaws.com\"\n  source_arn    = \"${aws_api_gateway_rest_api.lambda_api.execution_arn}/*/*\"\n}\n\nresource \"aws_api_gateway_deployment\" \"lambda_api_deployment\" {\n  depends_on = [aws_api_gateway_integration.lambda_integration]\n  rest_api_id = aws_api_gateway_rest_api.lambda_api.id\n}\n\nresource \"aws_api_gateway_stage\" \"prod\" {\n  stage_name    = \"prod\"\n  rest_api_id   = aws_api_gateway_rest_api.lambda_api.id\n  deployment_id = aws_api_gateway_deployment.lambda_api_deployment.id\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"lambda_function_name\" {\n  description = \"Name of the Lambda function.\"\n  value       = aws_lambda_function.main.function_name\n}\n\noutput \"lambda_function_arn\" {\n  description = \"ARN of the Lambda function.\"\n  value       = aws_lambda_function.main.arn\n}\n\noutput \"s3_bucket_name\" {\n  description = \"Name of the S3 bucket.\"\n  value       = aws_s3_bucket.lambda_bucket.bucket\n}\n\noutput \"api_gateway_invoke_url\" {\n  description = \"Invoke URL for the API Gateway.\"\n  value       = \"https://${aws_api_gateway_rest_api.lambda_api.id}.execute-api.${var.aws_region}.amazonaws.com/prod/\"\n}\n"
    }
  ]
}