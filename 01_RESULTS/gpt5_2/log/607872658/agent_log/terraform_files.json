{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = merge(\n      {\n        \"Project\"     = var.namespace\n        \"Environment\" = var.environment\n        \"ManagedBy\"   = \"terraform\"\n      },\n      var.tags\n    )\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n}\n\nvariable \"namespace\" {\n  description = \"Namespace / project name used for resource naming.\"\n  type        = string\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, staging, prod).\"\n  type        = string\n}\n\nvariable \"lambda_function_name\" {\n  description = \"Name of the Lambda function.\"\n  type        = string\n  default     = \"ssm_backup\"\n}\n\nvariable \"lambda_runtime\" {\n  description = \"Lambda runtime.\"\n  type        = string\n  default     = \"python3.11\"\n}\n\nvariable \"lambda_handler\" {\n  description = \"Lambda handler.\"\n  type        = string\n  default     = \"ssm_backup.lambda_handler\"\n}\n\nvariable \"lambda_timeout\" {\n  description = \"Lambda timeout in seconds.\"\n  type        = number\n  default     = 300\n}\n\nvariable \"lambda_memory_size\" {\n  description = \"Lambda memory size in MB.\"\n  type        = number\n  default     = 256\n}\n\nvariable \"lambda_log_retention_days\" {\n  description = \"CloudWatch Logs retention for the Lambda log group.\"\n  type        = number\n  default     = 30\n}\n\nvariable \"lambda_zip_path\" {\n  description = \"Path to the pre-built Lambda deployment package (zip).\"\n  type        = string\n  default     = \"../ssm_backup.zip\"\n}\n\nvariable \"schedule_expression\" {\n  description = \"EventBridge schedule expression. Example: rate(1 day) or cron(0 2 * * ? *).\"\n  type        = string\n  default     = \"rate(1 day)\"\n}\n\nvariable \"s3_backup_prefix\" {\n  description = \"S3 key prefix where backups are written. Must match the Lambda code (backups/).\"\n  type        = string\n  default     = \"backups/\"\n}\n\nvariable \"s3_force_destroy\" {\n  description = \"Whether to allow Terraform to destroy the bucket even if it contains objects.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"s3_lifecycle_expiration_days\" {\n  description = \"If set, expire backup objects after this many days. Set to null to disable.\"\n  type        = number\n  default     = 365\n}\n\nvariable \"kms_deletion_window_in_days\" {\n  description = \"KMS key deletion window in days.\"\n  type        = number\n  default     = 30\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply to all resources.\"\n  type        = map(string)\n  default     = {}\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_partition\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\nlocals {\n  name_prefix = \"${var.namespace}-${var.environment}\"\n}\n\n# -----------------------------\n# KMS key for S3 SSE-KMS\n# -----------------------------\nresource \"aws_kms_key\" \"backup\" {\n  description             = \"KMS key for SSM Parameter Store backups in S3\"\n  deletion_window_in_days = var.kms_deletion_window_in_days\n  enable_key_rotation     = true\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      # Allow account admins full access\n      {\n        Sid      = \"EnableIAMUserPermissions\"\n        Effect   = \"Allow\"\n        Principal = {\n          AWS = \"arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:root\"\n        }\n        Action   = \"kms:*\"\n        Resource = \"*\"\n      },\n      # Allow the Lambda execution role to use the key for SSE-KMS uploads\n      {\n        Sid    = \"AllowLambdaUseOfKey\"\n        Effect = \"Allow\"\n        Principal = {\n          AWS = aws_iam_role.lambda_exec.arn\n        }\n        Action = [\n          \"kms:Encrypt\",\n          \"kms:Decrypt\",\n          \"kms:ReEncrypt*\",\n          \"kms:GenerateDataKey*\",\n          \"kms:DescribeKey\"\n        ]\n        Resource = \"*\"\n      },\n      # Allow S3 to use the key for bucket default encryption\n      {\n        Sid    = \"AllowS3UseOfKey\"\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"s3.amazonaws.com\"\n        }\n        Action = [\n          \"kms:Encrypt\",\n          \"kms:Decrypt\",\n          \"kms:ReEncrypt*\",\n          \"kms:GenerateDataKey*\",\n          \"kms:DescribeKey\"\n        ]\n        Resource = \"*\"\n        Condition = {\n          StringEquals = {\n            \"aws:SourceAccount\" = data.aws_caller_identity.current.account_id\n          }\n          StringLike = {\n            \"aws:SourceArn\" = \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.backup.bucket}\"\n          }\n        }\n      }\n    ]\n  })\n}\n\nresource \"aws_kms_alias\" \"backup\" {\n  name          = \"alias/${local.name_prefix}-ssm-parameter-backup\"\n  target_key_id = aws_kms_key.backup.key_id\n}\n\n# -----------------------------\n# S3 bucket for backups\n# -----------------------------\nresource \"aws_s3_bucket\" \"backup\" {\n  bucket_prefix = \"${local.name_prefix}-ssm-parameter-backup-\"\n  force_destroy = var.s3_force_destroy\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"backup\" {\n  bucket                  = aws_s3_bucket.backup.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"backup\" {\n  bucket = aws_s3_bucket.backup.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"backup\" {\n  bucket = aws_s3_bucket.backup.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm     = \"aws:kms\"\n      kms_master_key_id = aws_kms_key.backup.arn\n    }\n  }\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"backup\" {\n  bucket = aws_s3_bucket.backup.id\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\nresource \"aws_s3_bucket_lifecycle_configuration\" \"backup\" {\n  count  = var.s3_lifecycle_expiration_days == null ? 0 : 1\n  bucket = aws_s3_bucket.backup.id\n\n  rule {\n    id     = \"expire-backups\"\n    status = \"Enabled\"\n\n    filter {\n      prefix = var.s3_backup_prefix\n    }\n\n    expiration {\n      days = var.s3_lifecycle_expiration_days\n    }\n\n    noncurrent_version_expiration {\n      noncurrent_days = var.s3_lifecycle_expiration_days\n    }\n  }\n}\n\n# Enforce SSE-KMS with the specific CMK for all uploads\nresource \"aws_s3_bucket_policy\" \"backup\" {\n  bucket = aws_s3_bucket.backup.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid       = \"DenyUnEncryptedObjectUploads\"\n        Effect    = \"Deny\"\n        Principal = \"*\"\n        Action    = \"s3:PutObject\"\n        Resource  = \"${aws_s3_bucket.backup.arn}/*\"\n        Condition = {\n          StringNotEquals = {\n            \"s3:x-amz-server-side-encryption\" = \"aws:kms\"\n          }\n        }\n      },\n      {\n        Sid       = \"DenyWrongKMSKey\"\n        Effect    = \"Deny\"\n        Principal = \"*\"\n        Action    = \"s3:PutObject\"\n        Resource  = \"${aws_s3_bucket.backup.arn}/*\"\n        Condition = {\n          StringNotEquals = {\n            \"s3:x-amz-server-side-encryption-aws-kms-key-id\" = aws_kms_key.backup.arn\n          }\n        }\n      }\n    ]\n  })\n\n  depends_on = [aws_s3_bucket_public_access_block.backup]\n}\n\n# -----------------------------\n# IAM for Lambda\n# -----------------------------\nresource \"aws_iam_role\" \"lambda_exec\" {\n  name_prefix = \"${local.name_prefix}-${var.lambda_function_name}-exec-\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"lambda.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_basic\" {\n  role       = aws_iam_role.lambda_exec.name\n  policy_arn = \"arn:${data.aws_partition.current.partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\n}\n\nresource \"aws_iam_policy\" \"lambda_custom\" {\n  name_prefix = \"${local.name_prefix}-${var.lambda_function_name}-\"\n  description = \"Least-privilege policy for SSM backup Lambda\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid    = \"SSMRead\"\n        Effect = \"Allow\"\n        Action = [\n          \"ssm:DescribeParameters\",\n          \"ssm:GetParameters\"\n        ]\n        Resource = \"*\"\n      },\n      {\n        Sid    = \"S3PutBackups\"\n        Effect = \"Allow\"\n        Action = [\n          \"s3:PutObject\"\n        ]\n        Resource = \"${aws_s3_bucket.backup.arn}/${var.s3_backup_prefix}*\"\n      },\n      {\n        Sid    = \"KMSForS3SSE\"\n        Effect = \"Allow\"\n        Action = [\n          \"kms:Encrypt\",\n          \"kms:GenerateDataKey\"\n        ]\n        Resource = aws_kms_key.backup.arn\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_custom\" {\n  role       = aws_iam_role.lambda_exec.name\n  policy_arn = aws_iam_policy.lambda_custom.arn\n}\n\n# -----------------------------\n# Lambda function\n# -----------------------------\nresource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${var.lambda_function_name}\"\n  retention_in_days = var.lambda_log_retention_days\n}\n\nresource \"aws_lambda_function\" \"ssm_backup\" {\n  function_name = var.lambda_function_name\n  role          = aws_iam_role.lambda_exec.arn\n  handler       = var.lambda_handler\n  runtime       = var.lambda_runtime\n\n  filename         = var.lambda_zip_path\n  source_code_hash = filebase64sha256(var.lambda_zip_path)\n\n  timeout     = var.lambda_timeout\n  memory_size = var.lambda_memory_size\n\n  environment {\n    variables = {\n      S3_BUCKET   = aws_s3_bucket.backup.bucket\n      KMS_KEY_ARN = aws_kms_key.backup.arn\n    }\n  }\n\n  depends_on = [aws_cloudwatch_log_group.lambda]\n}\n\n# -----------------------------\n# EventBridge schedule\n# -----------------------------\nresource \"aws_cloudwatch_event_rule\" \"daily\" {\n  name_prefix         = \"${local.name_prefix}-${var.lambda_function_name}-\"\n  description         = \"Schedule to run SSM Parameter Store backup Lambda\"\n  schedule_expression = var.schedule_expression\n}\n\nresource \"aws_cloudwatch_event_target\" \"lambda\" {\n  rule      = aws_cloudwatch_event_rule.daily.name\n  target_id = \"ssm-backup\"\n  arn       = aws_lambda_function.ssm_backup.arn\n}\n\nresource \"aws_lambda_permission\" \"allow_eventbridge\" {\n  statement_id  = \"AllowExecutionFromEventBridge\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.ssm_backup.function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.daily.arn\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"s3_bucket_name\" {\n  description = \"Name of the S3 bucket storing SSM backups.\"\n  value       = aws_s3_bucket.backup.bucket\n}\n\noutput \"kms_key_arn\" {\n  description = \"ARN of the KMS key used for SSE-KMS encryption.\"\n  value       = aws_kms_key.backup.arn\n}\n\noutput \"lambda_function_arn\" {\n  description = \"ARN of the backup Lambda function.\"\n  value       = aws_lambda_function.ssm_backup.arn\n}\n\noutput \"event_rule_arn\" {\n  description = \"ARN of the EventBridge rule that triggers the Lambda.\"\n  value       = aws_cloudwatch_event_rule.daily.arn\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region   = \"us-east-1\"\nnamespace    = \"myproject\"\nenvironment  = \"dev\"\n\n# schedule_expression = \"cron(0 2 * * ? *)\" # 02:00 UTC daily\n# s3_lifecycle_expiration_days = 365\n# s3_force_destroy = false\n"
    },
    {
      "name": "README.md",
      "content": "# Terraform - SSM Parameter Store Backup (Lambda)\n\nThis Terraform configuration provisions:\n- KMS CMK + alias\n- S3 bucket for backups (versioning, public access block, default SSE-KMS, bucket policy enforcing SSE-KMS)\n- Lambda function deployed from `../ssm_backup.zip`\n- IAM role/policies (least privilege)\n- EventBridge scheduled rule + target + lambda permission\n\n## Usage\n\n```bash\ncd ai_tf\nterraform init\nterraform apply -var-file=terraform.tfvars\n```\n\nCreate your `terraform.tfvars` from `terraform.tfvars.example`.\n\n## Notes\n- The Lambda code writes to `backups/` prefix; keep `var.s3_backup_prefix` aligned.\n- The Lambda uses `ServerSideEncryption='aws:kms'` and `SSEKMSKeyId` so the bucket policy enforces encryption.\n"
    }
  ]
}