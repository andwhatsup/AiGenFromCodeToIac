{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.4.5\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.27.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  # Auth is expected via environment (AWS_PROFILE) and mounted ~/.aws\n  # as described in the repository's docker-compose workflow.\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"ap-northeast-1\"\n}\n\nvariable \"name_prefix\" {\n  description = \"Prefix used for naming/tagging resources.\"\n  type        = string\n  default     = \"squid-proxy\"\n}\n\nvariable \"vpc_cidr\" {\n  description = \"CIDR block for the VPC.\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"public_subnet_cidr\" {\n  description = \"CIDR block for the public subnet.\"\n  type        = string\n  default     = \"10.0.1.0/24\"\n}\n\nvariable \"allowed_proxy_cidr\" {\n  description = \"Client public IP/CIDR allowed to access Squid on port 3128 (e.g., 203.0.113.10/32). Must match squid.conf ACL intent.\"\n  type        = string\n}\n\nvariable \"allowed_ssh_cidr\" {\n  description = \"Optional admin public IP/CIDR allowed to SSH (22). Set to null to disable SSH ingress.\"\n  type        = string\n  default     = null\n}\n\nvariable \"instance_type\" {\n  description = \"EC2 instance type for the Squid proxy.\"\n  type        = string\n  default     = \"t3.micro\"\n}\n\nvariable \"key_pair_name\" {\n  description = \"EC2 key pair name to create/use.\"\n  type        = string\n  default     = \"my-net-keypair\"\n}\n\nvariable \"public_key_path\" {\n  description = \"Path to an SSH public key to register as an EC2 key pair. If null, no key pair is created and SSH should be disabled.\"\n  type        = string\n  default     = null\n}\n\nvariable \"associate_eip\" {\n  description = \"Whether to allocate and associate an Elastic IP to the instance (stable public IP).\"\n  type        = bool\n  default     = false\n}\n\nvariable \"squid_conf_path\" {\n  description = \"Path to squid.conf to install on the instance.\"\n  type        = string\n  default     = \"../source/config/squid.conf\"\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply to resources.\"\n  type        = map(string)\n  default     = {}\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  az = data.aws_availability_zones.available.names[0]\n\n  common_tags = merge(\n    {\n      Project = var.name_prefix\n      Managed = \"terraform\"\n    },\n    var.tags\n  )\n}\n\nresource \"aws_vpc\" \"this\" {\n  cidr_block           = var.vpc_cidr\n  enable_dns_support   = true\n  enable_dns_hostnames = true\n\n  tags = merge(local.common_tags, { Name = \"${var.name_prefix}-vpc\" })\n}\n\nresource \"aws_internet_gateway\" \"this\" {\n  vpc_id = aws_vpc.this.id\n\n  tags = merge(local.common_tags, { Name = \"${var.name_prefix}-igw\" })\n}\n\nresource \"aws_subnet\" \"public\" {\n  vpc_id                  = aws_vpc.this.id\n  cidr_block              = var.public_subnet_cidr\n  availability_zone       = local.az\n  map_public_ip_on_launch = true\n\n  tags = merge(local.common_tags, { Name = \"${var.name_prefix}-public-${local.az}\" })\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.this.id\n\n  route {\n    cidr_block = \"0.0.0.0/0\"\n    gateway_id = aws_internet_gateway.this.id\n  }\n\n  tags = merge(local.common_tags, { Name = \"${var.name_prefix}-public-rt\" })\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  subnet_id      = aws_subnet.public.id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_security_group\" \"squid\" {\n  name        = \"${var.name_prefix}-sg\"\n  description = \"Security group for Squid proxy\"\n  vpc_id      = aws_vpc.this.id\n\n  ingress {\n    description = \"Squid proxy\"\n    from_port   = 3128\n    to_port     = 3128\n    protocol    = \"tcp\"\n    cidr_blocks = [var.allowed_proxy_cidr]\n  }\n\n  dynamic \"ingress\" {\n    for_each = var.allowed_ssh_cidr == null ? [] : [var.allowed_ssh_cidr]\n    content {\n      description = \"SSH\"\n      from_port   = 22\n      to_port     = 22\n      protocol    = \"tcp\"\n      cidr_blocks = [ingress.value]\n    }\n  }\n\n  egress {\n    description = \"Allow all egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = merge(local.common_tags, { Name = \"${var.name_prefix}-sg\" })\n}\n\n# Latest Amazon Linux 2 (x86_64) in the selected region.\ndata \"aws_ami\" \"al2\" {\n  most_recent = true\n  owners      = [\"amazon\"]\n\n  filter {\n    name   = \"name\"\n    values = [\"amzn2-ami-hvm-*-x86_64-gp2\"]\n  }\n\n  filter {\n    name   = \"state\"\n    values = [\"available\"]\n  }\n}\n\nresource \"aws_iam_role\" \"ec2\" {\n  name_prefix = \"${var.name_prefix}-ec2-\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"ec2.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n\n  tags = local.common_tags\n}\n\nresource \"aws_iam_role_policy_attachment\" \"ssm\" {\n  role       = aws_iam_role.ec2.name\n  policy_arn = \"arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\"\n}\n\nresource \"aws_iam_instance_profile\" \"ec2\" {\n  name_prefix = \"${var.name_prefix}-ip-\"\n  role        = aws_iam_role.ec2.name\n\n  tags = local.common_tags\n}\n\nresource \"aws_key_pair\" \"this\" {\n  count = var.public_key_path == null ? 0 : 1\n\n  key_name   = var.key_pair_name\n  public_key = file(var.public_key_path)\n\n  tags = local.common_tags\n}\n\nlocals {\n  squid_conf_rendered = replace(file(var.squid_conf_path), \"<my pc grobal ip address/32>\", var.allowed_proxy_cidr)\n\n  user_data = <<-EOF\n    #!/bin/bash\n    set -euo pipefail\n\n    timedatectl set-timezone Asia/Tokyo || true\n\n    yum update -y\n    yum install -y squid\n\n    cat > /etc/squid/squid.conf <<'SQUIDCONF'\n    ${local.squid_conf_rendered}\n    SQUIDCONF\n\n    systemctl enable squid\n    systemctl restart squid\n  EOF\n}\n\nresource \"aws_instance\" \"squid\" {\n  ami                         = data.aws_ami.al2.id\n  instance_type               = var.instance_type\n  subnet_id                   = aws_subnet.public.id\n  vpc_security_group_ids      = [aws_security_group.squid.id]\n  associate_public_ip_address = true\n  iam_instance_profile        = aws_iam_instance_profile.ec2.name\n\n  key_name = var.public_key_path == null ? null : aws_key_pair.this[0].key_name\n\n  user_data = local.user_data\n\n  metadata_options {\n    http_endpoint = \"enabled\"\n    http_tokens   = \"required\"\n  }\n\n  root_block_device {\n    encrypted   = true\n    volume_type = \"gp3\"\n    volume_size = 8\n  }\n\n  tags = merge(local.common_tags, { Name = \"${var.name_prefix}-ec2\" })\n}\n\nresource \"aws_eip\" \"this\" {\n  count  = var.associate_eip ? 1 : 0\n  domain = \"vpc\"\n\n  tags = merge(local.common_tags, { Name = \"${var.name_prefix}-eip\" })\n}\n\nresource \"aws_eip_association\" \"this\" {\n  count         = var.associate_eip ? 1 : 0\n  instance_id   = aws_instance.squid.id\n  allocation_id = aws_eip.this[0].id\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"vpc_id\" {\n  value       = aws_vpc.this.id\n  description = \"VPC ID\"\n}\n\noutput \"subnet_id\" {\n  value       = aws_subnet.public.id\n  description = \"Public subnet ID\"\n}\n\noutput \"security_group_id\" {\n  value       = aws_security_group.squid.id\n  description = \"Security group ID\"\n}\n\noutput \"ami_id\" {\n  value       = data.aws_ami.al2.id\n  description = \"AMI used for the instance\"\n}\n\noutput \"instance_id\" {\n  value       = aws_instance.squid.id\n  description = \"EC2 instance ID\"\n}\n\noutput \"public_ip\" {\n  value       = var.associate_eip ? aws_eip.this[0].public_ip : aws_instance.squid.public_ip\n  description = \"Public IP of the proxy (EIP if enabled, otherwise instance public IP)\"\n}\n\noutput \"public_dns\" {\n  value       = aws_instance.squid.public_dns\n  description = \"Public DNS name of the instance\"\n}\n\noutput \"proxy_endpoint\" {\n  value       = \"${var.associate_eip ? aws_eip.this[0].public_ip : aws_instance.squid.public_ip}:3128\"\n  description = \"Convenience endpoint for configuring clients\"\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "# Required: set to your client public IP/CIDR\nallowed_proxy_cidr = \"203.0.113.10/32\"\n\n# Optional: allow SSH from your admin IP/CIDR (or leave null to disable)\nallowed_ssh_cidr = \"203.0.113.10/32\"\n\n# Optional: create key pair from your public key (recommended)\n# public_key_path = \"../source/.security/my-net-keypair.id_rsa.pub\"\n\naws_region   = \"ap-northeast-1\"\nname_prefix  = \"squid-proxy\"\nassociate_eip = false\n"
    },
    {
      "name": "README_TERRAFORM.md",
      "content": "# Terraform (ai_tf)\n\nThis Terraform config provisions:\n- VPC + 1 public subnet + IGW + public route table\n- Security group allowing TCP/3128 only from `allowed_proxy_cidr`\n- Optional SSH (22) from `allowed_ssh_cidr`\n- Amazon Linux 2 EC2 instance running Squid (installed via user_data)\n- Optional Elastic IP\n\n## Usage\n\n1. Copy and edit variables:\n\n```bash\ncp terraform.tfvars.example terraform.tfvars\n```\n\n2. Ensure `allowed_proxy_cidr` matches your public IP (and the Squid ACL will be rendered accordingly).\n\n3. Run:\n\n```bash\nterraform init\nterraform validate\nterraform plan\nterraform apply\n```\n\nOutputs include `public_ip`, `public_dns`, and `proxy_endpoint`.\n"
    }
  ]
}