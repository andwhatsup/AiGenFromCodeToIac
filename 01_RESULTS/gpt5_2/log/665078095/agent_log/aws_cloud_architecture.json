{
  "aws_architecture_description": "### Target outcome\nThis repo is **not an application runtime**; it’s a **database schema + migrations toolchain** (Atlas + SQL migrations) that must be executed in a controlled way against a **production MySQL database on AWS**. The AWS architecture therefore centers on:\n1) a secure **Amazon RDS for MySQL** deployment, and\n2) a **CI/CD-driven “migrations runner”** that builds the Atlas container image and runs it with least-privilege network access to the DB.\n\n---\n\n## High-level AWS architecture\n\n### 1) Networking (secure-by-default)\n- Create a dedicated **VPC** spanning **2–3 Availability Zones**.\n- **Private subnets** in each AZ host the database (no public IPs).\n- **Public subnets** only host ingress/egress components (e.g., NAT Gateways) if needed.\n- Use **VPC endpoints** (Interface/Gateway) so CI/CD and runners can reach AWS services (ECR, CloudWatch Logs, Secrets Manager, S3) without traversing the public internet where possible.\n\n**Connectivity patterns (choose one):**\n- **Preferred (fully managed runner):** Run migrations as an **ECS Fargate task** in private subnets. It pulls the migrations image from ECR and connects to RDS over the VPC.\n- **If you need GitHub Actions / external CI:** Keep CI external, but run the *apply* step on AWS (ECS task) triggered by the pipeline. This avoids opening the DB to the internet.\n\n---\n\n### 2) Container image for migrations (Atlas toolchain)\n- Store the built migrations image (Dockerfile based on `arigaio/atlas`) in **Amazon ECR**.\n- CI builds and pushes a versioned image (e.g., git SHA tag) to ECR.\n\n---\n\n### 3) CI/CD orchestration (build + controlled apply)\nA lean, AWS-native approach:\n- **AWS CodePipeline** orchestrates stages:\n  1. **Source**: Git repository (CodeCommit or GitHub connection).\n  2. **Build**: **CodeBuild** builds the Docker image and pushes to ECR.\n  3. **Deploy/Migrate**: CodeBuild (or a dedicated step) triggers an **ECS Fargate RunTask** to execute `atlas migrate apply` against the target environment.\n\n**Environment separation:**\n- Use separate Atlas envs (e.g., `staging`, `prod`) with different DB endpoints and secrets.\n- Require a **manual approval** step before production migrations.\n\n---\n\n### 4) Production database (Amazon RDS for MySQL)\n- Deploy **Amazon RDS for MySQL 8.x** in **private subnets** with a **DB subnet group** across at least two AZs.\n- Enable:\n  - **Multi-AZ** (for production availability)\n  - **Automated backups** + retention\n  - **Encryption at rest** (KMS)\n  - **Performance Insights** (optional but common)\n- Restrict inbound access with a **DB security group** that only allows MySQL (3306) from the migrations runner security group (ECS tasks / CodeBuild VPC SG).\n\n---\n\n### 5) Secrets and configuration\n- Store DB credentials and connection info in **AWS Secrets Manager**.\n- The migrations runner retrieves secrets at runtime using an **IAM task role** (ECS) or **CodeBuild service role**.\n- Avoid embedding credentials in `atlas.hcl`; instead, inject via environment variables or runtime config.\n\n---\n\n### 6) Observability and audit\n- Send migrations runner logs to **CloudWatch Logs** (ECS log driver / CodeBuild logs).\n- Enable **CloudTrail** for audit of changes (who ran migrations, who changed secrets, etc.).\n- Optional: publish pipeline notifications to **SNS**.\n\n---\n\n## Deployment strategy (practical)\n- **Dev:** developers continue using local Docker MySQL (`docker://mysql/8/dev`).\n- **Staging (recommended):** an RDS instance (smaller) + same pipeline, auto-apply on merge to main.\n- **Prod:** same pipeline, but gated by manual approval; migrations run as an ECS one-off task in private subnets.\n\n---\n\n# AWS resources to provision\n\n## Core networking\n- Amazon VPC\n- Public subnets (2–3 AZs)\n- Private subnets (2–3 AZs)\n- Route tables (public/private) + routes\n- Internet Gateway (for public subnets)\n- NAT Gateway(s) + Elastic IP(s) (if private subnets need outbound internet)\n- VPC Endpoints:\n  - Interface endpoints: ECR (api + dkr), CloudWatch Logs, Secrets Manager, STS (commonly used)\n  - Gateway endpoint: S3 (for artifacts/logs if needed)\n- Security Groups:\n  - RDS security group\n  - ECS task / migrations runner security group\n  - (If CodeBuild runs in VPC) CodeBuild security group\n\n## Container registry\n- Amazon ECR repository (migrations image)\n- ECR lifecycle policy (cleanup old tags)\n\n## Migrations execution (recommended: ECS Fargate)\n- Amazon ECS cluster\n- ECS task definition (Atlas migrations container)\n- ECS task execution role (pull from ECR, write logs)\n- ECS task role (read Secrets Manager, decrypt with KMS)\n- ECS service (optional; typically **not** needed—use one-off RunTask)\n- CloudWatch Log Group for ECS task logs\n\n## CI/CD\n- AWS CodePipeline\n- AWS CodeBuild project(s):\n  - Build/push image to ECR\n  - Trigger/run migrations (or invoke ECS RunTask)\n- CodeStar Connections (if using GitHub as source)\n- S3 bucket for pipeline artifacts\n- IAM roles/policies:\n  - CodePipeline service role\n  - CodeBuild service role\n  - Permissions to ECR, ECS RunTask, CloudWatch Logs, S3 artifacts, Secrets Manager\n- (Optional) Manual approval action in CodePipeline\n\n## Database\n- Amazon RDS for MySQL (DB instance or Aurora MySQL-compatible if you choose)\n- DB Subnet Group\n- RDS Parameter Group (optional; for MySQL tuning)\n- RDS Option Group (optional)\n- KMS key (for RDS encryption and/or Secrets Manager encryption)\n- AWS Secrets Manager secret (DB master credentials and/or app user credentials)\n\n## Monitoring, audit, notifications\n- Amazon CloudWatch Logs (for CodeBuild and ECS)\n- Amazon CloudWatch Alarms (RDS CPU, storage, connections; pipeline failures)\n- AWS CloudTrail\n- (Optional) Amazon SNS topic (pipeline/migration notifications)\n\n---\n\nIf you tell me whether you want **AWS-native CI/CD (CodePipeline/CodeBuild)** or you’re using **GitHub Actions**, I can tailor the runner pattern (ECS task vs CodeBuild-in-VPC) and tighten the resource list further.",
  "aws_resources": [
    "Amazon VPC",
    "Public Subnets (multi-AZ)",
    "Private Subnets (multi-AZ)",
    "Internet Gateway (IGW)",
    "NAT Gateway(s) + Elastic IP(s)",
    "Route Tables (public/private) + Routes",
    "VPC Interface Endpoints (ECR api, ECR dkr, CloudWatch Logs, Secrets Manager, STS)",
    "VPC Gateway Endpoint (S3)",
    "Security Group (RDS)",
    "Security Group (Migrations Runner: ECS/CodeBuild)",
    "Amazon ECR Repository",
    "ECR Lifecycle Policy",
    "Amazon ECS Cluster",
    "ECS Fargate Task Definition (Atlas migrations container)",
    "IAM Role (ECS Task Execution Role)",
    "IAM Role (ECS Task Role)",
    "CloudWatch Log Group (ECS task logs)",
    "AWS CodePipeline",
    "AWS CodeBuild Project (build & push image)",
    "AWS CodeBuild Project or Step (trigger/run migrations)",
    "S3 Bucket (pipeline artifacts)",
    "IAM Role (CodePipeline service role)",
    "IAM Role (CodeBuild service role)",
    "CodeStar Connection (if using GitHub)",
    "Amazon RDS for MySQL DB Instance (MySQL 8.x)",
    "RDS DB Subnet Group",
    "RDS Parameter Group (optional)",
    "RDS Option Group (optional)",
    "AWS Secrets Manager Secret (DB credentials/connection)",
    "AWS KMS Key (encryption for RDS/Secrets)",
    "Amazon CloudWatch Alarms (RDS + pipeline)",
    "AWS CloudTrail",
    "Amazon SNS Topic (optional notifications)"
  ]
}