{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n    archive = {\n      source  = \"hashicorp/archive\"\n      version = \"~> 2.4\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = {\n      Project     = var.project_name\n      Environment = var.environment\n      ManagedBy   = \"terraform\"\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for resources.\"\n  type        = string\n  default     = \"venmo-action-automation\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, prod).\"\n  type        = string\n  default     = \"prod\"\n}\n\nvariable \"lambda_runtime\" {\n  description = \"Lambda runtime.\"\n  type        = string\n  default     = \"python3.12\"\n}\n\nvariable \"lambda_timeout_seconds\" {\n  description = \"Lambda timeout in seconds.\"\n  type        = number\n  default     = 30\n}\n\nvariable \"lambda_memory_mb\" {\n  description = \"Lambda memory size in MB.\"\n  type        = number\n  default     = 128\n}\n\nvariable \"log_retention_days\" {\n  description = \"CloudWatch log retention for the Lambda log group.\"\n  type        = number\n  default     = 30\n}\n\nvariable \"alarm_email\" {\n  description = \"Email address to subscribe to the SNS alerts topic. You must confirm the subscription email.\"\n  type        = string\n}\n\nvariable \"venmo_auth_token\" {\n  description = \"Venmo API auth token. Stored in Secrets Manager and injected into Lambda as an environment variable.\"\n  type        = string\n  sensitive   = true\n}\n\nvariable \"venmo_schedules\" {\n  description = <<EOT\nList of schedules to create. Each schedule invokes the Lambda with the provided JSON payload.\n\nExample:\n[\n  {\n    name            = \"NetflixSubscriptionRequest\"\n    description     = \"Schedule for monthly Netflix subscription request\"\n    cron_expression = \"cron(0 12 5 * ? *)\"\n    payload = jsonencode({\n      amount              = 7.50\n      action              = \"request\"\n      note                = \"Netflix subscription\"\n      recipient_user_name = \"RecipientVenmoUserName\"\n    })\n  }\n]\nEOT\n\n  type = list(object({\n    name            = string\n    description     = string\n    cron_expression = string\n    payload         = string\n  }))\n\n  default = []\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n}\n\n# Package Lambda code (handler.py + requirements.txt dependencies)\n# Uses the repository-provided script.\nresource \"null_resource\" \"package_lambda\" {\n  triggers = {\n    handler_sha      = filesha256(\"${path.module}/../handler.py\")\n    requirements_sha = filesha256(\"${path.module}/../requirements.txt\")\n    script_sha       = filesha256(\"${path.module}/../package_lambda.sh\")\n  }\n\n  provisioner \"local-exec\" {\n    command     = \"bash ${path.module}/../package_lambda.sh\"\n    working_dir = path.module\n  }\n}\n\ndata \"archive_file\" \"lambda_zip\" {\n  type        = \"zip\"\n  source_file = \"${path.module}/../handler.zip\"\n  output_path = \"${path.module}/../handler.zip\"\n\n  depends_on = [null_resource.package_lambda]\n}\n\n# Secrets Manager secret for Venmo token\nresource \"aws_secretsmanager_secret\" \"venmo_auth_token\" {\n  name                    = \"${local.name_prefix}/venmo/auth_token\"\n  recovery_window_in_days = 0\n}\n\nresource \"aws_secretsmanager_secret_version\" \"venmo_auth_token\" {\n  secret_id     = aws_secretsmanager_secret.venmo_auth_token.id\n  secret_string = var.venmo_auth_token\n}\n\n# IAM role for Lambda\ndata \"aws_iam_policy_document\" \"lambda_assume\" {\n  statement {\n    effect = \"Allow\"\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"lambda_exec\" {\n  name               = \"${local.name_prefix}-lambda-exec\"\n  assume_role_policy = data.aws_iam_policy_document.lambda_assume.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_basic\" {\n  role       = aws_iam_role.lambda_exec.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\n}\n\ndata \"aws_iam_policy_document\" \"lambda_secrets\" {\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"secretsmanager:GetSecretValue\",\n      \"secretsmanager:DescribeSecret\"\n    ]\n    resources = [aws_secretsmanager_secret.venmo_auth_token.arn]\n  }\n}\n\nresource \"aws_iam_policy\" \"lambda_secrets\" {\n  name   = \"${local.name_prefix}-lambda-secrets\"\n  policy = data.aws_iam_policy_document.lambda_secrets.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_secrets\" {\n  role       = aws_iam_role.lambda_exec.name\n  policy_arn = aws_iam_policy.lambda_secrets.arn\n}\n\n# CloudWatch log group with retention (created explicitly so retention is enforced)\nresource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${local.name_prefix}\"\n  retention_in_days = var.log_retention_days\n}\n\nresource \"aws_lambda_function\" \"venmo\" {\n  function_name = local.name_prefix\n  description   = \"Scheduled Venmo payment/request automation\"\n\n  role    = aws_iam_role.lambda_exec.arn\n  handler = \"handler.handler\"\n  runtime = var.lambda_runtime\n\n  filename         = data.archive_file.lambda_zip.output_path\n  source_code_hash = data.archive_file.lambda_zip.output_base64sha256\n\n  timeout      = var.lambda_timeout_seconds\n  memory_size  = var.lambda_memory_mb\n  publish      = true\n\n  environment {\n    variables = {\n      # handler.py expects VENMO_AUTH_TOKEN in env\n      VENMO_AUTH_TOKEN = aws_secretsmanager_secret_version.venmo_auth_token.secret_string\n    }\n  }\n\n  depends_on = [aws_cloudwatch_log_group.lambda]\n}\n\nresource \"aws_lambda_alias\" \"prod\" {\n  name             = \"prod\"\n  description      = \"Stable alias for scheduled invocations\"\n  function_name    = aws_lambda_function.venmo.function_name\n  function_version = aws_lambda_function.venmo.version\n}\n\n# EventBridge Scheduler group\nresource \"aws_scheduler_schedule_group\" \"this\" {\n  name = \"${local.name_prefix}-schedules\"\n}\n\n# IAM role used by EventBridge Scheduler to invoke the Lambda alias\ndata \"aws_iam_policy_document\" \"scheduler_assume\" {\n  statement {\n    effect = \"Allow\"\n    principals {\n      type        = \"Service\"\n      identifiers = [\"scheduler.amazonaws.com\"]\n    }\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"scheduler_invoke\" {\n  name               = \"${local.name_prefix}-scheduler-invoke\"\n  assume_role_policy = data.aws_iam_policy_document.scheduler_assume.json\n}\n\ndata \"aws_iam_policy_document\" \"scheduler_invoke\" {\n  statement {\n    effect    = \"Allow\"\n    actions   = [\"lambda:InvokeFunction\"]\n    resources = [aws_lambda_alias.prod.arn]\n  }\n}\n\nresource \"aws_iam_policy\" \"scheduler_invoke\" {\n  name   = \"${local.name_prefix}-scheduler-invoke\"\n  policy = data.aws_iam_policy_document.scheduler_invoke.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"scheduler_invoke\" {\n  role       = aws_iam_role.scheduler_invoke.name\n  policy_arn = aws_iam_policy.scheduler_invoke.arn\n}\n\n# Allow scheduler service principal to invoke the alias (resource-based policy)\nresource \"aws_lambda_permission\" \"allow_scheduler\" {\n  statement_id  = \"AllowExecutionFromEventBridgeScheduler\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.venmo.function_name\n  qualifier     = aws_lambda_alias.prod.name\n  principal     = \"scheduler.amazonaws.com\"\n}\n\n# Create one schedule per entry\nresource \"aws_scheduler_schedule\" \"venmo\" {\n  for_each = { for s in var.venmo_schedules : s.name => s }\n\n  name        = each.value.name\n  group_name  = aws_scheduler_schedule_group.this.name\n  description = each.value.description\n\n  schedule_expression          = each.value.cron_expression\n  schedule_expression_timezone = \"UTC\"\n\n  flexible_time_window {\n    mode = \"OFF\"\n  }\n\n  target {\n    arn      = aws_lambda_alias.prod.arn\n    role_arn = aws_iam_role.scheduler_invoke.arn\n    input    = each.value.payload\n  }\n}\n\n# SNS topic for alerts\nresource \"aws_sns_topic\" \"alerts\" {\n  name = \"${local.name_prefix}-alerts\"\n}\n\nresource \"aws_sns_topic_subscription\" \"email\" {\n  topic_arn = aws_sns_topic.alerts.arn\n  protocol  = \"email\"\n  endpoint  = var.alarm_email\n}\n\n# CloudWatch alarm on Lambda errors\nresource \"aws_cloudwatch_metric_alarm\" \"lambda_errors\" {\n  alarm_name          = \"${local.name_prefix}-lambda-errors\"\n  alarm_description   = \"Alarm when the Venmo automation Lambda reports errors\"\n  comparison_operator = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods  = 1\n  metric_name         = \"Errors\"\n  namespace           = \"AWS/Lambda\"\n  period              = 300\n  statistic           = \"Sum\"\n  threshold           = 1\n  treat_missing_data  = \"notBreaching\"\n\n  dimensions = {\n    FunctionName = aws_lambda_function.venmo.function_name\n  }\n\n  alarm_actions = [aws_sns_topic.alerts.arn]\n  ok_actions    = [aws_sns_topic.alerts.arn]\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"lambda_function_name\" {\n  value       = aws_lambda_function.venmo.function_name\n  description = \"Name of the Lambda function.\"\n}\n\noutput \"lambda_alias_arn\" {\n  value       = aws_lambda_alias.prod.arn\n  description = \"ARN of the Lambda alias used by schedules.\"\n}\n\noutput \"sns_topic_arn\" {\n  value       = aws_sns_topic.alerts.arn\n  description = \"SNS topic ARN for alerts.\"\n}\n\noutput \"schedule_group_name\" {\n  value       = aws_scheduler_schedule_group.this.name\n  description = \"EventBridge Scheduler schedule group name.\"\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region   = \"us-east-1\"\nproject_name = \"venmo-action-automation\"\nenvironment  = \"prod\"\n\n# Required\nalarm_email      = \"you@example.com\"\nvenmo_auth_token = \"paste-your-venmo-token-here\"\n\n# Define one or more schedules\nvenmo_schedules = [\n  {\n    name            = \"NetflixSubscriptionRequest\"\n    description     = \"Schedule for monthly Netflix subscription request\"\n    cron_expression = \"cron(0 12 5 * ? *)\"\n    payload = jsonencode({\n      amount              = 7.50\n      action              = \"request\"\n      note                = \"Netflix subscription\"\n      recipient_user_name = \"RecipientVenmoUserName\"\n    })\n  }\n]\n"
    }
  ]
}