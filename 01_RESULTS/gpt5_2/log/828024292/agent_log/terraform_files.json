{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = {\n      Project     = var.project_name\n      Environment = var.environment\n      ManagedBy   = \"terraform\"\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for resource naming.\"\n  type        = string\n  default     = \"awsS3BucketList\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, staging, prod).\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"artifact_bucket_name\" {\n  description = \"Optional explicit name for the S3 artifact bucket. Leave null to have Terraform generate a unique name.\"\n  type        = string\n  default     = null\n}\n\nvariable \"enable_codebuild\" {\n  description = \"Whether to create an optional CodeBuild project that can run the CLI on-demand (or via schedule).\"\n  type        = bool\n  default     = false\n}\n\nvariable \"codebuild_schedule_expression\" {\n  description = \"Optional EventBridge schedule expression to trigger CodeBuild (only used when enable_codebuild=true). Example: rate(1 day)\"\n  type        = string\n  default     = null\n}\n\nvariable \"codebuild_image\" {\n  description = \"Docker image for CodeBuild environment.\"\n  type        = string\n  default     = \"aws/codebuild/standard:7.0\"\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_partition\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\nresource \"aws_kms_key\" \"artifacts\" {\n  description             = \"KMS key for encrypting ${var.project_name} artifacts\"\n  deletion_window_in_days = 7\n  enable_key_rotation     = true\n}\n\nresource \"aws_kms_alias\" \"artifacts\" {\n  name          = \"alias/${var.project_name}-${var.environment}-artifacts\"\n  target_key_id = aws_kms_key.artifacts.key_id\n}\n\nresource \"aws_s3_bucket\" \"artifacts\" {\n  bucket        = var.artifact_bucket_name\n  force_destroy = false\n}\n\nresource \"aws_s3_bucket_versioning\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm     = \"aws:kms\"\n      kms_master_key_id = aws_kms_key.artifacts.arn\n    }\n    bucket_key_enabled = true\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\nresource \"aws_s3_bucket_lifecycle_configuration\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  rule {\n    id     = \"noncurrent-versions\"\n    status = \"Enabled\"\n\n    noncurrent_version_expiration {\n      noncurrent_days = 90\n    }\n\n    abort_incomplete_multipart_upload {\n      days_after_initiation = 7\n    }\n  }\n}\n\n# Optional: role intended for running the CLI in AWS-hosted environments (e.g., CodeBuild).\n# It grants only the permissions required by the app: list buckets and identify caller.\nresource \"aws_iam_role\" \"cli_execution\" {\n  name_prefix = \"${var.project_name}-${var.environment}-cli-\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"codebuild.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_policy\" \"cli_execution\" {\n  name_prefix = \"${var.project_name}-${var.environment}-cli-\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid    = \"ListBuckets\"\n        Effect = \"Allow\"\n        Action = [\n          \"s3:ListAllMyBuckets\"\n        ]\n        Resource = \"*\"\n      },\n      {\n        Sid    = \"GetCallerIdentity\"\n        Effect = \"Allow\"\n        Action = [\n          \"sts:GetCallerIdentity\"\n        ]\n        Resource = \"*\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"cli_execution\" {\n  role       = aws_iam_role.cli_execution.name\n  policy_arn = aws_iam_policy.cli_execution.arn\n}\n\nresource \"aws_cloudwatch_log_group\" \"codebuild\" {\n  count             = var.enable_codebuild ? 1 : 0\n  name              = \"/aws/codebuild/${var.project_name}-${var.environment}\"\n  retention_in_days = 30\n}\n\nresource \"aws_codebuild_project\" \"run_cli\" {\n  count        = var.enable_codebuild ? 1 : 0\n  name         = \"${var.project_name}-${var.environment}-run\"\n  description  = \"Optional on-demand execution of the ${var.project_name} CLI\"\n  service_role = aws_iam_role.cli_execution.arn\n\n  artifacts {\n    type = \"NO_ARTIFACTS\"\n  }\n\n  environment {\n    compute_type                = \"BUILD_GENERAL1_SMALL\"\n    image                       = var.codebuild_image\n    type                        = \"LINUX_CONTAINER\"\n    image_pull_credentials_type = \"CODEBUILD\"\n\n    environment_variable {\n      name  = \"AWS_REGION\"\n      value = var.aws_region\n    }\n  }\n\n  logs_config {\n    cloudwatch_logs {\n      group_name  = aws_cloudwatch_log_group.codebuild[0].name\n      stream_name = \"build\"\n    }\n  }\n\n  source {\n    type      = \"NO_SOURCE\"\n    buildspec = <<-YAML\n      version: 0.2\n      phases:\n        build:\n          commands:\n            - echo \"This project is a placeholder. Provide a buildspec that downloads your binary from S3 and runs it.\"\n            - aws sts get-caller-identity\n            - aws s3api list-buckets --query 'Buckets[].Name'\n      YAML\n  }\n}\n\nresource \"aws_iam_role\" \"events_invoke_codebuild\" {\n  count       = var.enable_codebuild && var.codebuild_schedule_expression != null ? 1 : 0\n  name_prefix = \"${var.project_name}-${var.environment}-events-\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"events.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"events_invoke_codebuild\" {\n  count = var.enable_codebuild && var.codebuild_schedule_expression != null ? 1 : 0\n  role  = aws_iam_role.events_invoke_codebuild[0].id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"codebuild:StartBuild\"\n        ]\n        Resource = aws_codebuild_project.run_cli[0].arn\n      }\n    ]\n  })\n}\n\nresource \"aws_cloudwatch_event_rule\" \"schedule\" {\n  count               = var.enable_codebuild && var.codebuild_schedule_expression != null ? 1 : 0\n  name                = \"${var.project_name}-${var.environment}-schedule\"\n  schedule_expression = var.codebuild_schedule_expression\n}\n\nresource \"aws_cloudwatch_event_target\" \"schedule_codebuild\" {\n  count     = var.enable_codebuild && var.codebuild_schedule_expression != null ? 1 : 0\n  rule      = aws_cloudwatch_event_rule.schedule[0].name\n  target_id = \"codebuild\"\n  arn       = aws_codebuild_project.run_cli[0].arn\n  role_arn  = aws_iam_role.events_invoke_codebuild[0].arn\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"artifact_bucket_name\" {\n  description = \"S3 bucket for storing built binaries/artifacts.\"\n  value       = aws_s3_bucket.artifacts.bucket\n}\n\noutput \"artifact_bucket_arn\" {\n  description = \"ARN of the artifact bucket.\"\n  value       = aws_s3_bucket.artifacts.arn\n}\n\noutput \"artifact_kms_key_arn\" {\n  description = \"KMS key ARN used for artifact bucket encryption.\"\n  value       = aws_kms_key.artifacts.arn\n}\n\noutput \"cli_execution_role_arn\" {\n  description = \"IAM role ARN intended for AWS-hosted execution (e.g., CodeBuild).\"\n  value       = aws_iam_role.cli_execution.arn\n}\n\noutput \"codebuild_project_name\" {\n  description = \"Optional CodeBuild project name (null if disabled).\"\n  value       = var.enable_codebuild ? aws_codebuild_project.run_cli[0].name : null\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region   = \"us-east-1\"\nproject_name = \"awsS3BucketList\"\nenvironment  = \"dev\"\n\n# artifact_bucket_name = \"my-unique-artifact-bucket-name\"\n\n# Optional managed execution (disabled by default)\n# enable_codebuild = true\n# codebuild_schedule_expression = \"rate(1 day)\"\n"
    }
  ]
}