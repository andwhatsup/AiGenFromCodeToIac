{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = var.tags\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into. Must match the REGION env var used by the iterator Lambda.\"\n  type        = string\n}\n\nvariable \"name_prefix\" {\n  description = \"Prefix used for naming AWS resources.\"\n  type        = string\n  default     = \"hfl\"\n}\n\nvariable \"target_lambda_arn\" {\n  description = \"ARN of the target Lambda function to invoke asynchronously.\"\n  type        = string\n}\n\nvariable \"artifact_bucket_name\" {\n  description = \"S3 bucket containing the iterator Lambda deployment package (iterator.zip).\"\n  type        = string\n}\n\nvariable \"artifact_key\" {\n  description = \"S3 key for the iterator Lambda deployment package.\"\n  type        = string\n  default     = \"iterator.zip\"\n}\n\nvariable \"artifact_object_version\" {\n  description = \"Optional S3 object version for immutable deployments. If null, latest is used.\"\n  type        = string\n  default     = null\n}\n\nvariable \"lambda_runtime\" {\n  description = \"Lambda runtime for the iterator. Use provided.al2 for Go custom runtime (zip contains 'bootstrap') or go1.x for legacy.\"\n  type        = string\n  default     = \"provided.al2\"\n}\n\nvariable \"lambda_handler\" {\n  description = \"Lambda handler. For provided.al2, use 'bootstrap'. For go1.x, use the binary name (e.g., 'iterator').\"\n  type        = string\n  default     = \"bootstrap\"\n}\n\nvariable \"lambda_memory_size\" {\n  description = \"Memory size (MB) for iterator Lambda.\"\n  type        = number\n  default     = 128\n}\n\nvariable \"lambda_timeout\" {\n  description = \"Timeout (seconds) for iterator Lambda.\"\n  type        = number\n  default     = 10\n}\n\nvariable \"lambda_reserved_concurrency\" {\n  description = \"Optional reserved concurrency for iterator Lambda to cap cost and protect downstream. Set null to disable.\"\n  type        = number\n  default     = 5\n}\n\nvariable \"log_retention_days\" {\n  description = \"CloudWatch log retention in days.\"\n  type        = number\n  default     = 14\n}\n\nvariable \"sfn_count\" {\n  description = \"How many iterations the Step Functions loop should run (definition.json uses count=6 by default).\"\n  type        = number\n  default     = 6\n}\n\nvariable \"sfn_wait_seconds\" {\n  description = \"Wait time between iterator invocations.\"\n  type        = number\n  default     = 10\n}\n\nvariable \"enable_async_failure_destination\" {\n  description = \"If true, configure an SQS DLQ as async failure destination for the iterator Lambda.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"tags\" {\n  description = \"Tags to apply to all resources.\"\n  type        = map(string)\n  default     = {}\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_partition\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\nlocals {\n  iterator_name      = \"${var.name_prefix}-iterator\"\n  state_machine_name = \"${var.name_prefix}-iterator-sfn\"\n\n  # Step Functions definition based on repo's definition.json, but parameterized.\n  sfn_definition = jsonencode({\n    Comment = \"Invoke Lambda every ${var.sfn_wait_seconds} seconds\"\n    StartAt = \"ConfigureCount\"\n    States = {\n      ConfigureCount = {\n        Type = \"Pass\"\n        Result = {\n          index = 0\n          count = var.sfn_count\n        }\n        ResultPath = \"$.iterator\"\n        Next       = \"Iterator\"\n      }\n      Iterator = {\n        Type       = \"Task\"\n        Resource   = \"arn:${data.aws_partition.current.partition}:states:::lambda:invoke\"\n        ResultPath = \"$.iterator\"\n        Parameters = {\n          FunctionName = aws_lambda_function.iterator.arn\n          Payload      = \"{}\"\n        }\n        Next = \"IsCountReached\"\n      }\n      IsCountReached = {\n        Type = \"Choice\"\n        Choices = [\n          {\n            Variable      = \"$.iterator.Payload.continue\"\n            BooleanEquals = true\n            Next          = \"Wait\"\n          }\n        ]\n        Default = \"Done\"\n      }\n      Wait = {\n        Type    = \"Wait\"\n        Seconds = var.sfn_wait_seconds\n        Next    = \"Iterator\"\n      }\n      Done = {\n        Type = \"Pass\"\n        End  = true\n      }\n    }\n  })\n}\n\n# -----------------------------\n# CloudWatch Logs\n# -----------------------------\nresource \"aws_cloudwatch_log_group\" \"iterator\" {\n  name              = \"/aws/lambda/${local.iterator_name}\"\n  retention_in_days = var.log_retention_days\n}\n\nresource \"aws_cloudwatch_log_group\" \"sfn\" {\n  name              = \"/aws/vendedlogs/states/${local.state_machine_name}\"\n  retention_in_days = var.log_retention_days\n}\n\n# -----------------------------\n# IAM: Iterator Lambda role\n# -----------------------------\nresource \"aws_iam_role\" \"iterator\" {\n  name               = \"${local.iterator_name}-role\"\n  assume_role_policy = file(\"${path.module}/../assume_role_policy.json\")\n}\n\nresource \"aws_iam_role_policy\" \"iterator\" {\n  name = \"${local.iterator_name}-policy\"\n  role = aws_iam_role.iterator.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid    = \"AllowLogs\"\n        Effect = \"Allow\"\n        Action = [\n          \"logs:CreateLogStream\",\n          \"logs:PutLogEvents\"\n        ]\n        Resource = \"${aws_cloudwatch_log_group.iterator.arn}:*\"\n      },\n      {\n        Sid    = \"AllowInvokeTarget\"\n        Effect = \"Allow\"\n        Action = [\n          \"lambda:InvokeFunction\"\n        ]\n        Resource = var.target_lambda_arn\n      }\n    ]\n  })\n}\n\n# -----------------------------\n# Lambda: Iterator/Dispatcher\n# -----------------------------\nresource \"aws_lambda_function\" \"iterator\" {\n  function_name = local.iterator_name\n  role          = aws_iam_role.iterator.arn\n\n  s3_bucket         = var.artifact_bucket_name\n  s3_key            = var.artifact_key\n  s3_object_version = var.artifact_object_version\n\n  runtime = var.lambda_runtime\n  handler = var.lambda_handler\n\n  memory_size = var.lambda_memory_size\n  timeout     = var.lambda_timeout\n\n  reserved_concurrent_executions = var.lambda_reserved_concurrency\n\n  environment {\n    variables = {\n      REGION = var.aws_region\n      LAMBDA = var.target_lambda_arn\n    }\n  }\n\n  depends_on = [aws_cloudwatch_log_group.iterator]\n}\n\n# Optional async failure destination (DLQ)\nresource \"aws_sqs_queue\" \"iterator_async_dlq\" {\n  count = var.enable_async_failure_destination ? 1 : 0\n\n  name                      = \"${local.iterator_name}-async-dlq\"\n  message_retention_seconds = 1209600 # 14 days\n\n  # SQS SSE-SQS (AWS managed) is enabled by default in most regions; explicitly set for clarity.\n  sqs_managed_sse_enabled = true\n}\n\nresource \"aws_lambda_function_event_invoke_config\" \"iterator\" {\n  count = var.enable_async_failure_destination ? 1 : 0\n\n  function_name          = aws_lambda_function.iterator.function_name\n  maximum_retry_attempts = 0\n\n  destination_config {\n    on_failure {\n      destination = aws_sqs_queue.iterator_async_dlq[0].arn\n    }\n  }\n}\n\nresource \"aws_sqs_queue_policy\" \"iterator_async_dlq\" {\n  count = var.enable_async_failure_destination ? 1 : 0\n\n  queue_url = aws_sqs_queue.iterator_async_dlq[0].id\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid       = \"AllowLambdaToSendMessage\"\n        Effect    = \"Allow\"\n        Principal = { Service = \"lambda.amazonaws.com\" }\n        Action    = \"sqs:SendMessage\"\n        Resource  = aws_sqs_queue.iterator_async_dlq[0].arn\n        Condition = {\n          ArnEquals = {\n            \"aws:SourceArn\" = aws_lambda_function.iterator.arn\n          }\n        }\n      }\n    ]\n  })\n}\n\n# -----------------------------\n# IAM: Step Functions role\n# -----------------------------\nresource \"aws_iam_role\" \"sfn\" {\n  name = \"${local.state_machine_name}-role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"states.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"sfn\" {\n  name = \"${local.state_machine_name}-policy\"\n  role = aws_iam_role.sfn.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid    = \"InvokeIterator\"\n        Effect = \"Allow\"\n        Action = [\n          \"lambda:InvokeFunction\"\n        ]\n        Resource = aws_lambda_function.iterator.arn\n      },\n      {\n        Sid    = \"AllowSfnLogs\"\n        Effect = \"Allow\"\n        Action = [\n          \"logs:CreateLogDelivery\",\n          \"logs:GetLogDelivery\",\n          \"logs:UpdateLogDelivery\",\n          \"logs:DeleteLogDelivery\",\n          \"logs:ListLogDeliveries\",\n          \"logs:PutResourcePolicy\",\n          \"logs:DescribeResourcePolicies\",\n          \"logs:DescribeLogGroups\"\n        ]\n        Resource = \"*\"\n      }\n    ]\n  })\n}\n\n# -----------------------------\n# Step Functions State Machine\n# -----------------------------\nresource \"aws_sfn_state_machine\" \"iterator\" {\n  name     = local.state_machine_name\n  role_arn = aws_iam_role.sfn.arn\n\n  definition = local.sfn_definition\n\n  logging_configuration {\n    level                 = \"ALL\"\n    include_execution_data = true\n    log_destination       = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"iterator_lambda_name\" {\n  description = \"Name of the iterator/dispatcher Lambda.\"\n  value       = aws_lambda_function.iterator.function_name\n}\n\noutput \"iterator_lambda_arn\" {\n  description = \"ARN of the iterator/dispatcher Lambda.\"\n  value       = aws_lambda_function.iterator.arn\n}\n\noutput \"state_machine_arn\" {\n  description = \"ARN of the Step Functions state machine.\"\n  value       = aws_sfn_state_machine.iterator.arn\n}\n\noutput \"async_failure_dlq_url\" {\n  description = \"URL of the SQS DLQ used for iterator async failures (if enabled).\"\n  value       = try(aws_sqs_queue.iterator_async_dlq[0].url, null)\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region           = \"us-west-2\"\nname_prefix          = \"hfl\"\n\n# Target Lambda to invoke (must already exist)\ntarget_lambda_arn    = \"arn:aws:lambda:us-west-2:123456789012:function:my-target\"\n\n# Artifact location for iterator.zip\nartifact_bucket_name = \"rockset-public\"\nartifact_key         = \"iterator.zip\"\n# artifact_object_version = \"...\"  # optional\n\ntags = {\n  project = \"high-frequency-lambda\"\n}\n"
    },
    {
      "name": "README_TERRAFORM.md",
      "content": "## Terraform (ai_tf)\n\nThis Terraform config deploys:\n- Iterator/dispatcher AWS Lambda (Go) deployed from an S3 artifact (`iterator.zip`)\n- Step Functions state machine that invokes the iterator, waits `sfn_wait_seconds`, and loops until `sfn_count` is reached\n- IAM roles/policies (least privilege)\n- CloudWatch log groups with retention\n- Optional SQS DLQ for iterator async invocation failures\n\n### Notes about the Lambda runtime\nThe CircleCI pipeline builds a Go binary named `iterator` and zips it.\n\nAWS Lambda Go packaging depends on runtime:\n- **provided.al2** expects a `bootstrap` executable in the zip.\n- **go1.x** expects the handler to be the binary name (e.g., `iterator`).\n\nIf your zip contains `iterator` (not `bootstrap`), set:\n- `lambda_runtime = \"go1.x\"`\n- `lambda_handler = \"iterator\"`\n\n### Usage\n1. Copy `terraform.tfvars.example` to `terraform.tfvars` and fill values.\n2. Run:\n   - `terraform init`\n   - `terraform validate`\n   - `terraform plan`\n   - `terraform apply`\n"
    }
  ]
}