{
  "aws_architecture_description": "## Proposed high-level AWS architecture (Go Lambda + Step Functions “iterator/dispatcher”)\n\n### 1) Packaging & deployment flow\n- **CI (CircleCI)** builds the Go binary, zips it as `iterator.zip`, and uploads it to an **S3 artifact bucket**.\n- Deployment to AWS should be done via **Infrastructure as Code (IaC)** (AWS SAM or CloudFormation/Terraform). The Lambda code can be referenced from the S3 object (bucket + key + version) so releases are immutable.\n- Recommended: keep the artifact bucket **private** (the current `rockset-public` naming suggests public access; for production, avoid public artifacts). Use **S3 Block Public Access**, **SSE-KMS**, and least-privilege access for the CI uploader.\n\n### 2) Orchestration / scheduling\n- Use **AWS Step Functions** to orchestrate the periodic execution of the iterator/dispatcher.\n- Because the cadence is very tight (~every 10 seconds), implement the schedule in one of these ways:\n  - **Preferred (simpler + cheaper): EventBridge Scheduler/Rule** triggers the iterator Lambda directly every 10 seconds (if your requirements allow it), and Step Functions is used only if you need workflow state, retries, or branching.\n  - **If Step Functions must be the scheduler:** a **Standard** or **Express** state machine that includes a `Wait` state (10 seconds) and a `Task` state to invoke the iterator Lambda, looping as needed. Ensure you set appropriate retry/backoff and a dead-letter/alerting strategy.\n\n### 3) Compute: iterator/dispatcher Lambda\n- **Iterator/Dispatcher Lambda (Go)** runs on the managed Lambda service.\n- It reads the target function name/ARN from the `LAMBDA` environment variable.\n- It uses the AWS SDK to **asynchronously invoke** the target Lambda (`InvocationType=Event`).\n- Configure:\n  - **Reserved concurrency** (to cap cost and protect downstream target Lambda).\n  - **Timeout** and **memory** sized to the dispatch logic.\n  - **Environment variable encryption** with KMS (if any sensitive config is added later).\n\n### 4) Target Lambda (external/provided)\n- The target Lambda is not in this repo, but the architecture assumes it exists in the same account or is invokable cross-account.\n- If cross-account, use:\n  - A **resource-based policy** on the target Lambda allowing invocation from the iterator role/account.\n  - Optionally, the iterator Lambda can **assume a cross-account role** before invoking (only if required).\n\n### 5) IAM & security\n- **Iterator Lambda execution role** (trust policy from `assume_role_policy.json`) with least privilege:\n  - `lambda:InvokeFunction` on the specific target Lambda ARN(s) only.\n  - CloudWatch Logs permissions for log group/streams.\n  - If reading artifacts at runtime (usually not needed), `s3:GetObject` on the artifact object.\n- **Step Functions execution role** allowing it to invoke the iterator Lambda.\n- **CI upload IAM principal** (user/role) limited to `s3:PutObject` (and optionally `s3:PutObjectTagging`, `s3:AbortMultipartUpload`) on the artifact prefix.\n\n### 6) Observability & operations\n- **CloudWatch Logs** for both Lambdas and Step Functions.\n- **CloudWatch Alarms** on:\n  - Iterator Lambda errors/throttles/duration.\n  - Step Functions execution failures/throttles.\n  - Target Lambda async failure signals (see below).\n- For async invocation reliability:\n  - Configure the iterator Lambda’s **asynchronous invocation destinations** (or DLQ) for failures (and optionally successes) to **SQS** or **SNS**.\n  - If you need to track target Lambda failures from async invokes, consider configuring the **target Lambda** with a DLQ/destination as well.\n\n### 7) Networking\n- This workload does not require a VPC unless the iterator/target must reach VPC-only resources.\n- **Lean default:** run Lambdas **without VPC attachment** (simpler, no NAT costs).\n- **If VPC is required:** create a VPC with private subnets for Lambda, VPC endpoints (S3, CloudWatch Logs, Step Functions if needed), and NAT only if you must reach the public internet.\n\n---\n\n## End-to-end request flow\n1. Scheduler (Step Functions loop or EventBridge schedule) triggers **Iterator Lambda** every ~10 seconds.\n2. Iterator Lambda reads `LAMBDA` env var and calls **Invoke (async)** on the **Target Lambda**.\n3. Logs/metrics go to **CloudWatch**; failures route to **DLQ/destinations** and trigger alarms.\n\n---\n\n## Notes on “every 10 seconds”\n- A 10-second cadence can generate high execution volume. Use concurrency controls and alarms to prevent runaway cost and downstream overload.\n",
  "aws_resources": [
    "Amazon S3 bucket (artifact bucket)",
    "Amazon S3 object (iterator.zip)",
    "AWS KMS key (for S3 SSE-KMS and optional env var encryption)",
    "AWS Lambda function (Iterator/Dispatcher)",
    "AWS Lambda function (Target Lambda) [external/provided, but referenced as a dependency]",
    "AWS IAM role (Iterator Lambda execution role)",
    "AWS IAM policy (least-privilege permissions for iterator: lambda:InvokeFunction, logs, etc.)",
    "AWS IAM role (Step Functions execution role)",
    "AWS IAM policy (Step Functions permissions to invoke iterator Lambda)",
    "AWS Step Functions state machine (from definition.json)",
    "Amazon CloudWatch Logs log group (Iterator Lambda)",
    "Amazon CloudWatch Logs log group (Target Lambda)",
    "Amazon CloudWatch Logs log group (Step Functions)",
    "Amazon CloudWatch Alarms (Lambda errors/throttles/duration; Step Functions failures)",
    "Amazon SNS topic or Amazon SQS queue (DLQ / async failure destination)",
    "AWS Lambda event invoke config (async destinations / DLQ configuration)",
    "AWS IAM role/user for CI uploads to S3 (least privilege)",
    "(Optional) Amazon EventBridge rule or EventBridge Scheduler schedule (if replacing Step Functions as the scheduler)",
    "(Optional, only if VPC is required) Amazon VPC",
    "(Optional, only if VPC is required) Public subnets (2 AZs)",
    "(Optional, only if VPC is required) Private subnets (2 AZs)",
    "(Optional, only if VPC is required) Route tables and routes",
    "(Optional, only if VPC is required) Internet Gateway",
    "(Optional, only if VPC is required) NAT Gateway (per AZ)",
    "(Optional, only if VPC is required) Security groups (Lambda)",
    "(Optional, only if VPC is required) VPC endpoints (S3 Gateway Endpoint, CloudWatch Logs Interface Endpoint)"
  ]
}