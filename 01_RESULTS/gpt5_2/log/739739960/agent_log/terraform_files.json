{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = merge(\n      {\n        Project     = var.project_name\n        Environment = var.environment\n        ManagedBy   = \"terraform\"\n      },\n      var.tags\n    )\n  }\n}\n\n# CloudFront + ACM (if used) require us-east-1 for certificates.\nprovider \"aws\" {\n  alias  = \"us_east_1\"\n  region = \"us-east-1\"\n\n  default_tags {\n    tags = merge(\n      {\n        Project     = var.project_name\n        Environment = var.environment\n        ManagedBy   = \"terraform\"\n      },\n      var.tags\n    )\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region for primary resources (S3, IAM). CloudFront is global.\"\n  type        = string\n  default     = \"eu-central-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for resource naming.\"\n  type        = string\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, staging, prod).\"\n  type        = string\n  default     = \"prod\"\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply to all resources.\"\n  type        = map(string)\n  default     = {}\n}\n\nvariable \"bucket_name\" {\n  description = \"Optional explicit S3 bucket name. If null, a unique name is generated.\"\n  type        = string\n  default     = null\n}\n\nvariable \"enable_versioning\" {\n  description = \"Enable S3 versioning on the site bucket.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"index_document\" {\n  description = \"Default root object served by CloudFront.\"\n  type        = string\n  default     = \"index.html\"\n}\n\nvariable \"error_document\" {\n  description = \"Error document (used only if you enable S3 website hosting; not used with OAC).\"\n  type        = string\n  default     = \"index.html\"\n}\n\nvariable \"spa_fallback\" {\n  description = \"If true, map 403/404 to index.html to support SPA routing.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"github_org\" {\n  description = \"GitHub organization or user that owns the repository.\"\n  type        = string\n}\n\nvariable \"github_repo\" {\n  description = \"GitHub repository name (without org).\"\n  type        = string\n}\n\nvariable \"github_ref\" {\n  description = \"GitHub ref condition for OIDC trust, e.g. 'refs/heads/main' or 'refs/tags/*'.\"\n  type        = string\n  default     = \"refs/heads/main\"\n}\n\nvariable \"github_environment\" {\n  description = \"Optional GitHub Actions environment name to restrict OIDC (sub claim). If null, not enforced.\"\n  type        = string\n  default     = null\n}\n\nvariable \"custom_domain_name\" {\n  description = \"Optional custom domain (e.g., 'www.example.com') for CloudFront. If null, CloudFront default domain is used.\"\n  type        = string\n  default     = null\n}\n\nvariable \"route53_zone_id\" {\n  description = \"Optional Route53 hosted zone id for creating alias records. Required if custom_domain_name is set.\"\n  type        = string\n  default     = null\n}\n\nvariable \"acm_certificate_arn\" {\n  description = \"Optional ACM certificate ARN in us-east-1 for CloudFront. If null and custom_domain_name is set, a DNS-validated cert will be created.\"\n  type        = string\n  default     = null\n}\n\nvariable \"enable_cloudfront_logs\" {\n  description = \"Enable CloudFront access logs to a dedicated S3 bucket.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"cloudfront_log_bucket_name\" {\n  description = \"Optional explicit name for the CloudFront logs bucket (only used if enable_cloudfront_logs=true).\"\n  type        = string\n  default     = null\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n\n  use_custom_domain = var.custom_domain_name != null && var.custom_domain_name != \"\"\n\n  # GitHub OIDC subject patterns\n  github_sub = var.github_environment != null && var.github_environment != \"\" ? (\n    \"repo:${var.github_org}/${var.github_repo}:environment:${var.github_environment}\"\n  ) : (\n    \"repo:${var.github_org}/${var.github_repo}:ref:${var.github_ref}\"\n  )\n}\n\nresource \"aws_s3_bucket\" \"site\" {\n  bucket        = var.bucket_name\n  force_destroy = false\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"site\" {\n  bucket                  = aws_s3_bucket.site.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"site\" {\n  bucket = aws_s3_bucket.site.id\n\n  versioning_configuration {\n    status = var.enable_versioning ? \"Enabled\" : \"Suspended\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"site\" {\n  bucket = aws_s3_bucket.site.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"site\" {\n  bucket = aws_s3_bucket.site.id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\nresource \"aws_s3_bucket_lifecycle_configuration\" \"site\" {\n  bucket = aws_s3_bucket.site.id\n\n  rule {\n    id     = \"abort-multipart\"\n    status = \"Enabled\"\n\n    abort_incomplete_multipart_upload {\n      days_after_initiation = 7\n    }\n  }\n}\n\n# Optional CloudFront logs bucket\nresource \"aws_s3_bucket\" \"cf_logs\" {\n  count         = var.enable_cloudfront_logs ? 1 : 0\n  bucket        = var.cloudfront_log_bucket_name\n  force_destroy = false\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"cf_logs\" {\n  count  = var.enable_cloudfront_logs ? 1 : 0\n  bucket = aws_s3_bucket.cf_logs[0].id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"cf_logs\" {\n  count  = var.enable_cloudfront_logs ? 1 : 0\n  bucket = aws_s3_bucket.cf_logs[0].id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"cf_logs\" {\n  count  = var.enable_cloudfront_logs ? 1 : 0\n  bucket = aws_s3_bucket.cf_logs[0].id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\n# CloudFront Origin Access Control (recommended over OAI)\nresource \"aws_cloudfront_origin_access_control\" \"oac\" {\n  name                              = \"${local.name_prefix}-oac\"\n  description                       = \"OAC for S3 origin ${aws_s3_bucket.site.bucket}\"\n  origin_access_control_origin_type = \"s3\"\n  signing_behavior                  = \"always\"\n  signing_protocol                  = \"sigv4\"\n}\n\n# Security headers\nresource \"aws_cloudfront_response_headers_policy\" \"security\" {\n  name = \"${local.name_prefix}-security-headers\"\n\n  security_headers_config {\n    content_type_options {\n      override = true\n    }\n\n    frame_options {\n      frame_option = \"DENY\"\n      override     = true\n    }\n\n    referrer_policy {\n      referrer_policy = \"strict-origin-when-cross-origin\"\n      override        = true\n    }\n\n    strict_transport_security {\n      access_control_max_age_sec = 31536000\n      include_subdomains         = true\n      preload                    = true\n      override                   = true\n    }\n\n    xss_protection {\n      protection = true\n      mode_block = true\n      override   = true\n    }\n  }\n}\n\n# Use AWS managed cache policy for optimized caching of static content\ndata \"aws_cloudfront_cache_policy\" \"caching_optimized\" {\n  name = \"Managed-CachingOptimized\"\n}\n\ndata \"aws_cloudfront_origin_request_policy\" \"cors_s3\" {\n  name = \"Managed-CORS-S3Origin\"\n}\n\n# ACM certificate (optional)\nresource \"aws_acm_certificate\" \"this\" {\n  provider = aws.us_east_1\n  count    = local.use_custom_domain && var.acm_certificate_arn == null ? 1 : 0\n\n  domain_name       = var.custom_domain_name\n  validation_method = \"DNS\"\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\nlocals {\n  acm_dvo = local.use_custom_domain && var.acm_certificate_arn == null ? (\n    one(aws_acm_certificate.this[0].domain_validation_options)\n  ) : null\n}\n\nresource \"aws_route53_record\" \"acm_validation\" {\n  count = local.use_custom_domain && var.acm_certificate_arn == null ? 1 : 0\n\n  zone_id = var.route53_zone_id\n  name    = local.acm_dvo.resource_record_name\n  type    = local.acm_dvo.resource_record_type\n  records = [local.acm_dvo.resource_record_value]\n  ttl     = 60\n}\n\nresource \"aws_acm_certificate_validation\" \"this\" {\n  provider = aws.us_east_1\n  count    = local.use_custom_domain && var.acm_certificate_arn == null ? 1 : 0\n\n  certificate_arn         = aws_acm_certificate.this[0].arn\n  validation_record_fqdns = [aws_route53_record.acm_validation[0].fqdn]\n}\n\nlocals {\n  viewer_certificate_arn = local.use_custom_domain ? (\n    var.acm_certificate_arn != null ? var.acm_certificate_arn : aws_acm_certificate_validation.this[0].certificate_arn\n  ) : null\n}\n\nresource \"aws_cloudfront_distribution\" \"this\" {\n  enabled             = true\n  comment             = \"${local.name_prefix} static site\"\n  default_root_object = var.index_document\n  price_class         = \"PriceClass_100\"\n  http_version        = \"http2and3\"\n  is_ipv6_enabled     = true\n\n  aliases = local.use_custom_domain ? [var.custom_domain_name] : null\n\n  origin {\n    domain_name              = aws_s3_bucket.site.bucket_regional_domain_name\n    origin_id                = \"s3-${aws_s3_bucket.site.id}\"\n    origin_access_control_id = aws_cloudfront_origin_access_control.oac.id\n  }\n\n  default_cache_behavior {\n    target_origin_id       = \"s3-${aws_s3_bucket.site.id}\"\n    viewer_protocol_policy = \"redirect-to-https\"\n\n    allowed_methods = [\"GET\", \"HEAD\", \"OPTIONS\"]\n    cached_methods  = [\"GET\", \"HEAD\", \"OPTIONS\"]\n\n    compress = true\n\n    cache_policy_id            = data.aws_cloudfront_cache_policy.caching_optimized.id\n    origin_request_policy_id   = data.aws_cloudfront_origin_request_policy.cors_s3.id\n    response_headers_policy_id = aws_cloudfront_response_headers_policy.security.id\n  }\n\n  restrictions {\n    geo_restriction {\n      restriction_type = \"none\"\n    }\n  }\n\n  dynamic \"custom_error_response\" {\n    for_each = var.spa_fallback ? [1] : []\n    content {\n      error_code            = 403\n      response_code         = 200\n      response_page_path    = \"/${var.index_document}\"\n      error_caching_min_ttl = 0\n    }\n  }\n\n  dynamic \"custom_error_response\" {\n    for_each = var.spa_fallback ? [1] : []\n    content {\n      error_code            = 404\n      response_code         = 200\n      response_page_path    = \"/${var.index_document}\"\n      error_caching_min_ttl = 0\n    }\n  }\n\n  viewer_certificate {\n    cloudfront_default_certificate = local.use_custom_domain ? false : true\n    acm_certificate_arn            = local.use_custom_domain ? local.viewer_certificate_arn : null\n    ssl_support_method             = local.use_custom_domain ? \"sni-only\" : null\n    minimum_protocol_version       = local.use_custom_domain ? \"TLSv1.2_2021\" : \"TLSv1\"\n  }\n\n  dynamic \"logging_config\" {\n    for_each = var.enable_cloudfront_logs ? [1] : []\n    content {\n      bucket          = aws_s3_bucket.cf_logs[0].bucket_domain_name\n      include_cookies = false\n      prefix          = \"cloudfront/\"\n    }\n  }\n\n  depends_on = [aws_s3_bucket_public_access_block.site]\n}\n\n# Allow CloudFront to read from the private S3 bucket via OAC\ndata \"aws_iam_policy_document\" \"site_bucket_policy\" {\n  statement {\n    sid     = \"AllowCloudFrontServicePrincipalReadOnly\"\n    effect  = \"Allow\"\n    actions = [\"s3:GetObject\"]\n\n    resources = [\"${aws_s3_bucket.site.arn}/*\"]\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"cloudfront.amazonaws.com\"]\n    }\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"AWS:SourceArn\"\n      values   = [aws_cloudfront_distribution.this.arn]\n    }\n  }\n}\n\nresource \"aws_s3_bucket_policy\" \"site\" {\n  bucket = aws_s3_bucket.site.id\n  policy = data.aws_iam_policy_document.site_bucket_policy.json\n\n  depends_on = [aws_s3_bucket_public_access_block.site]\n}\n\n# GitHub OIDC provider\nresource \"aws_iam_openid_connect_provider\" \"github\" {\n  url = \"https://token.actions.githubusercontent.com\"\n\n  client_id_list = [\"sts.amazonaws.com\"]\n\n  # GitHub Actions OIDC thumbprint (root CA). This value is stable but can change;\n  # if it does, update accordingly.\n  thumbprint_list = [\"6938fd4d98bab03faadb97b34396831e3780aea1\"]\n}\n\ndata \"aws_iam_policy_document\" \"github_assume_role\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRoleWithWebIdentity\"]\n\n    principals {\n      type        = \"Federated\"\n      identifiers = [aws_iam_openid_connect_provider.github.arn]\n    }\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"token.actions.githubusercontent.com:aud\"\n      values   = [\"sts.amazonaws.com\"]\n    }\n\n    condition {\n      test     = \"StringLike\"\n      variable = \"token.actions.githubusercontent.com:sub\"\n      values   = [local.github_sub]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"github_deploy\" {\n  name               = \"${local.name_prefix}-github-deploy\"\n  assume_role_policy = data.aws_iam_policy_document.github_assume_role.json\n}\n\ndata \"aws_iam_policy_document\" \"github_deploy\" {\n  statement {\n    sid    = \"S3List\"\n    effect = \"Allow\"\n\n    actions = [\n      \"s3:ListBucket\",\n      \"s3:GetBucketLocation\"\n    ]\n\n    resources = [aws_s3_bucket.site.arn]\n  }\n\n  statement {\n    sid    = \"S3ObjectRW\"\n    effect = \"Allow\"\n\n    actions = [\n      \"s3:PutObject\",\n      \"s3:DeleteObject\",\n      \"s3:GetObject\",\n      \"s3:AbortMultipartUpload\",\n      \"s3:ListBucketMultipartUploads\",\n      \"s3:ListMultipartUploadParts\"\n    ]\n\n    resources = [\"${aws_s3_bucket.site.arn}/*\"]\n  }\n\n  statement {\n    sid    = \"CloudFrontInvalidation\"\n    effect = \"Allow\"\n\n    actions   = [\"cloudfront:CreateInvalidation\"]\n    resources = [aws_cloudfront_distribution.this.arn]\n  }\n}\n\nresource \"aws_iam_policy\" \"github_deploy\" {\n  name   = \"${local.name_prefix}-github-deploy\"\n  policy = data.aws_iam_policy_document.github_deploy.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"github_deploy\" {\n  role       = aws_iam_role.github_deploy.name\n  policy_arn = aws_iam_policy.github_deploy.arn\n}\n\n# Optional Route53 alias record\nresource \"aws_route53_record\" \"site_a\" {\n  count = local.use_custom_domain ? 1 : 0\n\n  zone_id = var.route53_zone_id\n  name    = var.custom_domain_name\n  type    = \"A\"\n\n  alias {\n    name                   = aws_cloudfront_distribution.this.domain_name\n    zone_id                = aws_cloudfront_distribution.this.hosted_zone_id\n    evaluate_target_health = false\n  }\n}\n\nresource \"aws_route53_record\" \"site_aaaa\" {\n  count = local.use_custom_domain ? 1 : 0\n\n  zone_id = var.route53_zone_id\n  name    = var.custom_domain_name\n  type    = \"AAAA\"\n\n  alias {\n    name                   = aws_cloudfront_distribution.this.domain_name\n    zone_id                = aws_cloudfront_distribution.this.hosted_zone_id\n    evaluate_target_health = false\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"s3_bucket_name\" {\n  description = \"S3 bucket name for static site artifacts (origin).\"\n  value       = aws_s3_bucket.site.bucket\n}\n\noutput \"cloudfront_distribution_id\" {\n  description = \"CloudFront distribution id (use for invalidations).\"\n  value       = aws_cloudfront_distribution.this.id\n}\n\noutput \"cloudfront_domain_name\" {\n  description = \"CloudFront domain name.\"\n  value       = aws_cloudfront_distribution.this.domain_name\n}\n\noutput \"site_url\" {\n  description = \"Primary site URL.\"\n  value = (\n    var.custom_domain_name != null && var.custom_domain_name != \"\" ?\n    \"https://${var.custom_domain_name}\" :\n    \"https://${aws_cloudfront_distribution.this.domain_name}\"\n  )\n}\n\noutput \"github_deploy_role_arn\" {\n  description = \"IAM role ARN to configure in GitHub Actions (assume-role).\"\n  value       = aws_iam_role.github_deploy.arn\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "project_name = \"static-site\"\nenvironment  = \"prod\"\naws_region   = \"eu-central-1\"\n\n# GitHub OIDC trust\ngithub_org  = \"YOUR_GITHUB_ORG\"\ngithub_repo = \"YOUR_REPO\"\n# Restrict to main branch by default\ngithub_ref = \"refs/heads/main\"\n\n# Optional: custom domain\n# custom_domain_name = \"www.example.com\"\n# route53_zone_id    = \"Z1234567890ABC\"\n# If you already have a cert in us-east-1:\n# acm_certificate_arn = \"arn:aws:acm:us-east-1:123456789012:certificate/....\"\n\n# Optional: enable CloudFront logs\n# enable_cloudfront_logs = true\n# cloudfront_log_bucket_name = \"my-static-site-cf-logs-123456\"\n"
    },
    {
      "name": "README.md",
      "content": "# Terraform: Static site (S3 private origin + CloudFront) + GitHub Actions OIDC\n\n## What this creates\n- Private S3 bucket for static site artifacts\n- CloudFront distribution with Origin Access Control (OAC)\n- Security headers response policy\n- GitHub OIDC provider + deploy IAM role (least privilege: S3 sync + CloudFront invalidation)\n- Optional: ACM certificate (us-east-1) + Route53 alias records\n- Optional: CloudFront access logs bucket\n\n## Usage\n```bash\ncd ai_tf\nterraform init\nterraform validate\nterraform plan -var-file=terraform.tfvars\n```\n\n### GitHub Actions\nUse the output `github_deploy_role_arn` with `aws-actions/configure-aws-credentials`.\n\nYou will also need:\n- `AWS_S3_BUCKET_URL` (bucket name)\n- `AWS_CLOUDFRONT_DISTRIBUTION_ID`\n\n## Notes\n- The S3 bucket is **not** configured for S3 static website hosting; CloudFront uses the S3 REST endpoint with OAC.\n- SPA fallback is enabled by default (403/404 -> /index.html). Disable via `spa_fallback = false`.\n"
    }
  ]
}