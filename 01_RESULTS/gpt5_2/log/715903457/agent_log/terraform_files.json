{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.6.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.25\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region  = var.aws_region\n  profile = var.aws_profile\n\n  default_tags {\n    tags = {\n      Project     = var.nickname\n      Environment = var.environment\n      ManagedBy   = \"terraform\"\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  type        = string\n  description = \"AWS region to deploy into\"\n}\n\nvariable \"aws_profile\" {\n  type        = string\n  description = \"AWS CLI profile name\"\n  default     = \"default\"\n}\n\nvariable \"environment\" {\n  type        = string\n  description = \"Environment name (e.g., dev, prod)\"\n}\n\nvariable \"nickname\" {\n  type        = string\n  description = \"Project nickname used for naming/tagging\"\n  default     = \"strapi\"\n}\n\nvariable \"image\" {\n  type        = string\n  description = \"Container image URI (Docker Hub or ECR), e.g. camillehe1992/strapi:latest\"\n}\n\nvariable \"desired_count\" {\n  type        = number\n  description = \"Desired number of ECS tasks\"\n  default     = 1\n}\n\nvariable \"domain_name\" {\n  type        = string\n  description = \"Optional custom domain name for the ALB (Route53 record will be created if hosted_zone_id is set)\"\n  default     = null\n}\n\nvariable \"hosted_zone_id\" {\n  type        = string\n  description = \"Optional Route53 hosted zone id for creating an alias record to the ALB\"\n  default     = null\n}\n\nvariable \"acm_certificate_arn\" {\n  type        = string\n  description = \"ACM certificate ARN for HTTPS listener. If null, only HTTP listener will be created.\"\n  default     = null\n}\n\nvariable \"container_port\" {\n  type        = number\n  description = \"Strapi container port\"\n  default     = 1337\n}\n\nvariable \"cpu\" {\n  type        = number\n  description = \"Fargate task CPU units\"\n  default     = 512\n}\n\nvariable \"memory\" {\n  type        = number\n  description = \"Fargate task memory (MiB)\"\n  default     = 1024\n}\n\nvariable \"log_retention_in_days\" {\n  type        = number\n  description = \"CloudWatch log retention\"\n  default     = 30\n}\n\n# Strapi secrets (passed as TF vars; in real prod prefer injecting via Secrets Manager)\nvariable \"app_keys\" {\n  type        = string\n  description = \"Comma-separated Strapi APP_KEYS\"\n  sensitive   = true\n}\n\nvariable \"api_token_salt\" {\n  type        = string\n  description = \"Strapi API_TOKEN_SALT\"\n  sensitive   = true\n}\n\nvariable \"admin_jwt_secret\" {\n  type        = string\n  description = \"Strapi ADMIN_JWT_SECRET\"\n  sensitive   = true\n}\n\nvariable \"transfer_token_salt\" {\n  type        = string\n  description = \"Strapi TRANSFER_TOKEN_SALT\"\n  sensitive   = true\n}\n\nvariable \"jwt_secret\" {\n  type        = string\n  description = \"Strapi JWT_SECRET\"\n  sensitive   = true\n}\n\n# Database (this stack provisions RDS; these vars control DB name/user)\nvariable \"database_name\" {\n  type        = string\n  description = \"RDS database name\"\n  default     = \"strapi\"\n}\n\nvariable \"database_username\" {\n  type        = string\n  description = \"RDS master username\"\n  default     = \"strapi\"\n}\n\nvariable \"database_password\" {\n  type        = string\n  description = \"RDS master password\"\n  sensitive   = true\n}\n\nvariable \"db_instance_class\" {\n  type        = string\n  description = \"RDS instance class\"\n  default     = \"db.t4g.micro\"\n}\n\nvariable \"db_allocated_storage\" {\n  type        = number\n  description = \"RDS allocated storage (GiB)\"\n  default     = 20\n}\n\nvariable \"db_multi_az\" {\n  type        = bool\n  description = \"Enable Multi-AZ for RDS\"\n  default     = false\n}\n\nvariable \"db_backup_retention_period\" {\n  type        = number\n  description = \"RDS backup retention days\"\n  default     = 7\n}\n\nvariable \"db_deletion_protection\" {\n  type        = bool\n  description = \"Enable deletion protection on RDS\"\n  default     = false\n}\n\nvariable \"db_publicly_accessible\" {\n  type        = bool\n  description = \"Whether RDS is publicly accessible (should be false)\"\n  default     = false\n}\n\nvariable \"enable_execute_command\" {\n  type        = bool\n  description = \"Enable ECS Exec\"\n  default     = true\n}\n\nvariable \"alarm_email\" {\n  type        = string\n  description = \"Optional email address to subscribe to SNS alarms\"\n  default     = null\n}\n"
    },
    {
      "name": "locals.tf",
      "content": "locals {\n  name_prefix = \"${var.nickname}-${var.environment}\"\n\n  common_env = [\n    { name = \"HOST\", value = \"0.0.0.0\" },\n    { name = \"PORT\", value = tostring(var.container_port) },\n\n    { name = \"APP_KEYS\", value = var.app_keys },\n    { name = \"API_TOKEN_SALT\", value = var.api_token_salt },\n    { name = \"ADMIN_JWT_SECRET\", value = var.admin_jwt_secret },\n    { name = \"TRANSFER_TOKEN_SALT\", value = var.transfer_token_salt },\n    { name = \"JWT_SECRET\", value = var.jwt_secret },\n\n    { name = \"DATABASE_CLIENT\", value = \"mysql\" },\n    { name = \"DATABASE_HOST\", value = aws_db_instance.mysql.address },\n    { name = \"DATABASE_PORT\", value = \"3306\" },\n    { name = \"DATABASE_NAME\", value = var.database_name },\n    { name = \"DATABASE_USERNAME\", value = var.database_username },\n    { name = \"DATABASE_PASSWORD\", value = var.database_password },\n    { name = \"DATABASE_SSL\", value = \"false\" },\n  ]\n}\n"
    },
    {
      "name": "network.tf",
      "content": "data \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~> 5.0\"\n\n  name = local.name_prefix\n  cidr = \"10.0.0.0/16\"\n\n  azs             = slice(data.aws_availability_zones.available.names, 0, 2)\n  public_subnets  = [\"10.0.0.0/24\", \"10.0.1.0/24\"]\n  private_subnets = [\"10.0.10.0/24\", \"10.0.11.0/24\"]\n\n  enable_nat_gateway   = true\n  single_nat_gateway   = true\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n\n  public_subnet_tags = {\n    \"kubernetes.io/role/elb\" = 1\n  }\n\n  private_subnet_tags = {\n    \"kubernetes.io/role/internal-elb\" = 1\n  }\n}\n"
    },
    {
      "name": "security_groups.tf",
      "content": "resource \"aws_security_group\" \"alb\" {\n  name        = \"${local.name_prefix}-alb\"\n  description = \"ALB security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description = \"HTTP\"\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  dynamic \"ingress\" {\n    for_each = var.acm_certificate_arn == null ? [] : [1]\n    content {\n      description = \"HTTPS\"\n      from_port   = 443\n      to_port     = 443\n      protocol    = \"tcp\"\n      cidr_blocks = [\"0.0.0.0/0\"]\n    }\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_security_group\" \"ecs\" {\n  name        = \"${local.name_prefix}-ecs\"\n  description = \"ECS tasks security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description     = \"From ALB to Strapi\"\n    from_port       = var.container_port\n    to_port         = var.container_port\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.alb.id]\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_security_group\" \"rds\" {\n  name        = \"${local.name_prefix}-rds\"\n  description = \"RDS MySQL security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description     = \"MySQL from ECS\"\n    from_port       = 3306\n    to_port         = 3306\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.ecs.id]\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n"
    },
    {
      "name": "alb.tf",
      "content": "resource \"aws_lb\" \"this\" {\n  name               = substr(\"${local.name_prefix}-alb\", 0, 32)\n  load_balancer_type = \"application\"\n  internal           = false\n  security_groups    = [aws_security_group.alb.id]\n  subnets            = module.vpc.public_subnets\n\n  enable_deletion_protection = false\n}\n\nresource \"aws_lb_target_group\" \"this\" {\n  name        = substr(\"${local.name_prefix}-tg\", 0, 32)\n  port        = var.container_port\n  protocol    = \"HTTP\"\n  vpc_id      = module.vpc.vpc_id\n  target_type = \"ip\"\n\n  health_check {\n    enabled             = true\n    path                = \"/\"\n    matcher             = \"200-399\"\n    interval            = 30\n    timeout             = 5\n    healthy_threshold   = 2\n    unhealthy_threshold = 3\n  }\n}\n\nresource \"aws_lb_listener\" \"http\" {\n  load_balancer_arn = aws_lb.this.arn\n  port              = 80\n  protocol          = \"HTTP\"\n\n  default_action {\n    type = var.acm_certificate_arn == null ? \"forward\" : \"redirect\"\n\n    target_group_arn = var.acm_certificate_arn == null ? aws_lb_target_group.this.arn : null\n\n    redirect {\n      port        = \"443\"\n      protocol    = \"HTTPS\"\n      status_code = \"HTTP_301\"\n    }\n  }\n}\n\nresource \"aws_lb_listener\" \"https\" {\n  count = var.acm_certificate_arn == null ? 0 : 1\n\n  load_balancer_arn = aws_lb.this.arn\n  port              = 443\n  protocol          = \"HTTPS\"\n  ssl_policy        = \"ELBSecurityPolicy-TLS13-1-2-2021-06\"\n  certificate_arn   = var.acm_certificate_arn\n\n  default_action {\n    type             = \"forward\"\n    target_group_arn = aws_lb_target_group.this.arn\n  }\n}\n"
    },
    {
      "name": "iam_data.tf",
      "content": "data \"aws_iam_policy_document\" \"ecs_task_assume\" {\n  statement {\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"ecs-tasks.amazonaws.com\"]\n    }\n\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n"
    },
    {
      "name": "ecs.tf",
      "content": "resource \"aws_cloudwatch_log_group\" \"app\" {\n  name              = \"/ecs/${local.name_prefix}\"\n  retention_in_days = var.log_retention_in_days\n}\n\nresource \"aws_ecs_cluster\" \"this\" {\n  name = \"${local.name_prefix}-cluster\"\n\n  setting {\n    name  = \"containerInsights\"\n    value = \"enabled\"\n  }\n}\n\nresource \"aws_iam_role\" \"task_execution\" {\n  name               = \"${local.name_prefix}-ecs-task-exec\"\n  assume_role_policy = data.aws_iam_policy_document.ecs_task_assume.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"task_execution\" {\n  role      = aws_iam_role.task_execution.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\"\n}\n\nresource \"aws_iam_role\" \"task\" {\n  name               = \"${local.name_prefix}-ecs-task\"\n  assume_role_policy = data.aws_iam_policy_document.ecs_task_assume.json\n}\n\nresource \"aws_ecs_task_definition\" \"this\" {\n  family                   = local.name_prefix\n  requires_compatibilities = [\"FARGATE\"]\n  network_mode             = \"awsvpc\"\n  cpu                      = tostring(var.cpu)\n  memory                   = tostring(var.memory)\n  execution_role_arn       = aws_iam_role.task_execution.arn\n  task_role_arn            = aws_iam_role.task.arn\n\n  container_definitions = jsonencode([\n    {\n      name      = \"strapi\"\n      image     = var.image\n      essential = true\n\n      portMappings = [\n        {\n          containerPort = var.container_port\n          hostPort      = var.container_port\n          protocol      = \"tcp\"\n        }\n      ]\n\n      environment = local.common_env\n\n      logConfiguration = {\n        logDriver = \"awslogs\"\n        options = {\n          awslogs-group         = aws_cloudwatch_log_group.app.name\n          awslogs-region        = var.aws_region\n          awslogs-stream-prefix = \"ecs\"\n        }\n      }\n\n      healthCheck = {\n        command     = [\"CMD-SHELL\", \"node -e \\\"require('http').get('http://127.0.0.1:${var.container_port}/', r=>process.exit(r.statusCode<500?0:1)).on('error',()=>process.exit(1))\\\"\" ]\n        interval    = 30\n        timeout     = 5\n        retries     = 3\n        startPeriod = 60\n      }\n    }\n  ])\n}\n\nresource \"aws_ecs_service\" \"this\" {\n  name            = \"${local.name_prefix}-svc\"\n  cluster         = aws_ecs_cluster.this.id\n  task_definition = aws_ecs_task_definition.this.arn\n  desired_count   = var.desired_count\n  launch_type     = \"FARGATE\"\n\n  enable_execute_command = var.enable_execute_command\n\n  network_configuration {\n    subnets          = module.vpc.private_subnets\n    security_groups  = [aws_security_group.ecs.id]\n    assign_public_ip = false\n  }\n\n  load_balancer {\n    target_group_arn = aws_lb_target_group.this.arn\n    container_name   = \"strapi\"\n    container_port   = var.container_port\n  }\n\n  deployment_minimum_healthy_percent = 50\n  deployment_maximum_percent         = 200\n\n  depends_on = [aws_lb_listener.http]\n}\n"
    },
    {
      "name": "rds.tf",
      "content": "resource \"aws_db_subnet_group\" \"this\" {\n  name       = \"${local.name_prefix}-dbsubnets\"\n  subnet_ids = module.vpc.private_subnets\n}\n\nresource \"aws_db_parameter_group\" \"mysql\" {\n  name   = \"${local.name_prefix}-mysql8\"\n  family = \"mysql8.0\"\n}\n\nresource \"aws_db_instance\" \"mysql\" {\n  identifier = \"${local.name_prefix}-mysql\"\n\n  engine            = \"mysql\"\n  engine_version    = \"8.0\"\n  instance_class    = var.db_instance_class\n  allocated_storage = var.db_allocated_storage\n  storage_encrypted = true\n\n  db_name  = var.database_name\n  username = var.database_username\n  password = var.database_password\n\n  db_subnet_group_name   = aws_db_subnet_group.this.name\n  vpc_security_group_ids = [aws_security_group.rds.id]\n\n  parameter_group_name = aws_db_parameter_group.mysql.name\n\n  multi_az                = var.db_multi_az\n  backup_retention_period = var.db_backup_retention_period\n\n  publicly_accessible = var.db_publicly_accessible\n  deletion_protection = var.db_deletion_protection\n  skip_final_snapshot  = true\n  apply_immediately    = true\n\n  enabled_cloudwatch_logs_exports = [\"error\", \"general\", \"slowquery\"]\n}\n"
    },
    {
      "name": "route53.tf",
      "content": "resource \"aws_route53_record\" \"app\" {\n  count = var.domain_name != null && var.hosted_zone_id != null ? 1 : 0\n\n  zone_id = var.hosted_zone_id\n  name    = var.domain_name\n  type    = \"A\"\n\n  alias {\n    name                   = aws_lb.this.dns_name\n    zone_id                = aws_lb.this.zone_id\n    evaluate_target_health = true\n  }\n}\n"
    },
    {
      "name": "alarms.tf",
      "content": "resource \"aws_sns_topic\" \"alarms\" {\n  name = \"${local.name_prefix}-alarms\"\n}\n\nresource \"aws_sns_topic_subscription\" \"email\" {\n  count     = var.alarm_email == null ? 0 : 1\n  topic_arn = aws_sns_topic.alarms.arn\n  protocol  = \"email\"\n  endpoint  = var.alarm_email\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"alb_5xx\" {\n  alarm_name          = \"${local.name_prefix}-alb-5xx\"\n  comparison_operator = \"GreaterThanThreshold\"\n  evaluation_periods  = 1\n  metric_name         = \"HTTPCode_ELB_5XX_Count\"\n  namespace           = \"AWS/ApplicationELB\"\n  period              = 60\n  statistic           = \"Sum\"\n  threshold           = 5\n\n  dimensions = {\n    LoadBalancer = aws_lb.this.arn_suffix\n  }\n\n  alarm_actions = [aws_sns_topic.alarms.arn]\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"tg_5xx\" {\n  alarm_name          = \"${local.name_prefix}-tg-5xx\"\n  comparison_operator = \"GreaterThanThreshold\"\n  evaluation_periods  = 1\n  metric_name         = \"HTTPCode_Target_5XX_Count\"\n  namespace           = \"AWS/ApplicationELB\"\n  period              = 60\n  statistic           = \"Sum\"\n  threshold           = 5\n\n  dimensions = {\n    LoadBalancer = aws_lb.this.arn_suffix\n    TargetGroup  = aws_lb_target_group.this.arn_suffix\n  }\n\n  alarm_actions = [aws_sns_topic.alarms.arn]\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"alb_dns_name\" {\n  value       = aws_lb.this.dns_name\n  description = \"ALB DNS name\"\n}\n\noutput \"url\" {\n  value       = var.domain_name != null ? \"https://${var.domain_name}\" : \"http://${aws_lb.this.dns_name}\"\n  description = \"Application URL\"\n}\n\noutput \"rds_endpoint\" {\n  value       = aws_db_instance.mysql.address\n  description = \"RDS endpoint\"\n}\n\noutput \"ecs_cluster_name\" {\n  value = aws_ecs_cluster.this.name\n}\n\noutput \"ecs_service_name\" {\n  value = aws_ecs_service.this.name\n}\n"
    },
    {
      "name": "dev.tfvars.example",
      "content": "aws_region    = \"ap-southeast-1\"\naws_profile   = \"app-deployer\"\nenvironment   = \"dev\"\nnickname      = \"strapi\"\nimage         = \"camillehe1992/strapi:latest\"\ndesired_count = 1\n\n# If you have ACM + Route53\n# domain_name         = \"strapi.example.com\"\n# hosted_zone_id      = \"Z1234567890ABCDEFG\"\n# acm_certificate_arn = \"arn:aws:acm:ap-southeast-1:123456789012:certificate/....\"\n\n# Strapi secrets\napp_keys            = \"toBeModified1,toBeModified2\"\napi_token_salt      = \"tobemodified\"\nadmin_jwt_secret    = \"tobemodified\"\ntransfer_token_salt = \"tobemodified\"\njwt_secret          = \"tobemodified\"\n\n# DB\ndatabase_password = \"ChangeMe-UseASecretManager\"\n"
    },
    {
      "name": "README.md",
      "content": "## Terraform (ai_tf)\n\nThis Terraform stack provisions a lean Strapi-on-AWS deployment:\n- VPC (2 AZs) with public + private subnets and a NAT gateway\n- Internet-facing ALB (HTTP; optional HTTPS if `acm_certificate_arn` is provided)\n- ECS Fargate cluster/service running Strapi on port 1337\n- RDS MySQL 8.0 in private subnets\n- CloudWatch Logs + basic ALB/TG 5xx alarms to SNS\n\n### Usage\n\n1) Create a tfvars file (start from `dev.tfvars.example`).\n\n2) Run:\n```bash\ncd ai_tf\nterraform init\nterraform validate\nterraform plan -var-file=dev.tfvars\n```\n\n> Note: This stack intentionally keeps secrets as Terraform variables to match the repo's Makefile approach.\n> For production, prefer AWS Secrets Manager and reference secrets in the task definition.\n"
    }
  ]
}