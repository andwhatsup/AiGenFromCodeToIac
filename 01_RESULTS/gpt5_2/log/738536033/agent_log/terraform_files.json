{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.6.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.28\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = {\n      Project     = var.project_name\n      Environment = var.environment\n      ManagedBy   = \"terraform\"\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for tagging and resource naming.\"\n  type        = string\n  default     = \"dash-dashboard-demo\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, staging, prod).\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"vpc_cidr\" {\n  description = \"CIDR block for the VPC.\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"public_subnet_cidrs\" {\n  description = \"Public subnet CIDRs (one per AZ).\"\n  type        = list(string)\n  default     = [\"10.0.0.0/24\", \"10.0.1.0/24\"]\n}\n\nvariable \"private_subnet_cidrs\" {\n  description = \"Private subnet CIDRs (one per AZ).\"\n  type        = list(string)\n  default     = [\"10.0.10.0/24\", \"10.0.11.0/24\"]\n}\n\nvariable \"enable_nat_gateway\" {\n  description = \"Whether to create NAT gateway(s) for private subnet egress.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"single_nat_gateway\" {\n  description = \"If true, create a single NAT gateway (lower cost, less AZ resilience).\"\n  type        = bool\n  default     = true\n}\n\nvariable \"instance_type\" {\n  description = \"Elastic Beanstalk EC2 instance type.\"\n  type        = string\n  default     = \"t3.micro\"\n}\n\nvariable \"min_size\" {\n  description = \"Auto Scaling Group minimum size.\"\n  type        = number\n  default     = 1\n}\n\nvariable \"max_size\" {\n  description = \"Auto Scaling Group maximum size.\"\n  type        = number\n  default     = 2\n}\n\nvariable \"root_volume_size\" {\n  description = \"Root EBS volume size (GiB).\"\n  type        = number\n  default     = 10\n}\n\nvariable \"healthcheck_path\" {\n  description = \"ALB health check path. Dash apps typically respond on '/'.\"\n  type        = string\n  default     = \"/\"\n}\n\nvariable \"solution_stack_name\" {\n  description = \"Elastic Beanstalk solution stack name. If null, Terraform will pick the latest Amazon Linux 2023 Python 3 stack.\"\n  type        = string\n  default     = null\n}\n\nvariable \"app_env\" {\n  description = \"Map of environment variables to set on the Elastic Beanstalk environment.\"\n  type        = map(string)\n  default     = {}\n}\n\nvariable \"enable_managed_updates\" {\n  description = \"Enable Elastic Beanstalk managed platform updates.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"managed_update_start_time\" {\n  description = \"Start time for managed updates in UTC, format: 'HH:MM'.\"\n  type        = string\n  default     = \"03:00\"\n}\n\nvariable \"domain_name\" {\n  description = \"Optional Route53 hosted zone domain (e.g., example.com). If set, an alias record will be created.\"\n  type        = string\n  default     = null\n}\n\nvariable \"subdomain\" {\n  description = \"Optional subdomain to create in Route53 (e.g., 'dash' -> dash.example.com). Requires domain_name.\"\n  type        = string\n  default     = null\n}\n\nvariable \"acm_certificate_arn\" {\n  description = \"Optional ACM certificate ARN for HTTPS listener. If not set, EB will use HTTP only.\"\n  type        = string\n  default     = null\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n  azs         = slice(data.aws_availability_zones.available.names, 0, 2)\n}\n\n# -----------------------------\n# Networking (VPC)\n# -----------------------------\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~> 5.0\"\n\n  name = local.name_prefix\n  cidr = var.vpc_cidr\n\n  azs             = local.azs\n  public_subnets  = var.public_subnet_cidrs\n  private_subnets = var.private_subnet_cidrs\n\n  enable_nat_gateway = var.enable_nat_gateway\n  single_nat_gateway = var.single_nat_gateway\n\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n\n  # Helpful for EB/ALB\n  public_subnet_tags = {\n    \"kubernetes.io/role/elb\" = \"1\"\n  }\n\n  private_subnet_tags = {\n    \"kubernetes.io/role/internal-elb\" = \"1\"\n  }\n}\n\n# S3 bucket for EB application versions (artifact storage)\nresource \"aws_s3_bucket\" \"eb_artifacts\" {\n  bucket_prefix = \"${local.name_prefix}-eb-artifacts-\"\n\n  force_destroy = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"eb_artifacts\" {\n  bucket = aws_s3_bucket.eb_artifacts.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"eb_artifacts\" {\n  bucket = aws_s3_bucket.eb_artifacts.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"eb_artifacts\" {\n  bucket = aws_s3_bucket.eb_artifacts.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\n# -----------------------------\n# IAM for Elastic Beanstalk\n# -----------------------------\n# Service role used by Elastic Beanstalk to manage resources\nresource \"aws_iam_role\" \"eb_service\" {\n  name_prefix = \"${local.name_prefix}-eb-service-\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"elasticbeanstalk.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eb_service_enhanced_health\" {\n  role       = aws_iam_role.eb_service.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkEnhancedHealth\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eb_service_managed_updates\" {\n  role       = aws_iam_role.eb_service.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy\"\n}\n\n# Instance role for EC2 instances in the EB environment\nresource \"aws_iam_role\" \"eb_ec2\" {\n  name_prefix = \"${local.name_prefix}-eb-ec2-\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"ec2.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eb_ec2_web\" {\n  role       = aws_iam_role.eb_ec2.name\n  policy_arn = \"arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eb_ec2_worker\" {\n  role       = aws_iam_role.eb_ec2.name\n  policy_arn = \"arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"eb_ec2_multicontainer\" {\n  role       = aws_iam_role.eb_ec2.name\n  policy_arn = \"arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker\"\n}\n\nresource \"aws_iam_instance_profile\" \"eb_ec2\" {\n  name_prefix = \"${local.name_prefix}-eb-ec2-\"\n  role        = aws_iam_role.eb_ec2.name\n}\n\n# -----------------------------\n# Security Groups\n# -----------------------------\nresource \"aws_security_group\" \"alb\" {\n  name_prefix = \"${local.name_prefix}-alb-\"\n  description = \"ALB security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description = \"HTTP\"\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  ingress {\n    description = \"HTTPS\"\n    from_port   = 443\n    to_port     = 443\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_security_group\" \"app\" {\n  name_prefix = \"${local.name_prefix}-app-\"\n  description = \"EB instances security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description     = \"App from ALB\"\n    from_port       = 80\n    to_port         = 80\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.alb.id]\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\n# -----------------------------\n# Elastic Beanstalk\n# -----------------------------\nresource \"aws_elastic_beanstalk_application\" \"this\" {\n  name        = local.name_prefix\n  description = \"Dash/Flask demo application\"\n\n  appversion_lifecycle {\n    service_role          = aws_iam_role.eb_service.arn\n    max_count             = 20\n    delete_source_from_s3 = true\n  }\n}\n\n# Pick a reasonable default Python solution stack if not provided.\n# Note: stack names change over time; override via var.solution_stack_name if needed.\ndata \"aws_elastic_beanstalk_solution_stack\" \"python\" {\n  most_recent = true\n\n  name_regex = \"^64bit Amazon Linux 2023 v.* running Python 3.*$\"\n}\n\nlocals {\n  eb_solution_stack = coalesce(var.solution_stack_name, data.aws_elastic_beanstalk_solution_stack.python.name)\n}\n\nresource \"aws_elastic_beanstalk_environment\" \"this\" {\n  name                = local.name_prefix\n  application         = aws_elastic_beanstalk_application.this.name\n  solution_stack_name = local.eb_solution_stack\n\n  # VPC configuration\n  setting {\n    namespace = \"aws:ec2:vpc\"\n    name      = \"VPCId\"\n    value     = module.vpc.vpc_id\n  }\n\n  setting {\n    namespace = \"aws:ec2:vpc\"\n    name      = \"Subnets\"\n    value     = join(\",\", module.vpc.private_subnets)\n  }\n\n  setting {\n    namespace = \"aws:ec2:vpc\"\n    name      = \"ELBSubnets\"\n    value     = join(\",\", module.vpc.public_subnets)\n  }\n\n  setting {\n    namespace = \"aws:ec2:vpc\"\n    name      = \"AssociatePublicIpAddress\"\n    value     = \"false\"\n  }\n\n  # Environment type / load balancer\n  setting {\n    namespace = \"aws:elasticbeanstalk:environment\"\n    name      = \"EnvironmentType\"\n    value     = \"LoadBalanced\"\n  }\n\n  setting {\n    namespace = \"aws:elasticbeanstalk:environment\"\n    name      = \"LoadBalancerType\"\n    value     = \"application\"\n  }\n\n  # Launch configuration\n  setting {\n    namespace = \"aws:autoscaling:launchconfiguration\"\n    name      = \"InstanceType\"\n    value     = var.instance_type\n  }\n\n  setting {\n    namespace = \"aws:autoscaling:launchconfiguration\"\n    name      = \"IamInstanceProfile\"\n    value     = aws_iam_instance_profile.eb_ec2.name\n  }\n\n  setting {\n    namespace = \"aws:autoscaling:launchconfiguration\"\n    name      = \"SecurityGroups\"\n    value     = aws_security_group.app.id\n  }\n\n  setting {\n    namespace = \"aws:autoscaling:launchconfiguration\"\n    name      = \"RootVolumeSize\"\n    value     = tostring(var.root_volume_size)\n  }\n\n  # Auto Scaling\n  setting {\n    namespace = \"aws:autoscaling:asg\"\n    name      = \"MinSize\"\n    value     = tostring(var.min_size)\n  }\n\n  setting {\n    namespace = \"aws:autoscaling:asg\"\n    name      = \"MaxSize\"\n    value     = tostring(var.max_size)\n  }\n\n  # ALB security group\n  setting {\n    namespace = \"aws:elbv2:loadbalancer\"\n    name      = \"SecurityGroups\"\n    value     = aws_security_group.alb.id\n  }\n\n  # Health check\n  setting {\n    namespace = \"aws:elasticbeanstalk:environment:process:default\"\n    name      = \"HealthCheckPath\"\n    value     = var.healthcheck_path\n  }\n\n  # CloudWatch log streaming\n  setting {\n    namespace = \"aws:elasticbeanstalk:cloudwatch:logs\"\n    name      = \"StreamLogs\"\n    value     = \"true\"\n  }\n\n  setting {\n    namespace = \"aws:elasticbeanstalk:cloudwatch:logs\"\n    name      = \"RetentionInDays\"\n    value     = \"14\"\n  }\n\n  # Managed updates (optional)\n  dynamic \"setting\" {\n    for_each = var.enable_managed_updates ? [1] : []\n    content {\n      namespace = \"aws:elasticbeanstalk:managedactions\"\n      name      = \"ManagedActionsEnabled\"\n      value     = \"true\"\n    }\n  }\n\n  dynamic \"setting\" {\n    for_each = var.enable_managed_updates ? [1] : []\n    content {\n      namespace = \"aws:elasticbeanstalk:managedactions\"\n      name      = \"PreferredStartTime\"\n      value     = \"Sun:${var.managed_update_start_time}\"\n    }\n  }\n\n  dynamic \"setting\" {\n    for_each = var.enable_managed_updates ? [1] : []\n    content {\n      namespace = \"aws:elasticbeanstalk:managedactions:platformupdate\"\n      name      = \"UpdateLevel\"\n      value     = \"minor\"\n    }\n  }\n\n  # Application environment variables\n  dynamic \"setting\" {\n    for_each = var.app_env\n    content {\n      namespace = \"aws:elasticbeanstalk:application:environment\"\n      name      = setting.key\n      value     = setting.value\n    }\n  }\n\n  # Ensure EB can manage app versions lifecycle\n  setting {\n    namespace = \"aws:elasticbeanstalk:environment\"\n    name      = \"ServiceRole\"\n    value     = aws_iam_role.eb_service.arn\n  }\n}\n\n# Optional Route53 alias to the EB environment CNAME\n# Note: EB provides a CNAME; for ALB alias you typically need the ALB DNS name.\n# We keep it simple: create a CNAME record to the EB endpoint.\ndata \"aws_route53_zone\" \"this\" {\n  count = var.domain_name != null ? 1 : 0\n  name  = var.domain_name\n}\n\nresource \"aws_route53_record\" \"app\" {\n  count   = (var.domain_name != null && var.subdomain != null) ? 1 : 0\n  zone_id = data.aws_route53_zone.this[0].zone_id\n  name    = \"${var.subdomain}.${trim(var.domain_name, \".\")}\"\n  type    = \"CNAME\"\n  ttl     = 300\n  records = [aws_elastic_beanstalk_environment.this.cname]\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"application_name\" {\n  description = \"Elastic Beanstalk application name (used by `eb init`).\"\n  value       = aws_elastic_beanstalk_application.this.name\n}\n\noutput \"environment_name\" {\n  description = \"Elastic Beanstalk environment name.\"\n  value       = aws_elastic_beanstalk_environment.this.name\n}\n\noutput \"environment_cname\" {\n  description = \"Elastic Beanstalk environment CNAME (public endpoint).\"\n  value       = aws_elastic_beanstalk_environment.this.cname\n}\n\noutput \"vpc_id\" {\n  value = module.vpc.vpc_id\n}\n\noutput \"public_subnets\" {\n  value = module.vpc.public_subnets\n}\n\noutput \"private_subnets\" {\n  value = module.vpc.private_subnets\n}\n\noutput \"eb_artifacts_bucket\" {\n  description = \"S3 bucket for EB application versions/artifacts.\"\n  value       = aws_s3_bucket.eb_artifacts.bucket\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region   = \"us-east-1\"\nproject_name = \"dash-dashboard-demo\"\nenvironment  = \"dev\"\n\n# Optionally set these if you want a friendly DNS name\n# domain_name = \"example.com\"\n# subdomain   = \"dash\"\n\n# Optionally pass app environment variables\n# app_env = {\n#   DASH_DEBUG = \"0\"\n# }\n"
    }
  ]
}