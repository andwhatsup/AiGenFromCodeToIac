{
  "aws_architecture_description": "## Proposed high-level AWS architecture (lean, secure, scalable)\n\n### 1) Control plane (Prefect Orchestration)\n- **Prefect Cloud (recommended)** or **self-hosted Prefect Server** acts as the orchestrator.\n- Your AWS workloads (agent + flow-run tasks) make **outbound HTTPS** calls to the Prefect API to poll for work, send heartbeats, and report state.\n\n### 2) Container build & image distribution\n- Package the Prefect agent and flow runtime into one (or two) Docker images.\n- Store images in **Amazon ECR (private repository)** and deploy them to ECS. ([docs.aws.amazon.com](https://docs.aws.amazon.com/AmazonECR/latest/userguide/Repositories.html?utm_source=openai))\n\n### 3) Networking (VPC-first, private compute)\n- Create a dedicated **VPC** spanning **2+ Availability Zones**.\n- Use:\n  - **Private subnets** for all ECS/Fargate tasks (agent + flow runs + optional Dask).\n  - **Public subnets** only for NAT Gateways (if you need general internet egress).\n- For S3 access from private subnets, add an **S3 Gateway VPC Endpoint** and route private subnet route tables to it. This avoids needing NAT for S3 traffic and has no additional endpoint charge. ([docs.aws.amazon.com](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html?utm_source=openai))\n- If you want to keep *all* egress private (no NAT), add **Interface VPC Endpoints (AWS PrivateLink)** for services your tasks must reach privately (commonly: ECR API/DKR, CloudWatch Logs, Secrets Manager, STS). (S3 can also be accessed via interface endpoints when needed for on-prem/peering scenarios, but gateway endpoint is the simplest for in-VPC access.) ([docs.aws.amazon.com](https://docs.aws.amazon.com/AmazonS3/latest/userguide/privatelink-interface-endpoints.html?utm_source=openai))\n\n### 4) Compute & orchestration (ECS on Fargate)\n- **ECS Cluster (Fargate)** in the private subnets.\n- **ECS Service: Prefect Agent**\n  - Long-running service (desired count 1+).\n  - Polls Prefect work queues and launches flow-run tasks.\n- **ECS Tasks: Flow Runs**\n  - Launched on-demand per run.\n  - Pull flow code/artifacts from S3 (Prefect storage block) and write results/artifacts back to S3.\n- **Optional: Dask on ECS**\n  - If you use `prefect-dask`, run a small Dask scheduler + workers as ECS services/tasks, reachable only inside the VPC.\n\n### 5) Storage & data\n- **Amazon S3 bucket** for Prefect storage block (flow packages) and optionally run artifacts.\n  - Enable **SSE-KMS** encryption.\n  - Restrict bucket access to the ECS task role and (optionally) the S3 VPC endpoint.\n- **Optional database** (because SQLAlchemy is present but not configured in repo):\n  - Prefer **Amazon RDS for PostgreSQL** (or Aurora PostgreSQL) in private subnets.\n  - Use **Secrets Manager** for DB credentials.\n\n### 6) Security, IAM, and secrets\n- Use separate IAM roles:\n  - **ECS Task Execution Role**: pull from ECR, write logs to CloudWatch.\n  - **ECS Task Role**: least-privilege access to S3 bucket/prefixes, KMS decrypt, Secrets Manager read, and (if used) RDS connectivity.\n- Security groups:\n  - Agent/flow tasks: egress to Prefect API (443) and to AWS endpoints.\n  - DB SG: allow inbound only from ECS task SG on DB port.\n\n### 7) Observability\n- **CloudWatch Logs** for agent and flow-run task logs.\n- **CloudWatch metrics/alarms** for ECS service health, task failures, and (if NAT used) NAT errors/bytes.\n- **CloudTrail** for API auditing.\n\n---\n\n## AWS resources to provision\n\n### Networking\n- Amazon VPC\n- Internet Gateway (for public subnets; required if using NAT)\n- Public Subnets (2+ AZs)\n- Private Subnets (2+ AZs)\n- Route Tables (public + private) and route table associations\n- NAT Gateway(s) (optional but common; 1 per AZ for HA) + Elastic IP(s)\n- Security Groups (ECS tasks, optional DB)\n- Network ACLs (optional; default NACLs acceptable for lean setup)\n\n### VPC Endpoints (recommended)\n- VPC Gateway Endpoint: **com.amazonaws.<region>.s3** ([docs.aws.amazon.com](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html?utm_source=openai))\n- (Optional) VPC Interface Endpoints (PrivateLink):\n  - ECR API, ECR DKR\n  - CloudWatch Logs\n  - Secrets Manager\n  - STS\n  - (Optional) KMS\n\n### Container registry\n- Amazon ECR Private Repository (one for agent/flow image, or separate repos) ([docs.aws.amazon.com](https://docs.aws.amazon.com/AmazonECR/latest/userguide/Repositories.html?utm_source=openai))\n\n### Compute (ECS/Fargate)\n- Amazon ECS Cluster\n- ECS Task Definition: Prefect Agent\n- ECS Service: Prefect Agent (Fargate)\n- ECS Task Definition: Flow Run Worker (Fargate)\n- (Optional) ECS Service/Tasks: Dask scheduler/workers\n\n### Storage\n- Amazon S3 Bucket (Prefect storage block)\n- S3 Bucket Policy (restrict to task role and/or VPC endpoint)\n- (Optional) S3 Access Logs bucket (or centralized logging bucket)\n\n### IAM & security\n- IAM Role: ECS Task Execution Role\n- IAM Role: ECS Task Role (S3/KMS/Secrets access)\n- IAM Policies (least privilege) attached to roles\n- AWS KMS Key (CMK) for S3 encryption (and optionally Secrets Manager)\n- AWS Secrets Manager secrets (Prefect API key if used, DB credentials, other app secrets)\n\n### Observability & audit\n- CloudWatch Log Groups (agent + flow runs + optional Dask)\n- CloudWatch Alarms (ECS service desired/running count, task failures, etc.)\n- AWS CloudTrail (org/account level)\n\n### Optional database layer (only if your flows truly need it)\n- Amazon RDS (PostgreSQL) or Amazon Aurora PostgreSQL\n- DB Subnet Group\n- RDS Security Group\n- (Optional) RDS Parameter Group\n- (Optional) RDS Enhanced Monitoring IAM role\n\n### CI/CD (optional, but typical)\n- AWS CodeBuild / CodePipeline (or GitHub Actions) to build/push images to ECR and run `prefect deploy`\n\nIf you tell me whether you’re using **Prefect Cloud vs self-hosted Prefect Server**, and whether you want **NAT-less private egress** (endpoints-only) or are OK with **NAT**, I can tighten this into a minimal “exact” bill-of-materials and recommended subnet/endpoint layout.",
  "aws_resources": [
    "Amazon VPC",
    "Internet Gateway (optional; if using NAT/public subnets)",
    "Public Subnets (2+ AZs)",
    "Private Subnets (2+ AZs)",
    "Route Tables (public/private) + associations",
    "NAT Gateway(s) + Elastic IP(s) (optional)",
    "Security Groups (ECS tasks, optional DB)",
    "VPC Gateway Endpoint for Amazon S3",
    "(Optional) VPC Interface Endpoints: ECR API, ECR DKR, CloudWatch Logs, Secrets Manager, STS, KMS",
    "Amazon ECR Private Repository",
    "Amazon ECS Cluster (Fargate)",
    "ECS Task Definition (Prefect Agent)",
    "ECS Service (Prefect Agent)",
    "ECS Task Definition (Flow Runs)",
    "(Optional) ECS Service/Tasks (Dask scheduler/workers)",
    "Amazon S3 Bucket (Prefect storage/artifacts)",
    "S3 Bucket Policy",
    "AWS KMS Key (for S3 encryption)",
    "AWS Secrets Manager (Prefect API key, DB creds, other secrets)",
    "IAM Role: ECS Task Execution Role",
    "IAM Role: ECS Task Role",
    "IAM Policies (least privilege)",
    "CloudWatch Log Groups",
    "CloudWatch Alarms",
    "AWS CloudTrail",
    "(Optional) Amazon RDS PostgreSQL / Aurora PostgreSQL",
    "(Optional) DB Subnet Group",
    "(Optional) RDS Security Group",
    "(Optional) CI/CD: CodeBuild/CodePipeline (or external CI)"
  ]
}