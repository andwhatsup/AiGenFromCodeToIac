{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.28\"\n    }\n    random = {\n      source  = \"hashicorp/random\"\n      version = \"~> 3.8\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = var.tags\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"name\" {\n  description = \"Name prefix for all resources.\"\n  type        = string\n  default     = \"prefect-ecs\"\n}\n\nvariable \"tags\" {\n  description = \"Tags applied to all resources.\"\n  type        = map(string)\n  default = {\n    Project = \"prefect-ecs\"\n    Managed = \"terraform\"\n  }\n}\n\nvariable \"vpc_cidr\" {\n  description = \"CIDR block for the VPC.\"\n  type        = string\n  default     = \"10.20.0.0/16\"\n}\n\nvariable \"az_count\" {\n  description = \"Number of AZs to use (2 recommended).\"\n  type        = number\n  default     = 2\n}\n\nvariable \"enable_nat_gateway\" {\n  description = \"Whether to create NAT gateways for private subnet internet egress. If false, tasks must rely on VPC endpoints only.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"prefect_api_url\" {\n  description = \"Prefect API URL. For Prefect Cloud typically https://api.prefect.cloud/api.\"\n  type        = string\n  default     = \"https://api.prefect.cloud/api\"\n}\n\nvariable \"prefect_account_id\" {\n  description = \"Prefect Cloud account ID.\"\n  type        = string\n  default     = null\n}\n\nvariable \"prefect_workspace_id\" {\n  description = \"Prefect Cloud workspace ID.\"\n  type        = string\n  default     = null\n}\n\nvariable \"prefect_api_key\" {\n  description = \"Prefect API key (store in tfvars, not in VCS).\"\n  type        = string\n  sensitive   = true\n}\n\nvariable \"prefect_work_queue\" {\n  description = \"Prefect work queue name the agent will poll.\"\n  type        = string\n  default     = \"test-queue\"\n}\n\nvariable \"agent_image\" {\n  description = \"Container image for the Prefect agent (ECR image URI or other registry).\"\n  type        = string\n  default     = \"prefecthq/prefect:2.7.11-python3.10\"\n}\n\nvariable \"agent_cpu\" {\n  description = \"Fargate CPU units for the agent task.\"\n  type        = number\n  default     = 256\n}\n\nvariable \"agent_memory\" {\n  description = \"Fargate memory (MiB) for the agent task.\"\n  type        = number\n  default     = 512\n}\n\nvariable \"agent_desired_count\" {\n  description = \"Desired count for the Prefect agent ECS service.\"\n  type        = number\n  default     = 1\n}\n\nvariable \"s3_bucket_name\" {\n  description = \"Optional fixed S3 bucket name for Prefect storage. If null, a unique name will be generated.\"\n  type        = string\n  default     = null\n}\n\nvariable \"s3_prefix\" {\n  description = \"S3 prefix for Prefect storage block (e.g., ecs-agent-bucket).\"\n  type        = string\n  default     = \"ecs-agent-bucket\"\n}\n\nvariable \"log_retention_days\" {\n  description = \"CloudWatch log retention in days.\"\n  type        = number\n  default     = 30\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_partition\" \"current\" {}\n\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  azs = slice(data.aws_availability_zones.available.names, 0, var.az_count)\n}\n\nresource \"random_id\" \"bucket\" {\n  byte_length = 4\n}\n\n# ----------------------------\n# Networking (VPC + subnets)\n# ----------------------------\nresource \"aws_vpc\" \"this\" {\n  cidr_block           = var.vpc_cidr\n  enable_dns_support   = true\n  enable_dns_hostnames = true\n\n  tags = {\n    Name = \"${var.name}-vpc\"\n  }\n}\n\nresource \"aws_internet_gateway\" \"this\" {\n  vpc_id = aws_vpc.this.id\n\n  tags = {\n    Name = \"${var.name}-igw\"\n  }\n}\n\nresource \"aws_subnet\" \"public\" {\n  for_each = { for idx, az in local.azs : az => idx }\n\n  vpc_id                  = aws_vpc.this.id\n  availability_zone       = each.key\n  cidr_block              = cidrsubnet(var.vpc_cidr, 8, each.value)\n  map_public_ip_on_launch = true\n\n  tags = {\n    Name = \"${var.name}-public-${each.key}\"\n    Tier = \"public\"\n  }\n}\n\nresource \"aws_subnet\" \"private\" {\n  for_each = { for idx, az in local.azs : az => idx }\n\n  vpc_id                  = aws_vpc.this.id\n  availability_zone       = each.key\n  cidr_block              = cidrsubnet(var.vpc_cidr, 8, each.value + 100)\n  map_public_ip_on_launch = false\n\n  tags = {\n    Name = \"${var.name}-private-${each.key}\"\n    Tier = \"private\"\n  }\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.this.id\n\n  tags = {\n    Name = \"${var.name}-public-rt\"\n  }\n}\n\nresource \"aws_route\" \"public_internet\" {\n  route_table_id         = aws_route_table.public.id\n  destination_cidr_block = \"0.0.0.0/0\"\n  gateway_id             = aws_internet_gateway.this.id\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  for_each = aws_subnet.public\n\n  subnet_id      = each.value.id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_eip\" \"nat\" {\n  for_each = var.enable_nat_gateway ? aws_subnet.public : {}\n\n  domain = \"vpc\"\n\n  tags = {\n    Name = \"${var.name}-nat-eip-${each.key}\"\n  }\n}\n\nresource \"aws_nat_gateway\" \"this\" {\n  for_each = var.enable_nat_gateway ? aws_subnet.public : {}\n\n  allocation_id = aws_eip.nat[each.key].id\n  subnet_id     = each.value.id\n\n  tags = {\n    Name = \"${var.name}-nat-${each.key}\"\n  }\n\n  depends_on = [aws_internet_gateway.this]\n}\n\nresource \"aws_route_table\" \"private\" {\n  for_each = aws_subnet.private\n\n  vpc_id = aws_vpc.this.id\n\n  tags = {\n    Name = \"${var.name}-private-rt-${each.key}\"\n  }\n}\n\nresource \"aws_route\" \"private_default\" {\n  for_each = var.enable_nat_gateway ? aws_route_table.private : {}\n\n  route_table_id         = each.value.id\n  destination_cidr_block = \"0.0.0.0/0\"\n  nat_gateway_id         = aws_nat_gateway.this[each.key].id\n}\n\nresource \"aws_route_table_association\" \"private\" {\n  for_each = aws_subnet.private\n\n  subnet_id      = each.value.id\n  route_table_id = aws_route_table.private[each.key].id\n}\n\n# ----------------------------\n# VPC Endpoint for S3 (gateway)\n# ----------------------------\nresource \"aws_vpc_endpoint\" \"s3\" {\n  vpc_id            = aws_vpc.this.id\n  service_name      = \"com.amazonaws.${var.aws_region}.s3\"\n  vpc_endpoint_type = \"Gateway\"\n\n  route_table_ids = concat(\n    [aws_route_table.public.id],\n    [for rt in aws_route_table.private : rt.id]\n  )\n\n  tags = {\n    Name = \"${var.name}-s3-endpoint\"\n  }\n}\n\n# ----------------------------\n# KMS + S3 bucket for Prefect storage\n# ----------------------------\nresource \"aws_kms_key\" \"s3\" {\n  description             = \"KMS key for Prefect S3 bucket encryption\"\n  deletion_window_in_days = 30\n  enable_key_rotation     = true\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid      = \"EnableRootPermissions\"\n        Effect   = \"Allow\"\n        Principal = { AWS = \"arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:root\" }\n        Action   = \"kms:*\"\n        Resource = \"*\"\n      }\n    ]\n  })\n\n  tags = {\n    Name = \"${var.name}-s3-kms\"\n  }\n}\n\nresource \"aws_kms_alias\" \"s3\" {\n  name          = \"alias/${var.name}-s3\"\n  target_key_id = aws_kms_key.s3.key_id\n}\n\nlocals {\n  bucket_name = coalesce(var.s3_bucket_name, \"${var.name}-${data.aws_caller_identity.current.account_id}-${random_id.bucket.hex}\")\n}\n\nresource \"aws_s3_bucket\" \"prefect\" {\n  bucket        = local.bucket_name\n  force_destroy = false\n\n  tags = {\n    Name = local.bucket_name\n  }\n}\n\nresource \"aws_s3_bucket_versioning\" \"prefect\" {\n  bucket = aws_s3_bucket.prefect.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"prefect\" {\n  bucket = aws_s3_bucket.prefect.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm     = \"aws:kms\"\n      kms_master_key_id = aws_kms_key.s3.arn\n    }\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"prefect\" {\n  bucket = aws_s3_bucket.prefect.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"prefect\" {\n  bucket = aws_s3_bucket.prefect.id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\nresource \"aws_s3_bucket_policy\" \"prefect\" {\n  bucket = aws_s3_bucket.prefect.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid       = \"DenyInsecureTransport\"\n        Effect    = \"Deny\"\n        Principal = \"*\"\n        Action    = \"s3:*\"\n        Resource = [\n          aws_s3_bucket.prefect.arn,\n          \"${aws_s3_bucket.prefect.arn}/*\"\n        ]\n        Condition = {\n          Bool = { \"aws:SecureTransport\" = \"false\" }\n        }\n      }\n    ]\n  })\n}\n\n# ----------------------------\n# CloudWatch Logs\n# ----------------------------\nresource \"aws_cloudwatch_log_group\" \"agent\" {\n  name              = \"/ecs/${var.name}/agent\"\n  retention_in_days = var.log_retention_days\n}\n\n# ----------------------------\n# ECS Cluster\n# ----------------------------\nresource \"aws_ecs_cluster\" \"this\" {\n  name = \"${var.name}-cluster\"\n\n  setting {\n    name  = \"containerInsights\"\n    value = \"enabled\"\n  }\n}\n\n# ----------------------------\n# IAM roles for ECS tasks\n# ----------------------------\nresource \"aws_iam_role\" \"task_execution\" {\n  name = \"${var.name}-ecs-task-exec\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"ecs-tasks.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"task_execution\" {\n  role       = aws_iam_role.task_execution.name\n  policy_arn = \"arn:${data.aws_partition.current.partition}:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\"\n}\n\nresource \"aws_iam_role\" \"task\" {\n  name = \"${var.name}-ecs-task\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"ecs-tasks.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_policy\" \"task_s3\" {\n  name        = \"${var.name}-task-s3\"\n  description = \"Least-privilege access to Prefect S3 bucket/prefix and KMS decrypt\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid    = \"ListBucket\"\n        Effect = \"Allow\"\n        Action = [\"s3:ListBucket\"]\n        Resource = [aws_s3_bucket.prefect.arn]\n        Condition = {\n          StringLike = {\n            \"s3:prefix\" = [\"${var.s3_prefix}/*\", var.s3_prefix]\n          }\n        }\n      },\n      {\n        Sid    = \"ObjectRW\"\n        Effect = \"Allow\"\n        Action = [\n          \"s3:GetObject\",\n          \"s3:PutObject\",\n          \"s3:DeleteObject\"\n        ]\n        Resource = [\"${aws_s3_bucket.prefect.arn}/${var.s3_prefix}/*\"]\n      },\n      {\n        Sid      = \"KMSForS3\"\n        Effect   = \"Allow\"\n        Action   = [\"kms:Decrypt\", \"kms:Encrypt\", \"kms:GenerateDataKey\"]\n        Resource = [aws_kms_key.s3.arn]\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"task_s3\" {\n  role       = aws_iam_role.task.name\n  policy_arn = aws_iam_policy.task_s3.arn\n}\n\n# ----------------------------\n# Security group for ECS tasks\n# ----------------------------\nresource \"aws_security_group\" \"ecs_tasks\" {\n  name        = \"${var.name}-ecs-tasks\"\n  description = \"Security group for Prefect agent/tasks\"\n  vpc_id      = aws_vpc.this.id\n\n  egress {\n    description = \"Allow all egress (restrict further if you use endpoints-only)\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = {\n    Name = \"${var.name}-ecs-tasks\"\n  }\n}\n\n# ----------------------------\n# ECS Task Definition + Service (Prefect agent)\n# ----------------------------\nresource \"aws_ecs_task_definition\" \"agent\" {\n  family                   = \"${var.name}-agent\"\n  requires_compatibilities = [\"FARGATE\"]\n  network_mode             = \"awsvpc\"\n  cpu                      = tostring(var.agent_cpu)\n  memory                   = tostring(var.agent_memory)\n  execution_role_arn       = aws_iam_role.task_execution.arn\n  task_role_arn            = aws_iam_role.task.arn\n\n  container_definitions = jsonencode([\n    {\n      name      = \"prefect-agent\"\n      image     = var.agent_image\n      essential = true\n\n      # Prefect 2 agent command. This is intentionally minimal; adjust to your needs.\n      command = [\n        \"prefect\",\n        \"agent\",\n        \"start\",\n        \"-q\",\n        var.prefect_work_queue\n      ]\n\n      environment = [\n        { name = \"PREFECT_API_URL\", value = var.prefect_api_url },\n        { name = \"PREFECT_API_KEY\", value = var.prefect_api_key },\n        { name = \"PREFECT_ACCOUNT_ID\", value = coalesce(var.prefect_account_id, \"\") },\n        { name = \"PREFECT_WORKSPACE_ID\", value = coalesce(var.prefect_workspace_id, \"\") },\n        { name = \"PREFECT_LOGGING_LEVEL\", value = \"INFO\" },\n        { name = \"PREFECT_STORAGE_BASE_PATH\", value = \"s3://${aws_s3_bucket.prefect.bucket}/${var.s3_prefix}\" }\n      ]\n\n      logConfiguration = {\n        logDriver = \"awslogs\"\n        options = {\n          awslogs-group         = aws_cloudwatch_log_group.agent.name\n          awslogs-region        = var.aws_region\n          awslogs-stream-prefix = \"ecs\"\n        }\n      }\n    }\n  ])\n}\n\nresource \"aws_ecs_service\" \"agent\" {\n  name            = \"${var.name}-agent\"\n  cluster         = aws_ecs_cluster.this.id\n  task_definition = aws_ecs_task_definition.agent.arn\n  desired_count   = var.agent_desired_count\n  launch_type     = \"FARGATE\"\n\n  network_configuration {\n    subnets          = [for s in aws_subnet.private : s.id]\n    security_groups  = [aws_security_group.ecs_tasks.id]\n    assign_public_ip = false\n  }\n\n  deployment_minimum_healthy_percent = 50\n  deployment_maximum_percent         = 200\n\n  lifecycle {\n    ignore_changes = [task_definition]\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"vpc_id\" {\n  value       = aws_vpc.this.id\n  description = \"VPC ID\"\n}\n\noutput \"private_subnet_ids\" {\n  value       = [for s in aws_subnet.private : s.id]\n  description = \"Private subnet IDs for ECS tasks\"\n}\n\noutput \"ecs_cluster_name\" {\n  value       = aws_ecs_cluster.this.name\n  description = \"ECS cluster name\"\n}\n\noutput \"ecs_agent_service_name\" {\n  value       = aws_ecs_service.agent.name\n  description = \"ECS service name running the Prefect agent\"\n}\n\noutput \"prefect_s3_bucket\" {\n  value       = aws_s3_bucket.prefect.bucket\n  description = \"S3 bucket for Prefect storage block\"\n}\n\noutput \"prefect_s3_bucket_prefix\" {\n  value       = var.s3_prefix\n  description = \"S3 prefix for Prefect storage block\"\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region = \"us-east-1\"\nname       = \"prefect-ecs\"\n\n# Prefect Cloud\nprefect_api_url      = \"https://api.prefect.cloud/api\"\nprefect_account_id   = \"a22******\"\nprefect_workspace_id = \"e4c******\"\nprefect_api_key      = \"pnu_******\"\n\nprefect_work_queue = \"test-queue\"\n\n# Optional: pin bucket name (must be globally unique)\n# s3_bucket_name = \"bucket-full-of-sunshine-prefect\"\n\n# Prefix used by your Prefect S3 storage block\ns3_prefix = \"ecs-agent-bucket\"\n\n# If you want endpoints-only networking, set false and add interface endpoints as needed.\nenable_nat_gateway = true\n"
    },
    {
      "name": "README_DEPLOY.md",
      "content": "# Terraform: Prefect 2 agent on ECS Fargate\n\n## What this creates\n- VPC (2 AZs), public + private subnets\n- Optional NAT gateways (default: enabled)\n- S3 Gateway VPC endpoint\n- KMS key + S3 bucket for Prefect storage (SSE-KMS)\n- ECS cluster + ECS service running a Prefect 2 agent\n- CloudWatch log group\n\n## Configure\n1. Copy `terraform.tfvars.example` to `terraform.tfvars` and fill in:\n   - `prefect_api_key`\n   - `prefect_account_id` / `prefect_workspace_id` (for Prefect Cloud)\n   - optionally `s3_bucket_name`\n\n2. Deploy:\n```bash\nterraform init\nterraform validate\nterraform apply\n```\n\n## Use with your Prefect deployment\nYour repo shows a storage block like:\n`bucket_path: bucket-full-of-sunshine-prefect/ecs-agent-bucket`\n\nAfter apply, use outputs:\n- `prefect_s3_bucket`\n- `prefect_s3_bucket_prefix`\n\nThen build/apply your Prefect deployment, e.g.:\n```bash\nprefect deployment build ./log_flow.py:log_flow \\\n  -n log-agent-ecs \\\n  -sb s3/ecs-agent-bucket \\\n  -q test-queue \\\n  -o flows/log-flow-agent-ecs.yaml\n\nprefect deployment apply flows/log-flow-agent-ecs.yaml --upload\n```\n\n## Notes\n- This configuration runs the agent as an ECS service. Your README notes flow runs execute inside the agent task (not as separate ECS tasks).\n- If you disable NAT (`enable_nat_gateway=false`), you will likely need interface VPC endpoints for ECR, CloudWatch Logs, STS, and Secrets Manager depending on your image and runtime needs.\n"
    }
  ]
}