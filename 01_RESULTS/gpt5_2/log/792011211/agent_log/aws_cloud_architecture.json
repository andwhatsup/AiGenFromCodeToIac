{
  "aws_architecture_description": "## Proposed high-level AWS architecture (lean, production-ready)\n\n### 1) Networking foundation\n- Deploy into a dedicated **VPC** spanning **2 Availability Zones** for high availability.\n- Create **public subnets** (for the internet-facing ALB) and **private subnets** (for EKS worker nodes and pods).\n- Use an **Internet Gateway** for inbound/outbound public subnet traffic.\n- Use **NAT Gateways** (one per AZ, or one to reduce cost) so workloads in private subnets can reach the internet (needed for pulling images, calling OpenWeatherMap, and reaching AWS APIs if not using VPC endpoints).\n- Add **VPC endpoints** where it reduces NAT dependency and improves security:\n  - **ECR (api + dkr)** and **S3 gateway endpoint** (ECR image layers are stored in S3)\n  - **CloudWatch Logs** (for log shipping)\n  - **Secrets Manager** and **STS** (for IRSA token exchange and secret retrieval)\n\n### 2) Container platform (Amazon EKS)\n- Provision an **Amazon EKS cluster** with:\n  - **Managed node group(s)** (EC2) in private subnets.\n  - **Cluster endpoint** configured as private (preferred) or public with restricted CIDRs.\n- Install/operate these in-cluster components (as you already do via Helm/kubectl):\n  - **AWS Load Balancer Controller** to provision/manage an **Application Load Balancer** from Kubernetes Ingress.\n  - **Secrets Store CSI Driver** + **AWS provider** to mount/sync the OpenWeatherMap API key from **AWS Secrets Manager**.\n- Deploy the application as a Kubernetes **Deployment (replicas=2)** in namespace `prod`.\n  - Add **Horizontal Pod Autoscaler** (optional but recommended) based on CPU/requests.\n  - Add **PodDisruptionBudget** to keep at least 1 pod available during node maintenance.\n\n### 3) Ingress and TLS\n- Create a Kubernetes **Ingress (class: alb)** that results in an **internet-facing ALB**.\n- Terminate TLS at the ALB using **AWS Certificate Manager (ACM)**.\n- Use **Route 53** to map a friendly DNS name (e.g., `weather.example.com`) to the ALB.\n- Security groups:\n  - ALB SG allows inbound **443** from the internet; forwards to target group on the app port.\n  - Node/pod traffic restricted to only what’s needed from the ALB.\n\n### 4) Container image supply chain\n- Store the built Docker image in **Amazon ECR**.\n- EKS nodes pull from ECR using node IAM permissions (or IRSA if using ECR credential helper patterns).\n- Enable ECR image scanning (basic) and lifecycle policies to keep the repo clean.\n\n### 5) Secrets and IAM (IRSA)\n- Keep the OpenWeatherMap API key in **AWS Secrets Manager** at `/python-weather-app/api-key`.\n- Use **IRSA**:\n  - Create an **IAM OIDC provider** for the EKS cluster.\n  - Create an **IAM role** for the app’s Kubernetes ServiceAccount with least-privilege permissions to read only that secret.\n  - Create a separate **IAM role** for the AWS Load Balancer Controller.\n\n### 6) Observability and security posture\n- Send container logs to **CloudWatch Logs** (via Fluent Bit/Container Insights or your preferred logging DaemonSet).\n- Enable **CloudWatch Container Insights** for EKS metrics (optional but common).\n- Use **AWS CloudTrail** for audit logging and **AWS Config** (optional) for compliance drift detection.\n- Use **KMS** to encrypt Secrets Manager secrets and (optionally) EKS secrets envelope encryption.\n\n---\n\n## End-to-end request flow\n1. User → **Route 53** DNS → **ALB (HTTPS/443, ACM cert)**\n2. ALB → **Target Group** → EKS nodes/pods (via AWS Load Balancer Controller-managed Ingress)\n3. Pod reads API key via **Secrets Store CSI Driver** → **Secrets Manager** (authorized by **IRSA**)\n4. Pod calls **OpenWeatherMap API** over HTTPS\n\n---\n\n## Deployment strategy (practical)\n- CI builds Docker image → pushes to **ECR**.\n- CD applies Kubernetes manifests/Helm:\n  - Namespace, ServiceAccount (IRSA), Deployment, Service, Ingress, SecretProviderClass.\n- Use rolling updates on the Deployment; keep replicas=2 minimum.\n",
  "aws_resources": [
    "Amazon VPC",
    "VPC subnets (2x public, 2x private across 2 AZs)",
    "Internet Gateway (IGW)",
    "NAT Gateway(s)",
    "Route tables (public and private)",
    "Security Groups (ALB SG, node group SG, controller/app SGs as needed)",
    "Network ACLs (optional, if you enforce beyond SGs)",
    "VPC Endpoints: ECR (com.amazonaws.<region>.ecr.api)",
    "VPC Endpoints: ECR DKR (com.amazonaws.<region>.ecr.dkr)",
    "VPC Endpoint: S3 Gateway Endpoint",
    "VPC Endpoint: CloudWatch Logs",
    "VPC Endpoint: AWS Secrets Manager",
    "VPC Endpoint: AWS STS",
    "Amazon EKS Cluster",
    "EKS Managed Node Group(s) (EC2 worker nodes)",
    "EKS IAM OIDC Provider (for IRSA)",
    "IAM Role: EKS cluster service role",
    "IAM Role: EKS node group role (with ECR pull, CloudWatch logging, etc.)",
    "IAM Role: AWS Load Balancer Controller (IRSA)",
    "IAM Policy: AWS Load Balancer Controller permissions",
    "IAM Role: Application ServiceAccount role (IRSA)",
    "IAM Policy: least-privilege Secrets Manager read for /python-weather-app/api-key",
    "Amazon ECR Repository",
    "ECR lifecycle policy",
    "ECR image scanning configuration",
    "AWS Secrets Manager secret: /python-weather-app/api-key",
    "AWS KMS key (for Secrets Manager encryption; optional if using AWS-managed key)",
    "Elastic Load Balancing: Application Load Balancer (provisioned by controller)",
    "ALB Target Group(s) (provisioned by controller)",
    "ACM Certificate (for ALB HTTPS)",
    "Amazon Route 53 Hosted Zone + DNS record (A/AAAA alias to ALB)",
    "Amazon CloudWatch Log Groups (for application/container logs)",
    "Amazon CloudWatch metrics/alarms (ALB 5xx, target health, pod/node CPU, etc.)",
    "AWS CloudTrail (account-level, for audit)"
  ]
}