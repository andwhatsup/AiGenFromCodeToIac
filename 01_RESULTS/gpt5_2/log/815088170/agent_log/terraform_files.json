{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.28\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = var.tags\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"name\" {\n  description = \"Base name/prefix for resources.\"\n  type        = string\n  default     = \"hello-world\"\n}\n\nvariable \"ecr_repo_name\" {\n  description = \"ECR repository name used by CI to push the image. Must match GitHub Actions env ECR_REPO_NAME.\"\n  type        = string\n  default     = \"ptapp2\"\n}\n\nvariable \"image_tag\" {\n  description = \"Container image tag to deploy.\"\n  type        = string\n  default     = \"latest\"\n}\n\nvariable \"container_port\" {\n  description = \"Container port exposed by the app.\"\n  type        = number\n  default     = 3000\n}\n\nvariable \"desired_count\" {\n  description = \"Desired number of ECS tasks.\"\n  type        = number\n  default     = 2\n}\n\nvariable \"task_cpu\" {\n  description = \"Fargate task CPU units.\"\n  type        = number\n  default     = 256\n}\n\nvariable \"task_memory\" {\n  description = \"Fargate task memory (MiB).\"\n  type        = number\n  default     = 512\n}\n\nvariable \"log_group_name\" {\n  description = \"CloudWatch log group name for ECS awslogs driver.\"\n  type        = string\n  default     = \"/ecs/hello-world\"\n}\n\nvariable \"log_retention_in_days\" {\n  description = \"CloudWatch log retention in days.\"\n  type        = number\n  default     = 14\n}\n\nvariable \"vpc_cidr\" {\n  description = \"CIDR block for the VPC.\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"tags\" {\n  description = \"Tags applied to all resources via provider default_tags.\"\n  type        = map(string)\n  default = {\n    Project = \"hello-world\"\n    Managed = \"terraform\"\n  }\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  azs = slice(data.aws_availability_zones.available.names, 0, 2)\n\n  image_uri = \"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com/${var.ecr_repo_name}:${var.image_tag}\"\n}\n\n# --- Networking (VPC, subnets, NAT) ---\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~> 6.6\"\n\n  name = var.name\n  cidr = var.vpc_cidr\n\n  azs             = local.azs\n  public_subnets  = [for i, az in local.azs : cidrsubnet(var.vpc_cidr, 8, i)]\n  private_subnets = [for i, az in local.azs : cidrsubnet(var.vpc_cidr, 8, i + 10)]\n\n  enable_nat_gateway     = true\n  single_nat_gateway     = false\n  one_nat_gateway_per_az = true\n\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n}\n\n# --- ECR ---\nresource \"aws_ecr_repository\" \"app\" {\n  name                 = var.ecr_repo_name\n  image_tag_mutability = \"MUTABLE\"\n\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n}\n\nresource \"aws_ecr_lifecycle_policy\" \"app\" {\n  repository = aws_ecr_repository.app.name\n\n  policy = jsonencode({\n    rules = [\n      {\n        rulePriority = 1\n        description  = \"Expire untagged images older than 7 days\"\n        selection = {\n          tagStatus   = \"untagged\"\n          countType   = \"sinceImagePushed\"\n          countUnit   = \"days\"\n          countNumber = 7\n        }\n        action = {\n          type = \"expire\"\n        }\n      },\n      {\n        rulePriority = 2\n        description  = \"Keep last 30 images\"\n        selection = {\n          tagStatus   = \"any\"\n          countType   = \"imageCountMoreThan\"\n          countNumber = 30\n        }\n        action = {\n          type = \"expire\"\n        }\n      }\n    ]\n  })\n}\n\n# --- CloudWatch Logs ---\nresource \"aws_cloudwatch_log_group\" \"ecs\" {\n  name              = var.log_group_name\n  retention_in_days = var.log_retention_in_days\n}\n\n# --- Security Groups ---\nresource \"aws_security_group\" \"alb\" {\n  name        = \"${var.name}-alb\"\n  description = \"ALB security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description = \"HTTP\"\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_security_group\" \"ecs_tasks\" {\n  name        = \"${var.name}-ecs-tasks\"\n  description = \"ECS tasks security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description     = \"App from ALB\"\n    from_port       = var.container_port\n    to_port         = var.container_port\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.alb.id]\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\n# --- ALB ---\nmodule \"alb\" {\n  source  = \"terraform-aws-modules/alb/aws\"\n  version = \"~> 10.5\"\n\n  name               = var.name\n  load_balancer_type = \"application\"\n  vpc_id             = module.vpc.vpc_id\n  subnets            = module.vpc.public_subnets\n  security_groups    = [aws_security_group.alb.id]\n\n  listeners = {\n    http = {\n      port     = 80\n      protocol = \"HTTP\"\n\n      forward = {\n        target_group_key = \"app\"\n      }\n    }\n  }\n\n  target_groups = {\n    app = {\n      name_prefix          = \"app-\"\n      protocol             = \"HTTP\"\n      port                 = var.container_port\n      target_type          = \"ip\"\n      vpc_id               = module.vpc.vpc_id\n      deregistration_delay = 10\n\n      health_check = {\n        enabled             = true\n        path                = \"/\"\n        matcher             = \"200-399\"\n        interval            = 30\n        timeout             = 5\n        healthy_threshold   = 2\n        unhealthy_threshold = 2\n      }\n    }\n  }\n}\n\n# --- ECS (cluster, service, task definition) ---\nmodule \"ecs\" {\n  source  = \"terraform-aws-modules/ecs/aws\"\n  version = \"~> 7.3\"\n\n  cluster_name = var.name\n\n  default_capacity_provider_strategy = {\n    FARGATE = {\n      weight = 1\n      base   = 1\n    }\n  }\n\n  services = {\n    app = {\n      cpu    = var.task_cpu\n      memory = var.task_memory\n\n      desired_count = var.desired_count\n\n      subnet_ids          = module.vpc.private_subnets\n      security_group_ids  = [aws_security_group.ecs_tasks.id]\n      assign_public_ip    = false\n      enable_execute_command = true\n\n      load_balancer = {\n        service = {\n          target_group_arn = module.alb.target_groups[\"app\"].arn\n          container_name   = \"app\"\n          container_port   = var.container_port\n        }\n      }\n\n      container_definitions = {\n        app = {\n          name      = \"app\"\n          image     = local.image_uri\n          essential = true\n\n          port_mappings = [\n            {\n              name          = \"http\"\n              containerPort = var.container_port\n              protocol      = \"tcp\"\n            }\n          ]\n\n          readonly_root_filesystem = false\n\n          log_configuration = {\n            logDriver = \"awslogs\"\n            options = {\n              awslogs-group         = aws_cloudwatch_log_group.ecs.name\n              awslogs-region        = var.aws_region\n              awslogs-stream-prefix = \"ecs\"\n            }\n          }\n        }\n      }\n\n      # Allow the module to create the task execution role with the right permissions.\n      create_task_exec_iam_role = true\n\n      # App task role (no AWS permissions needed for this hello-world app)\n      create_tasks_iam_role = true\n    }\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"ecr_repository_url\" {\n  description = \"ECR repository URL (no tag).\"\n  value       = aws_ecr_repository.app.repository_url\n}\n\noutput \"alb_dns_name\" {\n  description = \"Public DNS name of the Application Load Balancer.\"\n  value       = module.alb.dns_name\n}\n\noutput \"ecs_cluster_name\" {\n  description = \"ECS cluster name.\"\n  value       = module.ecs.cluster_name\n}\n\noutput \"ecs_service_name\" {\n  description = \"ECS service name.\"\n  value       = module.ecs.services[\"app\"].name\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region    = \"us-east-1\"\nname          = \"hello-world\"\necr_repo_name = \"ptapp2\"\nimage_tag     = \"latest\"\n"
    }
  ]
}