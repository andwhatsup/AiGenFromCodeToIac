{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.6.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = {\n      Project     = var.project_name\n      Environment = var.environment\n      ManagedBy   = \"terraform\"\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for resources.\"\n  type        = string\n  default     = \"reminder-bot\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, prod).\"\n  type        = string\n  default     = \"prod\"\n}\n\nvariable \"lambda_function_name\" {\n  description = \"Lambda function name.\"\n  type        = string\n  default     = \"reminder-bot-lambda\"\n}\n\nvariable \"lambda_handler\" {\n  description = \"Lambda handler (Java).\"\n  type        = string\n  default     = \"handler.Handler::handleRequest\"\n}\n\nvariable \"lambda_runtime\" {\n  description = \"Lambda runtime.\"\n  type        = string\n  default     = \"java21\"\n}\n\nvariable \"lambda_memory_size\" {\n  description = \"Lambda memory size (MB).\"\n  type        = number\n  default     = 1024\n}\n\nvariable \"lambda_timeout_seconds\" {\n  description = \"Lambda timeout (seconds).\"\n  type        = number\n  default     = 30\n}\n\nvariable \"lambda_reserved_concurrency\" {\n  description = \"Reserved concurrency to prevent message storms. Set null to disable.\"\n  type        = number\n  default     = 1\n}\n\nvariable \"lambda_log_retention_days\" {\n  description = \"CloudWatch log retention in days.\"\n  type        = number\n  default     = 30\n}\n\nvariable \"lambda_package_path\" {\n  description = \"Path to the Lambda deployment package (zip or jar). For CI/CD, you can deploy code separately; Terraform will still create the function.\"\n  type        = string\n  default     = \"./build/lambda.zip\"\n}\n\nvariable \"telegram_bot_token\" {\n  description = \"Telegram bot token. Stored in Secrets Manager.\"\n  type        = string\n  sensitive   = true\n}\n\nvariable \"telegram_chat_id\" {\n  description = \"Telegram chat id. Stored in SSM Parameter Store.\"\n  type        = string\n}\n\nvariable \"half_month_message\" {\n  description = \"Message template for half-month reminder. Stored in SSM Parameter Store.\"\n  type        = string\n}\n\nvariable \"end_month_message\" {\n  description = \"Message template for end-month reminder. Stored in SSM Parameter Store.\"\n  type        = string\n}\n\nvariable \"schedule_half_month_cron\" {\n  description = \"EventBridge schedule expression for half-month reminder.\"\n  type        = string\n  default     = \"cron(0 9 15 * ? *)\" # 09:00 UTC on the 15th\n}\n\nvariable \"schedule_end_month_cron\" {\n  description = \"EventBridge schedule expression for end-month reminder.\"\n  type        = string\n  default     = \"cron(0 9 L * ? *)\" # 09:00 UTC on the last day of month\n}\n\nvariable \"enable_sns_alarm_notifications\" {\n  description = \"Whether to create an SNS topic and wire alarms to it.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"alarm_email\" {\n  description = \"Email address to subscribe to SNS topic (only used if enable_sns_alarm_notifications=true).\"\n  type        = string\n  default     = null\n}\n\nvariable \"github_org\" {\n  description = \"GitHub organization/user for OIDC trust (e.g., 'my-org').\"\n  type        = string\n  default     = null\n}\n\nvariable \"github_repo\" {\n  description = \"GitHub repository name for OIDC trust (e.g., 'reminder-bot').\"\n  type        = string\n  default     = null\n}\n\nvariable \"create_github_oidc\" {\n  description = \"Create GitHub OIDC provider and deploy role. Set true to use OIDC instead of long-lived keys.\"\n  type        = bool\n  default     = false\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n}\n\n# --- Secrets & Parameters ---\nresource \"aws_secretsmanager_secret\" \"telegram_bot_token\" {\n  name                    = \"${local.name_prefix}/telegram/bot_token\"\n  recovery_window_in_days = 7\n}\n\nresource \"aws_secretsmanager_secret_version\" \"telegram_bot_token\" {\n  secret_id     = aws_secretsmanager_secret.telegram_bot_token.id\n  secret_string = var.telegram_bot_token\n}\n\nresource \"aws_ssm_parameter\" \"telegram_chat_id\" {\n  name  = \"/${local.name_prefix}/telegram/chat_id\"\n  type  = \"String\"\n  value = var.telegram_chat_id\n}\n\nresource \"aws_ssm_parameter\" \"half_month_message\" {\n  name  = \"/${local.name_prefix}/messages/half_month\"\n  type  = \"String\"\n  value = var.half_month_message\n}\n\nresource \"aws_ssm_parameter\" \"end_month_message\" {\n  name  = \"/${local.name_prefix}/messages/end_month\"\n  type  = \"String\"\n  value = var.end_month_message\n}\n\n# --- IAM for Lambda ---\nresource \"aws_iam_role\" \"lambda_exec\" {\n  name = \"${local.name_prefix}-lambda-exec\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"lambda.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"lambda_exec_inline\" {\n  name = \"${local.name_prefix}-lambda-exec\"\n  role = aws_iam_role.lambda_exec.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      # CloudWatch Logs\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"logs:CreateLogGroup\",\n          \"logs:CreateLogStream\",\n          \"logs:PutLogEvents\"\n        ]\n        Resource = \"*\"\n      },\n      # Read secret value\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"secretsmanager:GetSecretValue\"\n        ]\n        Resource = aws_secretsmanager_secret.telegram_bot_token.arn\n      },\n      # Read parameters\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"ssm:GetParameter\",\n          \"ssm:GetParameters\"\n        ]\n        Resource = [\n          aws_ssm_parameter.telegram_chat_id.arn,\n          aws_ssm_parameter.half_month_message.arn,\n          aws_ssm_parameter.end_month_message.arn\n        ]\n      }\n    ]\n  })\n}\n\n# --- CloudWatch Log Group (explicit for retention) ---\nresource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${var.lambda_function_name}\"\n  retention_in_days = var.lambda_log_retention_days\n}\n\n# --- Lambda ---\nresource \"aws_lambda_function\" \"this\" {\n  function_name = var.lambda_function_name\n  role          = aws_iam_role.lambda_exec.arn\n  handler       = var.lambda_handler\n  runtime       = var.lambda_runtime\n\n  filename         = var.lambda_package_path\n  source_code_hash = filebase64sha256(var.lambda_package_path)\n\n  memory_size = var.lambda_memory_size\n  timeout     = var.lambda_timeout_seconds\n\n  reserved_concurrent_executions = var.lambda_reserved_concurrency\n\n  environment {\n    variables = {\n      # Keep compatibility with existing code expecting env vars.\n      # bot_token is stored in Secrets Manager; we pass the secret ARN and parameter names.\n      # If the code only reads env vars directly, you can switch to passing the plaintext token\n      # (not recommended) or update code to fetch from Secrets Manager/SSM.\n      BOT_TOKEN_SECRET_ARN = aws_secretsmanager_secret.telegram_bot_token.arn\n      CHAT_ID_PARAM_NAME   = aws_ssm_parameter.telegram_chat_id.name\n      HALF_MSG_PARAM_NAME  = aws_ssm_parameter.half_month_message.name\n      END_MSG_PARAM_NAME   = aws_ssm_parameter.end_month_message.name\n\n      # Backwards-compatible names (optional):\n      # chat_id, half_month_message, end_month_message can be injected directly if desired.\n      chat_id            = var.telegram_chat_id\n      half_month_message = var.half_month_message\n      end_month_message  = var.end_month_message\n    }\n  }\n\n  depends_on = [aws_cloudwatch_log_group.lambda]\n}\n\n# --- EventBridge Scheduler (two schedules) ---\nresource \"aws_iam_role\" \"scheduler_invoke\" {\n  name = \"${local.name_prefix}-scheduler-invoke\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"scheduler.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"scheduler_invoke\" {\n  name = \"${local.name_prefix}-scheduler-invoke\"\n  role = aws_iam_role.scheduler_invoke.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"lambda:InvokeFunction\"\n        ]\n        Resource = aws_lambda_function.this.arn\n      }\n    ]\n  })\n}\n\nresource \"aws_scheduler_schedule\" \"half_month\" {\n  name                         = \"${local.name_prefix}-half-month\"\n  schedule_expression          = var.schedule_half_month_cron\n  schedule_expression_timezone = \"UTC\"\n\n  flexible_time_window {\n    mode = \"OFF\"\n  }\n\n  target {\n    arn      = aws_lambda_function.this.arn\n    role_arn = aws_iam_role.scheduler_invoke.arn\n\n    input = jsonencode({\n      reminder_type = \"half_month\"\n    })\n  }\n}\n\nresource \"aws_scheduler_schedule\" \"end_month\" {\n  name                         = \"${local.name_prefix}-end-month\"\n  schedule_expression          = var.schedule_end_month_cron\n  schedule_expression_timezone = \"UTC\"\n\n  flexible_time_window {\n    mode = \"OFF\"\n  }\n\n  target {\n    arn      = aws_lambda_function.this.arn\n    role_arn = aws_iam_role.scheduler_invoke.arn\n\n    input = jsonencode({\n      reminder_type = \"end_month\"\n    })\n  }\n}\n\n# --- CloudWatch Alarms ---\nresource \"aws_sns_topic\" \"alarms\" {\n  count = var.enable_sns_alarm_notifications ? 1 : 0\n  name  = \"${local.name_prefix}-alarms\"\n}\n\nresource \"aws_sns_topic_subscription\" \"alarm_email\" {\n  count     = var.enable_sns_alarm_notifications && var.alarm_email != null ? 1 : 0\n  topic_arn = aws_sns_topic.alarms[0].arn\n  protocol  = \"email\"\n  endpoint  = var.alarm_email\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"lambda_errors\" {\n  alarm_name          = \"${local.name_prefix}-lambda-errors\"\n  alarm_description   = \"Lambda errors > 0\"\n  comparison_operator = \"GreaterThanThreshold\"\n  evaluation_periods  = 1\n  metric_name         = \"Errors\"\n  namespace           = \"AWS/Lambda\"\n  period              = 300\n  statistic           = \"Sum\"\n  threshold           = 0\n\n  dimensions = {\n    FunctionName = aws_lambda_function.this.function_name\n  }\n\n  alarm_actions = var.enable_sns_alarm_notifications ? [aws_sns_topic.alarms[0].arn] : []\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"lambda_throttles\" {\n  alarm_name          = \"${local.name_prefix}-lambda-throttles\"\n  alarm_description   = \"Lambda throttles > 0\"\n  comparison_operator = \"GreaterThanThreshold\"\n  evaluation_periods  = 1\n  metric_name         = \"Throttles\"\n  namespace           = \"AWS/Lambda\"\n  period              = 300\n  statistic           = \"Sum\"\n  threshold           = 0\n\n  dimensions = {\n    FunctionName = aws_lambda_function.this.function_name\n  }\n\n  alarm_actions = var.enable_sns_alarm_notifications ? [aws_sns_topic.alarms[0].arn] : []\n}\n\n# --- Optional: GitHub OIDC deploy role (recommended) ---\n# Creates an IAM role that GitHub Actions can assume to update Lambda code.\n# Enable with create_github_oidc=true and set github_org/github_repo.\n\nresource \"aws_iam_openid_connect_provider\" \"github\" {\n  count = var.create_github_oidc ? 1 : 0\n\n  url = \"https://token.actions.githubusercontent.com\"\n\n  client_id_list = [\n    \"sts.amazonaws.com\"\n  ]\n\n  thumbprint_list = [\n    # GitHub Actions OIDC root CA thumbprint (commonly used). You may need to update if GitHub changes.\n    \"6938fd4d98bab03faadb97b34396831e3780aea1\"\n  ]\n}\n\nresource \"aws_iam_role\" \"github_deploy\" {\n  count = var.create_github_oidc ? 1 : 0\n\n  name = \"${local.name_prefix}-github-deploy\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Federated = aws_iam_openid_connect_provider.github[0].arn\n        }\n        Action = \"sts:AssumeRoleWithWebIdentity\"\n        Condition = {\n          StringEquals = {\n            \"token.actions.githubusercontent.com:aud\" = \"sts.amazonaws.com\"\n          }\n          StringLike = {\n            \"token.actions.githubusercontent.com:sub\" = \"repo:${var.github_org}/${var.github_repo}:*\"\n          }\n        }\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"github_deploy\" {\n  count = var.create_github_oidc ? 1 : 0\n\n  name = \"${local.name_prefix}-github-deploy\"\n  role = aws_iam_role.github_deploy[0].id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"lambda:GetFunction\",\n          \"lambda:UpdateFunctionCode\",\n          \"lambda:UpdateFunctionConfiguration\"\n        ]\n        Resource = aws_lambda_function.this.arn\n      }\n    ]\n  })\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"lambda_function_name\" {\n  value       = aws_lambda_function.this.function_name\n  description = \"Deployed Lambda function name.\"\n}\n\noutput \"lambda_function_arn\" {\n  value       = aws_lambda_function.this.arn\n  description = \"Deployed Lambda function ARN.\"\n}\n\noutput \"telegram_bot_token_secret_arn\" {\n  value       = aws_secretsmanager_secret.telegram_bot_token.arn\n  description = \"Secrets Manager secret ARN storing the Telegram bot token.\"\n}\n\noutput \"ssm_parameter_names\" {\n  value = {\n    chat_id            = aws_ssm_parameter.telegram_chat_id.name\n    half_month_message = aws_ssm_parameter.half_month_message.name\n    end_month_message  = aws_ssm_parameter.end_month_message.name\n  }\n  description = \"SSM parameter names for configuration.\"\n}\n\noutput \"scheduler_schedule_names\" {\n  value = {\n    half_month = aws_scheduler_schedule.half_month.name\n    end_month  = aws_scheduler_schedule.end_month.name\n  }\n  description = \"EventBridge Scheduler schedule names.\"\n}\n\noutput \"github_deploy_role_arn\" {\n  value       = var.create_github_oidc ? aws_iam_role.github_deploy[0].arn : null\n  description = \"IAM role ARN for GitHub Actions OIDC deploy (if enabled).\"\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region   = \"us-east-1\"\nproject_name = \"reminder-bot\"\nenvironment  = \"prod\"\n\nlambda_function_name = \"reminder-bot-lambda\"\n# Ensure this file exists before running terraform plan/apply.\n# For example, package your shaded jar into a zip and point to it.\nlambda_package_path = \"./build/lambda.zip\"\n\n# Sensitive\ntelegram_bot_token = \"REPLACE_ME\"\n\n# Non-sensitive config\ntelegram_chat_id     = \"REPLACE_ME\"\nhalf_month_message   = \"Half-month reminder message\"\nend_month_message    = \"End-month reminder message\"\n\n# Schedules (UTC)\nschedule_half_month_cron = \"cron(0 9 15 * ? *)\"\nschedule_end_month_cron  = \"cron(0 9 L * ? *)\"\n\n# Optional alarms notifications\nenable_sns_alarm_notifications = false\n# alarm_email = \"you@example.com\"\n\n# Optional GitHub OIDC\ncreate_github_oidc = false\n# github_org  = \"my-org\"\n# github_repo = \"my-repo\"\n"
    },
    {
      "name": "README.md",
      "content": "# Terraform - Reminder Bot (Lambda + Scheduler)\n\n## What this provisions\n- Lambda function (Java 21)\n- Secrets Manager secret for Telegram bot token\n- SSM parameters for chat id and message templates\n- EventBridge Scheduler schedules (half-month + end-month)\n- CloudWatch log group retention + basic alarms\n- (Optional) GitHub OIDC provider + deploy role for GitHub Actions\n\n## Packaging note\nThis Terraform expects a deployment artifact at `var.lambda_package_path`.\nIn CI/CD you can still deploy code via `aws lambda update-function-code`, but Terraform needs a file to compute `source_code_hash`.\n\nA common approach:\n- Build shaded jar with Maven\n- Zip it as `lambda.zip` containing the jar at root\n- Set `lambda_package_path` to that zip\n\n## Run\n1. Copy tfvars example:\n   ```bash\n   cp terraform.tfvars.example terraform.tfvars\n   ```\n2. Fill in values.\n3. Init/validate:\n   ```bash\n   terraform init\n   terraform validate\n   ```\n"
    }
  ]
}