{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.7, < 2.0.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = merge(\n      {\n        ManagedBy = \"Terraform\"\n        Project   = var.project\n        Env       = var.environment\n      },\n      var.tags\n    )\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"project\" {\n  description = \"Project/name prefix used for tagging and resource naming.\"\n  type        = string\n  default     = \"iac-platform\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, stage, prod).\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"state_bucket_name\" {\n  description = \"S3 bucket name for Terraform remote state (e.g., <profile>-terraform-state). Must be globally unique.\"\n  type        = string\n}\n\nvariable \"state_bucket_force_destroy\" {\n  description = \"If true, allow Terraform to delete the state bucket even if it contains objects (DANGEROUS).\"\n  type        = bool\n  default     = false\n}\n\nvariable \"state_bucket_key_prefix\" {\n  description = \"Optional prefix within the state bucket to scope access (e.g., live/).\"\n  type        = string\n  default     = \"\"\n}\n\nvariable \"lock_table_name\" {\n  description = \"DynamoDB table name for Terraform state locking.\"\n  type        = string\n  default     = \"terraform-locks\"\n}\n\nvariable \"github_org\" {\n  description = \"GitHub organization or user that owns the repository.\"\n  type        = string\n}\n\nvariable \"github_repo\" {\n  description = \"GitHub repository name (without org).\"\n  type        = string\n}\n\nvariable \"github_oidc_thumbprints\" {\n  description = \"Thumbprints for GitHub Actions OIDC provider. Leave default unless you have a specific requirement.\"\n  type        = list(string)\n  default     = [\"6938fd4d98bab03faadb97b34396831e3780aea1\"]\n}\n\nvariable \"github_oidc_audience\" {\n  description = \"OIDC audience for GitHub Actions. Typically sts.amazonaws.com.\"\n  type        = string\n  default     = \"sts.amazonaws.com\"\n}\n\nvariable \"plan_role_name\" {\n  description = \"IAM role name for GitHub Actions plan (read-only-ish) operations.\"\n  type        = string\n  default     = \"terraform-plan-role\"\n}\n\nvariable \"apply_role_name\" {\n  description = \"IAM role name for GitHub Actions apply (write) operations.\"\n  type        = string\n  default     = \"terraform-apply-role\"\n}\n\nvariable \"apply_role_allowed_branches\" {\n  description = \"Branches allowed to assume the apply role. Use refs/heads/<branch>.\"\n  type        = list(string)\n  default     = [\"refs/heads/main\"]\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply to all resources.\"\n  type        = map(string)\n  default     = {}\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  name_prefix = \"${var.project}-${var.environment}\"\n\n  state_prefix_normalized = trim(var.state_bucket_key_prefix, \"/\")\n  state_prefix_arn        = local.state_prefix_normalized == \"\" ? \"\" : \"${local.state_prefix_normalized}/*\"\n\n  github_repo_sub = \"repo:${var.github_org}/${var.github_repo}:*\"\n\n  apply_branch_subs = [\n    for b in var.apply_role_allowed_branches : \"repo:${var.github_org}/${var.github_repo}:ref:${b}\"\n  ]\n}\n\n# -----------------------------\n# KMS key for tfstate encryption\n# -----------------------------\nresource \"aws_kms_key\" \"tfstate\" {\n  description             = \"KMS key for Terraform remote state encryption (S3 SSE-KMS)\"\n  deletion_window_in_days = 30\n  enable_key_rotation     = true\n\n  policy = data.aws_iam_policy_document.kms_tfstate.json\n}\n\nresource \"aws_kms_alias\" \"tfstate\" {\n  name          = \"alias/${local.name_prefix}-tfstate\"\n  target_key_id = aws_kms_key.tfstate.key_id\n}\n\ndata \"aws_iam_policy_document\" \"kms_tfstate\" {\n  statement {\n    sid     = \"EnableRootPermissions\"\n    effect  = \"Allow\"\n    actions = [\"kms:*\"]\n\n    principals {\n      type        = \"AWS\"\n      identifiers = [\"arn:aws:iam::${data.aws_caller_identity.current.account_id}:root\"]\n    }\n\n    resources = [\"*\"]\n  }\n\n  # Allow the GitHub roles to use the key for encrypt/decrypt of state objects.\n  statement {\n    sid    = \"AllowGitHubRolesUseKey\"\n    effect = \"Allow\"\n\n    actions = [\n      \"kms:Encrypt\",\n      \"kms:Decrypt\",\n      \"kms:ReEncrypt*\",\n      \"kms:GenerateDataKey*\",\n      \"kms:DescribeKey\"\n    ]\n\n    principals {\n      type        = \"AWS\"\n      identifiers = [\n        aws_iam_role.terraform_plan.arn,\n        aws_iam_role.terraform_apply.arn\n      ]\n    }\n\n    resources = [\"*\"]\n  }\n}\n\ndata \"aws_caller_identity\" \"current\" {}\n\n# -----------------------------\n# S3 bucket for Terraform state\n# -----------------------------\nresource \"aws_s3_bucket\" \"tfstate\" {\n  bucket        = var.state_bucket_name\n  force_destroy = var.state_bucket_force_destroy\n}\n\nresource \"aws_s3_bucket_versioning\" \"tfstate\" {\n  bucket = aws_s3_bucket.tfstate.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"tfstate\" {\n  bucket = aws_s3_bucket.tfstate.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm     = \"aws:kms\"\n      kms_master_key_id = aws_kms_key.tfstate.arn\n    }\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"tfstate\" {\n  bucket = aws_s3_bucket.tfstate.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"tfstate\" {\n  bucket = aws_s3_bucket.tfstate.id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\nresource \"aws_s3_bucket_policy\" \"tfstate\" {\n  bucket = aws_s3_bucket.tfstate.id\n  policy = data.aws_iam_policy_document.tfstate_bucket.json\n}\n\ndata \"aws_iam_policy_document\" \"tfstate_bucket\" {\n  # Deny non-TLS\n  statement {\n    sid    = \"DenyInsecureTransport\"\n    effect = \"Deny\"\n\n    principals {\n      type        = \"*\"\n      identifiers = [\"*\"]\n    }\n\n    actions = [\"s3:*\"]\n\n    resources = [\n      aws_s3_bucket.tfstate.arn,\n      \"${aws_s3_bucket.tfstate.arn}/*\"\n    ]\n\n    condition {\n      test     = \"Bool\"\n      variable = \"aws:SecureTransport\"\n      values   = [\"false\"]\n    }\n  }\n}\n\n# -----------------------------\n# DynamoDB table for state lock\n# -----------------------------\nresource \"aws_dynamodb_table\" \"terraform_locks\" {\n  name         = var.lock_table_name\n  billing_mode = \"PAY_PER_REQUEST\"\n  hash_key     = \"LockID\"\n\n  attribute {\n    name = \"LockID\"\n    type = \"S\"\n  }\n\n  point_in_time_recovery {\n    enabled = true\n  }\n}\n\n# -----------------------------\n# GitHub Actions OIDC provider\n# -----------------------------\nresource \"aws_iam_openid_connect_provider\" \"github\" {\n  url             = \"https://token.actions.githubusercontent.com\"\n  client_id_list  = [var.github_oidc_audience]\n  thumbprint_list = var.github_oidc_thumbprints\n}\n\n# -----------------------------\n# IAM roles for GitHub Actions\n# -----------------------------\nresource \"aws_iam_role\" \"terraform_plan\" {\n  name               = var.plan_role_name\n  assume_role_policy = data.aws_iam_policy_document.github_assume_plan.json\n}\n\nresource \"aws_iam_role\" \"terraform_apply\" {\n  name               = var.apply_role_name\n  assume_role_policy = data.aws_iam_policy_document.github_assume_apply.json\n}\n\ndata \"aws_iam_policy_document\" \"github_assume_plan\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRoleWithWebIdentity\"]\n\n    principals {\n      type        = \"Federated\"\n      identifiers = [aws_iam_openid_connect_provider.github.arn]\n    }\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"token.actions.githubusercontent.com:aud\"\n      values   = [var.github_oidc_audience]\n    }\n\n    condition {\n      test     = \"StringLike\"\n      variable = \"token.actions.githubusercontent.com:sub\"\n      values   = [local.github_repo_sub]\n    }\n  }\n}\n\ndata \"aws_iam_policy_document\" \"github_assume_apply\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRoleWithWebIdentity\"]\n\n    principals {\n      type        = \"Federated\"\n      identifiers = [aws_iam_openid_connect_provider.github.arn]\n    }\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"token.actions.githubusercontent.com:aud\"\n      values   = [var.github_oidc_audience]\n    }\n\n    # Restrict apply to specific branches\n    condition {\n      test     = \"StringLike\"\n      variable = \"token.actions.githubusercontent.com:sub\"\n      values   = local.apply_branch_subs\n    }\n  }\n}\n\n# Policy: allow state bucket + lock table access\nresource \"aws_iam_policy\" \"terraform_state_access\" {\n  name   = \"${local.name_prefix}-terraform-state-access\"\n  policy = data.aws_iam_policy_document.terraform_state_access.json\n}\n\ndata \"aws_iam_policy_document\" \"terraform_state_access\" {\n  statement {\n    sid    = \"ListStateBucket\"\n    effect = \"Allow\"\n\n    actions = [\n      \"s3:ListBucket\",\n      \"s3:GetBucketLocation\"\n    ]\n\n    resources = [aws_s3_bucket.tfstate.arn]\n\n    dynamic \"condition\" {\n      for_each = local.state_prefix_normalized == \"\" ? [] : [1]\n      content {\n        test     = \"StringLike\"\n        variable = \"s3:prefix\"\n        values   = [local.state_prefix_arn]\n      }\n    }\n  }\n\n  statement {\n    sid    = \"StateObjectRW\"\n    effect = \"Allow\"\n\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:DeleteObject\",\n      \"s3:GetObjectVersion\",\n      \"s3:ListBucketMultipartUploads\",\n      \"s3:AbortMultipartUpload\",\n      \"s3:ListMultipartUploadParts\"\n    ]\n\n    resources = [\n      local.state_prefix_normalized == \"\" ? \"${aws_s3_bucket.tfstate.arn}/*\" : \"${aws_s3_bucket.tfstate.arn}/${local.state_prefix_arn}\"\n    ]\n  }\n\n  statement {\n    sid    = \"DynamoDBLocking\"\n    effect = \"Allow\"\n\n    actions = [\n      \"dynamodb:DescribeTable\",\n      \"dynamodb:GetItem\",\n      \"dynamodb:PutItem\",\n      \"dynamodb:DeleteItem\",\n      \"dynamodb:UpdateItem\"\n    ]\n\n    resources = [aws_dynamodb_table.terraform_locks.arn]\n  }\n\n  statement {\n    sid    = \"KMSForState\"\n    effect = \"Allow\"\n\n    actions = [\n      \"kms:Encrypt\",\n      \"kms:Decrypt\",\n      \"kms:ReEncrypt*\",\n      \"kms:GenerateDataKey*\",\n      \"kms:DescribeKey\"\n    ]\n\n    resources = [aws_kms_key.tfstate.arn]\n  }\n}\n\nresource \"aws_iam_role_policy_attachment\" \"plan_state\" {\n  role       = aws_iam_role.terraform_plan.name\n  policy_arn = aws_iam_policy.terraform_state_access.arn\n}\n\nresource \"aws_iam_role_policy_attachment\" \"apply_state\" {\n  role       = aws_iam_role.terraform_apply.name\n  policy_arn = aws_iam_policy.terraform_state_access.arn\n}\n\n# NOTE: The apply role intentionally does NOT include broad service permissions.\n# Add additional policies for the AWS services your Terraform stacks manage.\n\n# -----------------------------\n# CloudTrail (audit)\n# -----------------------------\nresource \"aws_s3_bucket\" \"cloudtrail_logs\" {\n  bucket = \"${local.name_prefix}-cloudtrail-logs-${data.aws_caller_identity.current.account_id}\"\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"cloudtrail_logs\" {\n  bucket = aws_s3_bucket.cloudtrail_logs.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"cloudtrail_logs\" {\n  bucket = aws_s3_bucket.cloudtrail_logs.id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\nresource \"aws_s3_bucket_versioning\" \"cloudtrail_logs\" {\n  bucket = aws_s3_bucket.cloudtrail_logs.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"cloudtrail_logs\" {\n  bucket = aws_s3_bucket.cloudtrail_logs.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_policy\" \"cloudtrail_logs\" {\n  bucket = aws_s3_bucket.cloudtrail_logs.id\n  policy = data.aws_iam_policy_document.cloudtrail_bucket.json\n}\n\ndata \"aws_iam_policy_document\" \"cloudtrail_bucket\" {\n  statement {\n    sid    = \"AWSCloudTrailAclCheck\"\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"cloudtrail.amazonaws.com\"]\n    }\n\n    actions   = [\"s3:GetBucketAcl\"]\n    resources = [aws_s3_bucket.cloudtrail_logs.arn]\n  }\n\n  statement {\n    sid    = \"AWSCloudTrailWrite\"\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"cloudtrail.amazonaws.com\"]\n    }\n\n    actions = [\"s3:PutObject\"]\n\n    resources = [\n      \"${aws_s3_bucket.cloudtrail_logs.arn}/AWSLogs/${data.aws_caller_identity.current.account_id}/*\"\n    ]\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"s3:x-amz-acl\"\n      values   = [\"bucket-owner-full-control\"]\n    }\n  }\n\n  statement {\n    sid    = \"DenyInsecureTransport\"\n    effect = \"Deny\"\n\n    principals {\n      type        = \"*\"\n      identifiers = [\"*\"]\n    }\n\n    actions = [\"s3:*\"]\n\n    resources = [\n      aws_s3_bucket.cloudtrail_logs.arn,\n      \"${aws_s3_bucket.cloudtrail_logs.arn}/*\"\n    ]\n\n    condition {\n      test     = \"Bool\"\n      variable = \"aws:SecureTransport\"\n      values   = [\"false\"]\n    }\n  }\n}\n\nresource \"aws_cloudtrail\" \"main\" {\n  name                          = \"${local.name_prefix}-cloudtrail\"\n  s3_bucket_name                = aws_s3_bucket.cloudtrail_logs.id\n  include_global_service_events = true\n  is_multi_region_trail         = true\n  enable_logging                = true\n\n  event_selector {\n    read_write_type           = \"All\"\n    include_management_events = true\n  }\n\n  depends_on = [aws_s3_bucket_policy.cloudtrail_logs]\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"tfstate_bucket_name\" {\n  description = \"Terraform remote state S3 bucket name.\"\n  value       = aws_s3_bucket.tfstate.id\n}\n\noutput \"tfstate_bucket_arn\" {\n  description = \"Terraform remote state S3 bucket ARN.\"\n  value       = aws_s3_bucket.tfstate.arn\n}\n\noutput \"tfstate_kms_key_arn\" {\n  description = \"KMS key ARN used for S3 SSE-KMS encryption of tfstate.\"\n  value       = aws_kms_key.tfstate.arn\n}\n\noutput \"terraform_lock_table_name\" {\n  description = \"DynamoDB table name used for Terraform state locking.\"\n  value       = aws_dynamodb_table.terraform_locks.name\n}\n\noutput \"github_oidc_provider_arn\" {\n  description = \"ARN of the GitHub Actions OIDC provider in IAM.\"\n  value       = aws_iam_openid_connect_provider.github.arn\n}\n\noutput \"terraform_plan_role_arn\" {\n  description = \"ARN of the GitHub Actions Terraform plan role.\"\n  value       = aws_iam_role.terraform_plan.arn\n}\n\noutput \"terraform_apply_role_arn\" {\n  description = \"ARN of the GitHub Actions Terraform apply role.\"\n  value       = aws_iam_role.terraform_apply.arn\n}\n\noutput \"cloudtrail_s3_bucket_name\" {\n  description = \"S3 bucket name where CloudTrail logs are delivered.\"\n  value       = aws_s3_bucket.cloudtrail_logs.id\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "# Copy to terraform.tfvars and fill values\n\nproject     = \"iac-platform\"\nenvironment = \"dev\"\naws_region  = \"us-east-1\"\n\n# Must be globally unique\nstate_bucket_name = \"aws-acme-terraform-state\"\n\nlock_table_name = \"terraform-locks\"\n\ngithub_org  = \"YOUR_GITHUB_ORG\"\ngithub_repo = \"YOUR_REPO_NAME\"\n\n# Restrict apply role to main branch by default\napply_role_allowed_branches = [\"refs/heads/main\"]\n\n# Optional: scope state access to a prefix (recommended if sharing bucket)\n# state_bucket_key_prefix = \"live\"\n"
    }
  ]
}