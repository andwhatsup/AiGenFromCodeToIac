{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.6.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = {\n      Project     = var.project_name\n      Environment = var.environment\n      ManagedBy   = \"terraform\"\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project name used for naming/tagging\"\n  type        = string\n  default     = \"flink-poc\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, staging, prod)\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"vpc_cidr\" {\n  description = \"VPC CIDR\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"az_count\" {\n  description = \"Number of AZs to use\"\n  type        = number\n  default     = 2\n}\n\nvariable \"eks_cluster_version\" {\n  description = \"EKS Kubernetes version\"\n  type        = string\n  default     = \"1.29\"\n}\n\nvariable \"eks_node_instance_types\" {\n  description = \"Instance types for EKS managed node group\"\n  type        = list(string)\n  default     = [\"m6i.large\"]\n}\n\nvariable \"eks_node_desired_size\" {\n  type        = number\n  default     = 2\n}\n\nvariable \"eks_node_min_size\" {\n  type        = number\n  default     = 1\n}\n\nvariable \"eks_node_max_size\" {\n  type        = number\n  default     = 4\n}\n\nvariable \"msk_kafka_version\" {\n  description = \"MSK Kafka version\"\n  type        = string\n  default     = \"3.6.0\"\n}\n\nvariable \"msk_broker_instance_type\" {\n  description = \"MSK broker instance type\"\n  type        = string\n  default     = \"kafka.m5.large\"\n}\n\nvariable \"msk_broker_volume_size\" {\n  description = \"EBS volume size (GiB) for each MSK broker\"\n  type        = number\n  default     = 100\n}\n\nvariable \"msk_broker_count\" {\n  description = \"Number of MSK brokers (must be a multiple of AZ count for best HA)\"\n  type        = number\n  default     = 2\n}\n\nvariable \"create_s3_vpc_endpoint\" {\n  description = \"Create S3 gateway endpoint for private S3 access\"\n  type        = bool\n  default     = true\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n\n  azs = slice(data.aws_availability_zones.available.names, 0, var.az_count)\n\n  # /20s inside /16 gives 16 subnets; we use 2*az_count (public+private)\n  public_subnet_cidrs  = [for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 4, i)]\n  private_subnet_cidrs = [for i in range(var.az_count) : cidrsubnet(var.vpc_cidr, 4, i + var.az_count)]\n}\n\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~> 5.0\"\n\n  name = local.name_prefix\n  cidr = var.vpc_cidr\n\n  azs             = local.azs\n  public_subnets  = local.public_subnet_cidrs\n  private_subnets = local.private_subnet_cidrs\n\n  enable_nat_gateway = true\n  single_nat_gateway = true\n\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n\n  public_subnet_tags = {\n    \"kubernetes.io/role/elb\" = \"1\"\n  }\n\n  private_subnet_tags = {\n    \"kubernetes.io/role/internal-elb\" = \"1\"\n  }\n}\n\nresource \"aws_vpc_endpoint\" \"s3\" {\n  count = var.create_s3_vpc_endpoint ? 1 : 0\n\n  vpc_id            = module.vpc.vpc_id\n  service_name      = \"com.amazonaws.${var.aws_region}.s3\"\n  vpc_endpoint_type = \"Gateway\"\n\n  route_table_ids = concat(module.vpc.private_route_table_ids, module.vpc.public_route_table_ids)\n\n  tags = {\n    Name = \"${local.name_prefix}-s3-endpoint\"\n  }\n}\n\nmodule \"eks\" {\n  source  = \"terraform-aws-modules/eks/aws\"\n  version = \"~> 20.0\"\n\n  cluster_name    = local.name_prefix\n  cluster_version = var.eks_cluster_version\n\n  vpc_id     = module.vpc.vpc_id\n  subnet_ids = module.vpc.private_subnets\n\n  enable_irsa = true\n\n  cluster_endpoint_public_access  = true\n  cluster_endpoint_private_access = true\n\n  eks_managed_node_groups = {\n    default = {\n      name            = \"${local.name_prefix}-ng\"\n      instance_types  = var.eks_node_instance_types\n      desired_size    = var.eks_node_desired_size\n      min_size        = var.eks_node_min_size\n      max_size        = var.eks_node_max_size\n      subnet_ids      = module.vpc.private_subnets\n      capacity_type   = \"ON_DEMAND\"\n      ami_type        = \"AL2_x86_64\"\n      disk_size       = 50\n    }\n  }\n}\n\nresource \"aws_s3_bucket\" \"flink_state\" {\n  bucket_prefix = \"${local.name_prefix}-flink-state-\"\n\n  force_destroy = false\n}\n\nresource \"aws_s3_bucket_versioning\" \"flink_state\" {\n  bucket = aws_s3_bucket.flink_state.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"flink_state\" {\n  bucket = aws_s3_bucket.flink_state.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"flink_state\" {\n  bucket = aws_s3_bucket.flink_state.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket\" \"connect_sink\" {\n  bucket_prefix = \"${local.name_prefix}-connect-sink-\"\n\n  force_destroy = false\n}\n\nresource \"aws_s3_bucket_versioning\" \"connect_sink\" {\n  bucket = aws_s3_bucket.connect_sink.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"connect_sink\" {\n  bucket = aws_s3_bucket.connect_sink.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"connect_sink\" {\n  bucket = aws_s3_bucket.connect_sink.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_security_group\" \"msk\" {\n  name_prefix = \"${local.name_prefix}-msk-\"\n  description = \"MSK security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description = \"Kafka from within VPC\"\n    from_port   = 9092\n    to_port     = 9092\n    protocol    = \"tcp\"\n    cidr_blocks = [module.vpc.vpc_cidr_block]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_msk_configuration\" \"this\" {\n  name           = \"${local.name_prefix}-msk-config\"\n  kafka_versions = [var.msk_kafka_version]\n\n  server_properties = <<-EOT\n    auto.create.topics.enable=true\n    default.replication.factor=2\n    min.insync.replicas=1\n    num.partitions=3\n  EOT\n}\n\nresource \"aws_msk_cluster\" \"this\" {\n  cluster_name           = \"${local.name_prefix}-msk\"\n  kafka_version          = var.msk_kafka_version\n  number_of_broker_nodes = var.msk_broker_count\n\n  broker_node_group_info {\n    instance_type   = var.msk_broker_instance_type\n    client_subnets  = module.vpc.private_subnets\n    security_groups = [aws_security_group.msk.id]\n\n    storage_info {\n      ebs_storage_info {\n        volume_size = var.msk_broker_volume_size\n      }\n    }\n  }\n\n  encryption_info {\n    encryption_in_transit {\n      client_broker = \"TLS_PLAINTEXT\"\n      in_cluster    = true\n    }\n  }\n\n  configuration_info {\n    arn      = aws_msk_configuration.this.arn\n    revision = aws_msk_configuration.this.latest_revision\n  }\n\n  tags = {\n    Name = \"${local.name_prefix}-msk\"\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"vpc_id\" {\n  value       = module.vpc.vpc_id\n  description = \"VPC ID\"\n}\n\noutput \"eks_cluster_name\" {\n  value       = module.eks.cluster_name\n  description = \"EKS cluster name\"\n}\n\noutput \"eks_cluster_endpoint\" {\n  value       = module.eks.cluster_endpoint\n  description = \"EKS cluster endpoint\"\n}\n\noutput \"eks_cluster_ca\" {\n  value       = module.eks.cluster_certificate_authority_data\n  description = \"EKS cluster CA data (base64)\"\n  sensitive   = true\n}\n\noutput \"msk_bootstrap_brokers\" {\n  value       = aws_msk_cluster.this.bootstrap_brokers\n  description = \"MSK plaintext bootstrap brokers\"\n}\n\noutput \"msk_bootstrap_brokers_tls\" {\n  value       = aws_msk_cluster.this.bootstrap_brokers_tls\n  description = \"MSK TLS bootstrap brokers\"\n}\n\noutput \"s3_flink_state_bucket\" {\n  value       = aws_s3_bucket.flink_state.bucket\n  description = \"S3 bucket for Flink checkpoints/savepoints\"\n}\n\noutput \"s3_connect_sink_bucket\" {\n  value       = aws_s3_bucket.connect_sink.bucket\n  description = \"S3 bucket for Kafka Connect S3 sink output\"\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region  = \"us-east-1\"\nproject_name = \"flink-poc\"\nenvironment  = \"dev\"\n\n# Adjust as needed\naz_count = 2\n\n# EKS\neks_cluster_version      = \"1.29\"\neks_node_instance_types  = [\"m6i.large\"]\neks_node_desired_size    = 2\neks_node_min_size        = 1\neks_node_max_size        = 4\n\n# MSK\nmsk_kafka_version         = \"3.6.0\"\nmsk_broker_instance_type  = \"kafka.m5.large\"\nmsk_broker_volume_size    = 100\nmsk_broker_count          = 2\n"
    }
  ]
}