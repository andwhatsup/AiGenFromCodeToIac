{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.6.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.28\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = {\n      Project     = var.project_name\n      Environment = var.environment\n      ManagedBy   = \"terraform\"\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"ap-south-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for resource naming.\"\n  type        = string\n  default     = \"lambda-api\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, prod).\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"lambda_runtime\" {\n  description = \"Lambda runtime.\"\n  type        = string\n  default     = \"python3.12\"\n}\n\nvariable \"lambda_timeout_seconds\" {\n  description = \"Lambda timeout in seconds.\"\n  type        = number\n  default     = 10\n}\n\nvariable \"lambda_memory_mb\" {\n  description = \"Lambda memory size in MB.\"\n  type        = number\n  default     = 128\n}\n\nvariable \"log_retention_days\" {\n  description = \"CloudWatch log retention for the Lambda log group.\"\n  type        = number\n  default     = 14\n}\n\nvariable \"bucket_name\" {\n  description = \"Name of the S3 bucket that the Lambda will list. Must be globally unique.\"\n  type        = string\n}\n\nvariable \"lambda_zip_path\" {\n  description = \"Path to the pre-built Lambda deployment package zip.\"\n  type        = string\n  default     = \"../lambda_function.zip\"\n}\n\nvariable \"api_stage_name\" {\n  description = \"API Gateway stage name.\"\n  type        = string\n  default     = \"v1\"\n}\n\nvariable \"api_route_base\" {\n  description = \"Base route path for the API.\"\n  type        = string\n  default     = \"/list-bucket-content\"\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n}\n\n# -----------------------------\n# S3 bucket (private)\n# -----------------------------\nresource \"aws_s3_bucket\" \"data\" {\n  bucket = var.bucket_name\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"data\" {\n  bucket = aws_s3_bucket.data.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"data\" {\n  bucket = aws_s3_bucket.data.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_versioning\" \"data\" {\n  bucket = aws_s3_bucket.data.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\n# -----------------------------\n# IAM for Lambda\n# -----------------------------\ndata \"aws_iam_policy_document\" \"lambda_assume_role\" {\n  statement {\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"lambda\" {\n  name               = \"${local.name_prefix}-lambda-role\"\n  assume_role_policy = data.aws_iam_policy_document.lambda_assume_role.json\n}\n\n# Least privilege: ListObjectsV2 requires s3:ListBucket on the bucket.\ndata \"aws_iam_policy_document\" \"lambda_policy\" {\n  statement {\n    sid    = \"AllowListBucket\"\n    effect = \"Allow\"\n\n    actions = [\n      \"s3:ListBucket\"\n    ]\n\n    resources = [aws_s3_bucket.data.arn]\n  }\n\n  statement {\n    sid    = \"AllowCloudWatchLogs\"\n    effect = \"Allow\"\n\n    actions = [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ]\n\n    resources = [\n      \"arn:aws:logs:${var.aws_region}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/${local.name_prefix}:*\"\n    ]\n  }\n}\n\nresource \"aws_iam_policy\" \"lambda\" {\n  name   = \"${local.name_prefix}-lambda-policy\"\n  policy = data.aws_iam_policy_document.lambda_policy.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda\" {\n  role       = aws_iam_role.lambda.name\n  policy_arn = aws_iam_policy.lambda.arn\n}\n\ndata \"aws_caller_identity\" \"current\" {}\n\n# -----------------------------\n# CloudWatch Log Group (managed)\n# -----------------------------\nresource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${local.name_prefix}\"\n  retention_in_days = var.log_retention_days\n}\n\n# -----------------------------\n# Lambda\n# -----------------------------\nresource \"aws_lambda_function\" \"this\" {\n  function_name = local.name_prefix\n  role          = aws_iam_role.lambda.arn\n\n  runtime = var.lambda_runtime\n  handler = \"lambda_function.lambda_handler\"\n\n  filename         = var.lambda_zip_path\n  source_code_hash = filebase64sha256(var.lambda_zip_path)\n\n  timeout     = var.lambda_timeout_seconds\n  memory_size = var.lambda_memory_mb\n\n  environment {\n    variables = {\n      BUCKET_NAME = aws_s3_bucket.data.bucket\n    }\n  }\n\n  depends_on = [\n    aws_iam_role_policy_attachment.lambda,\n    aws_cloudwatch_log_group.lambda\n  ]\n}\n\n# -----------------------------\n# API Gateway v2 (HTTP API)\n# -----------------------------\nresource \"aws_apigatewayv2_api\" \"http\" {\n  name          = \"${local.name_prefix}-http-api\"\n  protocol_type = \"HTTP\"\n}\n\nresource \"aws_apigatewayv2_integration\" \"lambda\" {\n  api_id                 = aws_apigatewayv2_api.http.id\n  integration_type       = \"AWS_PROXY\"\n  integration_uri        = aws_lambda_function.this.arn\n  payload_format_version = \"2.0\"\n}\n\n# Routes:\n#  - GET /list-bucket-content\n#  - GET /list-bucket-content/{folder}\nresource \"aws_apigatewayv2_route\" \"root\" {\n  api_id    = aws_apigatewayv2_api.http.id\n  route_key = \"GET ${var.api_route_base}\"\n  target    = \"integrations/${aws_apigatewayv2_integration.lambda.id}\"\n}\n\nresource \"aws_apigatewayv2_route\" \"folder\" {\n  api_id    = aws_apigatewayv2_api.http.id\n  route_key = \"GET ${var.api_route_base}/{folder}\"\n  target    = \"integrations/${aws_apigatewayv2_integration.lambda.id}\"\n}\n\nresource \"aws_apigatewayv2_stage\" \"this\" {\n  api_id      = aws_apigatewayv2_api.http.id\n  name        = var.api_stage_name\n  auto_deploy = true\n\n  access_log_settings {\n    destination_arn = aws_cloudwatch_log_group.apigw.arn\n    format = jsonencode({\n      requestId              = \"$context.requestId\"\n      ip                     = \"$context.identity.sourceIp\"\n      requestTime            = \"$context.requestTime\"\n      httpMethod             = \"$context.httpMethod\"\n      routeKey               = \"$context.routeKey\"\n      status                 = \"$context.status\"\n      protocol               = \"$context.protocol\"\n      responseLength         = \"$context.responseLength\"\n      integrationErrorMessage = \"$context.integrationErrorMessage\"\n    })\n  }\n}\n\nresource \"aws_cloudwatch_log_group\" \"apigw\" {\n  name              = \"/aws/apigateway/${local.name_prefix}-http-api\"\n  retention_in_days = var.log_retention_days\n}\n\n# Allow API Gateway to invoke the Lambda\nresource \"aws_lambda_permission\" \"apigw\" {\n  statement_id  = \"AllowExecutionFromAPIGatewayV2\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.this.function_name\n  principal     = \"apigateway.amazonaws.com\"\n\n  source_arn = \"${aws_apigatewayv2_api.http.execution_arn}/*/*\"\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"api_base_url\" {\n  description = \"Base invoke URL for the HTTP API stage.\"\n  value       = aws_apigatewayv2_stage.this.invoke_url\n}\n\noutput \"api_route\" {\n  description = \"Convenience URL matching the README example.\"\n  value       = \"${aws_apigatewayv2_stage.this.invoke_url}${trimprefix(var.api_route_base, \"/\") }\"\n}\n\noutput \"bucket_name\" {\n  value = aws_s3_bucket.data.bucket\n}\n\noutput \"lambda_function_name\" {\n  value = aws_lambda_function.this.function_name\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "# Copy to terraform.tfvars and set values\naws_region   = \"ap-south-1\"\nproject_name = \"lambda-api\"\nenvironment  = \"dev\"\n\n# Must be globally unique\nbucket_name = \"my-unique-lambda-api-bucket-123456\"\n"
    },
    {
      "name": "README_TERRAFORM.md",
      "content": "## Terraform (generated)\n\n### Prereqs\n- Terraform >= 1.6\n- AWS credentials configured (env vars, shared config, SSO, etc.)\n\n### Deploy\n1. `cd ai_tf`\n2. `cp terraform.tfvars.example terraform.tfvars` and set `bucket_name`\n3. `terraform init`\n4. `terraform apply`\n\n### Test\n- Use the output `api_route`:\n  - `curl $(terraform output -raw api_route)`\n  - `curl $(terraform output -raw api_route)/some-prefix`\n\n### Destroy\n- `terraform destroy`\n- You may need to empty the S3 bucket first.\n"
    }
  ]
}