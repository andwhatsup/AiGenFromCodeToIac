{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_version = \">= 1.4.5\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.27.0\"\n    }\n    http = {\n      source  = \"hashicorp/http\"\n      version = \"~> 3.5\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = var.tags\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"ap-northeast-1\"\n}\n\nvariable \"name\" {\n  description = \"Name prefix for resources.\"\n  type        = string\n  default     = \"ec2-test-server\"\n}\n\nvariable \"tags\" {\n  description = \"Tags applied to all resources via provider default_tags.\"\n  type        = map(string)\n  default = {\n    Project = \"ec2_test_server\"\n    Managed = \"terraform\"\n  }\n}\n\nvariable \"vpc_id\" {\n  description = \"Existing VPC ID to deploy into.\"\n  type        = string\n}\n\nvariable \"public_subnet_id\" {\n  description = \"Existing public subnet ID (must have route to an Internet Gateway) to place the instance in.\"\n  type        = string\n}\n\nvariable \"instance_type\" {\n  description = \"EC2 instance type.\"\n  type        = string\n  default     = \"t3.micro\"\n}\n\nvariable \"ssh_username\" {\n  description = \"SSH username for the AMI. Amazon Linux 2 uses ec2-user.\"\n  type        = string\n  default     = \"ec2-user\"\n}\n\nvariable \"key_pair_name\" {\n  description = \"Existing EC2 key pair name to attach to the instance. If set, Terraform will not create a key pair.\"\n  type        = string\n  default     = null\n}\n\nvariable \"public_key_path\" {\n  description = \"Path to an SSH public key to register as an EC2 key pair (used when key_pair_name is null).\"\n  type        = string\n  default     = null\n}\n\nvariable \"private_key_path\" {\n  description = \"Path to the SSH private key used by Terraform provisioners to connect to the instance.\"\n  type        = string\n  default     = \".security/my-net-keypair.id_rsa\"\n}\n\nvariable \"allowed_cidr\" {\n  description = \"CIDR allowed to access the instance (SSH/HTTP/HTTPS). If null, it will be auto-detected from the runner public IP.\"\n  type        = string\n  default     = null\n}\n\nvariable \"enable_https\" {\n  description = \"Whether to open inbound 443. (TLS termination is not configured by default.)\"\n  type        = bool\n  default     = false\n}\n\nvariable \"root_volume_size_gb\" {\n  description = \"Root EBS volume size in GiB.\"\n  type        = number\n  default     = 10\n}\n\nvariable \"root_volume_type\" {\n  description = \"Root EBS volume type.\"\n  type        = string\n  default     = \"gp3\"\n}\n\nvariable \"associate_public_ip\" {\n  description = \"Whether to associate a public IP address. Should be true for a public subnet.\"\n  type        = bool\n  default     = true\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  # If allowed_cidr is not provided, detect the runner's public IP and allow /32.\n  detected_cidr = \"${chomp(data.http.myip.response_body)}/32\"\n  allow_cidr    = coalesce(var.allowed_cidr, local.detected_cidr)\n\n  key_name_effective = coalesce(var.key_pair_name, try(aws_key_pair.this[0].key_name, null))\n}\n\ndata \"http\" \"myip\" {\n  url = \"https://checkip.amazonaws.com/\"\n}\n\ndata \"aws_ami\" \"amazon_linux2\" {\n  most_recent = true\n  owners      = [\"amazon\"]\n\n  filter {\n    name   = \"name\"\n    values = [\"amzn2-ami-hvm-*-x86_64-gp2\"]\n  }\n\n  filter {\n    name   = \"virtualization-type\"\n    values = [\"hvm\"]\n  }\n}\n\nresource \"aws_key_pair\" \"this\" {\n  count = var.key_pair_name == null && var.public_key_path != null ? 1 : 0\n\n  key_name   = \"${var.name}-key\"\n  public_key = file(var.public_key_path)\n}\n\nresource \"aws_security_group\" \"web\" {\n  name_prefix = \"${var.name}-\"\n  description = \"Allow SSH and web access from allowlisted CIDR\"\n  vpc_id      = var.vpc_id\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\nresource \"aws_vpc_security_group_ingress_rule\" \"ssh\" {\n  security_group_id = aws_security_group.web.id\n  description       = \"SSH from allowlisted CIDR\"\n  cidr_ipv4         = local.allow_cidr\n  from_port         = 22\n  to_port           = 22\n  ip_protocol       = \"tcp\"\n}\n\nresource \"aws_vpc_security_group_ingress_rule\" \"http\" {\n  security_group_id = aws_security_group.web.id\n  description       = \"HTTP from allowlisted CIDR\"\n  cidr_ipv4         = local.allow_cidr\n  from_port         = 80\n  to_port           = 80\n  ip_protocol       = \"tcp\"\n}\n\nresource \"aws_vpc_security_group_ingress_rule\" \"https\" {\n  count             = var.enable_https ? 1 : 0\n  security_group_id = aws_security_group.web.id\n  description       = \"HTTPS from allowlisted CIDR\"\n  cidr_ipv4         = local.allow_cidr\n  from_port         = 443\n  to_port           = 443\n  ip_protocol       = \"tcp\"\n}\n\nresource \"aws_vpc_security_group_egress_rule\" \"all\" {\n  security_group_id = aws_security_group.web.id\n  description       = \"All outbound\"\n  cidr_ipv4         = \"0.0.0.0/0\"\n  ip_protocol       = \"-1\"\n}\n\nresource \"aws_instance\" \"web\" {\n  ami                         = data.aws_ami.amazon_linux2.id\n  instance_type               = var.instance_type\n  subnet_id                   = var.public_subnet_id\n  vpc_security_group_ids      = [aws_security_group.web.id]\n  associate_public_ip_address = var.associate_public_ip\n  key_name                    = local.key_name_effective\n\n  metadata_options {\n    http_endpoint = \"enabled\"\n    http_tokens   = \"required\" # IMDSv2\n  }\n\n  root_block_device {\n    volume_size = var.root_volume_size_gb\n    volume_type = var.root_volume_type\n    encrypted   = true\n  }\n\n  tags = {\n    Name = var.name\n  }\n\n  # Provision nginx + php-fpm using the repo script.\n  provisioner \"file\" {\n    source      = \"${path.module}/../source/nginx-php-inst.sh\"\n    destination = \"/tmp/nginx-php-inst.sh\"\n\n    connection {\n      type        = \"ssh\"\n      user        = var.ssh_username\n      host        = self.public_ip\n      private_key = file(var.private_key_path)\n      timeout     = \"5m\"\n    }\n  }\n\n  provisioner \"remote-exec\" {\n    inline = [\n      \"chmod +x /tmp/nginx-php-inst.sh\",\n      \"sudo /tmp/nginx-php-inst.sh\",\n    ]\n\n    connection {\n      type        = \"ssh\"\n      user        = var.ssh_username\n      host        = self.public_ip\n      private_key = file(var.private_key_path)\n      timeout     = \"10m\"\n    }\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"ami_id\" {\n  description = \"AMI ID used for the instance.\"\n  value       = data.aws_ami.amazon_linux2.id\n}\n\noutput \"allowed_cidr\" {\n  description = \"CIDR allowed to access the instance (auto-detected if not provided).\"\n  value       = local.allow_cidr\n}\n\noutput \"ec2_public_ip\" {\n  description = \"Public IP of the EC2 instance.\"\n  value       = aws_instance.web.public_ip\n}\n\noutput \"ec2_public_dns\" {\n  description = \"Public DNS name of the EC2 instance.\"\n  value       = aws_instance.web.public_dns\n}\n\noutput \"web_url\" {\n  description = \"HTTP URL for the web server.\"\n  value       = \"http://${aws_instance.web.public_dns}\"\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "# Example values - update to match your existing VPC/subnet.\naws_region       = \"ap-northeast-1\"\nname             = \"ec2-test-server\"\nvpc_id           = \"vpc-xxxxxxxx\"\npublic_subnet_id = \"subnet-xxxxxxxx\"\n\n# Option A (recommended): reference an existing key pair already in AWS\nkey_pair_name = \"my-net-keypair\"\n\n# Option B: have Terraform create the key pair from a public key\n# public_key_path = \".security/my-net-keypair.id_rsa.pub\"\n\n# If omitted, Terraform will auto-detect the runner public IP and allow /32\n# allowed_cidr = \"203.0.113.10/32\"\n"
    },
    {
      "name": "README-ai_tf.md",
      "content": "# ai_tf\n\nTerraform configuration to deploy a single Amazon Linux 2 EC2 instance running Nginx + PHP-FPM.\n\n## Inputs you must set\n- `vpc_id` and `public_subnet_id` must point to an existing VPC and a public subnet.\n- Provide either:\n  - `key_pair_name` (existing EC2 key pair in AWS), or\n  - `public_key_path` (Terraform will create an EC2 key pair).\n\n## Access control\nInbound access (SSH/HTTP and optional HTTPS) is restricted to `allowed_cidr`.\nIf `allowed_cidr` is not set, Terraform auto-detects the runner public IP via https://checkip.amazonaws.com and allows that /32.\n\n## Run\nFrom the terraform container (or locally):\n\n```sh\nterraform init\nterraform validate\nterraform plan -var-file=terraform.tfvars\nterraform apply -var-file=terraform.tfvars\n```\n"
    },
    {
      "name": ".terraform.lock.hcl",
      "content": "# This file is maintained automatically by \"terraform init\".\n# Manual edits may be lost in future updates.\n\nprovider \"registry.terraform.io/hashicorp/aws\" {\n  version     = \"6.27.0\"\n  constraints = \"~> 6.27.0\"\n  hashes = [\n    \"h1:emgTfB1LXSFYh9uAwgsRMoMIN5Wz7jNNKq3rqC0EHWk=\",\n    \"zh:177a24b806c72e8484b5cabc93b2b38e3d770ae6f745a998b54d6619fd0e8129\",\n    \"zh:4ac4a85c14fb868a3306b542e6a56c10bd6c6d5a67bc0c9b8f6a9060cf5f3be7\",\n    \"zh:552652185bc85c8ba1da1d65dea47c454728a5c6839c458b6dcd3ce71c19ccfc\",\n    \"zh:60284b8172d09aee91eae0856f09855eaf040ce3a58d6933602ae17c53f8ed04\",\n    \"zh:6be38d156756ca61fb8e7c752cc5d769cd709686700ac4b230f40a6e95b5dbc9\",\n    \"zh:7a409138fae4ef42e3a637e37cb9efedf96459e28a3c764fc4e855e8db9a7485\",\n    \"zh:8070cf5224ed1ed3a3e9a59f7c30ff88bf071c7567165275d477c1738a56c064\",\n    \"zh:894439ef340a9a79f69cd759e27ad11c7826adeca27be1b1ca82b3c9702fa300\",\n    \"zh:89d035eebf08a97c89374ff06040955ddc09f275ecca609d0c9d58d149bef5cf\",\n    \"zh:985b1145d724fc1f38369099e4a5087141885740fd6c0b1dbc492171e73c2e49\",\n    \"zh:9b12af85486a96aedd8d7984b0ff811a4b42e3d88dad1a3fb4c0b580d04fa425\",\n    \"zh:a80b47ae8d1475201c86bd94a5dcb9dd4da5e8b73102a90820b68b66b76d50fd\",\n    \"zh:d3395be1556210f82199b9166a6b2e677cee9c4b67e96e63f6c3a98325ad7ab0\",\n    \"zh:db0b869d09657f6f1e4110b56093c5fcdf9dbdd97c020db1e577b239c0adcbce\",\n    \"zh:ffc72e680370ae7c21f9bd3082c6317730df805c6797427839a6b6b7e9a26a01\",\n  ]\n}\n\nprovider \"registry.terraform.io/hashicorp/http\" {\n  version     = \"3.5.0\"\n  constraints = \"~> 3.5\"\n  hashes = [\n    \"h1:dl73+8wzQR++HFGoJgDqY3mj3pm14HUuH/CekVyOj5s=\",\n    \"zh:047c5b4920751b13425efe0d011b3a23a3be97d02d9c0e3c60985521c9c456b7\",\n    \"zh:157866f700470207561f6d032d344916b82268ecd0cf8174fb11c0674c8d0736\",\n    \"zh:1973eb9383b0d83dd4fd5e662f0f16de837d072b64a6b7cd703410d730499476\",\n    \"zh:212f833a4e6d020840672f6f88273d62a564f44acb0c857b5961cdb3bbc14c90\",\n    \"zh:2c8034bc039fffaa1d4965ca02a8c6d57301e5fa9fff4773e684b46e3f78e76a\",\n    \"zh:5df353fc5b2dd31577def9cc1a4ebf0c9a9c2699d223c6b02087a3089c74a1c6\",\n    \"zh:672083810d4185076c81b16ad13d1224b9e6ea7f4850951d2ab8d30fa6e41f08\",\n    \"zh:78d5eefdd9e494defcb3c68d282b8f96630502cac21d1ea161f53cfe9bb483b3\",\n    \"zh:7b4200f18abdbe39904b03537e1a78f21ebafe60f1c861a44387d314fda69da6\",\n    \"zh:843feacacd86baed820f81a6c9f7bd32cf302db3d7a0f39e87976ebc7a7cc2ee\",\n    \"zh:a9ea5096ab91aab260b22e4251c05f08dad2ed77e43e5e4fadcdfd87f2c78926\",\n    \"zh:d02b288922811739059e90184c7f76d45d07d3a77cc48d0b15fd3db14e928623\",\n  ]\n}\n"
    }
  ]
}