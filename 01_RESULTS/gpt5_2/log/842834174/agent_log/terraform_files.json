{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = merge(\n      {\n        Project     = var.project_name\n        Environment = var.environment\n        ManagedBy   = \"terraform\"\n      },\n      var.tags\n    )\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix for resources\"\n  type        = string\n  default     = \"range-slider\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, stg, prod)\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"tags\" {\n  description = \"Additional tags\"\n  type        = map(string)\n  default     = {}\n}\n\nvariable \"vpc_cidr\" {\n  description = \"VPC CIDR\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"az_count\" {\n  description = \"Number of AZs to use (2 or 3 recommended)\"\n  type        = number\n  default     = 2\n  validation {\n    condition     = var.az_count >= 2 && var.az_count <= 3\n    error_message = \"az_count must be 2 or 3.\"\n  }\n}\n\nvariable \"public_subnet_cidrs\" {\n  description = \"Public subnet CIDRs (length must equal az_count)\"\n  type        = list(string)\n  default     = [\"10.0.0.0/20\", \"10.0.16.0/20\"]\n}\n\nvariable \"private_subnet_cidrs\" {\n  description = \"Private subnet CIDRs (length must equal az_count)\"\n  type        = list(string)\n  default     = [\"10.0.128.0/20\", \"10.0.144.0/20\"]\n}\n\nvariable \"single_nat_gateway\" {\n  description = \"Use a single NAT gateway (cheaper) instead of one per AZ\"\n  type        = bool\n  default     = true\n}\n\nvariable \"cluster_version\" {\n  description = \"EKS Kubernetes version\"\n  type        = string\n  default     = \"1.29\"\n}\n\nvariable \"node_instance_types\" {\n  description = \"Instance types for the managed node group\"\n  type        = list(string)\n  default     = [\"t3.medium\"]\n}\n\nvariable \"node_desired_size\" {\n  description = \"Desired node count\"\n  type        = number\n  default     = 2\n}\n\nvariable \"node_min_size\" {\n  description = \"Minimum node count\"\n  type        = number\n  default     = 1\n}\n\nvariable \"node_max_size\" {\n  description = \"Maximum node count\"\n  type        = number\n  default     = 4\n}\n\nvariable \"ecr_repository_name\" {\n  description = \"ECR repository name for the app image\"\n  type        = string\n  default     = \"range-slider\"\n}\n\nvariable \"github_org\" {\n  description = \"GitHub org/user for OIDC trust (e.g., yash509)\"\n  type        = string\n  default     = \"\"\n}\n\nvariable \"github_repo\" {\n  description = \"GitHub repo name for OIDC trust (e.g., DevSecOps-Custom-Range-Slider-Deployment)\"\n  type        = string\n  default     = \"\"\n}\n\nvariable \"github_ref_patterns\" {\n  description = \"Allowed GitHub refs for OIDC (e.g., ['ref:refs/heads/main'])\"\n  type        = list(string)\n  default     = [\"ref:refs/heads/main\"]\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  name = \"${var.project_name}-${var.environment}\"\n  azs  = slice(data.aws_availability_zones.available.names, 0, var.az_count)\n}\n\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~> 5.0\"\n\n  name = local.name\n  cidr = var.vpc_cidr\n\n  azs             = local.azs\n  public_subnets  = slice(var.public_subnet_cidrs, 0, var.az_count)\n  private_subnets = slice(var.private_subnet_cidrs, 0, var.az_count)\n\n  enable_nat_gateway   = true\n  single_nat_gateway   = var.single_nat_gateway\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n\n  public_subnet_tags = {\n    \"kubernetes.io/role/elb\" = \"1\"\n  }\n\n  private_subnet_tags = {\n    \"kubernetes.io/role/internal-elb\" = \"1\"\n  }\n}\n\nmodule \"eks\" {\n  source  = \"terraform-aws-modules/eks/aws\"\n  version = \"~> 20.0\"\n\n  cluster_name    = local.name\n  cluster_version = var.cluster_version\n\n  vpc_id     = module.vpc.vpc_id\n  subnet_ids = module.vpc.private_subnets\n\n  cluster_endpoint_public_access = true\n\n  enable_irsa = true\n\n  cluster_enabled_log_types = [\"api\", \"audit\", \"authenticator\", \"controllerManager\", \"scheduler\"]\n\n  eks_managed_node_groups = {\n    default = {\n      name            = \"default\"\n      instance_types  = var.node_instance_types\n      desired_size    = var.node_desired_size\n      min_size        = var.node_min_size\n      max_size        = var.node_max_size\n      subnet_ids      = module.vpc.private_subnets\n      capacity_type   = \"ON_DEMAND\"\n      ami_type        = \"AL2_x86_64\"\n      disk_size       = 20\n      create_security_group = true\n    }\n  }\n\n  tags = {\n    \"kubernetes.io/cluster/${local.name}\" = \"shared\"\n  }\n}\n\nresource \"aws_ecr_repository\" \"app\" {\n  name                 = var.ecr_repository_name\n  image_tag_mutability = \"MUTABLE\"\n\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n\n  encryption_configuration {\n    encryption_type = \"AES256\"\n  }\n}\n\nresource \"aws_ecr_lifecycle_policy\" \"app\" {\n  repository = aws_ecr_repository.app.name\n\n  policy = jsonencode({\n    rules = [\n      {\n        rulePriority = 1\n        description  = \"Expire untagged images older than 14 days\"\n        selection = {\n          tagStatus   = \"untagged\"\n          countType   = \"sinceImagePushed\"\n          countUnit   = \"days\"\n          countNumber = 14\n        }\n        action = {\n          type = \"expire\"\n        }\n      }\n    ]\n  })\n}\n"
    },
    {
      "name": "iam_github_oidc.tf",
      "content": "# Optional: GitHub Actions OIDC role for pushing to ECR and describing the EKS cluster.\n# Enable by setting github_org and github_repo.\n\ndata \"aws_iam_openid_connect_provider\" \"github\" {\n  url = \"https://token.actions.githubusercontent.com\"\n}\n\nlocals {\n  enable_github_oidc = length(var.github_org) > 0 && length(var.github_repo) > 0\n}\n\ndata \"aws_iam_policy_document\" \"github_assume_role\" {\n  count = local.enable_github_oidc ? 1 : 0\n\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRoleWithWebIdentity\"]\n\n    principals {\n      type        = \"Federated\"\n      identifiers = [data.aws_iam_openid_connect_provider.github.arn]\n    }\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"token.actions.githubusercontent.com:aud\"\n      values   = [\"sts.amazonaws.com\"]\n    }\n\n    condition {\n      test     = \"StringLike\"\n      variable = \"token.actions.githubusercontent.com:sub\"\n      values = [\n        for ref in var.github_ref_patterns : \"repo:${var.github_org}/${var.github_repo}:${ref}\"\n      ]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"github_actions\" {\n  count = local.enable_github_oidc ? 1 : 0\n\n  name               = \"${local.name}-github-actions\"\n  assume_role_policy = data.aws_iam_policy_document.github_assume_role[0].json\n}\n\ndata \"aws_iam_policy_document\" \"github_actions\" {\n  count = local.enable_github_oidc ? 1 : 0\n\n  statement {\n    sid     = \"ECRPushPull\"\n    effect  = \"Allow\"\n    actions = [\n      \"ecr:GetAuthorizationToken\",\n      \"ecr:BatchCheckLayerAvailability\",\n      \"ecr:BatchGetImage\",\n      \"ecr:CompleteLayerUpload\",\n      \"ecr:GetDownloadUrlForLayer\",\n      \"ecr:InitiateLayerUpload\",\n      \"ecr:PutImage\",\n      \"ecr:UploadLayerPart\",\n      \"ecr:DescribeRepositories\",\n      \"ecr:ListImages\"\n    ]\n    resources = [\"*\"]\n  }\n\n  statement {\n    sid     = \"DescribeEKS\"\n    effect  = \"Allow\"\n    actions = [\n      \"eks:DescribeCluster\"\n    ]\n    resources = [module.eks.cluster_arn]\n  }\n}\n\nresource \"aws_iam_role_policy\" \"github_actions\" {\n  count = local.enable_github_oidc ? 1 : 0\n\n  name   = \"${local.name}-github-actions\"\n  role   = aws_iam_role.github_actions[0].id\n  policy = data.aws_iam_policy_document.github_actions[0].json\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"vpc_id\" {\n  value       = module.vpc.vpc_id\n  description = \"VPC ID\"\n}\n\noutput \"private_subnet_ids\" {\n  value       = module.vpc.private_subnets\n  description = \"Private subnet IDs\"\n}\n\noutput \"public_subnet_ids\" {\n  value       = module.vpc.public_subnets\n  description = \"Public subnet IDs\"\n}\n\noutput \"eks_cluster_name\" {\n  value       = module.eks.cluster_name\n  description = \"EKS cluster name\"\n}\n\noutput \"eks_cluster_endpoint\" {\n  value       = module.eks.cluster_endpoint\n  description = \"EKS cluster endpoint\"\n}\n\noutput \"eks_cluster_ca\" {\n  value       = module.eks.cluster_certificate_authority_data\n  description = \"EKS cluster CA (base64)\"\n  sensitive   = true\n}\n\noutput \"ecr_repository_url\" {\n  value       = aws_ecr_repository.app.repository_url\n  description = \"ECR repository URL\"\n}\n\noutput \"github_actions_role_arn\" {\n  value       = try(aws_iam_role.github_actions[0].arn, null)\n  description = \"IAM role ARN for GitHub Actions (OIDC), if enabled\"\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region   = \"us-east-1\"\nproject_name = \"range-slider\"\nenvironment  = \"dev\"\n\n# If you want GitHub Actions OIDC role created, set these:\n# github_org  = \"yash509\"\n# github_repo = \"DevSecOps-Custom-Range-Slider-Deployment\"\n# github_ref_patterns = [\"ref:refs/heads/main\"]\n"
    }
  ]
}