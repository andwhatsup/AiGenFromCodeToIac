{
  "aws_architecture_description": "### AWS high-level architecture (Nebari + metrics-server stage on EKS)\n\nThis repository is **not a standalone web app**—it’s a **Python Nebari plugin** that adds a **Nebari Terraform stage** which installs **Kubernetes Metrics Server** into a Kubernetes cluster. On AWS, the “system” you deploy is therefore:\n1) the **Nebari deployment/orchestration environment** that runs Terraform, and\n2) the **Amazon EKS cluster** where the stage installs **metrics-server**.\n\n#### 1) Source, build, and distribution\n- Developers/CI build the Python package and publish it (e.g., to PyPI as you do today, or to an internal artifact repo).\n- A Nebari “runner” environment (see below) installs the plugin package and executes Nebari’s provisioning workflow.\n\n#### 2) Nebari runner (Terraform execution environment)\nChoose one of these lean patterns:\n- **Recommended (managed CI runner):** Use a CI system (e.g., GitHub Actions) with **OIDC to AWS IAM** to run Nebari/Terraform without long‑lived AWS keys.\n- **Alternative (self-hosted runner):** Run Nebari/Terraform on an **EC2 instance** (or small Auto Scaling Group) in a private subnet, with SSM for access.\n\nIn both cases, the runner:\n- Assumes an IAM role with permissions to manage EKS and related AWS resources.\n- Uses a **remote Terraform backend** (S3 + DynamoDB locking) to store state safely and support team concurrency.\n\n#### 3) Networking foundation\n- A dedicated **VPC** spanning at least **2 Availability Zones**.\n- **Public subnets** for load balancers/NAT, and **private subnets** for EKS worker nodes (AWS recommends private subnets for nodes in the common pattern). ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/best-practices/subnets.html?utm_source=openai))\n- **NAT Gateways** (ideally one per AZ) so private nodes can reach AWS APIs / registries as needed.\n\n#### 4) Amazon EKS cluster\n- Provision an **EKS control plane** and either:\n  - **Managed Node Groups (EC2)** in private subnets (typical for Nebari-style platforms), or\n  - **EKS Fargate** for specific namespaces (note metrics-server has port considerations on Fargate). ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html?utm_source=openai))\n- Configure cluster endpoint access (public, private, or both) based on your ops model; private endpoint is common for stricter environments.\n\n#### 5) Installing Metrics Server (what this plugin does)\nYour plugin’s Terraform stage uses Terraform + Helm provider to install/upgrade the `metrics-server` Helm release into the cluster.\n- On EKS, **metrics-server is not installed by default**. ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html?utm_source=openai))\n- Ensure network rules allow metrics-server to scrape kubelets (commonly port **10250** between metrics-server pods and nodes). ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html?utm_source=openai))\n\n**Optional simplification (if you want to reduce custom Helm management):** EKS now supports installing Metrics Server as a **community add-on** via EKS add-ons APIs/console. ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html?utm_source=openai))  \n(You can keep the plugin as-is, but this is an AWS-native alternative if you later choose to refactor.)\n\n#### 6) Observability and operations\n- Use **CloudWatch Container Insights** (optional) and EKS control plane logs for cluster visibility.\n- Use **CloudTrail** for auditing, and **AWS Config** (optional) for compliance.\n- Use **AWS Systems Manager (SSM)** for access to any EC2-based runner/bastion without inbound SSH.\n\n---\n\n## AWS resources to provision\n\n### Account / IAM / security\n- **IAM OIDC provider** for GitHub Actions (or your CI) and **IAM role(s)** for CI-to-AWS access (OIDC assume role)\n- **IAM roles for EKS**:\n  - EKS Cluster Service Role\n  - EKS Node Group Role (if using managed node groups)\n  - (Optional) IRSA roles for in-cluster controllers/add-ons\n- **KMS key(s)** (optional but common):\n  - Encrypt EKS secrets (envelope encryption)\n  - Encrypt S3 Terraform state bucket\n- **AWS CloudTrail** (org/account trail)\n- **AWS Config** (optional)\n\n### Terraform state / IaC support\n- **S3 bucket** for Terraform remote state (versioning, encryption, public access block)\n- **DynamoDB table** for Terraform state locking\n\n### Networking (VPC)\n- **VPC**\n- **Internet Gateway (IGW)**\n- **Public subnets** (2+ AZs)\n- **Private subnets** (2+ AZs)\n- **Route tables** (public/private) + route table associations\n- **NAT Gateway(s)** (preferably one per AZ) + **Elastic IP(s)**\n- **VPC endpoints** (optional, to reduce NAT usage and improve security):\n  - Gateway endpoint: S3\n  - Interface endpoints: ECR (api + dkr), STS, CloudWatch Logs, SSM, EC2, etc. (pick what you actually use)\n- **Security Groups**:\n  - EKS cluster security group (managed/attached)\n  - Node group security group(s)\n  - (Optional) additional SGs for runner/bastion\n\n### Amazon EKS\n- **EKS Cluster**\n- **EKS Managed Node Group(s)** (or **EKS Fargate profiles** if you choose Fargate)\n- **EKS add-ons** (typical baseline):\n  - VPC CNI\n  - CoreDNS\n  - kube-proxy\n  - (Optional) EBS CSI driver\n- **EKS control plane logging** to CloudWatch Logs\n\n### Nebari runner (choose one)\n**Option A: CI-based runner (leanest)**\n- No compute resources required beyond your CI system\n\n**Option B: EC2-based runner**\n- **EC2 instance** (or small **Auto Scaling Group**) in private subnet\n- **Instance profile / IAM role** for Terraform/EKS operations\n- **SSM managed instance configuration**\n- (Optional) **EBS volume** sizing for workspace/cache\n\n### Kubernetes add-on deployed by this plugin (in-cluster, but created via AWS-backed infra)\n- **Kubernetes namespace** (typically `kube-system`)\n- **Helm release: metrics-server**\n- **Kubernetes resources** created by the chart (Deployment, Service, RBAC, etc.)\n\n### Monitoring / logging (recommended baseline)\n- **CloudWatch Log Groups** (EKS control plane logs; runner logs if applicable)\n- **CloudWatch Alarms** (cluster/node health signals, NAT errors, etc.)\n\nIf you tell me whether you want the Nebari runner to be **CI-only** or **EC2-hosted**, and whether your EKS nodes are **managed node groups** or **Fargate**, I can tighten the resource list to the minimal exact set for that choice.",
  "aws_resources": [
    "IAM OIDC Provider (for CI, e.g., GitHub Actions)",
    "IAM Role(s) for CI/Terraform (AssumeRoleWithWebIdentity)",
    "IAM Role: EKS Cluster Service Role",
    "IAM Role: EKS Node Group Role (if using managed node groups)",
    "IAM Roles for Service Accounts (IRSA) (optional)",
    "AWS KMS Key for EKS secrets encryption (optional)",
    "AWS KMS Key for S3 Terraform state encryption (optional)",
    "AWS CloudTrail Trail",
    "AWS Config Recorder/Rules (optional)",
    "Amazon S3 Bucket for Terraform remote state",
    "Amazon DynamoDB Table for Terraform state locking",
    "Amazon VPC",
    "Internet Gateway",
    "Public Subnets (2+ AZs)",
    "Private Subnets (2+ AZs)",
    "Route Tables (public/private) and Associations",
    "NAT Gateway(s) and Elastic IP(s)",
    "VPC Gateway Endpoint: S3 (optional)",
    "VPC Interface Endpoints: ECR (api,dkr), STS, CloudWatch Logs, SSM, EC2 (optional, as needed)",
    "Security Group: EKS Cluster SG (managed/attached)",
    "Security Group: EKS Node Group SG(s)",
    "Amazon EKS Cluster",
    "EKS Managed Node Group(s) (or EKS Fargate Profiles)",
    "EKS Add-ons: VPC CNI, CoreDNS, kube-proxy",
    "EKS Add-on: EBS CSI Driver (optional)",
    "CloudWatch Log Groups for EKS control plane logs",
    "CloudWatch Alarms (cluster/node/NAT/runner as applicable)",
    "EC2 Instance (Nebari/Terraform runner) (optional)",
    "EC2 Auto Scaling Group (runner) (optional alternative)",
    "EC2 Instance Profile / IAM Role (runner) (optional)",
    "AWS Systems Manager (SSM) managed instance configuration (runner) (optional)",
    "Kubernetes Namespace (kube-system or target namespace)",
    "Helm Release: metrics-server (deployed into EKS)"
  ]
}