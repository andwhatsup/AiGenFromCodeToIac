{
  "aws_architecture_description": "### Target runtime: Amazon EKS (stateful workload)\n\n#### 1) Networking foundation\n- Deploy a dedicated **VPC** spanning **2–3 Availability Zones**.\n- Create **public subnets** (for internet-facing load balancers) and **private subnets** (for EKS worker nodes and pods). Worker nodes should run in **private subnets**; outbound internet access (for pulling images, OS updates, etc.) is provided via **NAT Gateways**. ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/best-practices/subnets.html?utm_source=openai))\n- Use **VPC endpoints** (Interface/Gateway) where practical (ECR, S3, CloudWatch Logs, STS) to reduce NAT dependency and tighten egress.\n\n#### 2) EKS cluster and compute\n- Provision an **Amazon EKS cluster** with:\n  - Managed control plane.\n  - **Managed Node Group(s)** (EC2) in private subnets (recommended for this workload because it needs EBS-backed PVCs; EBS volumes can’t be mounted to Fargate pods). ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html?utm_source=openai))\n- Use **Cluster Autoscaler** (or Karpenter) to scale nodes based on pod scheduling needs. Keep it lean: one node group is fine initially; add a second node group only if you need separation (e.g., “stateful” vs “system”).\n\n#### 3) Storage for StatefulSet (PVC per replica)\n- Install the **Amazon EBS CSI Driver** as an **EKS add-on** and grant it permissions using **IRSA / Pod Identity**.\n- Create a Kubernetes **StorageClass** that provisions **encrypted EBS volumes** (gp3 recommended) and set it as default (or reference it explicitly in the StatefulSet). This will back the `volumeClaimTemplates` (1Gi RWO per pod) with EBS volumes. ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html?utm_source=openai))\n\n#### 4) Workload deployment (Energi node)\n- Deploy the existing Kubernetes manifests into a dedicated namespace (e.g., `energi`).\n- Keep the **StatefulSet** at 3 replicas as defined.\n- Use a **headless Service** for stable pod DNS identities (already implied by `serviceName: energi-node`).\n\n#### 5) Ingress / exposure model (RPC vs P2P)\n- **P2P (39798/TCP)**: typically needs inbound connectivity from the internet. Expose via a **Kubernetes Service type LoadBalancer** that provisions an **NLB** (Layer 4 TCP). The AWS Load Balancer Controller is the recommended controller for EKS and will manage NLB/ALB creation. ([docs.aws.amazon.com](https://docs.aws.amazon.com/eks/latest/best-practices/load-balancing.html?utm_source=openai))\n- **RPC (39797/TCP)**: treat as an admin/API surface.\n  - Default: **internal-only** (private NLB) and restrict access via security groups / NACLs / allowlists.\n  - If public access is required, put it behind an NLB with strict allowlisting and consider additional auth at the application layer.\n\n#### 6) Container image supply chain\n- Current flow pushes to Docker Hub and uses an imagePullSecret. For AWS-native hardening and reliability, prefer:\n  - **Amazon ECR** as the image registry.\n  - GitHub Actions authenticates to ECR (OIDC) and pushes images.\n  - EKS nodes pull from ECR without long-lived Docker Hub credentials.\n\n#### 7) CI/CD and IaC\n- Use **GitHub Actions with OIDC federation** to assume an AWS role (no static AWS keys).\n- Use **Terraform** (or CDK/CloudFormation) to provision: VPC, EKS, node groups, add-ons, IAM roles, and optionally deploy Kubernetes manifests via Helm/kubectl in pipeline.\n\n#### 8) Observability, security, and ops\n- Send cluster and workload logs to **CloudWatch Logs** (via Fluent Bit add-on).\n- Use **CloudWatch Container Insights** (optional) for metrics.\n- Enable **EKS control plane logging**.\n- Use **KMS** for encryption (EBS volumes, secrets if using envelope encryption).\n- Use **AWS Secrets Manager** (or SSM Parameter Store) for any sensitive runtime config; mount via External Secrets Operator if needed.\n\n---\n\n## AWS resources to provision\n\n### Networking\n- Amazon VPC\n- Public subnets (2–3 AZs)\n- Private subnets (2–3 AZs)\n- Internet Gateway (IGW)\n- NAT Gateway(s) (one per AZ for HA, or one to start for cost)\n- Route tables (public/private) + routes\n- Security Groups (EKS control plane, node group, load balancers)\n- Network ACLs (optional, if you enforce subnet-level controls)\n- VPC Endpoints:\n  - Gateway endpoint: S3\n  - Interface endpoints (as needed): ECR (api + dkr), CloudWatch Logs, STS\n\n### EKS\n- Amazon EKS Cluster\n- EKS Managed Node Group(s) (EC2)\n- EKS Add-ons:\n  - VPC CNI\n  - CoreDNS\n  - kube-proxy\n  - Amazon EBS CSI Driver add-on\n  - (Optional) Amazon CloudWatch Observability / Fluent Bit\n- EKS OIDC provider (for IRSA)\n\n### IAM / Security\n- IAM role for EKS cluster (service role)\n- IAM role(s) for node group(s) (instance role) + instance profile\n- IAM role for EBS CSI Driver (IRSA/Pod Identity) + policy attachment\n- IAM role for AWS Load Balancer Controller (IRSA) + policy attachment\n- IAM role for GitHub Actions (OIDC trust) to deploy infrastructure and/or push images\n- AWS KMS key (for EBS encryption; optionally for secrets encryption)\n\n### Load balancing / exposure\n- Network Load Balancer(s) (created by controller from K8s Service type LoadBalancer)\n- Target groups (NLB)\n- (Optional) Route 53 hosted zone + records (if you want stable DNS names)\n\n### Container registry (recommended)\n- Amazon ECR repository\n- ECR lifecycle policy\n- (Optional) ECR replication configuration (if multi-region)\n\n### Storage\n- Amazon EBS volumes (dynamically provisioned per PVC via EBS CSI)\n- (Optional) EBS snapshots + AWS Backup plan (if you need scheduled backups of chain data)\n\n### Monitoring / Logging\n- Amazon CloudWatch Log Groups (EKS control plane logs, container logs)\n- CloudWatch alarms (node CPU/mem, disk pressure, NLB health, etc.)\n\n### Optional (only if you need them)\n- AWS WAF (only relevant if you expose HTTP/HTTPS via ALB; not typical for raw TCP)\n- AWS Shield Advanced (if you expect DDoS risk and need enhanced protections)\n- AWS Global Accelerator (if you need static anycast IPs and global routing)",
  "aws_resources": [
    "Amazon VPC",
    "Public Subnets (2–3 AZs)",
    "Private Subnets (2–3 AZs)",
    "Internet Gateway (IGW)",
    "NAT Gateway(s)",
    "Public Route Table(s) + Routes",
    "Private Route Table(s) + Routes",
    "Security Groups (EKS control plane, nodes, load balancers)",
    "Network ACLs (optional)",
    "VPC Gateway Endpoint: Amazon S3",
    "VPC Interface Endpoints (as needed): ECR (api,dkr), CloudWatch Logs, STS",
    "Amazon EKS Cluster",
    "EKS Managed Node Group(s) (EC2)",
    "EKS Add-ons: VPC CNI, CoreDNS, kube-proxy",
    "EKS Add-on: Amazon EBS CSI Driver",
    "EKS Add-on: CloudWatch Observability / Fluent Bit (optional)",
    "EKS OIDC Provider (for IRSA)",
    "IAM Role: EKS Cluster Service Role",
    "IAM Role + Instance Profile: Node Group Instance Role",
    "IAM Role (IRSA): EBS CSI Driver Role",
    "IAM Role (IRSA): AWS Load Balancer Controller Role",
    "IAM Role: GitHub Actions OIDC Deploy Role",
    "AWS KMS Key (EBS encryption; optional secrets encryption)",
    "Elastic Load Balancing: Network Load Balancer(s)",
    "ELB Target Group(s)",
    "Amazon Route 53 Hosted Zone + DNS Records (optional)",
    "Amazon ECR Repository (recommended)",
    "ECR Lifecycle Policy",
    "Amazon EBS Volumes (dynamic via PVCs)",
    "CloudWatch Log Groups",
    "CloudWatch Alarms",
    "AWS Backup Plan + Vault (optional)"
  ]
}