{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.6.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 6.31\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = {\n      Project     = var.project_name\n      ManagedBy   = \"terraform\"\n      Repository  = var.project_name\n      Component   = \"home-automation\"\n      Environment = var.environment\n    }\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"project_name\" {\n  description = \"Project/name prefix used for resources.\"\n  type        = string\n  default     = \"home-automation\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, prod).\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"ecr_repository_name\" {\n  description = \"ECR repository name for the Lambda container image.\"\n  type        = string\n  default     = \"home_automation\"\n}\n\nvariable \"lambda_function_name\" {\n  description = \"Lambda function name.\"\n  type        = string\n  default     = \"home-automation\"\n}\n\nvariable \"lambda_image_tag\" {\n  description = \"Container image tag to deploy. You must build and push this tag to ECR.\"\n  type        = string\n  default     = \"latest\"\n}\n\nvariable \"lambda_timeout_seconds\" {\n  description = \"Lambda timeout in seconds.\"\n  type        = number\n  default     = 60\n}\n\nvariable \"lambda_memory_mb\" {\n  description = \"Lambda memory in MB.\"\n  type        = number\n  default     = 256\n}\n\nvariable \"lambda_reserved_concurrency\" {\n  description = \"Reserved concurrency for the Lambda. Set to 1 to avoid overlapping runs. Use -1 for unreserved.\"\n  type        = number\n  default     = 1\n}\n\nvariable \"schedule_expression\" {\n  description = \"EventBridge Scheduler expression, e.g. rate(5 minutes).\"\n  type        = string\n  default     = \"rate(5 minutes)\"\n}\n\n# --- App configuration (non-secret) ---\nvariable \"influxdb_url\" {\n  description = \"InfluxDB base URL reachable from Lambda (e.g., https://influx.example.com:8086).\"\n  type        = string\n}\n\nvariable \"influxdb_org\" {\n  description = \"InfluxDB organization.\"\n  type        = string\n}\n\nvariable \"influxdb_bucket\" {\n  description = \"InfluxDB bucket.\"\n  type        = string\n}\n\nvariable \"tuya_apisregion\" {\n  description = \"Tuya API region (e.g., eu, us, cn).\"\n  type        = string\n}\n\n# --- Secrets (stored in Secrets Manager) ---\nvariable \"tuya_apikey\" {\n  description = \"Tuya API key (stored in Secrets Manager).\"\n  type        = string\n  sensitive   = true\n}\n\nvariable \"tuya_apisecret\" {\n  description = \"Tuya API secret (stored in Secrets Manager).\"\n  type        = string\n  sensitive   = true\n}\n\nvariable \"influxdb_token\" {\n  description = \"InfluxDB token (stored in Secrets Manager).\"\n  type        = string\n  sensitive   = true\n}\n\n# --- Optional VPC wiring (recommended for private InfluxDB) ---\nvariable \"lambda_vpc_subnet_ids\" {\n  description = \"Optional: subnet IDs for Lambda VPC config. Leave empty to run Lambda without VPC.\"\n  type        = list(string)\n  default     = []\n}\n\nvariable \"lambda_vpc_security_group_ids\" {\n  description = \"Optional: security group IDs for Lambda VPC config. Required if lambda_vpc_subnet_ids is set.\"\n  type        = list(string)\n  default     = []\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n\n  use_vpc = length(var.lambda_vpc_subnet_ids) > 0\n}\n\ndata \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\n# --------------------\n# ECR repository\n# --------------------\nresource \"aws_ecr_repository\" \"home_automation\" {\n  name                 = var.ecr_repository_name\n  image_tag_mutability = \"MUTABLE\"\n\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n\n  encryption_configuration {\n    encryption_type = \"AES256\"\n  }\n}\n\nresource \"aws_ecr_lifecycle_policy\" \"home_automation\" {\n  repository = aws_ecr_repository.home_automation.name\n\n  policy = jsonencode({\n    rules = [\n      {\n        rulePriority = 1\n        description  = \"Keep last 20 images\"\n        selection = {\n          tagStatus   = \"any\"\n          countType   = \"imageCountMoreThan\"\n          countNumber = 20\n        }\n        action = {\n          type = \"expire\"\n        }\n      }\n    ]\n  })\n}\n\n# --------------------\n# Secrets Manager\n# --------------------\nresource \"aws_secretsmanager_secret\" \"tuya\" {\n  name                    = \"${local.name_prefix}/tuya\"\n  recovery_window_in_days = 0\n}\n\nresource \"aws_secretsmanager_secret_version\" \"tuya\" {\n  secret_id = aws_secretsmanager_secret.tuya.id\n  secret_string = jsonencode({\n    TUYA_APIKEY    = var.tuya_apikey\n    TUYA_APISECRET = var.tuya_apisecret\n  })\n}\n\nresource \"aws_secretsmanager_secret\" \"influxdb\" {\n  name                    = \"${local.name_prefix}/influxdb\"\n  recovery_window_in_days = 0\n}\n\nresource \"aws_secretsmanager_secret_version\" \"influxdb\" {\n  secret_id = aws_secretsmanager_secret.influxdb.id\n  secret_string = jsonencode({\n    INFLUXDB_TOKEN = var.influxdb_token\n  })\n}\n\n# --------------------\n# IAM for Lambda\n# --------------------\ndata \"aws_iam_policy_document\" \"lambda_assume_role\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRole\"]\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"lambda\" {\n  name               = \"${local.name_prefix}-lambda\"\n  assume_role_policy = data.aws_iam_policy_document.lambda_assume_role.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_basic\" {\n  role       = aws_iam_role.lambda.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_vpc\" {\n  count      = local.use_vpc ? 1 : 0\n  role       = aws_iam_role.lambda.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole\"\n}\n\ndata \"aws_iam_policy_document\" \"lambda_secrets\" {\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"secretsmanager:GetSecretValue\",\n      \"secretsmanager:DescribeSecret\"\n    ]\n    resources = [\n      aws_secretsmanager_secret.tuya.arn,\n      aws_secretsmanager_secret.influxdb.arn\n    ]\n  }\n}\n\nresource \"aws_iam_policy\" \"lambda_secrets\" {\n  name   = \"${local.name_prefix}-lambda-secrets\"\n  policy = data.aws_iam_policy_document.lambda_secrets.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_secrets\" {\n  role       = aws_iam_role.lambda.name\n  policy_arn = aws_iam_policy.lambda_secrets.arn\n}\n\n# --------------------\n# CloudWatch Log Group\n# --------------------\nresource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${var.lambda_function_name}\"\n  retention_in_days = 14\n}\n\n# --------------------\n# Lambda function (container image)\n# --------------------\nresource \"aws_lambda_function\" \"home_automation\" {\n  function_name = var.lambda_function_name\n  role          = aws_iam_role.lambda.arn\n\n  package_type = \"Image\"\n  image_uri    = \"${aws_ecr_repository.home_automation.repository_url}:${var.lambda_image_tag}\"\n\n  timeout     = var.lambda_timeout_seconds\n  memory_size = var.lambda_memory_mb\n\n  reserved_concurrent_executions = var.lambda_reserved_concurrency\n\n  dynamic \"vpc_config\" {\n    for_each = local.use_vpc ? [1] : []\n    content {\n      subnet_ids         = var.lambda_vpc_subnet_ids\n      security_group_ids = var.lambda_vpc_security_group_ids\n    }\n  }\n\n  environment {\n    variables = {\n      # Non-secret config\n      TUYA_APISREGION = var.tuya_apisregion\n      INFLUXDB_URL    = var.influxdb_url\n      INFLUXDB_ORG    = var.influxdb_org\n      INFLUXDB_BUCKET = var.influxdb_bucket\n\n      # Secret references (Lambda code should read these secrets at runtime)\n      TUYA_SECRET_ARN     = aws_secretsmanager_secret.tuya.arn\n      INFLUXDB_SECRET_ARN = aws_secretsmanager_secret.influxdb.arn\n    }\n  }\n\n  depends_on = [\n    aws_cloudwatch_log_group.lambda,\n    aws_iam_role_policy_attachment.lambda_basic\n  ]\n}\n\n# --------------------\n# EventBridge Scheduler -> Lambda\n# --------------------\n# Scheduler needs an execution role to invoke Lambda.\n\ndata \"aws_iam_policy_document\" \"scheduler_assume_role\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRole\"]\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"scheduler.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"scheduler\" {\n  name               = \"${local.name_prefix}-scheduler\"\n  assume_role_policy = data.aws_iam_policy_document.scheduler_assume_role.json\n}\n\ndata \"aws_iam_policy_document\" \"scheduler_invoke_lambda\" {\n  statement {\n    effect    = \"Allow\"\n    actions   = [\"lambda:InvokeFunction\"]\n    resources = [aws_lambda_function.home_automation.arn]\n  }\n}\n\nresource \"aws_iam_policy\" \"scheduler_invoke_lambda\" {\n  name   = \"${local.name_prefix}-scheduler-invoke-lambda\"\n  policy = data.aws_iam_policy_document.scheduler_invoke_lambda.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"scheduler_invoke_lambda\" {\n  role       = aws_iam_role.scheduler.name\n  policy_arn = aws_iam_policy.scheduler_invoke_lambda.arn\n}\n\nresource \"aws_scheduler_schedule\" \"home_automation\" {\n  name = \"${local.name_prefix}-poll\"\n\n  flexible_time_window {\n    mode = \"OFF\"\n  }\n\n  schedule_expression = var.schedule_expression\n\n  target {\n    arn      = aws_lambda_function.home_automation.arn\n    role_arn = aws_iam_role.scheduler.arn\n\n    retry_policy {\n      maximum_event_age_in_seconds = 300\n      maximum_retry_attempts       = 0\n    }\n  }\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"ecr_repository_url\" {\n  description = \"ECR repository URL to push the Lambda image to.\"\n  value       = aws_ecr_repository.home_automation.repository_url\n}\n\noutput \"lambda_function_arn\" {\n  description = \"Lambda function ARN.\"\n  value       = aws_lambda_function.home_automation.arn\n}\n\noutput \"scheduler_schedule_arn\" {\n  description = \"EventBridge Scheduler schedule ARN.\"\n  value       = aws_scheduler_schedule.home_automation.arn\n}\n\noutput \"tuya_secret_arn\" {\n  description = \"Secrets Manager secret ARN containing TUYA_APIKEY and TUYA_APISECRET.\"\n  value       = aws_secretsmanager_secret.tuya.arn\n}\n\noutput \"influxdb_secret_arn\" {\n  description = \"Secrets Manager secret ARN containing INFLUXDB_TOKEN.\"\n  value       = aws_secretsmanager_secret.influxdb.arn\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region   = \"us-east-1\"\nenvironment  = \"dev\"\nproject_name = \"home-automation\"\n\n# InfluxDB endpoint reachable from Lambda\ninfluxdb_url    = \"https://example.com:8086\"\ninfluxdb_org    = \"my-org\"\ninfluxdb_bucket = \"my-bucket\"\n\n# Tuya region\ntuya_apisregion = \"eu\"\n\n# Secrets (will be stored in AWS Secrets Manager)\ntuya_apikey    = \"REPLACE_ME\"\ntuya_apisecret = \"REPLACE_ME\"\ninfluxdb_token = \"REPLACE_ME\"\n\n# Optional: run Lambda in a VPC (recommended if InfluxDB is private)\n# lambda_vpc_subnet_ids         = [\"subnet-abc\", \"subnet-def\"]\n# lambda_vpc_security_group_ids = [\"sg-abc\"]\n\n# Schedule\nschedule_expression = \"rate(5 minutes)\"\n\n# Image tag to deploy (must exist in ECR)\nlambda_image_tag = \"latest\"\n"
    },
    {
      "name": "README_DEPLOY.md",
      "content": "# Terraform (ai_tf) - Home Automation (Tuya -> Lambda -> InfluxDB)\n\nThis Terraform creates:\n- ECR repository for the Lambda container image\n- Secrets Manager secrets for Tuya + InfluxDB token\n- Lambda function (container image)\n- EventBridge Scheduler schedule to invoke Lambda\n\n## Deploy\n\n1) Copy variables file\n\n```bash\ncp terraform.tfvars.example terraform.tfvars\n# edit terraform.tfvars\n```\n\n2) Init/Apply (creates ECR, secrets, lambda, schedule)\n\n```bash\nterraform init\nterraform apply\n```\n\n3) Build and push the Lambda image\n\n```bash\nECR_URL=$(terraform output -raw ecr_repository_url)\n\ndocker build -t home-automation ..\ndocker tag home-automation:latest ${ECR_URL}:latest\naws ecr get-login-password --region $(terraform output -raw aws_region 2>/dev/null || echo us-east-1) | \\\n  docker login --username AWS --password-stdin $(echo ${ECR_URL} | cut -d/ -f1)\n\ndocker push ${ECR_URL}:latest\n```\n\n4) Re-apply to ensure Lambda points at the pushed tag (if needed)\n\n```bash\nterraform apply\n```\n\n## Important\n\n- The current application code (`main.py`) reads secrets from environment variables `TUYA_APIKEY`, `TUYA_APISECRET`, and `INFLUXDB_TOKEN`.\n- This Terraform stores secrets in Secrets Manager and passes secret ARNs as env vars (`TUYA_SECRET_ARN`, `INFLUXDB_SECRET_ARN`).\n\nTo use Secrets Manager securely, update the Lambda code to fetch and set these values at runtime.\nIf you cannot change code, you can instead pass secrets directly as environment variables (less secure).\n"
    }
  ]
}