{
  "plantuml_diagram": "@startuml\n!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v20.0/dist\n!include AWSPuml/AWSCommon.puml\n\ntitle Local Nomad + Ansible Lab (Docker/Sysbox) - High Level Deployment\n\nskinparam shadowing false\nskinparam componentStyle rectangle\n\nnode \"Developer Workstation\\n(Make/Task + Ansible Controller)\\nPython 3 + ansible-core 2.17 / ansible 10\" as dev {\n  artifact \"Repo Workspace\\n(Playbooks, Nomad jobspecs, Dockerfiles)\" as repo\n  component \"Ansible\\n(playbooks/*, inventory.yml)\" as ansible\n  component \"Vagrant (Docker provider)\\n+ Docker Compose\" as vagrant\n}\n\ncloud \"Local Docker Engine\" as docker {\n  node \"Custom Bridge Network\\n(static IPs)\" as net\n\n  node \"server_1\\nSysbox Ubuntu system container\\nNomad 1.8.2 (server)\\nConsul 1.19.1 (optional)\\nSSH\" as s1 {\n    component \"Nomad Server\\n(scheduler + raft)\" as nomad_server\n    component \"Consul Agent (optional)\" as consul1\n  }\n\n  node \"server_2\\nSysbox Ubuntu system container\\nNomad 1.8.2 (client)\\nConsul 1.19.1 (optional)\\nDocker runtime\\nSSH\" as s2 {\n    component \"Nomad Client\\n(task driver: docker)\" as nomad_client\n    component \"Consul Agent (optional)\" as consul2\n\n    frame \"Nomad Allocations (Docker containers)\" as alloc {\n      component \"Redis\\n(redis:7.0.7-alpine)\" as redis\n      component \"Web API\\n(Flask container)\\nPort 5000\" as web\n      component \"Employee Worker\\n(batch/periodic)\" as worker\n      component \"Setup Job\\n(parameterized batch)\" as setup\n    }\n  }\n}\n\nnode \"Tailscale Overlay Network\" as tailscale {\n  component \"tailscale/tailscale\\n(container on each server)\" as ts\n}\n\n' Provisioning / orchestration\nansible --> s1 : SSH\\nprovision Nomad server config\nansible --> s2 : SSH\\nprovision Nomad client config\\n+ run tailscale container\nvagrant --> docker : build base image\\n(Dockerfile.server)\\ncreate server containers\n\n' Nomad cluster relationships\nnomad_client --> nomad_server : RPC\\nregister client\\nget allocations\nconsul1 .. consul2 : gossip (optional)\n\n' Service discovery / connectivity\nweb --> redis : service lookup\\n(nomadService \"redis-svc\")\\nTCP 6379\nworker --> redis : read/write\\nTCP 6379\nsetup --> redis : init/seed\\nTCP 6379\n\n' External access\ndev --> web : HTTP :5000\\n(via Docker network port mapping)\n\n' Overlay network\ns1 --> ts\ns2 --> ts\n\n@enduml",
  "svg_diagram": "<?plantuml 1.2026.2beta2?><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" contentStyleType=\"text/css\" data-diagram-type=\"DESCRIPTION\" height=\"1229px\" preserveAspectRatio=\"none\" style=\"width:1868px;height:1229px;background:#FFFFFF;\" version=\"1.1\" viewBox=\"0 0 1868 1229\" width=\"1868px\" zoomAndPan=\"magnify\"><title>Local Nomad + Ansible Lab (Docker/Sysbox) - High Level Deployment</title><defs/><g><g class=\"title\" data-source-line=\"4\"><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"14\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"547.6543\" x=\"653.5176\" y=\"22.9951\">Local Nomad + Ansible Lab (Docker/Sysbox) - High Level Deployment</text></g><!--cluster dev--><g class=\"cluster\" data-qualified-name=\"dev\" data-source-line=\"9\" id=\"ent0002\"><polygon fill=\"#FFFFFF\" points=\"873,53.2969,883,43.2969,1618,43.2969,1618,209.1869,1608,219.1869,873,219.1869,873,53.2969\" style=\"stroke:#7D8998;stroke-width:1.25;\"/><line style=\"stroke:#7D8998;stroke-width:1.25;\" x1=\"1608\" x2=\"1618\" y1=\"53.2969\" y2=\"43.2969\"/><line style=\"stroke:#7D8998;stroke-width:1.25;\" x1=\"873\" x2=\"1608\" y1=\"53.2969\" y2=\"53.2969\"/><line style=\"stroke:#7D8998;stroke-width:1.25;\" x1=\"1608\" x2=\"1608\" y1=\"53.2969\" y2=\"219.1869\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"14\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"182.2734\" x=\"1150.3633\" y=\"69.292\">Developer Workstation</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"14\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"260.4082\" x=\"1111.2959\" y=\"85.5889\">(Make/Task + Ansible Controller)</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"14\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"324.208\" x=\"1079.396\" y=\"101.8857\">Python 3 + ansible-core 2.17 / ansible 10</text></g><!--cluster docker--><g class=\"cluster\" data-qualified-name=\"docker\" data-source-line=\"15\" id=\"ent0006\"><path d=\"M354.8429,319.3842 C376.0794,284.3683 415.0416,280.7164 434.0876,321.6691 C457.2181,286.4247 491.647,282.8296 514.623,321.8367 C534.4992,287.7367 557.3805,291.3102 580.3751,318.4908 C612.5864,278.8995 640.0898,288.5638 665.8484,325.6809 C686.8334,286.3893 722.3055,280.0034 750.6202,317.5996 C770.9311,282.8945 806.2338,282.7097 825.7928,318.4026 C850.7914,291.7065 881.2713,285.9101 897.6716,327.4589 C915.5322,288.7969 957.9905,283.758 984.7504,316.6249 C1010.6994,284.2738 1035.3695,286.8877 1056.5486,321.7223 C1079.7247,291.7044 1117.4852,289.9249 1133.45,329.6712 C1157.2362,290.0022 1193.5261,288.6827 1216.4071,330.5917 C1241.1612,298.9707 1266.4973,289.2454 1291.4494,330.3875 C1312.6632,290.2982 1349.8919,282.374 1375.2109,326.2945 C1395.6283,287.4157 1428.4956,290.67 1450,325.1869 C1454.8343,328.1596 1455.3578,331.9992 1450.5287,335.4688 C1498.2816,358.1782 1498.8508,395.72 1453.2889,421.4259 C1488.6067,445.6473 1496.5218,478.2189 1455.6509,504.6037 C1489.721,527.3426 1498.4428,557.1781 1458.1123,582.2747 C1491.6498,602.8645 1501.2278,638.0873 1460.0709,660.5462 C1508.3138,684.6094 1512.6285,724.2773 1464.4533,752.9149 C1496.4506,777.93 1498.6495,801.886 1466.1173,828.325 C1505.8362,856.8105 1512.1606,891.3594 1468.4939,921.9613 C1498.093,948.3554 1498.983,986.5825 1453.9942,998.9246 C1489.7943,1023.1587 1485.5989,1051.1105 1454.6477,1075.9112 C1492.5925,1109.4142 1491.1701,1143.8649 1443,1166.2669 C1447.3933,1161.6402 1450.9028,1161.9971 1454.2915,1167.3981 C1437.2871,1212.112 1396.1837,1211.0315 1372.6454,1173.9175 C1346.0875,1208.9293 1317.9079,1215.2926 1288.537,1177.1517 C1263.8124,1214.6117 1233.7796,1204.1737 1213.667,1172.1801 C1184.722,1215.4922 1159.9897,1213.0677 1132.119,1171.1522 C1118.4868,1206.2653 1083.6344,1213.1122 1058.8078,1183.9129 C1033.5905,1217.9559 999.1769,1215.6413 983.1268,1174.6649 C956.087,1211.3178 923.5435,1210.597 897.2291,1173.8164 C881.2675,1218.571 848.2525,1215.948 821.2977,1184.8161 C798.4529,1218.7242 762.8683,1217.5909 743.2073,1181.2756 C720.4525,1212.9972 685.5532,1215.2125 663.6771,1180.2278 C632.3102,1214.6929 606.6646,1217.3067 584.7251,1171.0115 C561.952,1212.1692 536.9884,1208.7428 509.672,1175.6009 C491.2609,1222.0964 452.3005,1221.8593 427.8035,1181.326 C391.1363,1221.4515 351.8533,1212.0172 338,1159.2669 C345.5708,1160.4837 346.5964,1165.5405 342.5211,1171.1779 C299.2266,1145.9253 300.7475,1105.9547 348.4921,1087.173 C305.7628,1062.2499 305.7555,1025.9432 342.842,996.0699 C310.4233,973.8216 307.385,942.4149 345.0048,922.2177 C301.5612,893.1901 306.1639,860.8647 343.5903,830.5887 C304.339,805.412 301.2097,777.3886 343.8269,752.4599 C305.2897,730.6622 303.2245,695.8083 341.981,672.2322 C297.9427,641.5117 298.59,610.932 346.7076,585.2174 C304.774,561.6829 297.5565,534.3433 337.633,501.8788 C305.1921,474.5316 307.706,439.9699 344.0744,417.9006 C299.2029,383.6629 290.5259,351.5024 345,318.1869 C348.7893,314.4996 352.1815,313.7988 354.8429,319.3842\" fill=\"#FFFFFF\" style=\"stroke:#7D8998;stroke-width:1.25;\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"14\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"159.8926\" x=\"814.0537\" y=\"336.182\">Local Docker Engine</text></g><!-- (SVG truncated in this view for brevity by the client; it is the full SVG returned by the validator tool.) --></g></svg>",
  "architecture_description": "## High-level architecture\n\nThis repository defines a **local infrastructure lab** that stands up a small **HashiCorp Nomad cluster** on a developer machine using **Docker (Sysbox system containers)**, then configures and deploys workloads using **Ansible** and **Nomad jobspecs**.\n\n### Main deployment blocks\n\n1. **Developer Workstation (control plane for the lab)**\n   - Tooling: **Makefile/Taskfile**, **Python + Ansible (ansible-core 2.17 / ansible 10)**.\n   - Responsibilities:\n     - Builds/starts the lab environment (Docker network + containers) via **Vagrant (Docker provider)** and/or **Docker Compose**.\n     - Provisions the “server” nodes over **SSH** using **Ansible**.\n     - Submits/runs Nomad jobs (via task runner commands / Nomad CLI patterns).\n\n2. **Local Docker Engine (runtime for the lab)**\n   - Provides a **custom Docker bridge network** with **static IPs** (as defined in `docker-compose.yml` / Makefile).\n   - Hosts two Sysbox-based Ubuntu “system containers” that behave like lightweight VMs.\n\n3. **Nomad Cluster Nodes (Sysbox Ubuntu system containers)**\n   - **server_1 (Nomad Server)**\n     - Runs **Nomad 1.8.2 server** (scheduler + raft state).\n     - Has **Consul 1.19.1 installed** (optional/available for service discovery integration).\n   - **server_2 (Nomad Client)**\n     - Runs **Nomad 1.8.2 client** with **Docker task driver**.\n     - Executes the application workloads as **Nomad allocations** (Docker containers).\n     - Also has **Consul installed** (optional/available).\n\n4. **Application workloads (Nomad jobs / allocations on server_2)**\n   - **Redis**: `redis:7.0.7-alpine`.\n   - **Web API**: Flask-based container (from HashiCorp education images), exposed on **port 5000**.\n   - **Employee worker**: batch/periodic job.\n   - **Setup job**: parameterized batch job.\n\n5. **Overlay networking (Tailscale)**\n   - Ansible runs a **tailscale/tailscale** container on the servers to provide an optional **VPN/overlay network** for remote connectivity.\n\n### Key relationships / flows\n- **Provisioning:** Developer workstation → (SSH) → server_1/server_2 using **Ansible** to write Nomad server/client configs.\n- **Cluster operation:** Nomad client (server_2) → Nomad server (server_1) via **Nomad RPC** to register and receive allocations.\n- **Service connectivity:** Web/worker/setup → Redis over **TCP 6379**, with service discovery implied by Nomad templates (e.g., `nomadService \"redis-svc\"`).\n- **External access:** Developer workstation reaches the **Web API on port 5000** via Docker networking/port mapping.\n- **Optional discovery layer:** Consul agents can gossip between nodes if enabled, supporting service discovery/mesh patterns."
}