{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = var.tags\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"name\" {\n  description = \"Name prefix for resources.\"\n  type        = string\n  default     = \"ssh-key-agent\"\n}\n\nvariable \"tags\" {\n  description = \"Tags applied to all resources.\"\n  type        = map(string)\n  default = {\n    Project = \"ssh-key-agent\"\n    Managed = \"terraform\"\n  }\n}\n\nvariable \"vpc_cidr\" {\n  description = \"CIDR for the VPC.\"\n  type        = string\n  default     = \"10.20.0.0/16\"\n}\n\nvariable \"public_subnet_cidrs\" {\n  description = \"Public subnet CIDRs (2 recommended).\"\n  type        = list(string)\n  default     = [\"10.20.0.0/24\", \"10.20.1.0/24\"]\n}\n\nvariable \"private_subnet_cidrs\" {\n  description = \"Private subnet CIDRs (2 recommended).\"\n  type        = list(string)\n  default     = [\"10.20.10.0/24\", \"10.20.11.0/24\"]\n}\n\nvariable \"instance_type\" {\n  description = \"EC2 instance type.\"\n  type        = string\n  default     = \"t3.micro\"\n}\n\nvariable \"ssh_key_agent_image\" {\n  description = \"Container image to run (Quay.io).\"\n  type        = string\n  default     = \"quay.io/utilitywarehouse/ssh-key-agent:latest\"\n}\n\nvariable \"ska_key_uri\" {\n  description = \"URI location of the authmap JSON (SKA_KEY_URI).\"\n  type        = string\n}\n\nvariable \"ska_groups\" {\n  description = \"Comma separated list of groups allowed access (SKA_GROUPS).\"\n  type        = string\n}\n\nvariable \"ska_interval\" {\n  description = \"Sync interval in seconds (SKA_INTERVAL).\"\n  type        = number\n  default     = 60\n}\n\nvariable \"authorized_keys_host_path\" {\n  description = \"Host path to authorized_keys file. Will be bind-mounted into the container.\"\n  type        = string\n  default     = \"/home/ec2-user/.ssh/authorized_keys\"\n}\n\nvariable \"enable_efs\" {\n  description = \"If true, create and mount EFS at /mnt/ssh-keys and write authorized_keys there.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"asg_desired_capacity\" {\n  description = \"Desired capacity for the Auto Scaling Group.\"\n  type        = number\n  default     = 1\n}\n"
    },
    {
      "name": "main.tf",
      "content": "data \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\nlocals {\n  azs = slice(data.aws_availability_zones.available.names, 0, 2)\n\n  # If EFS is enabled, we write to EFS mount; otherwise to the provided host path.\n  effective_authorized_keys_host_path = var.enable_efs ? \"/mnt/ssh-keys/authorized_keys\" : var.authorized_keys_host_path\n\n  # Container sees the file at /authorized_keys\n  container_authorized_keys_path = \"/authorized_keys\"\n\n  user_data = templatefile(\"${path.module}/user_data.sh.tftpl\", {\n    aws_region                        = var.aws_region\n    name                              = var.name\n    ssh_key_agent_image               = var.ssh_key_agent_image\n    ska_key_uri_param_name            = aws_ssm_parameter.ska_key_uri.name\n    ska_groups_param_name             = aws_ssm_parameter.ska_groups.name\n    ska_interval_param_name           = aws_ssm_parameter.ska_interval.name\n    authorized_keys_host_path         = local.effective_authorized_keys_host_path\n    container_authorized_keys_path    = local.container_authorized_keys_path\n    enable_efs                        = var.enable_efs\n    efs_id                            = var.enable_efs ? aws_efs_file_system.this[0].id : \"\"\n    cloudwatch_log_group_name         = aws_cloudwatch_log_group.ssh_key_agent.name\n  })\n}\n\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"~> 5.0\"\n\n  name = var.name\n  cidr = var.vpc_cidr\n\n  azs             = local.azs\n  public_subnets  = var.public_subnet_cidrs\n  private_subnets = var.private_subnet_cidrs\n\n  enable_nat_gateway = true\n  single_nat_gateway = true\n\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n}\n\nresource \"aws_security_group\" \"instance\" {\n  name_prefix = \"${var.name}-instance-\"\n  description = \"Instance security group for ssh-key-agent host\"\n  vpc_id      = module.vpc.vpc_id\n\n  # No inbound required (use SSM Session Manager)\n\n  egress {\n    description = \"Allow HTTPS egress\"\n    from_port   = 443\n    to_port     = 443\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    description = \"Allow DNS\"\n    from_port   = 53\n    to_port     = 53\n    protocol    = \"udp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    description = \"Allow NTP\"\n    from_port   = 123\n    to_port     = 123\n    protocol    = \"udp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_security_group\" \"efs\" {\n  count       = var.enable_efs ? 1 : 0\n  name_prefix = \"${var.name}-efs-\"\n  description = \"EFS security group\"\n  vpc_id      = module.vpc.vpc_id\n\n  ingress {\n    description     = \"NFS from instance\"\n    from_port       = 2049\n    to_port         = 2049\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.instance.id]\n  }\n\n  egress {\n    description = \"All egress\"\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n}\n\nresource \"aws_efs_file_system\" \"this\" {\n  count          = var.enable_efs ? 1 : 0\n  creation_token = var.name\n  encrypted      = true\n\n  lifecycle_policy {\n    transition_to_ia = \"AFTER_30_DAYS\"\n  }\n}\n\nresource \"aws_efs_mount_target\" \"this\" {\n  count           = var.enable_efs ? length(module.vpc.private_subnets) : 0\n  file_system_id  = aws_efs_file_system.this[0].id\n  subnet_id       = module.vpc.private_subnets[count.index]\n  security_groups = [aws_security_group.efs[0].id]\n}\n\nresource \"aws_cloudwatch_log_group\" \"ssh_key_agent\" {\n  name              = \"/${var.name}/daemon\"\n  retention_in_days = 30\n}\n\nresource \"aws_ssm_parameter\" \"ska_key_uri\" {\n  name        = \"/${var.name}/SKA_KEY_URI\"\n  description = \"URI location of the authmap JSON\"\n  type        = \"String\"\n  value       = var.ska_key_uri\n}\n\nresource \"aws_ssm_parameter\" \"ska_groups\" {\n  name        = \"/${var.name}/SKA_GROUPS\"\n  description = \"Comma separated list of groups\"\n  type        = \"String\"\n  value       = var.ska_groups\n}\n\nresource \"aws_ssm_parameter\" \"ska_interval\" {\n  name        = \"/${var.name}/SKA_INTERVAL\"\n  description = \"Sync interval in seconds\"\n  type        = \"String\"\n  value       = tostring(var.ska_interval)\n}\n\ndata \"aws_ami\" \"al2023\" {\n  most_recent = true\n  owners      = [\"amazon\"]\n\n  filter {\n    name   = \"name\"\n    values = [\"al2023-ami-*-x86_64\"]\n  }\n\n  filter {\n    name   = \"virtualization-type\"\n    values = [\"hvm\"]\n  }\n}\n\nresource \"aws_launch_template\" \"this\" {\n  name_prefix   = \"${var.name}-\"\n  image_id      = data.aws_ami.al2023.id\n  instance_type = var.instance_type\n\n  vpc_security_group_ids = [aws_security_group.instance.id]\n\n  iam_instance_profile {\n    name = aws_iam_instance_profile.this.name\n  }\n\n  metadata_options {\n    http_endpoint               = \"enabled\"\n    http_tokens                 = \"required\"\n    http_put_response_hop_limit = 2\n  }\n\n  user_data = base64encode(local.user_data)\n\n  block_device_mappings {\n    device_name = \"/dev/xvda\"\n\n    ebs {\n      encrypted             = true\n      volume_size           = 10\n      volume_type           = \"gp3\"\n      delete_on_termination = true\n    }\n  }\n\n  tag_specifications {\n    resource_type = \"instance\"\n    tags = merge(var.tags, {\n      Name = var.name\n    })\n  }\n}\n\nresource \"aws_autoscaling_group\" \"this\" {\n  name                = var.name\n  desired_capacity    = var.asg_desired_capacity\n  min_size            = var.asg_desired_capacity\n  max_size            = var.asg_desired_capacity\n  vpc_zone_identifier = module.vpc.private_subnets\n\n  health_check_type         = \"EC2\"\n  health_check_grace_period = 120\n\n  launch_template {\n    id      = aws_launch_template.this.id\n    version = \"$Latest\"\n  }\n\n  tag {\n    key                 = \"Name\"\n    value               = var.name\n    propagate_at_launch = true\n  }\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n"
    },
    {
      "name": "iam.tf",
      "content": "data \"aws_iam_policy_document\" \"ec2_assume\" {\n  statement {\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"ec2.amazonaws.com\"]\n    }\n\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"this\" {\n  name_prefix        = \"${var.name}-ec2-\"\n  assume_role_policy = data.aws_iam_policy_document.ec2_assume.json\n}\n\nresource \"aws_iam_instance_profile\" \"this\" {\n  name_prefix = \"${var.name}-\"\n  role        = aws_iam_role.this.name\n}\n\nresource \"aws_iam_role_policy_attachment\" \"ssm\" {\n  role       = aws_iam_role.this.name\n  policy_arn = \"arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\"\n}\n\nresource \"aws_iam_role_policy_attachment\" \"cw_agent\" {\n  role       = aws_iam_role.this.name\n  policy_arn = \"arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy\"\n}\n\ndata \"aws_iam_policy_document\" \"ssm_params_read\" {\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"ssm:GetParameter\",\n      \"ssm:GetParameters\",\n      \"ssm:GetParametersByPath\"\n    ]\n    resources = [\n      \"arn:aws:ssm:${var.aws_region}:${data.aws_caller_identity.current.account_id}:parameter/${var.name}/*\"\n    ]\n  }\n}\n\ndata \"aws_caller_identity\" \"current\" {}\n\nresource \"aws_iam_policy\" \"ssm_params_read\" {\n  name_prefix = \"${var.name}-ssm-params-\"\n  policy      = data.aws_iam_policy_document.ssm_params_read.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"ssm_params_read\" {\n  role       = aws_iam_role.this.name\n  policy_arn = aws_iam_policy.ssm_params_read.arn\n}\n"
    },
    {
      "name": "user_data.sh.tftpl",
      "content": "#!/bin/bash\nset -euo pipefail\n\n# Log user-data\nexec > >(tee /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1\n\necho \"Bootstrapping ${name}...\"\n\nyum -y update\n\nyum -y install docker amazon-cloudwatch-agent amazon-efs-utils jq\nsystemctl enable --now docker\n\n# Fetch config from SSM Parameter Store\nSKA_KEY_URI=$(aws ssm get-parameter --region ${aws_region} --name \"${ska_key_uri_param_name}\" --query 'Parameter.Value' --output text)\nSKA_GROUPS=$(aws ssm get-parameter --region ${aws_region} --name \"${ska_groups_param_name}\" --query 'Parameter.Value' --output text)\nSKA_INTERVAL=$(aws ssm get-parameter --region ${aws_region} --name \"${ska_interval_param_name}\" --query 'Parameter.Value' --output text)\n\n# Prepare authorized_keys location\nAK_HOST_PATH=\"${authorized_keys_host_path}\"\nAK_HOST_DIR=$(dirname \"$AK_HOST_PATH\")\nmkdir -p \"$AK_HOST_DIR\"\n\n# If EFS enabled, mount it at /mnt/ssh-keys\nif [ \"${enable_efs}\" = \"true\" ]; then\n  mkdir -p /mnt/ssh-keys\n  # Use TLS for EFS mount\n  echo \"${efs_id}:/ /mnt/ssh-keys efs _netdev,tls 0 0\" >> /etc/fstab\n  mount -a\n  AK_HOST_PATH=\"/mnt/ssh-keys/authorized_keys\"\nfi\n\ntouch \"$AK_HOST_PATH\"\nchmod 700 \"$AK_HOST_DIR\" || true\nchmod 600 \"$AK_HOST_PATH\" || true\n\n# Configure CloudWatch Agent (basic)\ncat >/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<'CWAGENT'\n{\n  \"logs\": {\n    \"logs_collected\": {\n      \"files\": {\n        \"collect_list\": [\n          {\n            \"file_path\": \"/var/log/user-data.log\",\n            \"log_group_name\": \"${cloudwatch_log_group_name}\",\n            \"log_stream_name\": \"{instance_id}/user-data\",\n            \"timestamp_format\": \"%Y-%m-%d %H:%M:%S\"\n          }\n        ]\n      }\n    }\n  }\n}\nCWAGENT\n\n/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a stop || true\n/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s\n\n# Run container\n# Use awslogs driver to send container logs to CloudWatch\nCONTAINER_NAME=\"ssh-key-agent\"\n\ndocker rm -f \"$CONTAINER_NAME\" || true\n\ndocker run -d --name \"$CONTAINER_NAME\" --restart=always \\\n  --log-driver=awslogs \\\n  --log-opt awslogs-region=${aws_region} \\\n  --log-opt awslogs-group=${cloudwatch_log_group_name} \\\n  --log-opt awslogs-stream=\"{instance_id}/container\" \\\n  -v \"$AK_HOST_PATH\":\"${container_authorized_keys_path}\":rw \\\n  -e SKA_KEY_URI=\"$SKA_KEY_URI\" \\\n  -e SKA_GROUPS=\"$SKA_GROUPS\" \\\n  -e SKA_AKF_LOC=\"${container_authorized_keys_path}\" \\\n  -e SKA_INTERVAL=\"$SKA_INTERVAL\" \\\n  ${ssh_key_agent_image}\n\necho \"Done.\"\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"vpc_id\" {\n  value       = module.vpc.vpc_id\n  description = \"VPC ID\"\n}\n\noutput \"private_subnet_ids\" {\n  value       = module.vpc.private_subnets\n  description = \"Private subnet IDs\"\n}\n\noutput \"autoscaling_group_name\" {\n  value       = aws_autoscaling_group.this.name\n  description = \"ASG name\"\n}\n\noutput \"ssm_parameters\" {\n  description = \"SSM parameter names used by the instance\"\n  value = {\n    ska_key_uri  = aws_ssm_parameter.ska_key_uri.name\n    ska_groups   = aws_ssm_parameter.ska_groups.name\n    ska_interval = aws_ssm_parameter.ska_interval.name\n  }\n}\n\noutput \"cloudwatch_log_group\" {\n  value       = aws_cloudwatch_log_group.ssh_key_agent.name\n  description = \"CloudWatch Log Group for daemon logs\"\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "aws_region = \"us-east-1\"\nname       = \"ssh-key-agent\"\n\n# Required\nska_key_uri = \"https://example.com/authmap\"\nska_groups  = \"group@domain.com,group2@domain.com\"\n\n# Optional\nssh_key_agent_image          = \"quay.io/utilitywarehouse/ssh-key-agent:latest\"\nska_interval                 = 60\nauthorized_keys_host_path    = \"/home/ec2-user/.ssh/authorized_keys\"\nenable_efs                   = false\nasg_desired_capacity         = 1\n"
    }
  ]
}