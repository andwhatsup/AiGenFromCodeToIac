{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = merge(\n      {\n        Project   = var.project_name\n        ManagedBy = \"terraform\"\n      },\n      var.tags\n    )\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for resource naming.\"\n  type        = string\n  default     = \"awscomprehend\"\n}\n\nvariable \"name_prefix\" {\n  description = \"Optional additional prefix for resource names (e.g., env).\"\n  type        = string\n  default     = \"\"\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply to all resources.\"\n  type        = map(string)\n  default     = {}\n}\n\nvariable \"s3_bucket_name\" {\n  description = \"If set, use this exact bucket name (must be globally unique). If null, a name will be generated.\"\n  type        = string\n  default     = null\n}\n\nvariable \"text_prefix\" {\n  description = \"S3 prefix for raw text uploads.\"\n  type        = string\n  default     = \"text/\"\n}\n\nvariable \"comprehend_prefix\" {\n  description = \"S3 prefix for intermediate comprehend output.\"\n  type        = string\n  default     = \"comprehend/\"\n}\n\nvariable \"datalake_prefix\" {\n  description = \"S3 prefix for datalake output.\"\n  type        = string\n  default     = \"datalake/\"\n}\n\nvariable \"enable_sqs_sse\" {\n  description = \"Enable SQS SSE (SSE-SQS).\"\n  type        = bool\n  default     = true\n}\n\nvariable \"sqs_message_retention_seconds\" {\n  description = \"SQS message retention.\"\n  type        = number\n  default     = 1209600\n}\n\nvariable \"sqs_visibility_timeout_seconds\" {\n  description = \"SQS visibility timeout.\"\n  type        = number\n  default     = 300\n}\n\nvariable \"sqs_max_receive_count\" {\n  description = \"Max receives before sending to DLQ.\"\n  type        = number\n  default     = 5\n}\n\nvariable \"sfn_log_level\" {\n  description = \"Step Functions log level.\"\n  type        = string\n  default     = \"ALL\"\n  validation {\n    condition     = contains([\"ALL\", \"ERROR\", \"FATAL\", \"OFF\"], var.sfn_log_level)\n    error_message = \"sfn_log_level must be one of ALL, ERROR, FATAL, OFF.\"\n  }\n}\n\nvariable \"sfn_include_execution_data\" {\n  description = \"Include execution data in Step Functions logs.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"glue_database_name\" {\n  description = \"Glue Data Catalog database name.\"\n  type        = string\n  default     = \"awscomprehend_datalake\"\n}\n\nvariable \"create_glue_crawler\" {\n  description = \"Create a Glue crawler for the datalake prefix.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"glue_crawler_schedule\" {\n  description = \"Optional cron schedule for the crawler (e.g., cron(0 2 * * ? *)). Null disables schedule.\"\n  type        = string\n  default     = null\n}\n"
    },
    {
      "name": "locals.tf",
      "content": "locals {\n  prefix = var.name_prefix != \"\" ? \"${var.name_prefix}-\" : \"\"\n\n  bucket_name = coalesce(\n    var.s3_bucket_name,\n    lower(replace(\"${local.prefix}${var.project_name}-${data.aws_caller_identity.current.account_id}-${data.aws_region.current.name}\", \"_\", \"-\"))\n  )\n\n  # These are used to replace placeholders in the ASL JSON definitions.\n  # The state machines use States.Format('${aws_s3_object_key}{}.json', ...) style placeholders.\n  s3_object_key_comprehend_json = \"${var.comprehend_prefix}\"\n\n  # Datalake model prefixes (from DATALAKE.md)\n  s3_object_key_entity                      = \"${var.datalake_prefix}model=entity/\"\n  s3_object_key_key_phrase                  = \"${var.datalake_prefix}model=key_phrase/\"\n  s3_object_key_pii_entity                  = \"${var.datalake_prefix}model=pii_entity/\"\n  s3_object_key_sentiment                   = \"${var.datalake_prefix}model=sentiment/\"\n  s3_object_key_sentiment_score             = \"${var.datalake_prefix}model=sentiment_score/\"\n  s3_object_key_syntax_token                = \"${var.datalake_prefix}model=syntax_token/\"\n  s3_object_key_syntax_token_part_of_speech = \"${var.datalake_prefix}model=syntax_token_part_of_speech/\"\n  s3_object_key_targeted_sentiment          = \"${var.datalake_prefix}model=targeted_sentiment/\"\n  s3_object_key_targeted_sentiment_descriptive_mention = \"${var.datalake_prefix}model=targeted_sentiment_descriptive_mention/\"\n  s3_object_key_targeted_sentiment_mention  = \"${var.datalake_prefix}model=targeted_sentiment_mention/\"\n  s3_object_key_targeted_sentiment_mention_sentiment = \"${var.datalake_prefix}model=targeted_sentiment_mention_sentiment/\"\n  s3_object_key_targeted_sentiment_mention_sentiment_score = \"${var.datalake_prefix}model=targeted_sentiment_mention_sentiment_score/\"\n  s3_object_key_toxic_content               = \"${var.datalake_prefix}model=toxic_content/\"\n  s3_object_key_toxic_content_label         = \"${var.datalake_prefix}model=toxic_content_label/\"\n}\n"
    },
    {
      "name": "data.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n"
    },
    {
      "name": "kms.tf",
      "content": "resource \"aws_kms_key\" \"s3\" {\n  description             = \"KMS key for S3 encryption for ${var.project_name}\"\n  deletion_window_in_days = 7\n  enable_key_rotation     = true\n}\n\nresource \"aws_kms_alias\" \"s3\" {\n  name          = \"alias/${local.prefix}${var.project_name}-s3\"\n  target_key_id = aws_kms_key.s3.key_id\n}\n"
    },
    {
      "name": "s3.tf",
      "content": "resource \"aws_s3_bucket\" \"data\" {\n  bucket = local.bucket_name\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"data\" {\n  bucket                  = aws_s3_bucket.data.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"data\" {\n  bucket = aws_s3_bucket.data.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"data\" {\n  bucket = aws_s3_bucket.data.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm     = \"aws:kms\"\n      kms_master_key_id = aws_kms_key.s3.arn\n    }\n    bucket_key_enabled = true\n  }\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"data\" {\n  bucket = aws_s3_bucket.data.id\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\n# Enable EventBridge notifications for the bucket (required for EventBridge rules on S3 events)\nresource \"aws_s3_bucket_notification\" \"data\" {\n  bucket      = aws_s3_bucket.data.id\n  eventbridge = true\n\n  depends_on = [aws_s3_bucket_ownership_controls.data]\n}\n"
    },
    {
      "name": "sqs.tf",
      "content": "resource \"aws_sqs_queue\" \"text_dlq\" {\n  name                      = \"${local.prefix}${var.project_name}-text-dlq\"\n  message_retention_seconds = var.sqs_message_retention_seconds\n\n  sqs_managed_sse_enabled = var.enable_sqs_sse\n}\n\nresource \"aws_sqs_queue\" \"comprehend_dlq\" {\n  name                      = \"${local.prefix}${var.project_name}-comprehend-dlq\"\n  message_retention_seconds = var.sqs_message_retention_seconds\n\n  sqs_managed_sse_enabled = var.enable_sqs_sse\n}\n\nresource \"aws_sqs_queue\" \"text\" {\n  name                       = \"${local.prefix}${var.project_name}-s3-object-created-text\"\n  message_retention_seconds  = var.sqs_message_retention_seconds\n  visibility_timeout_seconds = var.sqs_visibility_timeout_seconds\n\n  redrive_policy = jsonencode({\n    deadLetterTargetArn = aws_sqs_queue.text_dlq.arn\n    maxReceiveCount     = var.sqs_max_receive_count\n  })\n\n  sqs_managed_sse_enabled = var.enable_sqs_sse\n}\n\nresource \"aws_sqs_queue\" \"comprehend\" {\n  name                       = \"${local.prefix}${var.project_name}-s3-object-created-comprehend\"\n  message_retention_seconds  = var.sqs_message_retention_seconds\n  visibility_timeout_seconds = var.sqs_visibility_timeout_seconds\n\n  redrive_policy = jsonencode({\n    deadLetterTargetArn = aws_sqs_queue.comprehend_dlq.arn\n    maxReceiveCount     = var.sqs_max_receive_count\n  })\n\n  sqs_managed_sse_enabled = var.enable_sqs_sse\n}\n"
    },
    {
      "name": "eventbridge.tf",
      "content": "resource \"aws_cloudwatch_event_rule\" \"s3_text_object_created\" {\n  name        = \"${local.prefix}${var.project_name}-s3-text-object-created\"\n  description = \"Route S3 ObjectCreated events for ${var.text_prefix} to SQS (text pipeline)\"\n\n  event_pattern = jsonencode({\n    source        = [\"aws.s3\"],\n    \"detail-type\" = [\"Object Created\"],\n    detail = {\n      bucket = {\n        name = [aws_s3_bucket.data.bucket]\n      },\n      object = {\n        key = [{ prefix = var.text_prefix }]\n      }\n    }\n  })\n}\n\nresource \"aws_cloudwatch_event_rule\" \"s3_comprehend_object_created\" {\n  name        = \"${local.prefix}${var.project_name}-s3-comprehend-object-created\"\n  description = \"Route S3 ObjectCreated events for ${var.comprehend_prefix} to SQS (datalake pipeline)\"\n\n  event_pattern = jsonencode({\n    source        = [\"aws.s3\"],\n    \"detail-type\" = [\"Object Created\"],\n    detail = {\n      bucket = {\n        name = [aws_s3_bucket.data.bucket]\n      },\n      object = {\n        key = [{ prefix = var.comprehend_prefix }]\n      }\n    }\n  })\n}\n\nresource \"aws_cloudwatch_event_target\" \"to_sqs_text\" {\n  rule      = aws_cloudwatch_event_rule.s3_text_object_created.name\n  target_id = \"sqs-text\"\n  arn       = aws_sqs_queue.text.arn\n}\n\nresource \"aws_cloudwatch_event_target\" \"to_sqs_comprehend\" {\n  rule      = aws_cloudwatch_event_rule.s3_comprehend_object_created.name\n  target_id = \"sqs-comprehend\"\n  arn       = aws_sqs_queue.comprehend.arn\n}\n\n# Allow EventBridge to send messages to the queues\nresource \"aws_sqs_queue_policy\" \"text\" {\n  queue_url = aws_sqs_queue.text.id\n  policy = jsonencode({\n    Version = \"2012-10-17\",\n    Statement = [\n      {\n        Sid       = \"AllowEventBridgeSendMessage\",\n        Effect    = \"Allow\",\n        Principal = { Service = \"events.amazonaws.com\" },\n        Action    = \"sqs:SendMessage\",\n        Resource  = aws_sqs_queue.text.arn,\n        Condition = {\n          ArnEquals = {\n            \"aws:SourceArn\" = aws_cloudwatch_event_rule.s3_text_object_created.arn\n          }\n        }\n      }\n    ]\n  })\n}\n\nresource \"aws_sqs_queue_policy\" \"comprehend\" {\n  queue_url = aws_sqs_queue.comprehend.id\n  policy = jsonencode({\n    Version = \"2012-10-17\",\n    Statement = [\n      {\n        Sid       = \"AllowEventBridgeSendMessage\",\n        Effect    = \"Allow\",\n        Principal = { Service = \"events.amazonaws.com\" },\n        Action    = \"sqs:SendMessage\",\n        Resource  = aws_sqs_queue.comprehend.arn,\n        Condition = {\n          ArnEquals = {\n            \"aws:SourceArn\" = aws_cloudwatch_event_rule.s3_comprehend_object_created.arn\n          }\n        }\n      }\n    ]\n  })\n}\n"
    },
    {
      "name": "iam.tf",
      "content": "data \"aws_iam_policy_document\" \"sfn_assume\" {\n  statement {\n    effect = \"Allow\"\n    principals {\n      type        = \"Service\"\n      identifiers = [\"states.amazonaws.com\"]\n    }\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"sfn\" {\n  name               = \"${local.prefix}${var.project_name}-sfn-role\"\n  assume_role_policy = data.aws_iam_policy_document.sfn_assume.json\n}\n\nresource \"aws_iam_policy\" \"sfn\" {\n  name = \"${local.prefix}${var.project_name}-sfn-policy\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\",\n    Statement = [\n      # S3 read/write\n      {\n        Effect = \"Allow\",\n        Action = [\n          \"s3:GetObject\",\n          \"s3:PutObject\",\n          \"s3:ListBucket\"\n        ],\n        Resource = [\n          aws_s3_bucket.data.arn,\n          \"${aws_s3_bucket.data.arn}/*\"\n        ]\n      },\n      # KMS for S3 encryption\n      {\n        Effect = \"Allow\",\n        Action = [\n          \"kms:Decrypt\",\n          \"kms:Encrypt\",\n          \"kms:GenerateDataKey\",\n          \"kms:DescribeKey\"\n        ],\n        Resource = [aws_kms_key.s3.arn]\n      },\n      # Comprehend APIs used by the state machine\n      {\n        Effect = \"Allow\",\n        Action = [\n          \"comprehend:DetectDominantLanguage\",\n          \"comprehend:DetectEntities\",\n          \"comprehend:DetectKeyPhrases\",\n          \"comprehend:DetectPiiEntities\",\n          \"comprehend:DetectSentiment\",\n          \"comprehend:DetectSyntax\",\n          \"comprehend:DetectTargetedSentiment\",\n          \"comprehend:DetectToxicContent\"\n        ],\n        Resource = \"*\"\n      },\n      # CloudWatch Logs for Step Functions\n      {\n        Effect = \"Allow\",\n        Action = [\n          \"logs:CreateLogDelivery\",\n          \"logs:GetLogDelivery\",\n          \"logs:UpdateLogDelivery\",\n          \"logs:DeleteLogDelivery\",\n          \"logs:ListLogDeliveries\",\n          \"logs:PutResourcePolicy\",\n          \"logs:DescribeResourcePolicies\",\n          \"logs:DescribeLogGroups\"\n        ],\n        Resource = \"*\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"sfn\" {\n  role       = aws_iam_role.sfn.name\n  policy_arn = aws_iam_policy.sfn.arn\n}\n\n# Glue role (for crawler)\ndata \"aws_iam_policy_document\" \"glue_assume\" {\n  statement {\n    effect = \"Allow\"\n    principals {\n      type        = \"Service\"\n      identifiers = [\"glue.amazonaws.com\"]\n    }\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"glue\" {\n  name               = \"${local.prefix}${var.project_name}-glue-role\"\n  assume_role_policy = data.aws_iam_policy_document.glue_assume.json\n}\n\nresource \"aws_iam_policy\" \"glue\" {\n  name = \"${local.prefix}${var.project_name}-glue-policy\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\",\n    Statement = [\n      {\n        Effect = \"Allow\",\n        Action = [\n          \"s3:GetObject\",\n          \"s3:PutObject\",\n          \"s3:ListBucket\"\n        ],\n        Resource = [\n          aws_s3_bucket.data.arn,\n          \"${aws_s3_bucket.data.arn}/*\"\n        ]\n      },\n      {\n        Effect = \"Allow\",\n        Action = [\n          \"kms:Decrypt\",\n          \"kms:Encrypt\",\n          \"kms:GenerateDataKey\",\n          \"kms:DescribeKey\"\n        ],\n        Resource = [aws_kms_key.s3.arn]\n      },\n      {\n        Effect = \"Allow\",\n        Action = [\n          \"glue:*\",\n          \"cloudwatch:PutMetricData\",\n          \"logs:CreateLogGroup\",\n          \"logs:CreateLogStream\",\n          \"logs:PutLogEvents\"\n        ],\n        Resource = \"*\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"glue\" {\n  role       = aws_iam_role.glue.name\n  policy_arn = aws_iam_policy.glue.arn\n}\n"
    },
    {
      "name": "logs.tf",
      "content": "resource \"aws_cloudwatch_log_group\" \"sfn\" {\n  name              = \"/aws/vendedlogs/states/${local.prefix}${var.project_name}\"\n  retention_in_days = 30\n}\n"
    },
    {
      "name": "stepfunctions.tf",
      "content": "locals {\n  # Replace placeholder strings in the ASL JSON definitions with real S3 key prefixes.\n  # The ASL uses patterns like: States.Format('${aws_s3_object_key}{}.json', ...)\n\n  sfn_text_definition = replace(\n    file(\"${path.module}/../state_machine/S3ObjectCreatedText.json\"),\n    \"$${aws_s3_object_key}\",\n    local.s3_object_key_comprehend_json\n  )\n\n  sfn_comprehend_definition = replace(\n    replace(\n      replace(\n        replace(\n          replace(\n            replace(\n              replace(\n                replace(\n                  replace(\n                    replace(\n                      replace(\n                        replace(\n                          replace(\n                            file(\"${path.module}/../state_machine/S3ObjectCreatedComprehend.json\"),\n                            \"$${aws_s3_object_key_entity}\",\n                            local.s3_object_key_entity\n                          ),\n                          \"$${aws_s3_object_key_key_phrase}\",\n                          local.s3_object_key_key_phrase\n                        ),\n                        \"$${aws_s3_object_key_pii_entity}\",\n                        local.s3_object_key_pii_entity\n                      ),\n                      \"$${aws_s3_object_key_sentiment}\",\n                      local.s3_object_key_sentiment\n                    ),\n                    \"$${aws_s3_object_key_sentiment_score}\",\n                    local.s3_object_key_sentiment_score\n                  ),\n                  \"$${aws_s3_object_key_syntax_token}\",\n                  local.s3_object_key_syntax_token\n                ),\n                \"$${aws_s3_object_key_syntax_token_part_of_speech}\",\n                local.s3_object_key_syntax_token_part_of_speech\n              ),\n              \"$${aws_s3_object_key_targeted_sentiment}\",\n              local.s3_object_key_targeted_sentiment\n            ),\n            \"$${aws_s3_object_key_targeted_sentiment_descriptive_mention}\",\n            local.s3_object_key_targeted_sentiment_descriptive_mention\n          ),\n          \"$${aws_s3_object_key_targeted_sentiment_mention}\",\n          local.s3_object_key_targeted_sentiment_mention\n        ),\n        \"$${aws_s3_object_key_targeted_sentiment_mention_sentiment}\",\n        local.s3_object_key_targeted_sentiment_mention_sentiment\n      ),\n      \"$${aws_s3_object_key_targeted_sentiment_mention_sentiment_score}\",\n      local.s3_object_key_targeted_sentiment_mention_sentiment_score\n    ),\n    \"$${aws_s3_object_key_toxic_content}\",\n    local.s3_object_key_toxic_content\n  )\n\n  sfn_comprehend_definition_final = replace(\n    local.sfn_comprehend_definition,\n    \"$${aws_s3_object_key_toxic_content_label}\",\n    local.s3_object_key_toxic_content_label\n  )\n}\n\nresource \"aws_sfn_state_machine\" \"text\" {\n  name     = \"${local.prefix}${var.project_name}-S3ObjectCreatedText\"\n  role_arn = aws_iam_role.sfn.arn\n\n  definition = local.sfn_text_definition\n\n  logging_configuration {\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n    include_execution_data = var.sfn_include_execution_data\n    level                  = var.sfn_log_level\n  }\n}\n\nresource \"aws_sfn_state_machine\" \"comprehend\" {\n  name     = \"${local.prefix}${var.project_name}-S3ObjectCreatedComprehend\"\n  role_arn = aws_iam_role.sfn.arn\n\n  definition = local.sfn_comprehend_definition_final\n\n  logging_configuration {\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n    include_execution_data = var.sfn_include_execution_data\n    level                  = var.sfn_log_level\n  }\n}\n"
    },
    {
      "name": "glue.tf",
      "content": "resource \"aws_glue_catalog_database\" \"datalake\" {\n  name = var.glue_database_name\n}\n\nresource \"aws_glue_crawler\" \"datalake\" {\n  count = var.create_glue_crawler ? 1 : 0\n\n  name          = \"${local.prefix}${var.project_name}-datalake\"\n  role          = aws_iam_role.glue.arn\n  database_name = aws_glue_catalog_database.datalake.name\n\n  s3_target {\n    path = \"s3://${aws_s3_bucket.data.bucket}/${var.datalake_prefix}\"\n  }\n\n  schedule = var.glue_crawler_schedule\n\n  configuration = jsonencode({\n    Version = 1.0,\n    CrawlerOutput = {\n      Partitions = { AddOrUpdateBehavior = \"InheritFromTable\" }\n    }\n  })\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"bucket_name\" {\n  description = \"S3 bucket used for text/comprehend/datalake prefixes.\"\n  value       = aws_s3_bucket.data.bucket\n}\n\noutput \"sqs_text_queue_url\" {\n  value = aws_sqs_queue.text.id\n}\n\noutput \"sqs_comprehend_queue_url\" {\n  value = aws_sqs_queue.comprehend.id\n}\n\noutput \"sfn_text_state_machine_arn\" {\n  value = aws_sfn_state_machine.text.arn\n}\n\noutput \"sfn_comprehend_state_machine_arn\" {\n  value = aws_sfn_state_machine.comprehend.arn\n}\n\noutput \"glue_database_name\" {\n  value = aws_glue_catalog_database.datalake.name\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region    = \"us-east-1\"\nproject_name  = \"awscomprehend\"\nname_prefix   = \"dev\"\n# s3_bucket_name = \"<globally-unique-bucket-name>\"  # optionally set\n\n# tags = {\n#   Environment = \"dev\"\n# }\n"
    }
  ]
}