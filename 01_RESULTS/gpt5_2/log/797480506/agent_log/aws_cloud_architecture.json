{
  "aws_architecture_description": "## Proposed high-level AWS architecture (serverless, event-driven)\n\n### 1) Ingestion / event entry\n- **Producer / upstream system** publishes a message to **Amazon SQS (Image Events Queue)**. The message body contains one or more **S3 event records** (as your parent state machine expects).\n- SQS acts as the durable buffer to absorb bursts, decouple producers from processing, and provide retry semantics.\n\n### 2) Orchestration\n- **AWS Step Functions (Standard Workflows)** hosts:\n  - **Parent state machine** (`Rekognition.json`) that:\n    - validates the incoming message shape,\n    - checks the referenced S3 bucket/object (e.g., `HeadBucket`, `HeadObject`, `GetObjectAttributes`),\n    - fans out to one or more child workflows via **nested `StartExecution`**.\n  - **Child state machines** (`RekognitionDetect*.json`) that each call a specific Rekognition API using **Step Functions AWS SDK integrations**.\n\n**Triggering Step Functions from SQS (recommended pattern):**\n- Use an **AWS Lambda “poller/dispatcher”** subscribed to SQS (event source mapping). The Lambda reads SQS messages and starts the **parent** Step Functions execution.\n  - This is the simplest, most common integration because Step Functions does not natively consume SQS messages without an intermediary.\n  - The Lambda should be minimal: validate message, start execution, and rely on SQS/Lambda partial batch response + DLQ for failure handling.\n\n### 3) Image storage and results\n- **Amazon S3 Input Bucket**\n  - Stores images referenced by the S3 event records.\n  - Enforce encryption, block public access, and (optionally) versioning.\n- **Amazon S3 Output Results Bucket**\n  - Stores JSON outputs written by the child workflows via `s3:PutObject`.\n  - Use a predictable key structure (e.g., by date/prefix + source object key + execution id) to avoid collisions.\n\n### 4) Analysis\n- **Amazon Rekognition** is invoked directly from Step Functions via AWS SDK integrations:\n  - `DetectLabels`, `DetectFaces`, `DetectText`, `DetectModerationLabels`, `DetectProtectiveEquipment`.\n\n### 5) Security / IAM\n- **Least-privilege IAM**:\n  - **Step Functions execution role**: allow only required Rekognition actions, S3 read metadata on input bucket, S3 write on output bucket, and `states:StartExecution` for child workflows.\n  - **Lambda execution role**: allow `states:StartExecution` on the parent workflow, and permissions to read/delete from the SQS queue (managed by the event source mapping).\n- **KMS**:\n  - Use **SSE-KMS** for S3 buckets and (optionally) SQS.\n  - Key policies should allow the relevant roles to use the keys.\n\n### 6) Reliability / failure handling\n- **SQS DLQ** for the Image Events Queue to capture poison messages.\n- **Step Functions retries/catches** in the ASL definitions for transient Rekognition/S3 errors.\n- **Idempotency**:\n  - Use a deterministic execution name (e.g., hash of bucket+key+version) or store a “processed marker” in the output bucket to avoid duplicate processing when SQS redelivers.\n\n### 7) Observability / audit\n- **CloudWatch Logs**:\n  - Step Functions execution logging (at least ERROR, ideally ALL for early stages).\n  - Lambda logs.\n- **CloudWatch Alarms**:\n  - SQS age of oldest message, DLQ depth, Lambda errors/throttles, Step Functions execution failures.\n- **CloudTrail** enabled for audit of API calls.\n\n### 8) Networking\n- This workload can be deployed **without a VPC** (Lambda/Step Functions/Rekognition/S3/SQS are public AWS services). That’s leanest.\n- If your organization requires VPC attachment for Lambda, add a VPC with private subnets + NAT (note: increases cost/complexity). For this pipeline, defaulting to **no VPC** is typically appropriate.\n\n---\n\n## AWS resources to provision\n\n### Core application resources\n- **AWS Step Functions**\n  - State machine: Parent (`Rekognition.json`)\n  - State machines: Child workflows (`RekognitionDetectLabels.json`, `RekognitionDetectFaces.json`, `RekognitionDetectText.json`, `RekognitionDetectModerationLabels.json`, `RekognitionDetectProtectiveEquipment.json`)\n- **Amazon SQS**\n  - SQS queue: Image Events Queue\n  - SQS dead-letter queue (DLQ)\n  - Redrive policy (main queue -> DLQ)\n- **AWS Lambda**\n  - Lambda function: SQS-to-StepFunctions dispatcher (poller)\n  - Event source mapping: SQS queue -> Lambda\n  - (Optional) Lambda reserved concurrency to control downstream load\n- **Amazon S3**\n  - S3 bucket: Input Images Bucket\n  - S3 bucket: Output Results Bucket\n\n### IAM / security\n- **AWS IAM**\n  - IAM role: Step Functions execution role\n  - IAM policies: least-privilege policies for S3/Rekognition/Step Functions nested executions\n  - IAM role: Lambda execution role\n  - IAM policy: allow `states:StartExecution` on parent state machine + SQS consume permissions\n- **AWS KMS**\n  - KMS key: S3 encryption (input bucket)\n  - KMS key: S3 encryption (output bucket)\n  - (Optional) KMS key: SQS encryption\n\n### Logging / monitoring / audit\n- **Amazon CloudWatch Logs**\n  - Log group(s): Step Functions execution logs\n  - Log group: Lambda logs\n- **Amazon CloudWatch**\n  - Alarms: SQS (ApproxAgeOfOldestMessage, DLQ depth), Lambda (Errors/Throttles), Step Functions (ExecutionsFailed)\n  - (Optional) Dashboard\n- **AWS CloudTrail**\n  - Organization/account trail (or ensure an existing trail covers these services)\n\n### Optional (only if required by policy)\n- **Amazon VPC**\n  - VPC, private subnets (2+ AZs), route tables\n  - NAT Gateway(s) + Elastic IP(s) (if Lambda in VPC needs outbound internet)\n  - Security group(s) for Lambda\n  - VPC endpoints (Gateway endpoint for S3; Interface endpoints for SQS/Step Functions if you want private connectivity)\n\nIf you tell me whether you want “no VPC” (lean) vs “VPC-required” (enterprise controls), I can tailor the resource list and permissions more precisely.",
  "aws_resources": [
    "AWS Step Functions state machine (Parent: Rekognition.json)",
    "AWS Step Functions state machines (Children: RekognitionDetectLabels.json, RekognitionDetectFaces.json, RekognitionDetectText.json, RekognitionDetectModerationLabels.json, RekognitionDetectProtectiveEquipment.json)",
    "Amazon SQS queue (Image Events Queue)",
    "Amazon SQS dead-letter queue (DLQ)",
    "SQS redrive policy (main queue -> DLQ)",
    "AWS Lambda function (SQS-to-StepFunctions dispatcher/poller)",
    "Lambda event source mapping (SQS -> Lambda)",
    "Amazon S3 bucket (Input Images Bucket)",
    "Amazon S3 bucket (Output Results Bucket)",
    "AWS IAM role (Step Functions execution role)",
    "AWS IAM policy (Step Functions permissions: Rekognition, S3 read/write, states:StartExecution)",
    "AWS IAM role (Lambda execution role)",
    "AWS IAM policy (Lambda permissions: states:StartExecution, SQS consume)",
    "AWS KMS key (S3 input bucket encryption)",
    "AWS KMS key (S3 output bucket encryption)",
    "(Optional) AWS KMS key (SQS encryption)",
    "Amazon CloudWatch Logs log group (Step Functions)",
    "Amazon CloudWatch Logs log group (Lambda)",
    "Amazon CloudWatch alarms (SQS, Lambda, Step Functions)",
    "AWS CloudTrail trail (or ensure existing trail covers services)",
    "(Optional) Amazon VPC",
    "(Optional) VPC subnets (private, 2+ AZs)",
    "(Optional) VPC route tables",
    "(Optional) NAT Gateway(s) and Elastic IP(s)",
    "(Optional) Security group(s) for Lambda",
    "(Optional) VPC endpoints (S3 gateway endpoint; SQS/Step Functions interface endpoints)"
  ]
}