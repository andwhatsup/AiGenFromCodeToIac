{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n    archive = {\n      source  = \"hashicorp/archive\"\n      version = \"~> 2.4\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.aws_region\n\n  default_tags {\n    tags = merge(\n      {\n        Project     = var.project_name\n        Environment = var.environment\n        ManagedBy   = \"terraform\"\n      },\n      var.tags\n    )\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"aws_region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for resource naming.\"\n  type        = string\n  default     = \"rekognition-orchestrator\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, staging, prod).\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply to all resources.\"\n  type        = map(string)\n  default     = {}\n}\n\nvariable \"input_bucket_name\" {\n  description = \"Optional explicit name for the input images bucket. If null, a name will be generated.\"\n  type        = string\n  default     = null\n}\n\nvariable \"output_bucket_name\" {\n  description = \"Optional explicit name for the output results bucket. If null, a name will be generated.\"\n  type        = string\n  default     = null\n}\n\nvariable \"sqs_queue_name\" {\n  description = \"Optional explicit name for the SQS queue. If null, a name will be generated.\"\n  type        = string\n  default     = null\n}\n\nvariable \"lambda_reserved_concurrency\" {\n  description = \"Optional reserved concurrency for the dispatcher Lambda. Set to null for unreserved.\"\n  type        = number\n  default     = 5\n}\n\nvariable \"lambda_batch_size\" {\n  description = \"SQS event source mapping batch size.\"\n  type        = number\n  default     = 10\n}\n\nvariable \"lambda_maximum_batching_window_in_seconds\" {\n  description = \"Maximum batching window for SQS event source mapping.\"\n  type        = number\n  default     = 5\n}\n\nvariable \"s3_results_prefix\" {\n  description = \"Prefix used by the parent state machine when writing results objects.\"\n  type        = string\n  default     = \"rekognition-results/\"\n}\n\nvariable \"enable_sqs_sse\" {\n  description = \"Enable SQS SSE (SSE-SQS).\"\n  type        = bool\n  default     = true\n}\n\nvariable \"stepfunctions_log_level\" {\n  description = \"Step Functions log level. One of: ALL, ERROR, FATAL, OFF.\"\n  type        = string\n  default     = \"ALL\"\n\n  validation {\n    condition     = contains([\"ALL\", \"ERROR\", \"FATAL\", \"OFF\"], var.stepfunctions_log_level)\n    error_message = \"stepfunctions_log_level must be one of ALL, ERROR, FATAL, OFF.\"\n  }\n}\n"
    },
    {
      "name": "locals.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_partition\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\nlocals {\n  name_prefix = \"${var.project_name}-${var.environment}\"\n\n  input_bucket_name  = coalesce(var.input_bucket_name, \"${local.name_prefix}-input-${data.aws_caller_identity.current.account_id}\")\n  output_bucket_name = coalesce(var.output_bucket_name, \"${local.name_prefix}-output-${data.aws_caller_identity.current.account_id}\")\n\n  sqs_queue_name = coalesce(var.sqs_queue_name, \"${local.name_prefix}-image-events\")\n  sqs_dlq_name   = \"${local.sqs_queue_name}-dlq\"\n\n  # Result object key prefixes used by the parent state machine.\n  s3_object_rekognition_detect_faces                = \"${var.s3_results_prefix}detect-faces/\"\n  s3_object_rekognition_detect_labels               = \"${var.s3_results_prefix}detect-labels/\"\n  s3_object_rekognition_detect_moderation_labels    = \"${var.s3_results_prefix}detect-moderation-labels/\"\n  s3_object_rekognition_detect_protective_equipment = \"${var.s3_results_prefix}detect-protective-equipment/\"\n  s3_object_rekognition_detect_text                 = \"${var.s3_results_prefix}detect-text/\"\n}\n"
    },
    {
      "name": "s3.tf",
      "content": "resource \"aws_s3_bucket\" \"input\" {\n  bucket = local.input_bucket_name\n}\n\nresource \"aws_s3_bucket\" \"output\" {\n  bucket = local.output_bucket_name\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"input\" {\n  bucket                  = aws_s3_bucket.input.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"output\" {\n  bucket                  = aws_s3_bucket.output.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"input\" {\n  bucket = aws_s3_bucket.input.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_versioning\" \"output\" {\n  bucket = aws_s3_bucket.output.id\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"input\" {\n  bucket = aws_s3_bucket.input.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"output\" {\n  bucket = aws_s3_bucket.output.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n"
    },
    {
      "name": "sqs.tf",
      "content": "resource \"aws_sqs_queue\" \"dlq\" {\n  name                      = local.sqs_dlq_name\n  message_retention_seconds = 1209600\n\n  sqs_managed_sse_enabled = var.enable_sqs_sse\n}\n\nresource \"aws_sqs_queue\" \"main\" {\n  name                      = local.sqs_queue_name\n  visibility_timeout_seconds = 60\n  message_retention_seconds  = 345600\n  receive_wait_time_seconds  = 10\n  sqs_managed_sse_enabled    = var.enable_sqs_sse\n\n  redrive_policy = jsonencode({\n    deadLetterTargetArn = aws_sqs_queue.dlq.arn\n    maxReceiveCount     = 5\n  })\n}\n"
    },
    {
      "name": "logging.tf",
      "content": "resource \"aws_cloudwatch_log_group\" \"sfn\" {\n  name              = \"/aws/vendedlogs/states/${local.name_prefix}\"\n  retention_in_days = 30\n}\n\nresource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${local.name_prefix}-dispatcher\"\n  retention_in_days = 14\n}\n"
    },
    {
      "name": "iam.tf",
      "content": "data \"aws_iam_policy_document\" \"lambda_assume\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRole\"]\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"lambda\" {\n  name               = \"${local.name_prefix}-dispatcher-lambda\"\n  assume_role_policy = data.aws_iam_policy_document.lambda_assume.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_basic\" {\n  role       = aws_iam_role.lambda.name\n  policy_arn = \"arn:${data.aws_partition.current.partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\n}\n\ndata \"aws_iam_policy_document\" \"lambda_inline\" {\n  statement {\n    sid     = \"StartParentStateMachine\"\n    effect  = \"Allow\"\n    actions = [\"states:StartExecution\"]\n    resources = [\n      aws_sfn_state_machine.parent.arn\n    ]\n  }\n}\n\nresource \"aws_iam_role_policy\" \"lambda_inline\" {\n  name   = \"${local.name_prefix}-dispatcher-inline\"\n  role   = aws_iam_role.lambda.id\n  policy = data.aws_iam_policy_document.lambda_inline.json\n}\n\n# Step Functions execution role\n\ndata \"aws_iam_policy_document\" \"sfn_assume\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRole\"]\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"states.amazonaws.com\"]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"sfn\" {\n  name               = \"${local.name_prefix}-sfn-exec\"\n  assume_role_policy = data.aws_iam_policy_document.sfn_assume.json\n}\n\ndata \"aws_iam_policy_document\" \"sfn_inline\" {\n  statement {\n    sid    = \"Rekognition\"\n    effect = \"Allow\"\n    actions = [\n      \"rekognition:DetectLabels\",\n      \"rekognition:DetectFaces\",\n      \"rekognition:DetectText\",\n      \"rekognition:DetectModerationLabels\",\n      \"rekognition:DetectProtectiveEquipment\"\n    ]\n    resources = [\"*\"]\n  }\n\n  statement {\n    sid    = \"S3ReadInput\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:HeadBucket\",\n      \"s3:HeadObject\",\n      \"s3:GetObjectAttributes\"\n    ]\n    resources = [\n      aws_s3_bucket.input.arn,\n      \"${aws_s3_bucket.input.arn}/*\"\n    ]\n  }\n\n  statement {\n    sid    = \"S3WriteOutput\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:PutObject\",\n      \"s3:PutObjectAcl\"\n    ]\n    resources = [\n      \"${aws_s3_bucket.output.arn}/*\"\n    ]\n  }\n\n  statement {\n    sid    = \"StartChildExecutions\"\n    effect = \"Allow\"\n    actions = [\n      \"states:StartExecution\"\n    ]\n    resources = [\n      aws_sfn_state_machine.detect_faces.arn,\n      aws_sfn_state_machine.detect_labels.arn,\n      aws_sfn_state_machine.detect_moderation_labels.arn,\n      aws_sfn_state_machine.detect_protective_equipment.arn,\n      aws_sfn_state_machine.detect_text.arn\n    ]\n  }\n\n  statement {\n    sid    = \"AllowCWLogsDelivery\"\n    effect = \"Allow\"\n    actions = [\n      \"logs:CreateLogDelivery\",\n      \"logs:GetLogDelivery\",\n      \"logs:UpdateLogDelivery\",\n      \"logs:DeleteLogDelivery\",\n      \"logs:ListLogDeliveries\",\n      \"logs:PutResourcePolicy\",\n      \"logs:DescribeResourcePolicies\",\n      \"logs:DescribeLogGroups\"\n    ]\n    resources = [\"*\"]\n  }\n}\n\nresource \"aws_iam_role_policy\" \"sfn_inline\" {\n  name   = \"${local.name_prefix}-sfn-inline\"\n  role   = aws_iam_role.sfn.id\n  policy = data.aws_iam_policy_document.sfn_inline.json\n}\n"
    },
    {
      "name": "lambda_dispatcher.py",
      "content": "import json\nimport os\nimport boto3\n\nsfn = boto3.client(\"stepfunctions\")\n\nPARENT_STATE_MACHINE_ARN = os.environ[\"PARENT_STATE_MACHINE_ARN\"]\n\n\ndef handler(event, context):\n    # SQS event\n    records = event.get(\"Records\", [])\n    failures = []\n\n    for r in records:\n        message_id = r.get(\"messageId\")\n        try:\n            # Pass through the SQS record as-is; the parent ASL expects eventSource/body.\n            sfn.start_execution(\n                stateMachineArn=PARENT_STATE_MACHINE_ARN,\n                input=json.dumps(r),\n            )\n        except Exception:\n            # Partial batch response: mark this message as failed so it will be retried.\n            if message_id:\n                failures.append({\"itemIdentifier\": message_id})\n            else:\n                failures.append({\"itemIdentifier\": \"unknown\"})\n\n    return {\"batchItemFailures\": failures}\n"
    },
    {
      "name": "lambda.tf",
      "content": "data \"archive_file\" \"dispatcher_zip\" {\n  type        = \"zip\"\n  source_file = \"${path.module}/lambda_dispatcher.py\"\n  output_path = \"${path.module}/.build/dispatcher.zip\"\n}\n\nresource \"aws_lambda_function\" \"dispatcher\" {\n  function_name = \"${local.name_prefix}-dispatcher\"\n  role          = aws_iam_role.lambda.arn\n  handler       = \"lambda_dispatcher.handler\"\n  runtime       = \"python3.12\"\n  timeout       = 30\n\n  filename         = data.archive_file.dispatcher_zip.output_path\n  source_code_hash = data.archive_file.dispatcher_zip.output_base64sha256\n\n  environment {\n    variables = {\n      PARENT_STATE_MACHINE_ARN = aws_sfn_state_machine.parent.arn\n    }\n  }\n\n  reserved_concurrent_executions = var.lambda_reserved_concurrency\n\n  depends_on = [\n    aws_iam_role_policy_attachment.lambda_basic,\n    aws_cloudwatch_log_group.lambda\n  ]\n}\n\nresource \"aws_lambda_event_source_mapping\" \"sqs\" {\n  event_source_arn = aws_sqs_queue.main.arn\n  function_name    = aws_lambda_function.dispatcher.arn\n\n  batch_size                         = var.lambda_batch_size\n  maximum_batching_window_in_seconds = var.lambda_maximum_batching_window_in_seconds\n\n  function_response_types = [\"ReportBatchItemFailures\"]\n}\n"
    },
    {
      "name": "stepfunctions.tf",
      "content": "locals {\n  # Load ASL definitions from the repository (outside ai_tf).\n  asl_parent = file(\"${path.module}/../state_machine/Rekognition.json\")\n\n  asl_detect_faces                = file(\"${path.module}/../state_machine/RekognitionDetectFaces.json\")\n  asl_detect_labels               = file(\"${path.module}/../state_machine/RekognitionDetectLabels.json\")\n  asl_detect_moderation_labels    = file(\"${path.module}/../state_machine/RekognitionDetectModerationLabels.json\")\n  asl_detect_protective_equipment = file(\"${path.module}/../state_machine/RekognitionDetectProtectiveEquipment.json\")\n  asl_detect_text                 = file(\"${path.module}/../state_machine/RekognitionDetectText.json\")\n\n  # Render parent ASL by replacing placeholders from the repo.\n  parent_definition = replace(\n    replace(\n      replace(\n        replace(\n          replace(\n            replace(\n              replace(\n                replace(\n                  replace(\n                    replace(\n                      replace(\n                        local.asl_parent,\n                        \"\\\"Bucket.$\\\": \\\"$.S3.Bucket.Name\\\"\",\n                        \"\\\"Bucket\\\": \\\"${aws_s3_bucket.output.bucket}\\\"\"\n                      ),\n                      \"$${rekognition_detect_faces}\",\n                      aws_sfn_state_machine.detect_faces.arn\n                    ),\n                    \"$${rekognition_detect_labels}\",\n                    aws_sfn_state_machine.detect_labels.arn\n                  ),\n                  \"$${rekognition_detect_moderation_labels}\",\n                  aws_sfn_state_machine.detect_moderation_labels.arn\n                ),\n                \"$${rekognition_detect_protective_equipment}\",\n                aws_sfn_state_machine.detect_protective_equipment.arn\n              ),\n              \"$${rekognition_detect_text}\",\n              aws_sfn_state_machine.detect_text.arn\n            ),\n            \"$${s3_object_rekognition_detect_faces}\",\n            local.s3_object_rekognition_detect_faces\n          ),\n          \"$${s3_object_rekognition_detect_labels}\",\n          local.s3_object_rekognition_detect_labels\n        ),\n        \"$${s3_object_rekognition_detect_moderation_labels}\",\n        local.s3_object_rekognition_detect_moderation_labels\n      ),\n      \"$${s3_object_rekognition_detect_protective_equipment}\",\n      local.s3_object_rekognition_detect_protective_equipment\n    ),\n    \"$${s3_object_rekognition_detect_text}\",\n    local.s3_object_rekognition_detect_text\n  )\n}\n\nresource \"aws_sfn_state_machine\" \"detect_faces\" {\n  name     = \"${local.name_prefix}-detect-faces\"\n  role_arn = aws_iam_role.sfn.arn\n  type     = \"STANDARD\"\n\n  definition = local.asl_detect_faces\n\n  logging_configuration {\n    level                  = var.stepfunctions_log_level\n    include_execution_data = true\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n  }\n}\n\nresource \"aws_sfn_state_machine\" \"detect_labels\" {\n  name     = \"${local.name_prefix}-detect-labels\"\n  role_arn = aws_iam_role.sfn.arn\n  type     = \"STANDARD\"\n\n  definition = local.asl_detect_labels\n\n  logging_configuration {\n    level                  = var.stepfunctions_log_level\n    include_execution_data = true\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n  }\n}\n\nresource \"aws_sfn_state_machine\" \"detect_moderation_labels\" {\n  name     = \"${local.name_prefix}-detect-moderation-labels\"\n  role_arn = aws_iam_role.sfn.arn\n  type     = \"STANDARD\"\n\n  definition = local.asl_detect_moderation_labels\n\n  logging_configuration {\n    level                  = var.stepfunctions_log_level\n    include_execution_data = true\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n  }\n}\n\nresource \"aws_sfn_state_machine\" \"detect_protective_equipment\" {\n  name     = \"${local.name_prefix}-detect-protective-equipment\"\n  role_arn = aws_iam_role.sfn.arn\n  type     = \"STANDARD\"\n\n  definition = local.asl_detect_protective_equipment\n\n  logging_configuration {\n    level                  = var.stepfunctions_log_level\n    include_execution_data = true\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n  }\n}\n\nresource \"aws_sfn_state_machine\" \"detect_text\" {\n  name     = \"${local.name_prefix}-detect-text\"\n  role_arn = aws_iam_role.sfn.arn\n  type     = \"STANDARD\"\n\n  definition = local.asl_detect_text\n\n  logging_configuration {\n    level                  = var.stepfunctions_log_level\n    include_execution_data = true\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n  }\n}\n\nresource \"aws_sfn_state_machine\" \"parent\" {\n  name     = \"${local.name_prefix}-parent\"\n  role_arn = aws_iam_role.sfn.arn\n  type     = \"STANDARD\"\n\n  definition = local.parent_definition\n\n  logging_configuration {\n    level                  = var.stepfunctions_log_level\n    include_execution_data = true\n    log_destination        = \"${aws_cloudwatch_log_group.sfn.arn}:*\"\n  }\n\n  depends_on = [\n    aws_iam_role_policy.sfn_inline\n  ]\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"input_bucket_name\" {\n  value       = aws_s3_bucket.input.bucket\n  description = \"S3 bucket for input images.\"\n}\n\noutput \"output_bucket_name\" {\n  value       = aws_s3_bucket.output.bucket\n  description = \"S3 bucket for output results.\"\n}\n\noutput \"sqs_queue_url\" {\n  value       = aws_sqs_queue.main.url\n  description = \"SQS queue URL for image events.\"\n}\n\noutput \"parent_state_machine_arn\" {\n  value       = aws_sfn_state_machine.parent.arn\n  description = \"ARN of the parent Step Functions state machine.\"\n}\n\noutput \"dispatcher_lambda_name\" {\n  value       = aws_lambda_function.dispatcher.function_name\n  description = \"Name of the SQS->StepFunctions dispatcher Lambda.\"\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "aws_region   = \"us-east-1\"\nenvironment  = \"dev\"\nproject_name = \"rekognition-orchestrator\"\n\n# Optionally set explicit bucket names (must be globally unique)\n# input_bucket_name  = \"my-input-bucket\"\n# output_bucket_name = \"my-output-bucket\"\n"
    }
  ]
}