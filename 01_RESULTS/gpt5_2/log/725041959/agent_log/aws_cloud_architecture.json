{
  "aws_architecture_description": "## Proposed high-level AWS architecture (lean, production-oriented)\n\n### 1) Container build & registry\n- **Source** remains in GitHub.\n- Build the image in **AWS CodeBuild** (or keep GitHub Actions if you prefer) and push to **Amazon ECR**.\n  - ECR gives IAM-native auth, lifecycle policies, vulnerability scanning, and tight integration with EKS.\n\n### 2) Kubernetes runtime on AWS\n- Run the CronJob on **Amazon EKS**.\n  - Create a dedicated **namespace** (e.g., `nextcloud-backup`) and deploy a **Kubernetes CronJob** that pulls the image from ECR.\n  - Use **IRSA (IAM Roles for Service Accounts)** so the Pod can access AWS services (S3, Secrets Manager, CloudWatch) without node-wide credentials.\n\n### 3) Nextcloud app + filesystem access\nYou have two common deployment options; pick based on how you run Nextcloud today:\n\n**Option A (recommended if Nextcloud is also on AWS/EKS):**\n- Run Nextcloud on the same EKS cluster (or a peered cluster/VPC).\n- Store Nextcloud persistent data on **Amazon EFS** (mounted into Nextcloud Pods).\n- The backup CronJob mounts the *same EFS access point* (read-only where possible) to archive the Nextcloud filesystem.\n- For “maintenance mode”: instead of editing `config/config.php` on a shared filesystem (risky), prefer toggling maintenance via `occ maintenance:mode --on/--off` executed against the Nextcloud Pod (e.g., `kubectl exec` from a tightly-scoped service account) or via a small internal admin endpoint. If you must keep the current behavior, ensure the CronJob has write access only to the specific config path.\n\n**Option B (if Nextcloud runs on EC2/elsewhere):**\n- Keep Nextcloud where it is.\n- Expose the Nextcloud filesystem to the backup job via **EFS** (if Nextcloud can mount it) or via a secure network file share/VPN. The CronJob must be able to read the Nextcloud data directory and config.\n\n### 4) Database\n- Use **Amazon RDS for MySQL or MariaDB** for the Nextcloud database.\n  - Place RDS in **private subnets**.\n  - Allow inbound DB traffic only from the EKS worker node security group (or EKS Pod ENIs if using security groups for pods).\n- The CronJob uses `mysqldump` against the RDS endpoint.\n\n### 5) Backup destination (replace FTP with S3)\n- Replace the FTP target with **Amazon S3** as the backup destination.\n  - `rclone` supports S3-compatible remotes; configure it to write to an S3 bucket.\n  - Enable **S3 Versioning** and **S3 Object Lock** (if you need immutability / ransomware resistance).\n  - Add **Lifecycle policies** to transition older backups to **S3 Glacier** tiers.\n  - Encrypt with **SSE-KMS**.\n\n(If you must keep FTP for compatibility, run an FTP server on AWS—e.g., **AWS Transfer Family (FTP/FTPS/SFTP)** backed by S3—but S3-native is simpler and more secure.)\n\n### 6) Secrets, config, and scheduling\n- Store DB credentials and any rclone config in **AWS Secrets Manager**.\n- Mount secrets into the CronJob as environment variables (via External Secrets Operator or CSI driver) and keep them out of Kubernetes manifests.\n- Use Kubernetes CronJob schedule for execution; optionally add **CloudWatch alarms** on job failures.\n\n### 7) Observability and security\n- Send container logs to **CloudWatch Logs** (via Fluent Bit / CloudWatch Observability add-on).\n- Use **CloudWatch Container Insights** for cluster metrics.\n- Use **AWS KMS** for encryption keys (S3, Secrets Manager).\n- Use **VPC endpoints** (Gateway endpoint for S3; Interface endpoints for ECR/Logs/Secrets Manager) so backups don’t require public internet egress.\n\n---\n\n## Data flow (end-to-end)\n1. CronJob Pod starts in EKS and pulls image from ECR.\n2. Pod reads Nextcloud filesystem (EFS mount) and creates an archive.\n3. Pod runs `mysqldump` against RDS (private endpoint).\n4. Pod uploads artifacts to S3 (private via VPC endpoint).\n5. Logs/metrics go to CloudWatch; alarms notify on failures.\n\n---\n\n## Notes on least privilege\n- The backup Pod’s IAM role (IRSA) should only allow:\n  - `s3:PutObject`, `s3:AbortMultipartUpload`, `s3:ListBucket` on the backup bucket/prefix\n  - `secretsmanager:GetSecretValue` for the specific secrets\n  - `kms:Encrypt/Decrypt` for the specific KMS key\n- Network access should be restricted with security groups and (optionally) Kubernetes NetworkPolicies.\n",
  "aws_resources": [
    "Amazon VPC",
    "Public subnets (2+ AZs)",
    "Private subnets (2+ AZs)",
    "Internet Gateway (if any public ingress is needed)",
    "NAT Gateway (only if private subnets need controlled internet egress)",
    "VPC Route Tables",
    "VPC Security Groups (EKS nodes/pods, RDS, EFS)",
    "VPC Endpoints: S3 Gateway Endpoint",
    "VPC Endpoints: ECR (api + dkr) Interface Endpoints",
    "VPC Endpoint: CloudWatch Logs Interface Endpoint",
    "VPC Endpoint: Secrets Manager Interface Endpoint",
    "VPC Endpoint: STS Interface Endpoint (commonly needed for IRSA)",
    "Amazon EKS Cluster",
    "EKS Managed Node Group(s) or Fargate Profiles (choose one)",
    "EKS Add-ons: VPC CNI, CoreDNS, kube-proxy",
    "IAM OIDC Provider for EKS (for IRSA)",
    "IAM Roles: EKS cluster role, node role(s)",
    "IAM Role for Kubernetes ServiceAccount (IRSA) used by backup CronJob",
    "Amazon ECR Repository (for the backup image)",
    "ECR Lifecycle Policy",
    "Amazon RDS for MySQL/MariaDB (DB instance or Multi-AZ)",
    "RDS Subnet Group",
    "RDS Parameter Group (optional)",
    "AWS Secrets Manager Secrets (DB credentials, rclone config)",
    "AWS KMS Key (for S3 + Secrets Manager encryption)",
    "Amazon EFS File System (for Nextcloud persistent data, if Nextcloud is on AWS/EKS)",
    "EFS Mount Targets (per AZ)",
    "EFS Access Point(s) (recommended for least-privilege mounts)",
    "Amazon S3 Bucket (backup destination)",
    "S3 Bucket Versioning",
    "S3 Lifecycle Policy (transition/expire backups)",
    "S3 Bucket Policy (restrict to IRSA role, enforce TLS)",
    "S3 Server-Side Encryption (SSE-KMS)",
    "CloudWatch Log Group(s) (EKS workloads)",
    "CloudWatch Alarms (CronJob failures / error patterns)",
    "Amazon SNS Topic (optional, for alarm notifications)"
  ]
}