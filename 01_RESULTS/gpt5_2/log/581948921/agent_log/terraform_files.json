{
  "files": [
    {
      "name": "provider.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.region\n\n  default_tags {\n    tags = var.tags\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"region\" {\n  description = \"AWS region to deploy into.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project/name prefix used for tagging and resource naming.\"\n  type        = string\n  default     = \"mkdocs-demo\"\n}\n\nvariable \"artifact_bucket_name\" {\n  description = \"S3 bucket used to store MkDocs build archives (referenced by Makefile/workflows).\"\n  type        = string\n  default     = \"factually-settled-boxer-artifacts\"\n}\n\nvariable \"dev_site_bucket_name\" {\n  description = \"S3 bucket name for the development static website (S3 website hosting endpoint).\"\n  type        = string\n  default     = \"factually-settled-boxer-development\"\n}\n\nvariable \"prod_site_bucket_name\" {\n  description = \"S3 bucket name for the production static website (S3 website hosting endpoint).\"\n  type        = string\n  default     = \"factually-settled-boxer\"\n}\n\nvariable \"pr_prefix\" {\n  description = \"Prefix for per-PR temporary website buckets.\"\n  type        = string\n  default     = \"ntno-mkdocs-demo-ci-pr-\"\n}\n\nvariable \"enable_pr_buckets\" {\n  description = \"Whether to create a limited number of PR buckets (for demo). If false, only dev/prod buckets are created.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"pr_bucket_count\" {\n  description = \"How many PR buckets to create when enable_pr_buckets=true.\"\n  type        = number\n  default     = 0\n}\n\nvariable \"github_org\" {\n  description = \"GitHub organization/user that owns the repository. Used in OIDC trust policy.\"\n  type        = string\n  default     = \"ntno\"\n}\n\nvariable \"github_repo\" {\n  description = \"GitHub repository name. Used in OIDC trust policy.\"\n  type        = string\n  default     = \"mkdocs-demo\"\n}\n\nvariable \"github_oidc_provider_url\" {\n  description = \"GitHub Actions OIDC provider URL.\"\n  type        = string\n  default     = \"https://token.actions.githubusercontent.com\"\n}\n\nvariable \"github_oidc_thumbprints\" {\n  description = \"Thumbprints for the GitHub OIDC provider. GitHub currently uses a well-known root CA; keep configurable.\"\n  type        = list(string)\n  default     = [\"6938fd4d98bab03faadb97b34396831e3780aea1\"]\n}\n\nvariable \"tags\" {\n  description = \"Tags applied to all resources via provider default_tags.\"\n  type        = map(string)\n  default = {\n    ManagedBy = \"Terraform\"\n    Project   = \"mkdocs-demo\"\n  }\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  dev_bucket  = var.dev_site_bucket_name\n  prod_bucket = var.prod_site_bucket_name\n\n  pr_buckets = var.enable_pr_buckets ? [for i in range(var.pr_bucket_count) : \"${var.pr_prefix}${i + 1}\"] : []\n\n  site_buckets = toset(concat([local.dev_bucket, local.prod_bucket], local.pr_buckets))\n}\n\n# -----------------------------\n# S3 buckets: static website hosting (dev/prod + optional PR buckets)\n# -----------------------------\n\nresource \"aws_s3_bucket\" \"site\" {\n  for_each = local.site_buckets\n\n  bucket = each.value\n\n  # Demo repo uses S3 website endpoints (http://<bucket>.s3-website-<region>.amazonaws.com)\n  # so we intentionally allow public read via bucket policy.\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"site\" {\n  for_each = aws_s3_bucket.site\n\n  bucket = each.value.id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\n# For S3 website hosting with public read, we must disable Block Public Access at bucket level.\nresource \"aws_s3_bucket_public_access_block\" \"site\" {\n  for_each = aws_s3_bucket.site\n\n  bucket = each.value.id\n\n  block_public_acls       = false\n  block_public_policy     = false\n  ignore_public_acls      = false\n  restrict_public_buckets = false\n}\n\nresource \"aws_s3_bucket_website_configuration\" \"site\" {\n  for_each = aws_s3_bucket.site\n\n  bucket = each.value.id\n\n  index_document {\n    suffix = \"index.html\"\n  }\n\n  error_document {\n    key = \"404.html\"\n  }\n}\n\nresource \"aws_s3_bucket_versioning\" \"site\" {\n  for_each = aws_s3_bucket.site\n\n  bucket = each.value.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"site\" {\n  for_each = aws_s3_bucket.site\n\n  bucket = each.value.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\ndata \"aws_iam_policy_document\" \"site_bucket_policy\" {\n  for_each = aws_s3_bucket.site\n\n  statement {\n    sid     = \"PublicReadForGetBucketObjects\"\n    effect  = \"Allow\"\n    actions = [\"s3:GetObject\"]\n\n    principals {\n      type        = \"*\"\n      identifiers = [\"*\"]\n    }\n\n    resources = [\"${each.value.arn}/*\"]\n  }\n\n  # Enforce SSE-S3 on uploads (matches .github/ci/s3-website.yml)\n  statement {\n    sid     = \"DenyIncorrectEncryptionHeader\"\n    effect  = \"Deny\"\n    actions = [\"s3:PutObject\"]\n\n    principals {\n      type        = \"*\"\n      identifiers = [\"*\"]\n    }\n\n    resources = [\"${each.value.arn}/*\"]\n\n    condition {\n      test     = \"StringNotEquals\"\n      variable = \"s3:x-amz-server-side-encryption\"\n      values   = [\"AES256\"]\n    }\n  }\n\n  statement {\n    sid     = \"DenyUnEncryptedObjectUploads\"\n    effect  = \"Deny\"\n    actions = [\"s3:PutObject\"]\n\n    principals {\n      type        = \"*\"\n      identifiers = [\"*\"]\n    }\n\n    resources = [\"${each.value.arn}/*\"]\n\n    condition {\n      test     = \"Null\"\n      variable = \"s3:x-amz-server-side-encryption\"\n      values   = [\"true\"]\n    }\n  }\n}\n\nresource \"aws_s3_bucket_policy\" \"site\" {\n  for_each = aws_s3_bucket.site\n\n  bucket = each.value.id\n  policy = data.aws_iam_policy_document.site_bucket_policy[each.key].json\n\n  depends_on = [aws_s3_bucket_public_access_block.site]\n}\n\n# -----------------------------\n# S3 bucket: artifacts\n# -----------------------------\n\nresource \"aws_s3_bucket\" \"artifacts\" {\n  bucket = var.artifact_bucket_name\n}\n\nresource \"aws_s3_bucket_ownership_controls\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  rule {\n    object_ownership = \"BucketOwnerEnforced\"\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_lifecycle_configuration\" \"artifacts\" {\n  bucket = aws_s3_bucket.artifacts.id\n\n  rule {\n    id     = \"expire-old-artifacts\"\n    status = \"Enabled\"\n\n    filter {\n      prefix = \"\"\n    }\n\n    expiration {\n      days = 30\n    }\n\n    noncurrent_version_expiration {\n      noncurrent_days = 30\n    }\n  }\n}\n\n# -----------------------------\n# IAM: GitHub OIDC provider + roles for workflows\n# -----------------------------\n\ndata \"aws_iam_openid_connect_provider\" \"github_existing\" {\n  # If the provider already exists, this data source will work.\n  # If it doesn't exist, Terraform will error; set create_github_oidc_provider=true in a future enhancement.\n  url = var.github_oidc_provider_url\n}\n\n# Create provider if not present is not directly possible with a conditional data source.\n# For this demo, we create it unconditionally; if it already exists, import it.\nresource \"aws_iam_openid_connect_provider\" \"github\" {\n  url             = var.github_oidc_provider_url\n  client_id_list  = [\"sts.amazonaws.com\"]\n  thumbprint_list = var.github_oidc_thumbprints\n}\n\nlocals {\n  github_sub_repo = \"repo:${var.github_org}/${var.github_repo}:*\"\n}\n\ndata \"aws_iam_policy_document\" \"gha_assume_role\" {\n  statement {\n    effect  = \"Allow\"\n    actions = [\"sts:AssumeRoleWithWebIdentity\"]\n\n    principals {\n      type        = \"Federated\"\n      identifiers = [aws_iam_openid_connect_provider.github.arn]\n    }\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"token.actions.githubusercontent.com:aud\"\n      values   = [\"sts.amazonaws.com\"]\n    }\n\n    condition {\n      test     = \"StringLike\"\n      variable = \"token.actions.githubusercontent.com:sub\"\n      values   = [local.github_sub_repo]\n    }\n  }\n}\n\nresource \"aws_iam_role\" \"gha_deploy_dev\" {\n  name               = \"${var.project_name}-gha-deploy-dev\"\n  assume_role_policy = data.aws_iam_policy_document.gha_assume_role.json\n}\n\nresource \"aws_iam_role\" \"gha_deploy_prod\" {\n  name               = \"${var.project_name}-gha-deploy-prod\"\n  assume_role_policy = data.aws_iam_policy_document.gha_assume_role.json\n}\n\nresource \"aws_iam_role\" \"gha_deploy_integration\" {\n  name               = \"${var.project_name}-gha-deploy-integration\"\n  assume_role_policy = data.aws_iam_policy_document.gha_assume_role.json\n}\n\ndata \"aws_iam_policy_document\" \"gha_s3_deploy_dev\" {\n  statement {\n    sid    = \"ListBucket\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:ListBucket\",\n      \"s3:GetBucketLocation\"\n    ]\n    resources = [aws_s3_bucket.site[local.dev_bucket].arn]\n  }\n\n  statement {\n    sid    = \"ObjectRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:DeleteObject\",\n      \"s3:PutObjectAcl\"\n    ]\n    resources = [\"${aws_s3_bucket.site[local.dev_bucket].arn}/*\"]\n  }\n\n  statement {\n    sid    = \"ArtifactsRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:ListBucket\",\n      \"s3:GetBucketLocation\"\n    ]\n    resources = [aws_s3_bucket.artifacts.arn]\n  }\n\n  statement {\n    sid    = \"ArtifactsObjectRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:DeleteObject\"\n    ]\n    resources = [\"${aws_s3_bucket.artifacts.arn}/*\"]\n  }\n}\n\ndata \"aws_iam_policy_document\" \"gha_s3_deploy_prod\" {\n  statement {\n    sid    = \"ListBucket\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:ListBucket\",\n      \"s3:GetBucketLocation\"\n    ]\n    resources = [aws_s3_bucket.site[local.prod_bucket].arn]\n  }\n\n  statement {\n    sid    = \"ObjectRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:DeleteObject\",\n      \"s3:PutObjectAcl\"\n    ]\n    resources = [\"${aws_s3_bucket.site[local.prod_bucket].arn}/*\"]\n  }\n\n  statement {\n    sid    = \"ArtifactsRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:ListBucket\",\n      \"s3:GetBucketLocation\"\n    ]\n    resources = [aws_s3_bucket.artifacts.arn]\n  }\n\n  statement {\n    sid    = \"ArtifactsObjectRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:DeleteObject\"\n    ]\n    resources = [\"${aws_s3_bucket.artifacts.arn}/*\"]\n  }\n}\n\ndata \"aws_iam_policy_document\" \"gha_s3_deploy_integration\" {\n  statement {\n    sid    = \"ListBuckets\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:ListAllMyBuckets\"\n    ]\n    resources = [\"*\"]\n  }\n\n  statement {\n    sid    = \"ManagePrBuckets\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:CreateBucket\",\n      \"s3:DeleteBucket\",\n      \"s3:PutBucketPolicy\",\n      \"s3:DeleteBucketPolicy\",\n      \"s3:PutBucketWebsite\",\n      \"s3:DeleteBucketWebsite\",\n      \"s3:PutBucketPublicAccessBlock\",\n      \"s3:PutBucketOwnershipControls\",\n      \"s3:PutEncryptionConfiguration\",\n      \"s3:PutBucketVersioning\",\n      \"s3:GetBucketLocation\",\n      \"s3:ListBucket\"\n    ]\n    resources = [\n      \"arn:aws:s3:::${var.pr_prefix}*\"\n    ]\n  }\n\n  statement {\n    sid    = \"PrBucketObjects\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:DeleteObject\",\n      \"s3:PutObjectAcl\"\n    ]\n    resources = [\n      \"arn:aws:s3:::${var.pr_prefix}*/*\"\n    ]\n  }\n\n  statement {\n    sid    = \"ArtifactsRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:ListBucket\",\n      \"s3:GetBucketLocation\"\n    ]\n    resources = [aws_s3_bucket.artifacts.arn]\n  }\n\n  statement {\n    sid    = \"ArtifactsObjectRW\"\n    effect = \"Allow\"\n    actions = [\n      \"s3:GetObject\",\n      \"s3:PutObject\",\n      \"s3:DeleteObject\"\n    ]\n    resources = [\"${aws_s3_bucket.artifacts.arn}/*\"]\n  }\n}\n\nresource \"aws_iam_policy\" \"gha_deploy_dev\" {\n  name   = \"${var.project_name}-gha-deploy-dev\"\n  policy = data.aws_iam_policy_document.gha_s3_deploy_dev.json\n}\n\nresource \"aws_iam_policy\" \"gha_deploy_prod\" {\n  name   = \"${var.project_name}-gha-deploy-prod\"\n  policy = data.aws_iam_policy_document.gha_s3_deploy_prod.json\n}\n\nresource \"aws_iam_policy\" \"gha_deploy_integration\" {\n  name   = \"${var.project_name}-gha-deploy-integration\"\n  policy = data.aws_iam_policy_document.gha_s3_deploy_integration.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"dev\" {\n  role       = aws_iam_role.gha_deploy_dev.name\n  policy_arn = aws_iam_policy.gha_deploy_dev.arn\n}\n\nresource \"aws_iam_role_policy_attachment\" \"prod\" {\n  role       = aws_iam_role.gha_deploy_prod.name\n  policy_arn = aws_iam_policy.gha_deploy_prod.arn\n}\n\nresource \"aws_iam_role_policy_attachment\" \"integration\" {\n  role       = aws_iam_role.gha_deploy_integration.name\n  policy_arn = aws_iam_policy.gha_deploy_integration.arn\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"dev_site_bucket_name\" {\n  value       = var.dev_site_bucket_name\n  description = \"Development S3 website bucket name.\"\n}\n\noutput \"prod_site_bucket_name\" {\n  value       = var.prod_site_bucket_name\n  description = \"Production S3 website bucket name.\"\n}\n\noutput \"artifact_bucket_name\" {\n  value       = var.artifact_bucket_name\n  description = \"Artifact S3 bucket name.\"\n}\n\noutput \"development_iam_role_arn\" {\n  value       = aws_iam_role.gha_deploy_dev.arn\n  description = \"Set this as GitHub secret DEVELOPMENT_IAM_ROLE_ARN.\"\n}\n\noutput \"production_iam_role_arn\" {\n  value       = aws_iam_role.gha_deploy_prod.arn\n  description = \"Set this as GitHub secret PRODUCTION_IAM_ROLE_ARN.\"\n}\n\noutput \"integration_iam_role_arn\" {\n  value       = aws_iam_role.gha_deploy_integration.arn\n  description = \"Set this as GitHub secret INTEGRATION_IAM_ROLE_ARN (PR deploy workflows).\"\n}\n\noutput \"dev_website_endpoint\" {\n  value       = aws_s3_bucket_website_configuration.site[local.dev_bucket].website_endpoint\n  description = \"HTTP endpoint for S3 static website hosting (dev).\"\n}\n\noutput \"prod_website_endpoint\" {\n  value       = aws_s3_bucket_website_configuration.site[local.prod_bucket].website_endpoint\n  description = \"HTTP endpoint for S3 static website hosting (prod).\"\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "region              = \"us-east-1\"\nproject_name         = \"mkdocs-demo\"\nartifact_bucket_name = \"factually-settled-boxer-artifacts\"\ndev_site_bucket_name = \"factually-settled-boxer-development\"\nprod_site_bucket_name = \"factually-settled-boxer\"\n\ngithub_org  = \"ntno\"\ngithub_repo = \"mkdocs-demo\"\n\n# PR buckets are created dynamically by workflows in this repo; keep disabled by default.\nenable_pr_buckets = false\npr_bucket_count   = 0\n"
    }
  ]
}