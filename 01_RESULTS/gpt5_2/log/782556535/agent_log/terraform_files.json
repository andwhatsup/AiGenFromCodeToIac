{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region                      = var.region\n  access_key                  = var.aws_access_key_id\n  secret_key                  = var.aws_secret_access_key\n  skip_credentials_validation = var.use_localstack\n  skip_metadata_api_check     = var.use_localstack\n  skip_requesting_account_id  = var.use_localstack\n\n  s3_use_path_style = var.s3_use_path_style\n\n  dynamic \"endpoints\" {\n    for_each = var.use_localstack ? [1] : []\n    content {\n      s3 = var.localstack_endpoint\n    }\n  }\n\n  default_tags {\n    tags = merge(\n      {\n        Project = var.project\n      },\n      var.tags,\n    )\n  }\n}\n"
    },
    {
      "name": "main.tf",
      "content": "locals {\n  # Terratest expects the access log target bucket to be \"${bucket_id}-logs\"\n  logs_bucket_name = \"${var.bucket_name}-logs\"\n}\n\nresource \"aws_s3_bucket\" \"logs\" {\n  bucket        = local.logs_bucket_name\n  force_destroy = var.force_destroy\n\n  tags = {\n    Name        = local.logs_bucket_name\n    Environment = var.tag_bucket_environment\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"logs\" {\n  bucket = aws_s3_bucket.logs.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"logs\" {\n  bucket = aws_s3_bucket.logs.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"logs\" {\n  bucket = aws_s3_bucket.logs.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\n# Allow S3 server access logging to write into the log bucket.\n# In AWS, the recommended principal is logging.s3.amazonaws.com with SourceArn/SourceAccount conditions.\n# LocalStack may not enforce these strictly, but this policy is valid in AWS.\nresource \"aws_s3_bucket_policy\" \"logs\" {\n  bucket = aws_s3_bucket.logs.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Sid    = \"S3ServerAccessLogsPolicy\"\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"logging.s3.amazonaws.com\"\n        }\n        Action   = \"s3:PutObject\"\n        Resource = \"${aws_s3_bucket.logs.arn}/${var.access_logs_prefix}*\"\n        Condition = {\n          StringEquals = {\n            \"s3:x-amz-acl\" = \"bucket-owner-full-control\"\n          }\n        }\n      }\n    ]\n  })\n\n  depends_on = [aws_s3_bucket_public_access_block.logs]\n}\n\nresource \"aws_s3_bucket\" \"app\" {\n  bucket        = var.bucket_name\n  force_destroy = var.force_destroy\n\n  tags = {\n    Name        = var.tag_bucket_name\n    Environment = var.tag_bucket_environment\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"app\" {\n  bucket = aws_s3_bucket.app.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"app\" {\n  bucket = aws_s3_bucket.app.id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"app\" {\n  bucket = aws_s3_bucket.app.id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\nresource \"aws_s3_bucket_logging\" \"app\" {\n  bucket        = aws_s3_bucket.app.id\n  target_bucket = aws_s3_bucket.logs.id\n  target_prefix = var.access_logs_prefix\n}\n\ndata \"aws_iam_policy_document\" \"app_bucket_policy\" {\n  count = var.with_policy ? 1 : 0\n\n  statement {\n    sid     = \"DenyInsecureTransport\"\n    effect  = \"Deny\"\n    actions = [\"s3:*\"]\n\n    principals {\n      type        = \"*\"\n      identifiers = [\"*\"]\n    }\n\n    resources = [\n      aws_s3_bucket.app.arn,\n      \"${aws_s3_bucket.app.arn}/*\",\n    ]\n\n    condition {\n      test     = \"Bool\"\n      variable = \"aws:SecureTransport\"\n      values   = [\"false\"]\n    }\n  }\n}\n\nresource \"aws_s3_bucket_policy\" \"app\" {\n  count  = var.with_policy ? 1 : 0\n  bucket = aws_s3_bucket.app.id\n  policy = data.aws_iam_policy_document.app_bucket_policy[0].json\n\n  depends_on = [aws_s3_bucket_public_access_block.app]\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"project\" {\n  description = \"Project tag applied via provider default_tags.\"\n  type        = string\n  default     = \"terratest-localstack\"\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply via provider default_tags.\"\n  type        = map(string)\n  default     = {}\n}\n\nvariable \"region\" {\n  description = \"AWS region to use. Terratest passes this in.\"\n  type        = string\n}\n\nvariable \"bucket_name\" {\n  description = \"Name of the application S3 bucket.\"\n  type        = string\n}\n\nvariable \"tag_bucket_name\" {\n  description = \"Value for the Name tag on the application bucket (Terratest passes this).\"\n  type        = string\n}\n\nvariable \"tag_bucket_environment\" {\n  description = \"Value for the Environment tag on the buckets (Terratest passes this).\"\n  type        = string\n}\n\nvariable \"with_policy\" {\n  description = \"Whether to attach a bucket policy to the application bucket (Terratest expects true).\"\n  type        = bool\n  default     = true\n}\n\nvariable \"access_logs_prefix\" {\n  description = \"Prefix for S3 server access logs. Terratest expects TFStateLogs/.\"\n  type        = string\n  default     = \"TFStateLogs/\"\n}\n\nvariable \"force_destroy\" {\n  description = \"Whether to force-destroy buckets (useful for tests).\"\n  type        = bool\n  default     = true\n}\n\n# LocalStack support\nvariable \"use_localstack\" {\n  description = \"If true, configure the AWS provider to use LocalStack endpoints and skip validations.\"\n  type        = bool\n  default     = true\n}\n\nvariable \"localstack_endpoint\" {\n  description = \"LocalStack edge endpoint.\"\n  type        = string\n  default     = \"http://localhost:4566\"\n}\n\nvariable \"s3_use_path_style\" {\n  description = \"Set true when using http://localhost:4566 for S3 to avoid DNS-style bucket addressing issues.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"aws_access_key_id\" {\n  description = \"AWS access key (LocalStack default is 'test').\"\n  type        = string\n  default     = \"test\"\n  sensitive   = true\n}\n\nvariable \"aws_secret_access_key\" {\n  description = \"AWS secret key (LocalStack default is 'test').\"\n  type        = string\n  default     = \"test\"\n  sensitive   = true\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"bucket_id\" {\n  description = \"ID (name) of the application bucket. Terratest reads this output.\"\n  value       = aws_s3_bucket.app.id\n}\n\noutput \"logs_bucket_id\" {\n  description = \"ID (name) of the access logs bucket.\"\n  value       = aws_s3_bucket.logs.id\n}\n\noutput \"logs_prefix\" {\n  description = \"Prefix used for server access logs.\"\n  value       = var.access_logs_prefix\n}\n"
    },
    {
      "name": "terraform.tfvars",
      "content": "# Defaults for running against LocalStack.\nuse_localstack      = true\nlocalstack_endpoint = \"http://localhost:4566\"\n\n# If you use the S3 endpoint http://localhost:4566, you may need path-style addressing.\n# If you use http://s3.localhost.localstack.cloud:4566, keep this false.\ns3_use_path_style = false\n\naws_access_key_id     = \"test\"\naws_secret_access_key = \"test\"\n\n# Terratest passes these, but providing placeholders makes manual runs easier.\nregion                 = \"us-east-1\"\nbucket_name             = \"terratest-aws-s3-example-placeholder\"\ntag_bucket_name         = \"terratest-aws-s3-example-placeholder\"\ntag_bucket_environment  = \"Automated Testing\"\nwith_policy             = true\n"
    },
    {
      "name": "README.md",
      "content": "# Terraform (ai_tf)\n\nThis Terraform configuration provisions the S3 resources expected by the Go/Terratest tests in `infra_tests/`.\n\n## What it creates\n- Application S3 bucket (output: `bucket_id`)\n  - Versioning enabled\n  - Default encryption (SSE-S3)\n  - Public access blocked\n  - Optional bucket policy (`with_policy`)\n  - Server access logging enabled\n- Access logs S3 bucket named `${bucket_name}-logs`\n  - Versioning enabled\n  - Default encryption (SSE-S3)\n  - Public access blocked\n  - Bucket policy allowing S3 server access logging delivery\n\n## LocalStack\nBy default, the AWS provider is configured to use LocalStack (`use_localstack = true`).\n\nIf you want to run against real AWS, set `use_localstack = false` and provide real credentials (or use environment variables / profiles).\n"
    }
  ]
}