{
  "files": [
    {
      "name": "versions.tf",
      "content": "terraform {\n  required_version = \">= 1.5.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n"
    },
    {
      "name": "provider.tf",
      "content": "provider \"aws\" {\n  region = var.region\n\n  default_tags {\n    tags = merge(\n      {\n        Project     = var.project_name\n        Environment = var.environment\n        ManagedBy   = \"terraform\"\n      },\n      var.tags\n    )\n  }\n}\n"
    },
    {
      "name": "variables.tf",
      "content": "variable \"project_name\" {\n  description = \"Project/name prefix used for resources.\"\n  type        = string\n  default     = \"aws-iam-gitops\"\n}\n\nvariable \"environment\" {\n  description = \"Environment name (e.g., dev, prod).\"\n  type        = string\n  default     = \"dev\"\n}\n\nvariable \"region\" {\n  description = \"AWS region.\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\nvariable \"random_suffix\" {\n  description = \"Optional suffix to make names unique (matches repo README usage).\"\n  type        = string\n  default     = \"31\"\n}\n\nvariable \"ecr_repo_name\" {\n  description = \"ECR repository name that stores the Lambda container image.\"\n  type        = string\n  default     = \"aws-iam-gitops\"\n}\n\nvariable \"image_tag\" {\n  description = \"Container image tag in ECR.\"\n  type        = string\n  default     = \"v31\"\n}\n\nvariable \"lambda_function_name\" {\n  description = \"Lambda function name.\"\n  type        = string\n  default     = \"aws-iam-gitops-31\"\n}\n\nvariable \"lambda_timeout\" {\n  description = \"Lambda timeout in seconds.\"\n  type        = number\n  default     = 120\n}\n\nvariable \"lambda_memory_size\" {\n  description = \"Lambda memory size in MB.\"\n  type        = number\n  default     = 512\n}\n\nvariable \"lambda_ephemeral_storage\" {\n  description = \"Ephemeral storage in MB for /tmp (512-10240).\"\n  type        = number\n  default     = 1024\n}\n\nvariable \"eventbridge_name\" {\n  description = \"EventBridge rule name.\"\n  type        = string\n  default     = \"aws-iam-gitops-31\"\n}\n\nvariable \"schedule_expression\" {\n  description = \"EventBridge schedule expression.\"\n  type        = string\n  default     = \"rate(1 day)\"\n}\n\nvariable \"github_username\" {\n  description = \"GitHub username/owner.\"\n  type        = string\n}\n\nvariable \"github_repo\" {\n  description = \"GitHub repository name.\"\n  type        = string\n}\n\nvariable \"github_token\" {\n  description = \"GitHub token with write access to the repo. Stored in Secrets Manager.\"\n  type        = string\n  sensitive   = true\n}\n\nvariable \"create_cloudtrail\" {\n  description = \"Whether to create CloudTrail + S3 log bucket in this stack.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"cloudtrail_name\" {\n  description = \"CloudTrail trail name (if create_cloudtrail=true).\"\n  type        = string\n  default     = \"aws-iam-gitops-31\"\n}\n\nvariable \"s3_bucket_name\" {\n  description = \"S3 bucket name for CloudTrail logs (if create_cloudtrail=true). Must be globally unique.\"\n  type        = string\n  default     = \"aws-iam-gitops-31\"\n}\n\nvariable \"tags\" {\n  description = \"Additional tags to apply to resources.\"\n  type        = map(string)\n  default     = {}\n}\n"
    },
    {
      "name": "locals.tf",
      "content": "data \"aws_caller_identity\" \"current\" {}\n\ndata \"aws_partition\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\nlocals {\n  name_suffix = var.random_suffix\n\n  ecr_image_uri = \"${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.region}.amazonaws.com/${var.ecr_repo_name}:${var.image_tag}\"\n\n  github_secret_name = \"${var.project_name}-github-token-${local.name_suffix}\"\n}\n"
    },
    {
      "name": "ecr.tf",
      "content": "resource \"aws_ecr_repository\" \"this\" {\n  name                 = var.ecr_repo_name\n  image_tag_mutability = \"MUTABLE\"\n\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n\n  encryption_configuration {\n    encryption_type = \"AES256\"\n  }\n}\n\nresource \"aws_ecr_lifecycle_policy\" \"this\" {\n  repository = aws_ecr_repository.this.name\n\n  policy = jsonencode({\n    rules = [\n      {\n        rulePriority = 1\n        description  = \"Keep last 20 images\"\n        selection = {\n          tagStatus   = \"any\"\n          countType   = \"imageCountMoreThan\"\n          countNumber = 20\n        }\n        action = {\n          type = \"expire\"\n        }\n      }\n    ]\n  })\n}\n"
    },
    {
      "name": "secrets.tf",
      "content": "resource \"aws_secretsmanager_secret\" \"github_token\" {\n  name                    = local.github_secret_name\n  recovery_window_in_days  = 7\n}\n\nresource \"aws_secretsmanager_secret_version\" \"github_token\" {\n  secret_id     = aws_secretsmanager_secret.github_token.id\n  secret_string = var.github_token\n}\n"
    },
    {
      "name": "iam.tf",
      "content": "data \"aws_iam_policy_document\" \"lambda_assume\" {\n  statement {\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\nresource \"aws_iam_role\" \"lambda\" {\n  name               = \"${var.project_name}-lambda-role-${local.name_suffix}\"\n  assume_role_policy = data.aws_iam_policy_document.lambda_assume.json\n}\n\ndata \"aws_iam_policy_document\" \"lambda_permissions\" {\n  statement {\n    sid     = \"CloudWatchLogs\"\n    effect  = \"Allow\"\n    actions = [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ]\n    resources = [\"*\"]\n  }\n\n  statement {\n    sid    = \"OrganizationsRead\"\n    effect = \"Allow\"\n    actions = [\n      \"organizations:ListPolicies\",\n      \"organizations:DescribePolicy\"\n    ]\n    resources = [\"*\"]\n  }\n\n  statement {\n    sid    = \"IamRead\"\n    effect = \"Allow\"\n    actions = [\n      \"iam:ListRoles\",\n      \"iam:ListPolicies\"\n    ]\n    resources = [\"*\"]\n  }\n\n  statement {\n    sid    = \"ReadGithubTokenSecret\"\n    effect = \"Allow\"\n    actions = [\n      \"secretsmanager:GetSecretValue\",\n      \"secretsmanager:DescribeSecret\"\n    ]\n    resources = [aws_secretsmanager_secret.github_token.arn]\n  }\n}\n\nresource \"aws_iam_policy\" \"lambda\" {\n  name   = \"${var.project_name}-lambda-permissions-${local.name_suffix}\"\n  policy = data.aws_iam_policy_document.lambda_permissions.json\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda\" {\n  role       = aws_iam_role.lambda.name\n  policy_arn = aws_iam_policy.lambda.arn\n}\n"
    },
    {
      "name": "lambda.tf",
      "content": "resource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${var.lambda_function_name}\"\n  retention_in_days = 30\n}\n\nresource \"aws_lambda_function\" \"this\" {\n  function_name = var.lambda_function_name\n  role          = aws_iam_role.lambda.arn\n  package_type  = \"Image\"\n  image_uri     = local.ecr_image_uri\n\n  timeout      = var.lambda_timeout\n  memory_size  = var.lambda_memory_size\n\n  ephemeral_storage {\n    size = var.lambda_ephemeral_storage\n  }\n\n  environment {\n    variables = {\n      GITHUB_USERNAME  = var.github_username\n      GITHUB_REPO      = var.github_repo\n      GITHUB_TOKEN_ARN = aws_secretsmanager_secret.github_token.arn\n    }\n  }\n\n  depends_on = [aws_cloudwatch_log_group.lambda]\n}\n\n# NOTE: The provided Dockerfile bakes GitHub credentials into the image via build args.\n# This Terraform stack stores the token in Secrets Manager, but the current code does not read it.\n# Consider updating lambda_function.py to read the token from Secrets Manager using GITHUB_TOKEN_ARN.\n"
    },
    {
      "name": "eventbridge.tf",
      "content": "resource \"aws_cloudwatch_event_rule\" \"schedule\" {\n  name                = var.eventbridge_name\n  description         = \"Scheduled trigger for ${var.lambda_function_name}\"\n  schedule_expression = var.schedule_expression\n}\n\nresource \"aws_cloudwatch_event_target\" \"lambda\" {\n  rule      = aws_cloudwatch_event_rule.schedule.name\n  target_id = \"lambda\"\n  arn       = aws_lambda_function.this.arn\n}\n\nresource \"aws_lambda_permission\" \"allow_eventbridge\" {\n  statement_id  = \"AllowExecutionFromEventBridge\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.this.function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.schedule.arn\n}\n"
    },
    {
      "name": "cloudtrail.tf",
      "content": "resource \"aws_s3_bucket\" \"cloudtrail\" {\n  count  = var.create_cloudtrail ? 1 : 0\n  bucket = var.s3_bucket_name\n\n  force_destroy = false\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"cloudtrail\" {\n  count  = var.create_cloudtrail ? 1 : 0\n  bucket = aws_s3_bucket.cloudtrail[0].id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\nresource \"aws_s3_bucket_versioning\" \"cloudtrail\" {\n  count  = var.create_cloudtrail ? 1 : 0\n  bucket = aws_s3_bucket.cloudtrail[0].id\n\n  versioning_configuration {\n    status = \"Enabled\"\n  }\n}\n\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"cloudtrail\" {\n  count  = var.create_cloudtrail ? 1 : 0\n  bucket = aws_s3_bucket.cloudtrail[0].id\n\n  rule {\n    apply_server_side_encryption_by_default {\n      sse_algorithm = \"AES256\"\n    }\n  }\n}\n\ndata \"aws_iam_policy_document\" \"cloudtrail_bucket\" {\n  count = var.create_cloudtrail ? 1 : 0\n\n  statement {\n    sid    = \"AWSCloudTrailAclCheck\"\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"cloudtrail.amazonaws.com\"]\n    }\n\n    actions   = [\"s3:GetBucketAcl\"]\n    resources = [aws_s3_bucket.cloudtrail[0].arn]\n  }\n\n  statement {\n    sid    = \"AWSCloudTrailWrite\"\n    effect = \"Allow\"\n\n    principals {\n      type        = \"Service\"\n      identifiers = [\"cloudtrail.amazonaws.com\"]\n    }\n\n    actions = [\"s3:PutObject\"]\n\n    resources = [\n      \"${aws_s3_bucket.cloudtrail[0].arn}/AWSLogs/${data.aws_caller_identity.current.account_id}/*\"\n    ]\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"s3:x-amz-acl\"\n      values   = [\"bucket-owner-full-control\"]\n    }\n  }\n}\n\nresource \"aws_s3_bucket_policy\" \"cloudtrail\" {\n  count  = var.create_cloudtrail ? 1 : 0\n  bucket = aws_s3_bucket.cloudtrail[0].id\n  policy = data.aws_iam_policy_document.cloudtrail_bucket[0].json\n}\n\nresource \"aws_cloudtrail\" \"this\" {\n  count = var.create_cloudtrail ? 1 : 0\n\n  name                          = var.cloudtrail_name\n  s3_bucket_name                = aws_s3_bucket.cloudtrail[0].id\n  include_global_service_events = true\n  is_multi_region_trail         = true\n  enable_logging                = true\n}\n"
    },
    {
      "name": "outputs.tf",
      "content": "output \"ecr_repository_url\" {\n  value       = aws_ecr_repository.this.repository_url\n  description = \"ECR repository URL.\"\n}\n\noutput \"lambda_function_name\" {\n  value       = aws_lambda_function.this.function_name\n  description = \"Lambda function name.\"\n}\n\noutput \"lambda_function_arn\" {\n  value       = aws_lambda_function.this.arn\n  description = \"Lambda function ARN.\"\n}\n\noutput \"eventbridge_rule_arn\" {\n  value       = aws_cloudwatch_event_rule.schedule.arn\n  description = \"EventBridge rule ARN.\"\n}\n\noutput \"cloudtrail_bucket_name\" {\n  value       = var.create_cloudtrail ? aws_s3_bucket.cloudtrail[0].bucket : null\n  description = \"CloudTrail S3 bucket name (if created).\"\n}\n"
    },
    {
      "name": "terraform.tfvars.example",
      "content": "region            = \"us-east-1\"\nproject_name       = \"aws-iam-gitops\"\nenvironment        = \"dev\"\nrandom_suffix      = \"31\"\n\ngithub_username    = \"YOUR_GITHUB_USERNAME\"\ngithub_repo        = \"YOUR_REPO_NAME\"\ngithub_token       = \"YOUR_GITHUB_TOKEN\"\n\n# Ensure you have pushed an image to ECR with this tag before apply.\necr_repo_name      = \"aws-iam-gitops\"\nimage_tag          = \"v31\"\n\nlambda_function_name = \"aws-iam-gitops-31\"\neventbridge_name     = \"aws-iam-gitops-31\"\nschedule_expression  = \"rate(1 day)\"\n\n# Optional: create CloudTrail + S3 bucket in this stack\ncreate_cloudtrail = false\ncloudtrail_name   = \"aws-iam-gitops-31\"\ns3_bucket_name    = \"aws-iam-gitops-31-CHANGE-ME-UNIQUE\"\n"
    }
  ]
}