{
  "version": 4,
  "terraform_version": "1.13.5",
  "serial": 6,
  "lineage": "b7f0fbf8-24b3-28c0-7edf-605e2a894ad1",
  "outputs": {
    "eventbridge_rule_name": {
      "value": "ssm-parameter-backup-dev-schedule-20260126234945516500000001",
      "type": "string"
    },
    "kms_key_arn": {
      "value": "arn:aws:kms:us-east-1:000000000000:key/57922c81-e767-4472-8112-51eef27935ac",
      "type": "string"
    },
    "lambda_function_name": {
      "value": "ssm-parameter-backup-dev-ssm-backup",
      "type": "string"
    }
  },
  "resources": [
    {
      "mode": "data",
      "type": "archive_file",
      "name": "lambda_dummy",
      "provider": "provider[\"registry.terraform.io/hashicorp/archive\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "exclude_symlink_directories": null,
            "excludes": null,
            "id": "58e93fade67637870be5af38eff8d5aa66c7da49",
            "output_base64sha256": "wmbalFzzY/wG3ivChKElOZB3+B4gptmQyIat05p+fU4=",
            "output_base64sha512": "BQYAg1LwEY4tDmry1VoRx6StX0vjH+7LpfB5KAZLVvfJQjioPbBv1QxI6QF6P2U614fU3h9XKBCb9z5Y1ornqA==",
            "output_file_mode": null,
            "output_md5": "a0dbd832a6a977d6d5b28ea5c85e30fb",
            "output_path": "./.dummy/lambda.zip",
            "output_sha": "58e93fade67637870be5af38eff8d5aa66c7da49",
            "output_sha256": "c266da945cf363fc06de2bc284a125399077f81e20a6d990c886add39a7e7d4e",
            "output_sha512": "0506008352f0118e2d0e6af2d55a11c7a4ad5f4be31feecba5f07928064b56f7c94238a83db06fd50c48e9017a3f653ad787d4de1f5728109bf73e58d68ae7a8",
            "output_size": 246,
            "source": [
              {
                "content": "exports.handler = async (event) =\u003e {\n  console.log(\"Dummy lambda invoked\");\n  return { statusCode: 200, body: \"dummy\" };\n};\n",
                "filename": "index.js"
              }
            ],
            "source_content": null,
            "source_content_filename": null,
            "source_dir": null,
            "source_file": null,
            "type": "zip"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0
        }
      ]
    },
    {
      "mode": "data",
      "type": "archive_file",
      "name": "lambda_zip",
      "provider": "provider[\"registry.terraform.io/hashicorp/archive\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "exclude_symlink_directories": null,
            "excludes": null,
            "id": "4247baed0e5cfb321f5efc81530f8c463a00aac3",
            "output_base64sha256": "Kp4uCUmlD5T25tvRyuZfWJzJ9eM3Z8+h5fhxYs+T34w=",
            "output_base64sha512": "BTywDtb8zG5zZh4WZDmxJsIRrrSdgCmDRUNngCGyrxicRaaYafX2Eys11EAruoW2oyv537Rvp63jK7EcFY+C0w==",
            "output_file_mode": null,
            "output_md5": "1243b9bace89e64ef52efd9d1af37a84",
            "output_path": "./build/ssm_backup.zip",
            "output_sha": "4247baed0e5cfb321f5efc81530f8c463a00aac3",
            "output_sha256": "2a9e2e0949a50f94f6e6dbd1cae65f589cc9f5e33767cfa1e5f87162cf93df8c",
            "output_sha512": "053cb00ed6fccc6e73661e166439b126c211aeb49d8029834543678021b2af189c45a69869f5f6132b35d4402bba85b6a32bf9dfb46fa7ade32bb11c158f82d3",
            "output_size": 1315,
            "source": [],
            "source_content": null,
            "source_content_filename": null,
            "source_dir": null,
            "source_file": "./build/ssm_backup.py",
            "type": "zip"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0
        }
      ]
    },
    {
      "mode": "data",
      "type": "aws_caller_identity",
      "name": "current",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "account_id": "000000000000",
            "arn": "arn:aws:iam::000000000000:root",
            "id": "000000000000",
            "user_id": "AKIAIOSFODNN7EXAMPLE"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0
        }
      ]
    },
    {
      "mode": "data",
      "type": "aws_partition",
      "name": "current",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "dns_suffix": "amazonaws.com",
            "id": "aws",
            "partition": "aws",
            "reverse_dns_prefix": "com.amazonaws"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0
        }
      ]
    },
    {
      "mode": "data",
      "type": "aws_region",
      "name": "current",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "description": "US East (N. Virginia)",
            "endpoint": "ec2.us-east-1.amazonaws.com",
            "id": "us-east-1",
            "name": "us-east-1",
            "region": "us-east-1"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_cloudwatch_event_rule",
      "name": "schedule",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "arn": "arn:aws:events:us-east-1:000000000000:rule/ssm-parameter-backup-dev-schedule-20260126234945516500000001",
            "description": "",
            "event_bus_name": "default",
            "event_pattern": null,
            "force_destroy": false,
            "id": "ssm-parameter-backup-dev-schedule-20260126234945516500000001",
            "is_enabled": true,
            "name": "ssm-parameter-backup-dev-schedule-20260126234945516500000001",
            "name_prefix": "ssm-parameter-backup-dev-schedule-",
            "region": "us-east-1",
            "role_arn": "",
            "schedule_expression": "rate(1 day)",
            "state": "ENABLED",
            "tags": null,
            "tags_all": {
              "Environment": "dev",
              "ManagedBy": "terraform",
              "Project": "ssm-parameter-backup"
            }
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "account_id": "000000000000",
            "name": "ssm-parameter-backup-dev-schedule-20260126234945516500000001",
            "region": "us-east-1"
          },
          "private": "eyJzY2hlbWFfdmVyc2lvbiI6IjEifQ=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_iam_role",
      "name": "lambda",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "arn": "arn:aws:iam::000000000000:role/ssm-parameter-backup-dev-lambda-20260126234945516600000002",
            "assume_role_policy": "{\"Statement\":[{\"Action\":\"sts:AssumeRole\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"lambda.amazonaws.com\"}}],\"Version\":\"2012-10-17\"}",
            "create_date": "2026-01-26T23:49:45Z",
            "description": "",
            "force_detach_policies": false,
            "id": "ssm-parameter-backup-dev-lambda-20260126234945516600000002",
            "inline_policy": [],
            "managed_policy_arns": [],
            "max_session_duration": 3600,
            "name": "ssm-parameter-backup-dev-lambda-20260126234945516600000002",
            "name_prefix": "ssm-parameter-backup-dev-lambda-",
            "path": "/",
            "permissions_boundary": "",
            "tags": null,
            "tags_all": {
              "Environment": "dev",
              "ManagedBy": "terraform",
              "Project": "ssm-parameter-backup"
            },
            "unique_id": "AROAQAAAAAAAF4PMBVFSI"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "account_id": "000000000000",
            "name": "ssm-parameter-backup-dev-lambda-20260126234945516600000002"
          },
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_kms_alias",
      "name": "backup",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "arn": "arn:aws:kms:us-east-1:000000000000:alias/ssm-parameter-backup-dev-ssm-backup",
            "id": "alias/ssm-parameter-backup-dev-ssm-backup",
            "name": "alias/ssm-parameter-backup-dev-ssm-backup",
            "name_prefix": "",
            "region": "us-east-1",
            "target_key_arn": "arn:aws:kms:us-east-1:000000000000:key/57922c81-e767-4472-8112-51eef27935ac",
            "target_key_id": "57922c81-e767-4472-8112-51eef27935ac"
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "account_id": "000000000000",
            "name": "alias/ssm-parameter-backup-dev-ssm-backup",
            "region": "us-east-1"
          },
          "private": "bnVsbA==",
          "dependencies": [
            "aws_kms_key.backup"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_kms_key",
      "name": "backup",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "arn": "arn:aws:kms:us-east-1:000000000000:key/57922c81-e767-4472-8112-51eef27935ac",
            "bypass_policy_lockout_safety_check": false,
            "custom_key_store_id": "",
            "customer_master_key_spec": "SYMMETRIC_DEFAULT",
            "deletion_window_in_days": 7,
            "description": "KMS key for encrypting SSM Parameter Store backups in S3",
            "enable_key_rotation": true,
            "id": "57922c81-e767-4472-8112-51eef27935ac",
            "is_enabled": true,
            "key_id": "57922c81-e767-4472-8112-51eef27935ac",
            "key_usage": "ENCRYPT_DECRYPT",
            "multi_region": false,
            "policy": "{\"Id\":\"key-default-1\",\"Statement\":[{\"Action\":\"kms:*\",\"Effect\":\"Allow\",\"Principal\":{\"AWS\":\"arn:aws:iam::000000000000:root\"},\"Resource\":\"*\",\"Sid\":\"Enable IAM User Permissions\"}],\"Version\":\"2012-10-17\"}",
            "region": "us-east-1",
            "rotation_period_in_days": 365,
            "tags": null,
            "tags_all": {
              "Environment": "dev",
              "ManagedBy": "terraform",
              "Project": "ssm-parameter-backup"
            },
            "timeouts": null,
            "xks_key_id": ""
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "identity": {
            "account_id": "000000000000",
            "id": "57922c81-e767-4472-8112-51eef27935ac",
            "region": "us-east-1"
          },
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjoxMjAwMDAwMDAwMDB9fQ=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_s3_bucket",
      "name": "backup",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": []
    },
    {
      "mode": "managed",
      "type": "local_file",
      "name": "lambda_source",
      "provider": "provider[\"registry.terraform.io/hashicorp/local\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "content": "from io import StringIO\nimport boto3\nimport time\nimport os\nimport json\nimport math\nimport traceback\nfrom botocore.exceptions import ClientError\n\ndef get_parameters_from_ssm(ssm_client, params_names, x, tries=1):\n    try:\n        return ssm_client.get_parameters(Names=params_names[((x-1)*10):(x*10)], WithDecryption=True)\n    except ClientError as exception_obj:\n        if exception_obj.response['Error']['Code'] == 'ThrottlingException':\n            if tries \u003c= 3:\n                print(\"Throttling Exception Occured.\")\n                print(\"Retrying.....\")\n                print(\"Attempt No.: \" + str(tries))\n                time.sleep(3)\n                return get_parameters_from_ssm(ssm_client, params_names, x, tries + 1)\n            else:\n                print(\"Attempted 3 Times But No Success.\")\n                print(\"Raising Exception.....\")\n                raise\n        else:\n            raise\n\ndef ssm_backup():\n    # fetch environment variables\n    s3_bucket = os.getenv('S3_BUCKET')\n    kms_key_arn = os.getenv('KMS_KEY_ARN')\n    time_string = time.strftime(\"%Y-%m-%d-%H-%M\")\n\n    # create param variables\n    params = []\n    params_names = []\n    params_values = {}\n    str_params = ''\n\n    # create S3 and SSM clients\n    s3_client = boto3.client('s3')\n    ssm_client = boto3.client('ssm')\n\n    # describe parameters (without values)\n    ssm_paginator = ssm_client.get_paginator('describe_parameters')\n\n    # create page iterator\n    page_iterator = ssm_paginator.paginate()\n\n    # get param names\n    for page in page_iterator:\n        for item in page['Parameters']:\n            params.append(item)\n            params_names.append(item['Name'])\n\n    # get param values\n    params_names_loop = math.ceil(len(params_names) / 10) + 1\n\n    for x in range(1, params_names_loop):\n        response = get_parameters_from_ssm(ssm_client, params_names, x, 1)\n\n        for item in response['Parameters']:\n            params_values[item['Name']] = item['Value']\n\n    # add values to parameters list\n    for param in params:\n        param['Value'] = params_values[param['Name']]\n        str_params += json.dumps(param, default=str) + \",\\n\"\n\n    # fix json string\n    str_params = \"[\\n\" + str_params + \"]\"\n    str_params = str_params.replace(\",\\n]\", \"\\n]\")\n\n    # write to s3 bucket\n    fake_handle = StringIO(str_params)\n    s3_client.put_object(Bucket=s3_bucket, Key=\"backups/parameters-\" + time_string + \".json\", Body=fake_handle.read(), ServerSideEncryption='aws:kms', SSEKMSKeyId=kms_key_arn)\n\n    print(\"Successfully taken the backup of all the parameters residing on AWS SSM Parameter Store.\")\n\ndef lambda_handler(event, context):\n    try:\n        ssm_backup()\n\n        # return success\n        return \"Lambda function executed successfully.\"\n    except Exception as e:\n        # return exception\n        tb = traceback.format_exc()\n        print(tb)\n        return tb\n\n# locally test the code\nif __name__ == \"__main__\":\n    event = []\n    context = []\n    print(lambda_handler(event, context))\n",
            "content_base64": null,
            "content_base64sha256": "WM5OUY2uajilUHStEnW8YCgCM2C2ruyv3eEair5FV3g=",
            "content_base64sha512": "kBk5RIdAxMXyzDU9h4Ybhg/rYNdH7+HstAY6PhK8K8r7kWaX7icmCnUjbmL7Ofy77TiV/QzUD57y9PxmIPIaGQ==",
            "content_md5": "4a90ba39e984baed4c28adeec6ef0506",
            "content_sha1": "6bbd5d5f532c6e76ebecde6aa1e4fc8925b2f050",
            "content_sha256": "58ce4e518dae6a38a55074ad1275bc6028023360b6aeecafdde11a8abe455778",
            "content_sha512": "901939448740c4c5f2cc353d87861b860feb60d747efe1ecb4063a3e12bc2bcafb916697ee27260a75236e62fb39fcbbed3895fd0cd40f9ef2f4fc6620f21a19",
            "directory_permission": "0777",
            "file_permission": "0777",
            "filename": "./build/ssm_backup.py",
            "id": "6bbd5d5f532c6e76ebecde6aa1e4fc8925b2f050",
            "sensitive_content": null,
            "source": null
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "sensitive_content"
              }
            ]
          ],
          "identity_schema_version": 0
        }
      ]
    }
  ],
  "check_results": null
}
